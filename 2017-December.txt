From emerson.barea at gmail.com  Fri Dec  1 19:03:00 2017
From: emerson.barea at gmail.com (Emerson Barea)
Date: Fri, 1 Dec 2017 22:03:00 -0200
Subject: [Project Clearwater] Clearwater bandwidth and delay requirements
Message-ID: <CAO1UhdXULgW=Yr9Prs6K6j6AF9JoTH5DYsg7ugnByKf_thc+ZA@mail.gmail.com>

Hi. What is the requeriments of bandwidth and delay for Clearwater services?

Thanks

Emerson
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20171201/eb5c4dd7/attachment.html>

From Ying.Huang at metaswitch.com  Thu Dec  7 10:12:28 2017
From: Ying.Huang at metaswitch.com (Ying Huang)
Date: Thu, 7 Dec 2017 15:12:28 +0000
Subject: [Project Clearwater] Clearwater bandwidth and delay requirements
In-Reply-To: <CAO1UhdXULgW=Yr9Prs6K6j6AF9JoTH5DYsg7ugnByKf_thc+ZA@mail.gmail.com>
References: <CAO1UhdXULgW=Yr9Prs6K6j6AF9JoTH5DYsg7ugnByKf_thc+ZA@mail.gmail.com>
Message-ID: <DM5PR0201MB3623E8DE318F446B8AADB2A4F8330@DM5PR0201MB3623.namprd02.prod.outlook.com>

Hey Emerson,

I am afraid I don?t fully understand your question. The bandwidth depends on the amount of network traffic, while the delay depends on your network setup and probably hardware. Although if the delay between nodes in-site exceed 10 ms or the delay between sites exceeds 100 ms, Clearwater is unlikely to work as most of the service timeout was estimated based on that speed.

Thanks,
Ying

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Emerson Barea
Sent: 02 December 2017 00:03
To: clearwater at lists.projectclearwater.org
Subject: [Project Clearwater] Clearwater bandwidth and delay requirements

Hi. What is the requeriments of bandwidth and delay for Clearwater services?
Thanks
Emerson
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20171207/b846b017/attachment.html>

From Ying.Huang at metaswitch.com  Thu Dec  7 10:30:03 2017
From: Ying.Huang at metaswitch.com (Ying Huang)
Date: Thu, 7 Dec 2017 15:30:03 +0000
Subject: [Project Clearwater] Clearwater Failing with Docker Swarm on
 Single/Multiple Machine(s)
In-Reply-To: <CAOVf8C0nCtHk9fHdW+Bq9OZ9Cv=mxgA1KJBOQqCT-Ued8U-uVA@mail.gmail.com>
References: <CAOVf8C0nCtHk9fHdW+Bq9OZ9Cv=mxgA1KJBOQqCT-Ued8U-uVA@mail.gmail.com>
Message-ID: <DM5PR0201MB362367636F38F7CCC4D10F2CF8330@DM5PR0201MB3623.namprd02.prod.outlook.com>

Hi Muhammad,

Sorry about this late reply ? I was quite busy for release. We have tested Clearwater with Docker Compose as well as with Kubernete, and know for sure Clearwater works with them. The fact that you were able to enter the container also suggests that the deployment has been successfully created, and Docker Swarm isn?t what is causing the problem here. I would suggest you try to deploy it with Docker Compose, and


  1.  If it doesn?t work, I can help with the investigation more easily by comparing to how I did it
  2.  If it works, we can be sure it?s something to do with Docker Swarm and investigate in that direction

Thanks,
Ying


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Muhammad Imran
Sent: 27 November 2017 08:45
To: clearwater at lists.projectclearwater.org
Subject: [Project Clearwater] Clearwater Failing with Docker Swarm on Single/Multiple Machine(s)

Hi,



I am trying to deploy Clearwater project on Docker Swarm. However,  it fails to start the services of Clearwater components inside the container. I tested it by deploying the services on a single machine as well as multiple machines. The issues are the same.


Steps (on multiple machines):
Executed the following on swarm leader machine.


sudo docker swarm init

(joined swarm on nodes and set node.labels.comp=<componentname>  on each node so that each component must run on separate machine.)

sudo docker network create  -d overlay --subnet=10.254.0.0/16<http://10.254.0.0/16> clearwater_nw --attachable

sudo docker service create --name etcd  --constraint 'node.labels.comp==etcd' --mode=global  --hostname etcd --network clearwater_nw -p 4001:4001 -p 2379:2379 -p 2380:2380 quay.io/coreos/etcd:v2.2.5<http://quay.io/coreos/etcd:v2.2.5> -name etcd0 -advertise-client-urls http://etcd:2379,http://etcd:4001 -listen-client-urls http://0.0.0.0:2379,http://0.0.0.0:4001 -initial-advertise-peer-urls http://etcd:2380 -listen-peer-urls http://0.0.0.0:2380  -initial-cluster etcd0=http://etcd:2380 -initial-cluster-state new

sudo docker service create --name astaire  --constraint 'node.labels.comp==astaire' --mode=global --network clearwater_nw  -e ADDITIONAL_SHARED_CONFIG  -p 22 clearwater/astaire

sudo docker service create --name cassandra  --constraint 'node.labels.comp==cassandra' --mode=global --network clearwater_nw  -e ADDITIONAL_SHARED_CONFIG  -p 22  clearwater/cassandra

sudo docker service create --name chronos  --constraint 'node.labels.comp==chronos' --mode=global --network clearwater_nw  -e ADDITIONAL_SHARED_CONFIG  -p 22 clearwater/chronos

sudo docker service create --name homestead  --constraint 'node.labels.comp==homestead' --mode=global --network clearwater_nw  -e ADDITIONAL_SHARED_CONFIG -p 22 clearwater/homestead

sudo docker service create --name homestead-prov  --constraint 'node.labels.comp==homesteadprov' --mode=global --network clearwater_nw   -e ADDITIONAL_SHARED_CONFIG   -p 22 clearwater/homestead-prov

sudo docker service create --name homer  --constraint 'node.labels.comp==homer' --mode=global --network clearwater_nw   -e ADDITIONAL_SHARED_CONFIG  -p 22 clearwater/homer

sudo docker service create --name ralf  --constraint 'node.labels.comp==ralf' --mode=global --network clearwater_nw  -e ADDITIONAL_SHARED_CONFIG   -p 22 clearwater/ralf

sudo docker service create --name sprout  --constraint 'node.labels.comp==sprout'  --network name=clearwater_nw,alias=scscf.sprout,alias=icscf.sprout --mode=global -e ADDITIONAL_SHARED_CONFIG  -p 22 clearwater/sprout

sudo docker service create --name bono   --constraint 'node.labels.comp==bono' --mode=global --env-file .env --network clearwater_nw -e ADDITIONAL_SHARED_CONFIG -p 22 -p 3478:3478 -p 3478:3478/udp -p 5060:5060 -p 5060:5060/udp -p 5062:5062 clearwater/bono

sudo docker service create --name ellis  --constraint 'node.labels.comp==ellis' --mode=globtachableal --network clearwater_nw -e ADDITIONAL_SHARED_CONFIG  -p 22 -p 80:80 clearwater/ellis

After that, when I enter inside the container, services of ellis, bono, sprout, and others are not started, so no logs are available.



Environment:

- I am using Openstack instances with ubuntu 16.04 (kernel version 4.10.0.28).
- Clearwater docker project stable (also tried with latest and some older images available on docker hub)
- Docker version 17.09.0-ce


Steps (on a single machines):
The commands are same as above, but no constraints and mode(by default replicated) are used.


I tested Clearwater project without swarm on a single machine, and it's working fine and clearwater live tests are passing.


My question is: Has the clearwater tested with Docker swarm? OR does it work with swarm for someone? OR am I doing something wrong?



Please let me know if you need further clarifications from me.



Thanks a lot!


Best Regards,
Muhammad Imran









-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20171207/64129a76/attachment.html>

From case at gci.com  Fri Dec  8 15:14:13 2017
From: case at gci.com (Roger Case)
Date: Fri, 8 Dec 2017 20:14:13 +0000
Subject: [Project Clearwater] Bono Send Invite using TCP, Header Reduction
Message-ID: <A7E1158244C52C428F0B61BDC9CF760C016D83B340@ex-mbx-prd02.gci.com>

Dear Clearwater,

The PacketCable 2.0 eDVA UE endpoints I am using will not send responses to Invites if the response is greater than 1300 bytes, and it wants to respond using UDP.  Is there a way to get Bono to send the Invite to the UE using TCP?  These devices should then respond using TCP.

Also, the Bono P-CSCF includes all Record Route and Via headers for the call.  Is there a way to reduce the number of headers sent to the UE, making the Invite smaller?  Can Bono do a bit of topology hiding, to accomplish this?

Thanks very much.

Roger Case
GCI Alaska
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20171208/c543dc67/attachment.html>

From akedar at TechMahindra.com  Tue Dec 12 08:45:49 2017
From: akedar at TechMahindra.com (Kedar Ambekar)
Date: Tue, 12 Dec 2017 13:45:49 +0000
Subject: [Project Clearwater] 502 Bad Gateway and other errors while running
 live tests
Message-ID: <PN1PR0101MB1565F6502AF8CA8FE9E3E06CA3340@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>

Hi,

I have installed Clearwater with heat templates (available on ONAP wiki) directly on openstack. Appreciate help on below issues.


1.       When I run Clearwater live tests, all tests fail with below  error.



RuntimeError thrown:

   - Account creation failed with HTTP code 502, body {"status": 502, "message": "Bad Gateway", "reason": "Upstream request failed", "detail": {"Upstream error": "599", "Upstream URL": "None"}, "error": true}



2.       ps for bono process shows this.



[bono]ubuntu at 0:/etc/clearwater$ ps -ef |grep bono

bono 6897 1 0 05:06 ? 00:00:11 /usr/share/clearwater/bin/bono --domain= --localhost=10.0.0.28,0.bono.me.cw-ngv.com --al ias=10.0.0.28,0.bono.me.cw-ngv.com, --pcscf=5060,5058 --webrtc-port=5062 --routing-proxy=icscf.,5052,50,600 --sas=0.0.0.0,bono at 0.bono.me.cw-ngv.com --dns-server=127.0.0.1 --worker-threads=2 --analytics=/var/log/bono --log-file=/var/log/bono --log-level=2 --daemon --pidfile=/var/run/bono/bono.pid



3.       In bono, I saw these logs.

 UTC Error sip_connection_pool.cpp:190: Failed to resolve icscf. to an IP address - Not found (PJ_ENOTFOUND)

UTC Warning dnscachedresolver.cpp:828: Failed to retrieve record for icscf.: Domain name not found



4.       To debug above issues, I ended up making these changes in /etc/init.d/bono and restarted bono service.



DAEMON_ARGS="--domain=me.cw-ngv.com  (instead of -domain=$home_domain)

upstream_hostname=icscf.sprout.me.cw-ngv.com (instead of upstream_hostname=icscf.$sprout_hostname)


5.       But now, I get below error in bono. Port 5052 is not in listen mode on sprout.

UTC Warning pjsip: tcpc0x7f90cc07 TCP connect() error: Connection refused [code=120111]
UTC Warning pjsip: tcpc0x7f90cc07 Unable to connect to <sprout ip>:5052
============================================================================================================================

Disclaimer:  This message and the information contained herein is proprietary and confidential and subject to the Tech Mahindra policy statement, you may review the policy at http://www.techmahindra.com/Disclaimer.html <http://www.techmahindra.com/Disclaimer.html> externally http://tim.techmahindra.com/tim/disclaimer.html <http://tim.techmahindra.com/tim/disclaimer.html> internally within TechMahindra.

============================================================================================================================
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20171212/98df0d10/attachment.html>

From Adam.Lindley at metaswitch.com  Tue Dec 12 11:41:12 2017
From: Adam.Lindley at metaswitch.com (Adam Lindley)
Date: Tue, 12 Dec 2017 16:41:12 +0000
Subject: [Project Clearwater] 502 Bad Gateway and other errors while
 running live tests
In-Reply-To: <PN1PR0101MB1565F6502AF8CA8FE9E3E06CA3340@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
References: <PN1PR0101MB1565F6502AF8CA8FE9E3E06CA3340@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
Message-ID: <BY2PR02MB20378C8381AD633827882732E2340@BY2PR02MB2037.namprd02.prod.outlook.com>

Hi Kedar,

I've just had a look around for the templates on the ONAP wiki; I wasn't aware they had their own copies of them.
I found https://wiki.onap.org/display/DW/Clearwater+vIMS+Onboarding+and+Instantiation . Is this what you've been working from?

When deploying with the templates, have you been specifying a "repo_url" option in the arguments? The Clearwater HEAT templates included steps to install the Clearwater packages from our public stable repo by default, but the templates on the ONAP wiki are now somewhat out of date. If you haven't specified a repo containing packages from the same point in time the templates were effectively forked, you're going to be hitting conflicts between the code version, and the orchestration steps.

I am not sure what differences there need to be for templates to run on ONAP, but I can point you towards our current set of heat templates: https://github.com/Metaswitch/clearwater-heat/tree/stable . I would suggest you try redeploying with these templates, as a fair number of things have changed in the code since the templates on the wiki were valid. If you hit any issues, do let us know.

Cheers,
Adam


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: 12 December 2017 13:46
To: clearwater at lists.projectclearwater.org
Subject: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

I have installed Clearwater with heat templates (available on ONAP wiki) directly on openstack. Appreciate help on below issues.


  1.  When I run Clearwater live tests, all tests fail with below  error.



RuntimeError thrown:

   - Account creation failed with HTTP code 502, body {"status": 502, "message": "Bad Gateway", "reason": "Upstream request failed", "detail": {"Upstream error": "599", "Upstream URL": "None"}, "error": true}



  1.  ps for bono process shows this.



[bono]ubuntu at 0:/etc/clearwater$ ps -ef |grep bono

bono 6897 1 0 05:06 ? 00:00:11 /usr/share/clearwater/bin/bono --domain= --localhost=10.0.0.28,0.bono.me.cw-ngv.com --al ias=10.0.0.28,0.bono.me.cw-ngv.com, --pcscf=5060,5058 --webrtc-port=5062 --routing-proxy=icscf.,5052,50,600 --sas=0.0.0.0,bono at 0.bono.me.cw-ngv.com --dns-server=127.0.0.1 --worker-threads=2 --analytics=/var/log/bono --log-file=/var/log/bono --log-level=2 --daemon --pidfile=/var/run/bono/bono.pid



  1.  In bono, I saw these logs.

 UTC Error sip_connection_pool.cpp:190: Failed to resolve icscf. to an IP address - Not found (PJ_ENOTFOUND)

UTC Warning dnscachedresolver.cpp:828: Failed to retrieve record for icscf.: Domain name not found



  1.  To debug above issues, I ended up making these changes in /etc/init.d/bono and restarted bono service.



DAEMON_ARGS="--domain=me.cw-ngv.com  (instead of -domain=$home_domain)

upstream_hostname=icscf.sprout.me.cw-ngv.com (instead of upstream_hostname=icscf.$sprout_hostname)


  1.  But now, I get below error in bono. Port 5052 is not in listen mode on sprout.

UTC Warning pjsip: tcpc0x7f90cc07 TCP connect() error: Connection refused [code=120111]
UTC Warning pjsip: tcpc0x7f90cc07 Unable to connect to <sprout ip>:5052
============================================================================================================================
Disclaimer:  This message and the information contained herein is proprietary and confidential and subject to the Tech Mahindra policy statement, you may review the policy at http://www.techmahindra.com/Disclaimer.html externally http://tim.techmahindra.com/tim/disclaimer.html internally within TechMahindra.
============================================================================================================================
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20171212/7fbc5fe4/attachment.html>

From mike at metaswitch.com  Tue Dec 12 11:59:59 2017
From: mike at metaswitch.com (Mike Evans)
Date: Tue, 12 Dec 2017 16:59:59 +0000
Subject: [Project Clearwater] 502 Bad Gateway and other errors while
 running live tests
In-Reply-To: <BY2PR02MB20378C8381AD633827882732E2340@BY2PR02MB2037.namprd02.prod.outlook.com>
References: <PN1PR0101MB1565F6502AF8CA8FE9E3E06CA3340@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<BY2PR02MB20378C8381AD633827882732E2340@BY2PR02MB2037.namprd02.prod.outlook.com>
Message-ID: <BLUPR0201MB1889B9B407D22938B59ED116B0340@BLUPR0201MB1889.namprd02.prod.outlook.com>

Adam

I put the ONAP templates together, so I'm happy to update them if they won't work with the latest Project Clearwater code.  Is there anywhere I can look for an explanation of the changes?

Mike

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Adam Lindley
Sent: 12 December 2017 16:41
To: clearwater at lists.projectclearwater.org
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Kedar,

I've just had a look around for the templates on the ONAP wiki; I wasn't aware they had their own copies of them.
I found https://wiki.onap.org/display/DW/Clearwater+vIMS+Onboarding+and+Instantiation . Is this what you've been working from?

When deploying with the templates, have you been specifying a "repo_url" option in the arguments? The Clearwater HEAT templates included steps to install the Clearwater packages from our public stable repo by default, but the templates on the ONAP wiki are now somewhat out of date. If you haven't specified a repo containing packages from the same point in time the templates were effectively forked, you're going to be hitting conflicts between the code version, and the orchestration steps.

I am not sure what differences there need to be for templates to run on ONAP, but I can point you towards our current set of heat templates: https://github.com/Metaswitch/clearwater-heat/tree/stable . I would suggest you try redeploying with these templates, as a fair number of things have changed in the code since the templates on the wiki were valid. If you hit any issues, do let us know.

Cheers,
Adam


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: 12 December 2017 13:46
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

I have installed Clearwater with heat templates (available on ONAP wiki) directly on openstack. Appreciate help on below issues.


  1.  When I run Clearwater live tests, all tests fail with below  error.



RuntimeError thrown:

   - Account creation failed with HTTP code 502, body {"status": 502, "message": "Bad Gateway", "reason": "Upstream request failed", "detail": {"Upstream error": "599", "Upstream URL": "None"}, "error": true}



  1.  ps for bono process shows this.



[bono]ubuntu at 0:/etc/clearwater$ ps -ef |grep bono

bono 6897 1 0 05:06 ? 00:00:11 /usr/share/clearwater/bin/bono --domain= --localhost=10.0.0.28,0.bono.me.cw-ngv.com --al ias=10.0.0.28,0.bono.me.cw-ngv.com, --pcscf=5060,5058 --webrtc-port=5062 --routing-proxy=icscf.,5052,50,600 --sas=0.0.0.0,bono at 0.bono.me.cw-ngv.com --dns-server=127.0.0.1 --worker-threads=2 --analytics=/var/log/bono --log-file=/var/log/bono --log-level=2 --daemon --pidfile=/var/run/bono/bono.pid



  1.  In bono, I saw these logs.

 UTC Error sip_connection_pool.cpp:190: Failed to resolve icscf. to an IP address - Not found (PJ_ENOTFOUND)

UTC Warning dnscachedresolver.cpp:828: Failed to retrieve record for icscf.: Domain name not found



  1.  To debug above issues, I ended up making these changes in /etc/init.d/bono and restarted bono service.



DAEMON_ARGS="--domain=me.cw-ngv.com  (instead of -domain=$home_domain)

upstream_hostname=icscf.sprout.me.cw-ngv.com (instead of upstream_hostname=icscf.$sprout_hostname)


  1.  But now, I get below error in bono. Port 5052 is not in listen mode on sprout.

UTC Warning pjsip: tcpc0x7f90cc07 TCP connect() error: Connection refused [code=120111]
UTC Warning pjsip: tcpc0x7f90cc07 Unable to connect to <sprout ip>:5052
============================================================================================================================
Disclaimer:  This message and the information contained herein is proprietary and confidential and subject to the Tech Mahindra policy statement, you may review the policy at http://www.techmahindra.com/Disclaimer.html externally http://tim.techmahindra.com/tim/disclaimer.html internally within TechMahindra.
============================================================================================================================
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20171212/550ea278/attachment.html>

From Adam.Lindley at metaswitch.com  Tue Dec 12 12:19:56 2017
From: Adam.Lindley at metaswitch.com (Adam Lindley)
Date: Tue, 12 Dec 2017 17:19:56 +0000
Subject: [Project Clearwater] 502 Bad Gateway and other errors while
 running live tests
In-Reply-To: <BLUPR0201MB1889B9B407D22938B59ED116B0340@BLUPR0201MB1889.namprd02.prod.outlook.com>
References: <PN1PR0101MB1565F6502AF8CA8FE9E3E06CA3340@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<BY2PR02MB20378C8381AD633827882732E2340@BY2PR02MB2037.namprd02.prod.outlook.com>
	<BLUPR0201MB1889B9B407D22938B59ED116B0340@BLUPR0201MB1889.namprd02.prod.outlook.com>
Message-ID: <BY2PR02MB2037FFD49230C6B498B0D35EE2340@BY2PR02MB2037.namprd02.prod.outlook.com>

Do you know which release you based the templates on?
We should be able to take a look over our release notes between then and now, which should give a reasonable view of the changes, and then we can go from there. Equally, the commit history (https://github.com/Metaswitch/clearwater-heat/commits/stable) gives a fairly clear overview of what and why, with the pull requests adding a bit more detail.

Though as we're likely to hit similar problems in future as we continue to develop Project Clearwater and our heat templates. Are the ONAP changes something we could be pulling in to the main code base? I'd be interested to know the extent of the work needed to keep them running

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Mike Evans
Sent: 12 December 2017 17:00
To: clearwater at lists.projectclearwater.org
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Adam

I put the ONAP templates together, so I'm happy to update them if they won't work with the latest Project Clearwater code.  Is there anywhere I can look for an explanation of the changes?

Mike

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Adam Lindley
Sent: 12 December 2017 16:41
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Kedar,

I've just had a look around for the templates on the ONAP wiki; I wasn't aware they had their own copies of them.
I found https://wiki.onap.org/display/DW/Clearwater+vIMS+Onboarding+and+Instantiation . Is this what you've been working from?

When deploying with the templates, have you been specifying a "repo_url" option in the arguments? The Clearwater HEAT templates included steps to install the Clearwater packages from our public stable repo by default, but the templates on the ONAP wiki are now somewhat out of date. If you haven't specified a repo containing packages from the same point in time the templates were effectively forked, you're going to be hitting conflicts between the code version, and the orchestration steps.

I am not sure what differences there need to be for templates to run on ONAP, but I can point you towards our current set of heat templates: https://github.com/Metaswitch/clearwater-heat/tree/stable . I would suggest you try redeploying with these templates, as a fair number of things have changed in the code since the templates on the wiki were valid. If you hit any issues, do let us know.

Cheers,
Adam


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: 12 December 2017 13:46
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

I have installed Clearwater with heat templates (available on ONAP wiki) directly on openstack. Appreciate help on below issues.


  1.  When I run Clearwater live tests, all tests fail with below  error.



RuntimeError thrown:

   - Account creation failed with HTTP code 502, body {"status": 502, "message": "Bad Gateway", "reason": "Upstream request failed", "detail": {"Upstream error": "599", "Upstream URL": "None"}, "error": true}



  1.  ps for bono process shows this.



[bono]ubuntu at 0:/etc/clearwater$ ps -ef |grep bono

bono 6897 1 0 05:06 ? 00:00:11 /usr/share/clearwater/bin/bono --domain= --localhost=10.0.0.28,0.bono.me.cw-ngv.com --al ias=10.0.0.28,0.bono.me.cw-ngv.com, --pcscf=5060,5058 --webrtc-port=5062 --routing-proxy=icscf.,5052,50,600 --sas=0.0.0.0,bono at 0.bono.me.cw-ngv.com --dns-server=127.0.0.1 --worker-threads=2 --analytics=/var/log/bono --log-file=/var/log/bono --log-level=2 --daemon --pidfile=/var/run/bono/bono.pid



  1.  In bono, I saw these logs.

 UTC Error sip_connection_pool.cpp:190: Failed to resolve icscf. to an IP address - Not found (PJ_ENOTFOUND)

UTC Warning dnscachedresolver.cpp:828: Failed to retrieve record for icscf.: Domain name not found



  1.  To debug above issues, I ended up making these changes in /etc/init.d/bono and restarted bono service.



DAEMON_ARGS="--domain=me.cw-ngv.com  (instead of -domain=$home_domain)

upstream_hostname=icscf.sprout.me.cw-ngv.com (instead of upstream_hostname=icscf.$sprout_hostname)


  1.  But now, I get below error in bono. Port 5052 is not in listen mode on sprout.

UTC Warning pjsip: tcpc0x7f90cc07 TCP connect() error: Connection refused [code=120111]
UTC Warning pjsip: tcpc0x7f90cc07 Unable to connect to <sprout ip>:5052
============================================================================================================================
Disclaimer:  This message and the information contained herein is proprietary and confidential and subject to the Tech Mahindra policy statement, you may review the policy at http://www.techmahindra.com/Disclaimer.html externally http://tim.techmahindra.com/tim/disclaimer.html internally within TechMahindra.
============================================================================================================================
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20171212/5693a567/attachment.html>

From akedar at TechMahindra.com  Wed Dec 13 01:07:20 2017
From: akedar at TechMahindra.com (Kedar Ambekar)
Date: Wed, 13 Dec 2017 06:07:20 +0000
Subject: [Project Clearwater] 502 Bad Gateway and other errors while
 running live tests
In-Reply-To: <BY2PR02MB2037FFD49230C6B498B0D35EE2340@BY2PR02MB2037.namprd02.prod.outlook.com>
References: <PN1PR0101MB1565F6502AF8CA8FE9E3E06CA3340@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<BY2PR02MB20378C8381AD633827882732E2340@BY2PR02MB2037.namprd02.prod.outlook.com>
	<BLUPR0201MB1889B9B407D22938B59ED116B0340@BLUPR0201MB1889.namprd02.prod.outlook.com>
	<BY2PR02MB2037FFD49230C6B498B0D35EE2340@BY2PR02MB2037.namprd02.prod.outlook.com>
Message-ID: <PN1PR0101MB156515BD66752ACFB3BCD909A3350@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>

Hi Adam,

Got the point. I had suspected the same.
I have repo_url http://repo.cw-ngv.com/stable in heat's env file.

Is it possible to use same release on which ONAP's heat templates are based, may be by changing this repo URL?

I will have a look at current heat template on Clearwater GitHub but I think those won't be ONAP compatible.

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Adam Lindley
Sent: Tuesday, December 12, 2017 10:50 PM
To: clearwater at lists.projectclearwater.org
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Do you know which release you based the templates on?
We should be able to take a look over our release notes between then and now, which should give a reasonable view of the changes, and then we can go from there. Equally, the commit history (https://github.com/Metaswitch/clearwater-heat/commits/stable) gives a fairly clear overview of what and why, with the pull requests adding a bit more detail.

Though as we're likely to hit similar problems in future as we continue to develop Project Clearwater and our heat templates. Are the ONAP changes something we could be pulling in to the main code base? I'd be interested to know the extent of the work needed to keep them running

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Mike Evans
Sent: 12 December 2017 17:00
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Adam

I put the ONAP templates together, so I'm happy to update them if they won't work with the latest Project Clearwater code.  Is there anywhere I can look for an explanation of the changes?

Mike

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Adam Lindley
Sent: 12 December 2017 16:41
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Kedar,

I've just had a look around for the templates on the ONAP wiki; I wasn't aware they had their own copies of them.
I found https://wiki.onap.org/display/DW/Clearwater+vIMS+Onboarding+and+Instantiation . Is this what you've been working from?

When deploying with the templates, have you been specifying a "repo_url" option in the arguments? The Clearwater HEAT templates included steps to install the Clearwater packages from our public stable repo by default, but the templates on the ONAP wiki are now somewhat out of date. If you haven't specified a repo containing packages from the same point in time the templates were effectively forked, you're going to be hitting conflicts between the code version, and the orchestration steps.

I am not sure what differences there need to be for templates to run on ONAP, but I can point you towards our current set of heat templates: https://github.com/Metaswitch/clearwater-heat/tree/stable . I would suggest you try redeploying with these templates, as a fair number of things have changed in the code since the templates on the wiki were valid. If you hit any issues, do let us know.

Cheers,
Adam


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: 12 December 2017 13:46
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

I have installed Clearwater with heat templates (available on ONAP wiki) directly on openstack. Appreciate help on below issues.


  1.  When I run Clearwater live tests, all tests fail with below  error.



RuntimeError thrown:

   - Account creation failed with HTTP code 502, body {"status": 502, "message": "Bad Gateway", "reason": "Upstream request failed", "detail": {"Upstream error": "599", "Upstream URL": "None"}, "error": true}



  1.  ps for bono process shows this.



[bono]ubuntu at 0:/etc/clearwater$ ps -ef |grep bono

bono 6897 1 0 05:06 ? 00:00:11 /usr/share/clearwater/bin/bono --domain= --localhost=10.0.0.28,0.bono.me.cw-ngv.com --al ias=10.0.0.28,0.bono.me.cw-ngv.com, --pcscf=5060,5058 --webrtc-port=5062 --routing-proxy=icscf.,5052,50,600 --sas=0.0.0.0,bono at 0.bono.me.cw-ngv.com --dns-server=127.0.0.1 --worker-threads=2 --analytics=/var/log/bono --log-file=/var/log/bono --log-level=2 --daemon --pidfile=/var/run/bono/bono.pid



  1.  In bono, I saw these logs.

 UTC Error sip_connection_pool.cpp:190: Failed to resolve icscf. to an IP address - Not found (PJ_ENOTFOUND)

UTC Warning dnscachedresolver.cpp:828: Failed to retrieve record for icscf.: Domain name not found



  1.  To debug above issues, I ended up making these changes in /etc/init.d/bono and restarted bono service.



DAEMON_ARGS="--domain=me.cw-ngv.com  (instead of -domain=$home_domain)

upstream_hostname=icscf.sprout.me.cw-ngv.com (instead of upstream_hostname=icscf.$sprout_hostname)


  1.  But now, I get below error in bono. Port 5052 is not in listen mode on sprout.

UTC Warning pjsip: tcpc0x7f90cc07 TCP connect() error: Connection refused [code=120111]
UTC Warning pjsip: tcpc0x7f90cc07 Unable to connect to <sprout ip>:5052
============================================================================================================================
Disclaimer:  This message and the information contained herein is proprietary and confidential and subject to the Tech Mahindra policy statement, you may review the policy at http://www.techmahindra.com/Disclaimer.html externally http://tim.techmahindra.com/tim/disclaimer.html internally within TechMahindra.
============================================================================================================================
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20171213/2a8b226f/attachment.html>

From akedar at TechMahindra.com  Wed Dec 13 01:59:31 2017
From: akedar at TechMahindra.com (Kedar Ambekar)
Date: Wed, 13 Dec 2017 06:59:31 +0000
Subject: [Project Clearwater] 502 Bad Gateway and other errors while
 running live tests
References: <PN1PR0101MB1565F6502AF8CA8FE9E3E06CA3340@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<BY2PR02MB20378C8381AD633827882732E2340@BY2PR02MB2037.namprd02.prod.outlook.com>
	<BLUPR0201MB1889B9B407D22938B59ED116B0340@BLUPR0201MB1889.namprd02.prod.outlook.com>
	<BY2PR02MB2037FFD49230C6B498B0D35EE2340@BY2PR02MB2037.namprd02.prod.outlook.com>
Message-ID: <PN1PR0101MB15651EE3174A2D040BB3AC5AA3350@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>

Hi Adam, Mike,

Clearwater heat templates on ONAP wiki are put around July 13. Clearwater release 127, which is released on May 30th , seems to have been used for testing these templates.

If I want to give a try with release 127 installation via heat, how to do that ? I tried URL http://repo.cw-ngv.com/release-127/binary/Packages in browser, but got 404.

From: Kedar Ambekar
Sent: Wednesday, December 13, 2017 11:37 AM
To: clearwater at lists.projectclearwater.org
Subject: RE: 502 Bad Gateway and other errors while running live tests

Hi Adam,

Got the point. I had suspected the same.
I have repo_url http://repo.cw-ngv.com/stable in heat's env file.

Is it possible to use same release on which ONAP's heat templates are based, may be by changing this repo URL?

I will have a look at current heat template on Clearwater GitHub but I think those won't be ONAP compatible.

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Adam Lindley
Sent: Tuesday, December 12, 2017 10:50 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Do you know which release you based the templates on?
We should be able to take a look over our release notes between then and now, which should give a reasonable view of the changes, and then we can go from there. Equally, the commit history (https://github.com/Metaswitch/clearwater-heat/commits/stable) gives a fairly clear overview of what and why, with the pull requests adding a bit more detail.

Though as we're likely to hit similar problems in future as we continue to develop Project Clearwater and our heat templates. Are the ONAP changes something we could be pulling in to the main code base? I'd be interested to know the extent of the work needed to keep them running

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Mike Evans
Sent: 12 December 2017 17:00
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Adam

I put the ONAP templates together, so I'm happy to update them if they won't work with the latest Project Clearwater code.  Is there anywhere I can look for an explanation of the changes?

Mike

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Adam Lindley
Sent: 12 December 2017 16:41
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Kedar,

I've just had a look around for the templates on the ONAP wiki; I wasn't aware they had their own copies of them.
I found https://wiki.onap.org/display/DW/Clearwater+vIMS+Onboarding+and+Instantiation . Is this what you've been working from?

When deploying with the templates, have you been specifying a "repo_url" option in the arguments? The Clearwater HEAT templates included steps to install the Clearwater packages from our public stable repo by default, but the templates on the ONAP wiki are now somewhat out of date. If you haven't specified a repo containing packages from the same point in time the templates were effectively forked, you're going to be hitting conflicts between the code version, and the orchestration steps.

I am not sure what differences there need to be for templates to run on ONAP, but I can point you towards our current set of heat templates: https://github.com/Metaswitch/clearwater-heat/tree/stable . I would suggest you try redeploying with these templates, as a fair number of things have changed in the code since the templates on the wiki were valid. If you hit any issues, do let us know.

Cheers,
Adam


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: 12 December 2017 13:46
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

I have installed Clearwater with heat templates (available on ONAP wiki) directly on openstack. Appreciate help on below issues.


  1.  When I run Clearwater live tests, all tests fail with below  error.



RuntimeError thrown:

   - Account creation failed with HTTP code 502, body {"status": 502, "message": "Bad Gateway", "reason": "Upstream request failed", "detail": {"Upstream error": "599", "Upstream URL": "None"}, "error": true}



  1.  ps for bono process shows this.



[bono]ubuntu at 0:/etc/clearwater$ ps -ef |grep bono

bono 6897 1 0 05:06 ? 00:00:11 /usr/share/clearwater/bin/bono --domain= --localhost=10.0.0.28,0.bono.me.cw-ngv.com --al ias=10.0.0.28,0.bono.me.cw-ngv.com, --pcscf=5060,5058 --webrtc-port=5062 --routing-proxy=icscf.,5052,50,600 --sas=0.0.0.0,bono at 0.bono.me.cw-ngv.com --dns-server=127.0.0.1 --worker-threads=2 --analytics=/var/log/bono --log-file=/var/log/bono --log-level=2 --daemon --pidfile=/var/run/bono/bono.pid



  1.  In bono, I saw these logs.

 UTC Error sip_connection_pool.cpp:190: Failed to resolve icscf. to an IP address - Not found (PJ_ENOTFOUND)

UTC Warning dnscachedresolver.cpp:828: Failed to retrieve record for icscf.: Domain name not found



  1.  To debug above issues, I ended up making these changes in /etc/init.d/bono and restarted bono service.



DAEMON_ARGS="--domain=me.cw-ngv.com  (instead of -domain=$home_domain)

upstream_hostname=icscf.sprout.me.cw-ngv.com (instead of upstream_hostname=icscf.$sprout_hostname)


  1.  But now, I get below error in bono. Port 5052 is not in listen mode on sprout.

UTC Warning pjsip: tcpc0x7f90cc07 TCP connect() error: Connection refused [code=120111]
UTC Warning pjsip: tcpc0x7f90cc07 Unable to connect to <sprout ip>:5052
============================================================================================================================
Disclaimer:  This message and the information contained herein is proprietary and confidential and subject to the Tech Mahindra policy statement, you may review the policy at http://www.techmahindra.com/Disclaimer.html externally http://tim.techmahindra.com/tim/disclaimer.html internally within TechMahindra.
============================================================================================================================
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20171213/c8a5dfa3/attachment.html>

From Ying.Huang at metaswitch.com  Wed Dec 13 13:45:42 2017
From: Ying.Huang at metaswitch.com (Ying Huang)
Date: Wed, 13 Dec 2017 18:45:42 +0000
Subject: [Project Clearwater] Bono Send Invite using TCP,
 Header Reduction
In-Reply-To: <A7E1158244C52C428F0B61BDC9CF760C016D83B340@ex-mbx-prd02.gci.com>
References: <A7E1158244C52C428F0B61BDC9CF760C016D83B340@ex-mbx-prd02.gci.com>
Message-ID: <DM5PR0201MB3623D60EE643F36F30B2EA16F8350@DM5PR0201MB3623.namprd02.prod.outlook.com>

Hi Roger,

Bono would be forwarding the message as how the message is. So if the client registered as TCP, Bono would be forwarding TCP messages.

As for topology hiding, no Bono doesn't do it.

Thanks,
Ying

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Roger Case
Sent: 08 December 2017 20:14
To: clearwater at lists.projectclearwater.org
Subject: [Project Clearwater] Bono Send Invite using TCP, Header Reduction

Dear Clearwater,

The PacketCable 2.0 eDVA UE endpoints I am using will not send responses to Invites if the response is greater than 1300 bytes, and it wants to respond using UDP.  Is there a way to get Bono to send the Invite to the UE using TCP?  These devices should then respond using TCP.

Also, the Bono P-CSCF includes all Record Route and Via headers for the call.  Is there a way to reduce the number of headers sent to the UE, making the Invite smaller?  Can Bono do a bit of topology hiding, to accomplish this?

Thanks very much.

Roger Case
GCI Alaska
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20171213/2db822aa/attachment.html>

From akedar at TechMahindra.com  Thu Dec 14 01:59:15 2017
From: akedar at TechMahindra.com (Kedar Ambekar)
Date: Thu, 14 Dec 2017 06:59:15 +0000
Subject: [Project Clearwater] 502 Bad Gateway and other errors while
 running live tests
In-Reply-To: <PN1PR0101MB15651EE3174A2D040BB3AC5AA3350@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
References: <PN1PR0101MB1565F6502AF8CA8FE9E3E06CA3340@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<BY2PR02MB20378C8381AD633827882732E2340@BY2PR02MB2037.namprd02.prod.outlook.com>
	<BLUPR0201MB1889B9B407D22938B59ED116B0340@BLUPR0201MB1889.namprd02.prod.outlook.com>
	<BY2PR02MB2037FFD49230C6B498B0D35EE2340@BY2PR02MB2037.namprd02.prod.outlook.com>
	<PN1PR0101MB15651EE3174A2D040BB3AC5AA3350@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
Message-ID: <PN1PR0101MB1565488BBCA00EE6E02B441FA30A0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>

Hi,

I gave a try with release 127 ( repo URL  http://repo.cw-ngv.com/archive/repo127 in env file). But issues seem to be very same.


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Wednesday, December 13, 2017 12:30 PM
To: clearwater at lists.projectclearwater.org
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Adam, Mike,

Clearwater heat templates on ONAP wiki are put around July 13. Clearwater release 127, which is released on May 30th , seems to have been used for testing these templates.

If I want to give a try with release 127 installation via heat, how to do that ? I tried URL http://repo.cw-ngv.com/release-127/binary/Packages in browser, but got 404.

From: Kedar Ambekar
Sent: Wednesday, December 13, 2017 11:37 AM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: RE: 502 Bad Gateway and other errors while running live tests

Hi Adam,

Got the point. I had suspected the same.
I have repo_url http://repo.cw-ngv.com/stable in heat's env file.

Is it possible to use same release on which ONAP's heat templates are based, may be by changing this repo URL?

I will have a look at current heat template on Clearwater GitHub but I think those won't be ONAP compatible.

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Adam Lindley
Sent: Tuesday, December 12, 2017 10:50 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Do you know which release you based the templates on?
We should be able to take a look over our release notes between then and now, which should give a reasonable view of the changes, and then we can go from there. Equally, the commit history (https://github.com/Metaswitch/clearwater-heat/commits/stable) gives a fairly clear overview of what and why, with the pull requests adding a bit more detail.

Though as we're likely to hit similar problems in future as we continue to develop Project Clearwater and our heat templates. Are the ONAP changes something we could be pulling in to the main code base? I'd be interested to know the extent of the work needed to keep them running

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Mike Evans
Sent: 12 December 2017 17:00
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Adam

I put the ONAP templates together, so I'm happy to update them if they won't work with the latest Project Clearwater code.  Is there anywhere I can look for an explanation of the changes?

Mike

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Adam Lindley
Sent: 12 December 2017 16:41
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Kedar,

I've just had a look around for the templates on the ONAP wiki; I wasn't aware they had their own copies of them.
I found https://wiki.onap.org/display/DW/Clearwater+vIMS+Onboarding+and+Instantiation . Is this what you've been working from?

When deploying with the templates, have you been specifying a "repo_url" option in the arguments? The Clearwater HEAT templates included steps to install the Clearwater packages from our public stable repo by default, but the templates on the ONAP wiki are now somewhat out of date. If you haven't specified a repo containing packages from the same point in time the templates were effectively forked, you're going to be hitting conflicts between the code version, and the orchestration steps.

I am not sure what differences there need to be for templates to run on ONAP, but I can point you towards our current set of heat templates: https://github.com/Metaswitch/clearwater-heat/tree/stable . I would suggest you try redeploying with these templates, as a fair number of things have changed in the code since the templates on the wiki were valid. If you hit any issues, do let us know.

Cheers,
Adam


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: 12 December 2017 13:46
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

I have installed Clearwater with heat templates (available on ONAP wiki) directly on openstack. Appreciate help on below issues.


  1.  When I run Clearwater live tests, all tests fail with below  error.



RuntimeError thrown:

   - Account creation failed with HTTP code 502, body {"status": 502, "message": "Bad Gateway", "reason": "Upstream request failed", "detail": {"Upstream error": "599", "Upstream URL": "None"}, "error": true}



  1.  ps for bono process shows this.



[bono]ubuntu at 0:/etc/clearwater$ ps -ef |grep bono

bono 6897 1 0 05:06 ? 00:00:11 /usr/share/clearwater/bin/bono --domain= --localhost=10.0.0.28,0.bono.me.cw-ngv.com --al ias=10.0.0.28,0.bono.me.cw-ngv.com, --pcscf=5060,5058 --webrtc-port=5062 --routing-proxy=icscf.,5052,50,600 --sas=0.0.0.0,bono at 0.bono.me.cw-ngv.com --dns-server=127.0.0.1 --worker-threads=2 --analytics=/var/log/bono --log-file=/var/log/bono --log-level=2 --daemon --pidfile=/var/run/bono/bono.pid



  1.  In bono, I saw these logs.

 UTC Error sip_connection_pool.cpp:190: Failed to resolve icscf. to an IP address - Not found (PJ_ENOTFOUND)

UTC Warning dnscachedresolver.cpp:828: Failed to retrieve record for icscf.: Domain name not found



  1.  To debug above issues, I ended up making these changes in /etc/init.d/bono and restarted bono service.



DAEMON_ARGS="--domain=me.cw-ngv.com  (instead of -domain=$home_domain)

upstream_hostname=icscf.sprout.me.cw-ngv.com (instead of upstream_hostname=icscf.$sprout_hostname)


  1.  But now, I get below error in bono. Port 5052 is not in listen mode on sprout.

UTC Warning pjsip: tcpc0x7f90cc07 TCP connect() error: Connection refused [code=120111]
UTC Warning pjsip: tcpc0x7f90cc07 Unable to connect to <sprout ip>:5052
============================================================================================================================
Disclaimer:  This message and the information contained herein is proprietary and confidential and subject to the Tech Mahindra policy statement, you may review the policy at http://www.techmahindra.com/Disclaimer.html externally http://tim.techmahindra.com/tim/disclaimer.html internally within TechMahindra.
============================================================================================================================
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20171214/21f1627f/attachment.html>

From akedar at TechMahindra.com  Thu Dec 14 09:07:22 2017
From: akedar at TechMahindra.com (Kedar Ambekar)
Date: Thu, 14 Dec 2017 14:07:22 +0000
Subject: [Project Clearwater] 502 Bad Gateway and other errors while
 running live tests
In-Reply-To: <PN1PR0101MB1565488BBCA00EE6E02B441FA30A0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
References: <PN1PR0101MB1565F6502AF8CA8FE9E3E06CA3340@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<BY2PR02MB20378C8381AD633827882732E2340@BY2PR02MB2037.namprd02.prod.outlook.com>
	<BLUPR0201MB1889B9B407D22938B59ED116B0340@BLUPR0201MB1889.namprd02.prod.outlook.com>
	<BY2PR02MB2037FFD49230C6B498B0D35EE2340@BY2PR02MB2037.namprd02.prod.outlook.com>
	<PN1PR0101MB15651EE3174A2D040BB3AC5AA3350@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<PN1PR0101MB1565488BBCA00EE6E02B441FA30A0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
Message-ID: <MA1PR0101MB155824EC66E0BBF4AA4235CEA30A0@MA1PR0101MB1558.INDPRD01.PROD.OUTLOOK.COM>

Hi,

/etc/Clearwater/shared_config is empty on both the sprout instances post installation. Is this expected if I want to run sproutlets like ICSCF, SCSCF at least ?

Here are couple of commands I tried.

[sprout]ubuntu at 0:~$ sudo monit summary
Monit 5.18.1 uptime: 7h 12m
Service Name                     Status                      Type
node-0.sprout.me.cw-ngv.com      Running                     System
sprout_process                   Execution failed | Does...  Process
snmpd_process                    Running                     Process
ntp_process                      Running                     Process
nginx_process                    Running                     Process
memcached_process                Running                     Process
clearwater_queue_manager_pro...  Running                     Process
etcd_process                     Running                     Process
clearwater_diags_monitor_pro...  Running                     Process
clearwater_config_manager_pr...  Running                     Process
clearwater_cluster_manager_p...  Running                     Process
chronos_process                  Running                     Process
astaire_process                  Running                     Process
sprout_uptime                    Wait parent                 Program
poll_sprout_sip                  Wait parent                 Program
poll_sprout_http                 Wait parent                 Program
nginx_ping                       Status ok                   Program
nginx_uptime                     Status ok                   Program
monit_uptime                     Status ok                   Program
memcached_uptime                 Status ok                   Program
poll_memcached                   Status ok                   Program
clearwater_queue_manager_uptime  Status ok                   Program
etcd_uptime                      Status ok                   Program
poll_etcd_cluster                Status ok                   Program
poll_etcd                        Status ok                   Program
chronos_uptime                   Status ok                   Program
poll_chronos                     Status ok                   Program
astaire_uptime                   Status ok                   Program

[sprout]ubuntu at 0:~$ service sprout status
* sprout is not running
[sprout]ubuntu at 0:~$ sudo service sprout start
14-12-2017 14:06:17.215 UTC Status utils.cpp:496: Switching to daemon mode

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Thursday, December 14, 2017 12:29 PM
To: clearwater at lists.projectclearwater.org
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

I gave a try with release 127 ( repo URL  http://repo.cw-ngv.com/archive/repo127 in env file). But issues seem to be very same.


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Wednesday, December 13, 2017 12:30 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Adam, Mike,

Clearwater heat templates on ONAP wiki are put around July 13. Clearwater release 127, which is released on May 30th , seems to have been used for testing these templates.

If I want to give a try with release 127 installation via heat, how to do that ? I tried URL http://repo.cw-ngv.com/release-127/binary/Packages in browser, but got 404.

From: Kedar Ambekar
Sent: Wednesday, December 13, 2017 11:37 AM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: RE: 502 Bad Gateway and other errors while running live tests

Hi Adam,

Got the point. I had suspected the same.
I have repo_url http://repo.cw-ngv.com/stable in heat's env file.

Is it possible to use same release on which ONAP's heat templates are based, may be by changing this repo URL?

I will have a look at current heat template on Clearwater GitHub but I think those won't be ONAP compatible.

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Adam Lindley
Sent: Tuesday, December 12, 2017 10:50 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Do you know which release you based the templates on?
We should be able to take a look over our release notes between then and now, which should give a reasonable view of the changes, and then we can go from there. Equally, the commit history (https://github.com/Metaswitch/clearwater-heat/commits/stable) gives a fairly clear overview of what and why, with the pull requests adding a bit more detail.

Though as we're likely to hit similar problems in future as we continue to develop Project Clearwater and our heat templates. Are the ONAP changes something we could be pulling in to the main code base? I'd be interested to know the extent of the work needed to keep them running

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Mike Evans
Sent: 12 December 2017 17:00
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Adam

I put the ONAP templates together, so I'm happy to update them if they won't work with the latest Project Clearwater code.  Is there anywhere I can look for an explanation of the changes?

Mike

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Adam Lindley
Sent: 12 December 2017 16:41
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Kedar,

I've just had a look around for the templates on the ONAP wiki; I wasn't aware they had their own copies of them.
I found https://wiki.onap.org/display/DW/Clearwater+vIMS+Onboarding+and+Instantiation . Is this what you've been working from?

When deploying with the templates, have you been specifying a "repo_url" option in the arguments? The Clearwater HEAT templates included steps to install the Clearwater packages from our public stable repo by default, but the templates on the ONAP wiki are now somewhat out of date. If you haven't specified a repo containing packages from the same point in time the templates were effectively forked, you're going to be hitting conflicts between the code version, and the orchestration steps.

I am not sure what differences there need to be for templates to run on ONAP, but I can point you towards our current set of heat templates: https://github.com/Metaswitch/clearwater-heat/tree/stable . I would suggest you try redeploying with these templates, as a fair number of things have changed in the code since the templates on the wiki were valid. If you hit any issues, do let us know.

Cheers,
Adam


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: 12 December 2017 13:46
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

I have installed Clearwater with heat templates (available on ONAP wiki) directly on openstack. Appreciate help on below issues.


  1.  When I run Clearwater live tests, all tests fail with below  error.



RuntimeError thrown:

   - Account creation failed with HTTP code 502, body {"status": 502, "message": "Bad Gateway", "reason": "Upstream request failed", "detail": {"Upstream error": "599", "Upstream URL": "None"}, "error": true}



  1.  ps for bono process shows this.



[bono]ubuntu at 0:/etc/clearwater$ ps -ef |grep bono

bono 6897 1 0 05:06 ? 00:00:11 /usr/share/clearwater/bin/bono --domain= --localhost=10.0.0.28,0.bono.me.cw-ngv.com --al ias=10.0.0.28,0.bono.me.cw-ngv.com, --pcscf=5060,5058 --webrtc-port=5062 --routing-proxy=icscf.,5052,50,600 --sas=0.0.0.0,bono at 0.bono.me.cw-ngv.com --dns-server=127.0.0.1 --worker-threads=2 --analytics=/var/log/bono --log-file=/var/log/bono --log-level=2 --daemon --pidfile=/var/run/bono/bono.pid



  1.  In bono, I saw these logs.

 UTC Error sip_connection_pool.cpp:190: Failed to resolve icscf. to an IP address - Not found (PJ_ENOTFOUND)

UTC Warning dnscachedresolver.cpp:828: Failed to retrieve record for icscf.: Domain name not found



  1.  To debug above issues, I ended up making these changes in /etc/init.d/bono and restarted bono service.



DAEMON_ARGS="--domain=me.cw-ngv.com  (instead of -domain=$home_domain)

upstream_hostname=icscf.sprout.me.cw-ngv.com (instead of upstream_hostname=icscf.$sprout_hostname)


  1.  But now, I get below error in bono. Port 5052 is not in listen mode on sprout.

UTC Warning pjsip: tcpc0x7f90cc07 TCP connect() error: Connection refused [code=120111]
UTC Warning pjsip: tcpc0x7f90cc07 Unable to connect to <sprout ip>:5052
============================================================================================================================
Disclaimer:  This message and the information contained herein is proprietary and confidential and subject to the Tech Mahindra policy statement, you may review the policy at http://www.techmahindra.com/Disclaimer.html externally http://tim.techmahindra.com/tim/disclaimer.html internally within TechMahindra.
============================================================================================================================
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20171214/65ca7f66/attachment.html>

From case at gci.com  Thu Dec 14 19:59:08 2017
From: case at gci.com (Roger Case)
Date: Fri, 15 Dec 2017 00:59:08 +0000
Subject: [Project Clearwater] Bono Send Invite using TCP,
 Header Reduction
In-Reply-To: <DM5PR0201MB3623D60EE643F36F30B2EA16F8350@DM5PR0201MB3623.namprd02.prod.outlook.com>
References: <A7E1158244C52C428F0B61BDC9CF760C016D83B340@ex-mbx-prd02.gci.com>
	<DM5PR0201MB3623D60EE643F36F30B2EA16F8350@DM5PR0201MB3623.namprd02.prod.outlook.com>
Message-ID: <A7E1158244C52C428F0B61BDC9CF760C016D84D493@ex-mbx-prd02.gci.com>

Hi Ying,

Indeed I can successfully register my UE using TCP, but when I send an Invite from the UE it is met with 403 Forbidden.  UDP registration/Invite from UE works fine, but an Invite to UE is too big.
Where can I find the meaning of various log messages, such as:

15-12-2017 00:38:09.962 UTC Error pjsip: tcpc0x7f095455 TCP connect() error: Connection refused [code=120111]
And
15-12-2017 00:46:27.070 UTC Status sip_connection_pool.cpp:447: Recycle TCP connection slot 9
And
15-12-2017 00:46:49.225 UTC Status alarm.cpp:62: sprout issued 1004.1 alarm
15-12-2017 00:46:49.225 UTC Status alarm.cpp:62: sprout issued 1001.1 alarm
15-12-2017 00:46:49.225 UTC Status alarm.cpp:62: sprout issued 1002.1 alarm

Thanks!

Roger


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Ying Huang
Sent: Wednesday, December 13, 2017 9:46 AM
To: clearwater at lists.projectclearwater.org
Subject: Re: [Project Clearwater] Bono Send Invite using TCP, Header Reduction

[External Email]
Hi Roger,

Bono would be forwarding the message as how the message is. So if the client registered as TCP, Bono would be forwarding TCP messages.

As for topology hiding, no Bono doesn?t do it.

Thanks,
Ying

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Roger Case
Sent: 08 December 2017 20:14
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: [Project Clearwater] Bono Send Invite using TCP, Header Reduction

Dear Clearwater,

The PacketCable 2.0 eDVA UE endpoints I am using will not send responses to Invites if the response is greater than 1300 bytes, and it wants to respond using UDP.  Is there a way to get Bono to send the Invite to the UE using TCP?  These devices should then respond using TCP.

Also, the Bono P-CSCF includes all Record Route and Via headers for the call.  Is there a way to reduce the number of headers sent to the UE, making the Invite smaller?  Can Bono do a bit of topology hiding, to accomplish this?

Thanks very much.

Roger Case
GCI Alaska
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20171215/9bc68cdf/attachment.html>

From Ying.Huang at metaswitch.com  Fri Dec 15 12:53:48 2017
From: Ying.Huang at metaswitch.com (Ying Huang)
Date: Fri, 15 Dec 2017 17:53:48 +0000
Subject: [Project Clearwater] 502 Bad Gateway and other errors while
 running live tests
In-Reply-To: <MA1PR0101MB155824EC66E0BBF4AA4235CEA30A0@MA1PR0101MB1558.INDPRD01.PROD.OUTLOOK.COM>
References: <PN1PR0101MB1565F6502AF8CA8FE9E3E06CA3340@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<BY2PR02MB20378C8381AD633827882732E2340@BY2PR02MB2037.namprd02.prod.outlook.com>
	<BLUPR0201MB1889B9B407D22938B59ED116B0340@BLUPR0201MB1889.namprd02.prod.outlook.com>
	<BY2PR02MB2037FFD49230C6B498B0D35EE2340@BY2PR02MB2037.namprd02.prod.outlook.com>
	<PN1PR0101MB15651EE3174A2D040BB3AC5AA3350@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<PN1PR0101MB1565488BBCA00EE6E02B441FA30A0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<MA1PR0101MB155824EC66E0BBF4AA4235CEA30A0@MA1PR0101MB1558.INDPRD01.PROD.OUTLOOK.COM>
Message-ID: <DM5PR0201MB36231D60D83A6D448BE67115F80B0@DM5PR0201MB3623.namprd02.prod.outlook.com>

Hi Kedar,

Shared config shouldn't be empty. Looks like Sprout process has failed for some reason. It's worthwhile checking the sprout log under /var/sys/log/sprout/sprout_current or send it over to see what went wrong.

Thanks,
Ying

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: 14 December 2017 14:07
To: clearwater at lists.projectclearwater.org
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

/etc/Clearwater/shared_config is empty on both the sprout instances post installation. Is this expected if I want to run sproutlets like ICSCF, SCSCF at least ?

Here are couple of commands I tried.

[sprout]ubuntu at 0:~$ sudo monit summary
Monit 5.18.1 uptime: 7h 12m
Service Name                     Status                      Type
node-0.sprout.me.cw-ngv.com      Running                     System
sprout_process                   Execution failed | Does...  Process
snmpd_process                    Running                     Process
ntp_process                      Running                     Process
nginx_process                    Running                     Process
memcached_process                Running                     Process
clearwater_queue_manager_pro...  Running                     Process
etcd_process                     Running                     Process
clearwater_diags_monitor_pro...  Running                     Process
clearwater_config_manager_pr...  Running                     Process
clearwater_cluster_manager_p...  Running                     Process
chronos_process                  Running                     Process
astaire_process                  Running                     Process
sprout_uptime                    Wait parent                 Program
poll_sprout_sip                  Wait parent                 Program
poll_sprout_http                 Wait parent                 Program
nginx_ping                       Status ok                   Program
nginx_uptime                     Status ok                   Program
monit_uptime                     Status ok                   Program
memcached_uptime                 Status ok                   Program
poll_memcached                   Status ok                   Program
clearwater_queue_manager_uptime  Status ok                   Program
etcd_uptime                      Status ok                   Program
poll_etcd_cluster                Status ok                   Program
poll_etcd                        Status ok                   Program
chronos_uptime                   Status ok                   Program
poll_chronos                     Status ok                   Program
astaire_uptime                   Status ok                   Program

[sprout]ubuntu at 0:~$ service sprout status
* sprout is not running
[sprout]ubuntu at 0:~$ sudo service sprout start
14-12-2017 14:06:17.215 UTC Status utils.cpp:496: Switching to daemon mode

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Thursday, December 14, 2017 12:29 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

I gave a try with release 127 ( repo URL  http://repo.cw-ngv.com/archive/repo127 in env file). But issues seem to be very same.


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Wednesday, December 13, 2017 12:30 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Adam, Mike,

Clearwater heat templates on ONAP wiki are put around July 13. Clearwater release 127, which is released on May 30th , seems to have been used for testing these templates.

If I want to give a try with release 127 installation via heat, how to do that ? I tried URL http://repo.cw-ngv.com/release-127/binary/Packages in browser, but got 404.

From: Kedar Ambekar
Sent: Wednesday, December 13, 2017 11:37 AM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: RE: 502 Bad Gateway and other errors while running live tests

Hi Adam,

Got the point. I had suspected the same.
I have repo_url http://repo.cw-ngv.com/stable in heat's env file.

Is it possible to use same release on which ONAP's heat templates are based, may be by changing this repo URL?

I will have a look at current heat template on Clearwater GitHub but I think those won't be ONAP compatible.

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Adam Lindley
Sent: Tuesday, December 12, 2017 10:50 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Do you know which release you based the templates on?
We should be able to take a look over our release notes between then and now, which should give a reasonable view of the changes, and then we can go from there. Equally, the commit history (https://github.com/Metaswitch/clearwater-heat/commits/stable) gives a fairly clear overview of what and why, with the pull requests adding a bit more detail.

Though as we're likely to hit similar problems in future as we continue to develop Project Clearwater and our heat templates. Are the ONAP changes something we could be pulling in to the main code base? I'd be interested to know the extent of the work needed to keep them running

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Mike Evans
Sent: 12 December 2017 17:00
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Adam

I put the ONAP templates together, so I'm happy to update them if they won't work with the latest Project Clearwater code.  Is there anywhere I can look for an explanation of the changes?

Mike

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Adam Lindley
Sent: 12 December 2017 16:41
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Kedar,

I've just had a look around for the templates on the ONAP wiki; I wasn't aware they had their own copies of them.
I found https://wiki.onap.org/display/DW/Clearwater+vIMS+Onboarding+and+Instantiation . Is this what you've been working from?

When deploying with the templates, have you been specifying a "repo_url" option in the arguments? The Clearwater HEAT templates included steps to install the Clearwater packages from our public stable repo by default, but the templates on the ONAP wiki are now somewhat out of date. If you haven't specified a repo containing packages from the same point in time the templates were effectively forked, you're going to be hitting conflicts between the code version, and the orchestration steps.

I am not sure what differences there need to be for templates to run on ONAP, but I can point you towards our current set of heat templates: https://github.com/Metaswitch/clearwater-heat/tree/stable . I would suggest you try redeploying with these templates, as a fair number of things have changed in the code since the templates on the wiki were valid. If you hit any issues, do let us know.

Cheers,
Adam


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: 12 December 2017 13:46
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

I have installed Clearwater with heat templates (available on ONAP wiki) directly on openstack. Appreciate help on below issues.


  1.  When I run Clearwater live tests, all tests fail with below  error.



RuntimeError thrown:

   - Account creation failed with HTTP code 502, body {"status": 502, "message": "Bad Gateway", "reason": "Upstream request failed", "detail": {"Upstream error": "599", "Upstream URL": "None"}, "error": true}



  1.  ps for bono process shows this.



[bono]ubuntu at 0:/etc/clearwater$ ps -ef |grep bono

bono 6897 1 0 05:06 ? 00:00:11 /usr/share/clearwater/bin/bono --domain= --localhost=10.0.0.28,0.bono.me.cw-ngv.com --al ias=10.0.0.28,0.bono.me.cw-ngv.com, --pcscf=5060,5058 --webrtc-port=5062 --routing-proxy=icscf.,5052,50,600 --sas=0.0.0.0,bono at 0.bono.me.cw-ngv.com --dns-server=127.0.0.1 --worker-threads=2 --analytics=/var/log/bono --log-file=/var/log/bono --log-level=2 --daemon --pidfile=/var/run/bono/bono.pid



  1.  In bono, I saw these logs.

 UTC Error sip_connection_pool.cpp:190: Failed to resolve icscf. to an IP address - Not found (PJ_ENOTFOUND)

UTC Warning dnscachedresolver.cpp:828: Failed to retrieve record for icscf.: Domain name not found



  1.  To debug above issues, I ended up making these changes in /etc/init.d/bono and restarted bono service.



DAEMON_ARGS="--domain=me.cw-ngv.com  (instead of -domain=$home_domain)

upstream_hostname=icscf.sprout.me.cw-ngv.com (instead of upstream_hostname=icscf.$sprout_hostname)


  1.  But now, I get below error in bono. Port 5052 is not in listen mode on sprout.

UTC Warning pjsip: tcpc0x7f90cc07 TCP connect() error: Connection refused [code=120111]
UTC Warning pjsip: tcpc0x7f90cc07 Unable to connect to <sprout ip>:5052
============================================================================================================================
Disclaimer:  This message and the information contained herein is proprietary and confidential and subject to the Tech Mahindra policy statement, you may review the policy at http://www.techmahindra.com/Disclaimer.html externally http://tim.techmahindra.com/tim/disclaimer.html internally within TechMahindra.
============================================================================================================================
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20171215/ef45a756/attachment.html>

From Adam.Lindley at metaswitch.com  Fri Dec 15 13:21:18 2017
From: Adam.Lindley at metaswitch.com (Adam Lindley)
Date: Fri, 15 Dec 2017 18:21:18 +0000
Subject: [Project Clearwater] 502 Bad Gateway and other errors while
 running live tests
In-Reply-To: <DM5PR0201MB36231D60D83A6D448BE67115F80B0@DM5PR0201MB3623.namprd02.prod.outlook.com>
References: <PN1PR0101MB1565F6502AF8CA8FE9E3E06CA3340@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<BY2PR02MB20378C8381AD633827882732E2340@BY2PR02MB2037.namprd02.prod.outlook.com>
	<BLUPR0201MB1889B9B407D22938B59ED116B0340@BLUPR0201MB1889.namprd02.prod.outlook.com>
	<BY2PR02MB2037FFD49230C6B498B0D35EE2340@BY2PR02MB2037.namprd02.prod.outlook.com>
	<PN1PR0101MB15651EE3174A2D040BB3AC5AA3350@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<PN1PR0101MB1565488BBCA00EE6E02B441FA30A0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<MA1PR0101MB155824EC66E0BBF4AA4235CEA30A0@MA1PR0101MB1558.INDPRD01.PROD.OUTLOOK.COM>
	<DM5PR0201MB36231D60D83A6D448BE67115F80B0@DM5PR0201MB3623.namprd02.prod.outlook.com>
Message-ID: <CY1PR02MB20442B9F94B1E5A15A7F5E26E20B0@CY1PR02MB2044.namprd02.prod.outlook.com>

As a few more pointers of where to look, our HEAT templates currently generate shared config on the Ellis node, and upload this to the cluster as a whole. It would be worth looking at the install log on the ellis node to see if there was some error there. You may have the shared_config file present, and be able to upload that to the etcd cluster to bring the deployment to life.
If that doesn't give you any joy, make sure that the template install process has completed successfully on each of your nodes. It seems odd that shared_config has not been generated, and so I'd want to sanity check that nothing else is going wrong. If all nodes are installed, but lacking config, you should be able to generate shared config based on the script in the ellis.yaml file.
As Ying has said, once those things are sorted, you can look in the process logs to see why you are hitting errors. Almost all of our components log to /var/log/<process_name> on their node, so that's a great place to start debugging. You may also find our troubleshooting guide helpful: https://clearwater.readthedocs.io/en/stable/Troubleshooting_and_Recovery.html

Cheers,
Adam

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Ying Huang
Sent: 15 December 2017 17:54
To: clearwater at lists.projectclearwater.org
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Kedar,

Shared config shouldn't be empty. Looks like Sprout process has failed for some reason. It's worthwhile checking the sprout log under /var/sys/log/sprout/sprout_current or send it over to see what went wrong.

Thanks,
Ying

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: 14 December 2017 14:07
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

/etc/Clearwater/shared_config is empty on both the sprout instances post installation. Is this expected if I want to run sproutlets like ICSCF, SCSCF at least ?

Here are couple of commands I tried.

[sprout]ubuntu at 0:~$ sudo monit summary
Monit 5.18.1 uptime: 7h 12m
Service Name                     Status                      Type
node-0.sprout.me.cw-ngv.com      Running                     System
sprout_process                   Execution failed | Does...  Process
snmpd_process                    Running                     Process
ntp_process                      Running                     Process
nginx_process                    Running                     Process
memcached_process                Running                     Process
clearwater_queue_manager_pro...  Running                     Process
etcd_process                     Running                     Process
clearwater_diags_monitor_pro...  Running                     Process
clearwater_config_manager_pr...  Running                     Process
clearwater_cluster_manager_p...  Running                     Process
chronos_process                  Running                     Process
astaire_process                  Running                     Process
sprout_uptime                    Wait parent                 Program
poll_sprout_sip                  Wait parent                 Program
poll_sprout_http                 Wait parent                 Program
nginx_ping                       Status ok                   Program
nginx_uptime                     Status ok                   Program
monit_uptime                     Status ok                   Program
memcached_uptime                 Status ok                   Program
poll_memcached                   Status ok                   Program
clearwater_queue_manager_uptime  Status ok                   Program
etcd_uptime                      Status ok                   Program
poll_etcd_cluster                Status ok                   Program
poll_etcd                        Status ok                   Program
chronos_uptime                   Status ok                   Program
poll_chronos                     Status ok                   Program
astaire_uptime                   Status ok                   Program

[sprout]ubuntu at 0:~$ service sprout status
* sprout is not running
[sprout]ubuntu at 0:~$ sudo service sprout start
14-12-2017 14:06:17.215 UTC Status utils.cpp:496: Switching to daemon mode

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Thursday, December 14, 2017 12:29 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

I gave a try with release 127 ( repo URL  http://repo.cw-ngv.com/archive/repo127 in env file). But issues seem to be very same.


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Wednesday, December 13, 2017 12:30 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Adam, Mike,

Clearwater heat templates on ONAP wiki are put around July 13. Clearwater release 127, which is released on May 30th , seems to have been used for testing these templates.

If I want to give a try with release 127 installation via heat, how to do that ? I tried URL http://repo.cw-ngv.com/release-127/binary/Packages in browser, but got 404.

From: Kedar Ambekar
Sent: Wednesday, December 13, 2017 11:37 AM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: RE: 502 Bad Gateway and other errors while running live tests

Hi Adam,

Got the point. I had suspected the same.
I have repo_url http://repo.cw-ngv.com/stable in heat's env file.

Is it possible to use same release on which ONAP's heat templates are based, may be by changing this repo URL?

I will have a look at current heat template on Clearwater GitHub but I think those won't be ONAP compatible.

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Adam Lindley
Sent: Tuesday, December 12, 2017 10:50 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Do you know which release you based the templates on?
We should be able to take a look over our release notes between then and now, which should give a reasonable view of the changes, and then we can go from there. Equally, the commit history (https://github.com/Metaswitch/clearwater-heat/commits/stable) gives a fairly clear overview of what and why, with the pull requests adding a bit more detail.

Though as we're likely to hit similar problems in future as we continue to develop Project Clearwater and our heat templates. Are the ONAP changes something we could be pulling in to the main code base? I'd be interested to know the extent of the work needed to keep them running

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Mike Evans
Sent: 12 December 2017 17:00
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Adam

I put the ONAP templates together, so I'm happy to update them if they won't work with the latest Project Clearwater code.  Is there anywhere I can look for an explanation of the changes?

Mike

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Adam Lindley
Sent: 12 December 2017 16:41
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Kedar,

I've just had a look around for the templates on the ONAP wiki; I wasn't aware they had their own copies of them.
I found https://wiki.onap.org/display/DW/Clearwater+vIMS+Onboarding+and+Instantiation . Is this what you've been working from?

When deploying with the templates, have you been specifying a "repo_url" option in the arguments? The Clearwater HEAT templates included steps to install the Clearwater packages from our public stable repo by default, but the templates on the ONAP wiki are now somewhat out of date. If you haven't specified a repo containing packages from the same point in time the templates were effectively forked, you're going to be hitting conflicts between the code version, and the orchestration steps.

I am not sure what differences there need to be for templates to run on ONAP, but I can point you towards our current set of heat templates: https://github.com/Metaswitch/clearwater-heat/tree/stable . I would suggest you try redeploying with these templates, as a fair number of things have changed in the code since the templates on the wiki were valid. If you hit any issues, do let us know.

Cheers,
Adam


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: 12 December 2017 13:46
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

I have installed Clearwater with heat templates (available on ONAP wiki) directly on openstack. Appreciate help on below issues.


  1.  When I run Clearwater live tests, all tests fail with below  error.



RuntimeError thrown:

   - Account creation failed with HTTP code 502, body {"status": 502, "message": "Bad Gateway", "reason": "Upstream request failed", "detail": {"Upstream error": "599", "Upstream URL": "None"}, "error": true}



  1.  ps for bono process shows this.



[bono]ubuntu at 0:/etc/clearwater$ ps -ef |grep bono

bono 6897 1 0 05:06 ? 00:00:11 /usr/share/clearwater/bin/bono --domain= --localhost=10.0.0.28,0.bono.me.cw-ngv.com --al ias=10.0.0.28,0.bono.me.cw-ngv.com, --pcscf=5060,5058 --webrtc-port=5062 --routing-proxy=icscf.,5052,50,600 --sas=0.0.0.0,bono at 0.bono.me.cw-ngv.com --dns-server=127.0.0.1 --worker-threads=2 --analytics=/var/log/bono --log-file=/var/log/bono --log-level=2 --daemon --pidfile=/var/run/bono/bono.pid



  1.  In bono, I saw these logs.

 UTC Error sip_connection_pool.cpp:190: Failed to resolve icscf. to an IP address - Not found (PJ_ENOTFOUND)

UTC Warning dnscachedresolver.cpp:828: Failed to retrieve record for icscf.: Domain name not found



  1.  To debug above issues, I ended up making these changes in /etc/init.d/bono and restarted bono service.



DAEMON_ARGS="--domain=me.cw-ngv.com  (instead of -domain=$home_domain)

upstream_hostname=icscf.sprout.me.cw-ngv.com (instead of upstream_hostname=icscf.$sprout_hostname)


  1.  But now, I get below error in bono. Port 5052 is not in listen mode on sprout.

UTC Warning pjsip: tcpc0x7f90cc07 TCP connect() error: Connection refused [code=120111]
UTC Warning pjsip: tcpc0x7f90cc07 Unable to connect to <sprout ip>:5052
============================================================================================================================
Disclaimer:  This message and the information contained herein is proprietary and confidential and subject to the Tech Mahindra policy statement, you may review the policy at http://www.techmahindra.com/Disclaimer.html externally http://tim.techmahindra.com/tim/disclaimer.html internally within TechMahindra.
============================================================================================================================
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20171215/6b3fa813/attachment.html>

From akedar at TechMahindra.com  Mon Dec 18 01:04:03 2017
From: akedar at TechMahindra.com (Kedar Ambekar)
Date: Mon, 18 Dec 2017 06:04:03 +0000
Subject: [Project Clearwater] 502 Bad Gateway and other errors while
 running live tests
In-Reply-To: <CY1PR02MB20442B9F94B1E5A15A7F5E26E20B0@CY1PR02MB2044.namprd02.prod.outlook.com>
References: <PN1PR0101MB1565F6502AF8CA8FE9E3E06CA3340@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<BY2PR02MB20378C8381AD633827882732E2340@BY2PR02MB2037.namprd02.prod.outlook.com>
	<BLUPR0201MB1889B9B407D22938B59ED116B0340@BLUPR0201MB1889.namprd02.prod.outlook.com>
	<BY2PR02MB2037FFD49230C6B498B0D35EE2340@BY2PR02MB2037.namprd02.prod.outlook.com>
	<PN1PR0101MB15651EE3174A2D040BB3AC5AA3350@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<PN1PR0101MB1565488BBCA00EE6E02B441FA30A0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<MA1PR0101MB155824EC66E0BBF4AA4235CEA30A0@MA1PR0101MB1558.INDPRD01.PROD.OUTLOOK.COM>
	<DM5PR0201MB36231D60D83A6D448BE67115F80B0@DM5PR0201MB3623.namprd02.prod.outlook.com>
	<CY1PR02MB20442B9F94B1E5A15A7F5E26E20B0@CY1PR02MB2044.namprd02.prod.outlook.com>
Message-ID: <PN1PR0101MB156571D41BC08C9107D9C1B1A30E0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>

Hi Adam, Ying,


1.       When I said shared_config is empty on sprout instances, I wanted to say that no config statements in it.


[sprout]ubuntu at 1:/etc/clearwater$ more shared_config
#####################################################################
# No Shared Config has been provided
# Replace this file with the Shared Configuration for your deployment
#####################################################################


2.       /var/log/sprout/sprout_current has these entries periodically.



UTC Status utils.cpp:607: Log level set to 2

UTC Status main.cpp:1618: Access logging enabled to /var/log/sprout

UTC Warning signalhandler.h:90: SIGNAL already hooked

UTC Warning main.cpp:1674: SAS server option was invalid or not configured - SAS is disabled

UTC Error main.cpp:1713: S/I-CSCF enabled with no Homestead server


3.       So is it ok if only one node, that is going to push shared config to cluster (ellis in the heat based deployment), to have shared_config file with all the configuration and other nodes to have 'empty' file like above ?



4.       PFA ellis's shared_config attached. I don't find any sproutlet related configuration there..OK ? I have attached tail of ellis's heat installation log. Looks ok to me. Couldn't find anything suspicious in remaining log file.



5.       Btw, one thing I should have told this in the beginning - When I tried the heat templates as it is, I observed that DNS VM's IP was not being passed to all other components. So I ended up carving out DNS VM and instantiated that first and used its IP in env file. I could confirm that IP got used by heat instructions of other VMs and DNSMASQ on them got configured ok. nslookup for components' names also works ok. (may be we need to use wait condition in the heat template)



6.       I am going through troubleshooting options and will update on that.

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Adam Lindley
Sent: Friday, December 15, 2017 11:51 PM
To: clearwater at lists.projectclearwater.org
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

As a few more pointers of where to look, our HEAT templates currently generate shared config on the Ellis node, and upload this to the cluster as a whole. It would be worth looking at the install log on the ellis node to see if there was some error there. You may have the shared_config file present, and be able to upload that to the etcd cluster to bring the deployment to life.
If that doesn't give you any joy, make sure that the template install process has completed successfully on each of your nodes. It seems odd that shared_config has not been generated, and so I'd want to sanity check that nothing else is going wrong. If all nodes are installed, but lacking config, you should be able to generate shared config based on the script in the ellis.yaml file.
As Ying has said, once those things are sorted, you can look in the process logs to see why you are hitting errors. Almost all of our components log to /var/log/<process_name> on their node, so that's a great place to start debugging. You may also find our troubleshooting guide helpful: https://clearwater.readthedocs.io/en/stable/Troubleshooting_and_Recovery.html

Cheers,
Adam

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Ying Huang
Sent: 15 December 2017 17:54
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Kedar,

Shared config shouldn't be empty. Looks like Sprout process has failed for some reason. It's worthwhile checking the sprout log under /var/sys/log/sprout/sprout_current or send it over to see what went wrong.

Thanks,
Ying

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: 14 December 2017 14:07
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

/etc/Clearwater/shared_config is empty on both the sprout instances post installation. Is this expected if I want to run sproutlets like ICSCF, SCSCF at least ?

Here are couple of commands I tried.

[sprout]ubuntu at 0:~$ sudo monit summary
Monit 5.18.1 uptime: 7h 12m
Service Name                     Status                      Type
node-0.sprout.me.cw-ngv.com      Running                     System
sprout_process                   Execution failed | Does...  Process
snmpd_process                    Running                     Process
ntp_process                      Running                     Process
nginx_process                    Running                     Process
memcached_process                Running                     Process
clearwater_queue_manager_pro...  Running                     Process
etcd_process                     Running                     Process
clearwater_diags_monitor_pro...  Running                     Process
clearwater_config_manager_pr...  Running                     Process
clearwater_cluster_manager_p...  Running                     Process
chronos_process                  Running                     Process
astaire_process                  Running                     Process
sprout_uptime                    Wait parent                 Program
poll_sprout_sip                  Wait parent                 Program
poll_sprout_http                 Wait parent                 Program
nginx_ping                       Status ok                   Program
nginx_uptime                     Status ok                   Program
monit_uptime                     Status ok                   Program
memcached_uptime                 Status ok                   Program
poll_memcached                   Status ok                   Program
clearwater_queue_manager_uptime  Status ok                   Program
etcd_uptime                      Status ok                   Program
poll_etcd_cluster                Status ok                   Program
poll_etcd                        Status ok                   Program
chronos_uptime                   Status ok                   Program
poll_chronos                     Status ok                   Program
astaire_uptime                   Status ok                   Program

[sprout]ubuntu at 0:~$ service sprout status
* sprout is not running
[sprout]ubuntu at 0:~$ sudo service sprout start
14-12-2017 14:06:17.215 UTC Status utils.cpp:496: Switching to daemon mode

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Thursday, December 14, 2017 12:29 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

I gave a try with release 127 ( repo URL  http://repo.cw-ngv.com/archive/repo127 in env file). But issues seem to be very same.


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Wednesday, December 13, 2017 12:30 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Adam, Mike,

Clearwater heat templates on ONAP wiki are put around July 13. Clearwater release 127, which is released on May 30th , seems to have been used for testing these templates.

If I want to give a try with release 127 installation via heat, how to do that ? I tried URL http://repo.cw-ngv.com/release-127/binary/Packages in browser, but got 404.

From: Kedar Ambekar
Sent: Wednesday, December 13, 2017 11:37 AM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: RE: 502 Bad Gateway and other errors while running live tests

Hi Adam,

Got the point. I had suspected the same.
I have repo_url http://repo.cw-ngv.com/stable in heat's env file.

Is it possible to use same release on which ONAP's heat templates are based, may be by changing this repo URL?

I will have a look at current heat template on Clearwater GitHub but I think those won't be ONAP compatible.

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Adam Lindley
Sent: Tuesday, December 12, 2017 10:50 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Do you know which release you based the templates on?
We should be able to take a look over our release notes between then and now, which should give a reasonable view of the changes, and then we can go from there. Equally, the commit history (https://github.com/Metaswitch/clearwater-heat/commits/stable) gives a fairly clear overview of what and why, with the pull requests adding a bit more detail.

Though as we're likely to hit similar problems in future as we continue to develop Project Clearwater and our heat templates. Are the ONAP changes something we could be pulling in to the main code base? I'd be interested to know the extent of the work needed to keep them running

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Mike Evans
Sent: 12 December 2017 17:00
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Adam

I put the ONAP templates together, so I'm happy to update them if they won't work with the latest Project Clearwater code.  Is there anywhere I can look for an explanation of the changes?

Mike

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Adam Lindley
Sent: 12 December 2017 16:41
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Kedar,

I've just had a look around for the templates on the ONAP wiki; I wasn't aware they had their own copies of them.
I found https://wiki.onap.org/display/DW/Clearwater+vIMS+Onboarding+and+Instantiation . Is this what you've been working from?

When deploying with the templates, have you been specifying a "repo_url" option in the arguments? The Clearwater HEAT templates included steps to install the Clearwater packages from our public stable repo by default, but the templates on the ONAP wiki are now somewhat out of date. If you haven't specified a repo containing packages from the same point in time the templates were effectively forked, you're going to be hitting conflicts between the code version, and the orchestration steps.

I am not sure what differences there need to be for templates to run on ONAP, but I can point you towards our current set of heat templates: https://github.com/Metaswitch/clearwater-heat/tree/stable . I would suggest you try redeploying with these templates, as a fair number of things have changed in the code since the templates on the wiki were valid. If you hit any issues, do let us know.

Cheers,
Adam


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: 12 December 2017 13:46
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

I have installed Clearwater with heat templates (available on ONAP wiki) directly on openstack. Appreciate help on below issues.


  1.  When I run Clearwater live tests, all tests fail with below  error.



RuntimeError thrown:

   - Account creation failed with HTTP code 502, body {"status": 502, "message": "Bad Gateway", "reason": "Upstream request failed", "detail": {"Upstream error": "599", "Upstream URL": "None"}, "error": true}



  1.  ps for bono process shows this.



[bono]ubuntu at 0:/etc/clearwater$ ps -ef |grep bono

bono 6897 1 0 05:06 ? 00:00:11 /usr/share/clearwater/bin/bono --domain= --localhost=10.0.0.28,0.bono.me.cw-ngv.com --al ias=10.0.0.28,0.bono.me.cw-ngv.com, --pcscf=5060,5058 --webrtc-port=5062 --routing-proxy=icscf.,5052,50,600 --sas=0.0.0.0,bono at 0.bono.me.cw-ngv.com --dns-server=127.0.0.1 --worker-threads=2 --analytics=/var/log/bono --log-file=/var/log/bono --log-level=2 --daemon --pidfile=/var/run/bono/bono.pid



  1.  In bono, I saw these logs.

 UTC Error sip_connection_pool.cpp:190: Failed to resolve icscf. to an IP address - Not found (PJ_ENOTFOUND)

UTC Warning dnscachedresolver.cpp:828: Failed to retrieve record for icscf.: Domain name not found



  1.  To debug above issues, I ended up making these changes in /etc/init.d/bono and restarted bono service.



DAEMON_ARGS="--domain=me.cw-ngv.com  (instead of -domain=$home_domain)

upstream_hostname=icscf.sprout.me.cw-ngv.com (instead of upstream_hostname=icscf.$sprout_hostname)


  1.  But now, I get below error in bono. Port 5052 is not in listen mode on sprout.

UTC Warning pjsip: tcpc0x7f90cc07 TCP connect() error: Connection refused [code=120111]
UTC Warning pjsip: tcpc0x7f90cc07 Unable to connect to <sprout ip>:5052
============================================================================================================================
Disclaimer:  This message and the information contained herein is proprietary and confidential and subject to the Tech Mahindra policy statement, you may review the policy at http://www.techmahindra.com/Disclaimer.html externally http://tim.techmahindra.com/tim/disclaimer.html internally within TechMahindra.
============================================================================================================================
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20171218/f5cb620e/attachment.html>
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: shared_config on ellis.txt
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20171218/f5cb620e/attachment.txt>
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: partial heat log on ellis.txt
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20171218/f5cb620e/attachment-0001.txt>

From akedar at TechMahindra.com  Mon Dec 18 08:59:49 2017
From: akedar at TechMahindra.com (Kedar Ambekar)
Date: Mon, 18 Dec 2017 13:59:49 +0000
Subject: [Project Clearwater] 502 Bad Gateway and other errors while
 running live tests
In-Reply-To: <PN1PR0101MB156571D41BC08C9107D9C1B1A30E0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
References: <PN1PR0101MB1565F6502AF8CA8FE9E3E06CA3340@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<BY2PR02MB20378C8381AD633827882732E2340@BY2PR02MB2037.namprd02.prod.outlook.com>
	<BLUPR0201MB1889B9B407D22938B59ED116B0340@BLUPR0201MB1889.namprd02.prod.outlook.com>
	<BY2PR02MB2037FFD49230C6B498B0D35EE2340@BY2PR02MB2037.namprd02.prod.outlook.com>
	<PN1PR0101MB15651EE3174A2D040BB3AC5AA3350@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<PN1PR0101MB1565488BBCA00EE6E02B441FA30A0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<MA1PR0101MB155824EC66E0BBF4AA4235CEA30A0@MA1PR0101MB1558.INDPRD01.PROD.OUTLOOK.COM>
	<DM5PR0201MB36231D60D83A6D448BE67115F80B0@DM5PR0201MB3623.namprd02.prod.outlook.com>
	<CY1PR02MB20442B9F94B1E5A15A7F5E26E20B0@CY1PR02MB2044.namprd02.prod.outlook.com>
	<PN1PR0101MB156571D41BC08C9107D9C1B1A30E0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
Message-ID: <MA1PR0101MB1558C054087ED8884393C4D0A30E0@MA1PR0101MB1558.INDPRD01.PROD.OUTLOOK.COM>

Hi,

6 continued.

6-a. bono errors attached for log locations mentioned in troubleshooting page. I tried stopping bono service. It got started by monit but same errors continue.
6-b. sprout errors attached for log locations mentioned in troubleshooting page. Sprout service is not running, so didn't try to stop to let me restart by monit.
6-c. /var/log/ellis/ellis-err.log is empty.
        /var/log/ellis/ellis_<time>.txt has these entries INFO web.py:1447: 200 GET /ping (0.0.0.0) 0.53ms.
        I tried stopping ellis service. It got started by monit but don't see anything changed.
       /var/log/monit.log errors attached.

Appreciate any help here !

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Monday, December 18, 2017 11:34 AM
To: clearwater at lists.projectclearwater.org
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Adam, Ying,


1.       When I said shared_config is empty on sprout instances, I wanted to say that no config statements in it.


[sprout]ubuntu at 1:/etc/clearwater$ more shared_config
#####################################################################
# No Shared Config has been provided
# Replace this file with the Shared Configuration for your deployment
#####################################################################


2.       /var/log/sprout/sprout_current has these entries periodically.



UTC Status utils.cpp:607: Log level set to 2

UTC Status main.cpp:1618: Access logging enabled to /var/log/sprout

UTC Warning signalhandler.h:90: SIGNAL already hooked

UTC Warning main.cpp:1674: SAS server option was invalid or not configured - SAS is disabled

UTC Error main.cpp:1713: S/I-CSCF enabled with no Homestead server


3.       So is it ok if only one node, that is going to push shared config to cluster (ellis in the heat based deployment), to have shared_config file with all the configuration and other nodes to have 'empty' file like above ?



4.       PFA ellis's shared_config attached. I don't find any sproutlet related configuration there..OK ? I have attached tail of ellis's heat installation log. Looks ok to me. Couldn't find anything suspicious in remaining log file.



5.       Btw, one thing I should have told this in the beginning - When I tried the heat templates as it is, I observed that DNS VM's IP was not being passed to all other components. So I ended up carving out DNS VM and instantiated that first and used its IP in env file. I could confirm that IP got used by heat instructions of other VMs and DNSMASQ on them got configured ok. nslookup for components' names also works ok. (may be we need to use wait condition in the heat template)



6.       I am going through troubleshooting options and will update on that.

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Adam Lindley
Sent: Friday, December 15, 2017 11:51 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

As a few more pointers of where to look, our HEAT templates currently generate shared config on the Ellis node, and upload this to the cluster as a whole. It would be worth looking at the install log on the ellis node to see if there was some error there. You may have the shared_config file present, and be able to upload that to the etcd cluster to bring the deployment to life.
If that doesn't give you any joy, make sure that the template install process has completed successfully on each of your nodes. It seems odd that shared_config has not been generated, and so I'd want to sanity check that nothing else is going wrong. If all nodes are installed, but lacking config, you should be able to generate shared config based on the script in the ellis.yaml file.
As Ying has said, once those things are sorted, you can look in the process logs to see why you are hitting errors. Almost all of our components log to /var/log/<process_name> on their node, so that's a great place to start debugging. You may also find our troubleshooting guide helpful: https://clearwater.readthedocs.io/en/stable/Troubleshooting_and_Recovery.html

Cheers,
Adam

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Ying Huang
Sent: 15 December 2017 17:54
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Kedar,

Shared config shouldn't be empty. Looks like Sprout process has failed for some reason. It's worthwhile checking the sprout log under /var/sys/log/sprout/sprout_current or send it over to see what went wrong.

Thanks,
Ying

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: 14 December 2017 14:07
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

/etc/Clearwater/shared_config is empty on both the sprout instances post installation. Is this expected if I want to run sproutlets like ICSCF, SCSCF at least ?

Here are couple of commands I tried.

[sprout]ubuntu at 0:~$ sudo monit summary
Monit 5.18.1 uptime: 7h 12m
Service Name                     Status                      Type
node-0.sprout.me.cw-ngv.com      Running                     System
sprout_process                   Execution failed | Does...  Process
snmpd_process                    Running                     Process
ntp_process                      Running                     Process
nginx_process                    Running                     Process
memcached_process                Running                     Process
clearwater_queue_manager_pro...  Running                     Process
etcd_process                     Running                     Process
clearwater_diags_monitor_pro...  Running                     Process
clearwater_config_manager_pr...  Running                     Process
clearwater_cluster_manager_p...  Running                     Process
chronos_process                  Running                     Process
astaire_process                  Running                     Process
sprout_uptime                    Wait parent                 Program
poll_sprout_sip                  Wait parent                 Program
poll_sprout_http                 Wait parent                 Program
nginx_ping                       Status ok                   Program
nginx_uptime                     Status ok                   Program
monit_uptime                     Status ok                   Program
memcached_uptime                 Status ok                   Program
poll_memcached                   Status ok                   Program
clearwater_queue_manager_uptime  Status ok                   Program
etcd_uptime                      Status ok                   Program
poll_etcd_cluster                Status ok                   Program
poll_etcd                        Status ok                   Program
chronos_uptime                   Status ok                   Program
poll_chronos                     Status ok                   Program
astaire_uptime                   Status ok                   Program

[sprout]ubuntu at 0:~$ service sprout status
* sprout is not running
[sprout]ubuntu at 0:~$ sudo service sprout start
14-12-2017 14:06:17.215 UTC Status utils.cpp:496: Switching to daemon mode

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Thursday, December 14, 2017 12:29 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

I gave a try with release 127 ( repo URL  http://repo.cw-ngv.com/archive/repo127 in env file). But issues seem to be very same.


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Wednesday, December 13, 2017 12:30 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Adam, Mike,

Clearwater heat templates on ONAP wiki are put around July 13. Clearwater release 127, which is released on May 30th , seems to have been used for testing these templates.

If I want to give a try with release 127 installation via heat, how to do that ? I tried URL http://repo.cw-ngv.com/release-127/binary/Packages in browser, but got 404.

From: Kedar Ambekar
Sent: Wednesday, December 13, 2017 11:37 AM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: RE: 502 Bad Gateway and other errors while running live tests

Hi Adam,

Got the point. I had suspected the same.
I have repo_url http://repo.cw-ngv.com/stable in heat's env file.

Is it possible to use same release on which ONAP's heat templates are based, may be by changing this repo URL?

I will have a look at current heat template on Clearwater GitHub but I think those won't be ONAP compatible.

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Adam Lindley
Sent: Tuesday, December 12, 2017 10:50 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Do you know which release you based the templates on?
We should be able to take a look over our release notes between then and now, which should give a reasonable view of the changes, and then we can go from there. Equally, the commit history (https://github.com/Metaswitch/clearwater-heat/commits/stable) gives a fairly clear overview of what and why, with the pull requests adding a bit more detail.

Though as we're likely to hit similar problems in future as we continue to develop Project Clearwater and our heat templates. Are the ONAP changes something we could be pulling in to the main code base? I'd be interested to know the extent of the work needed to keep them running

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Mike Evans
Sent: 12 December 2017 17:00
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Adam

I put the ONAP templates together, so I'm happy to update them if they won't work with the latest Project Clearwater code.  Is there anywhere I can look for an explanation of the changes?

Mike

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Adam Lindley
Sent: 12 December 2017 16:41
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Kedar,

I've just had a look around for the templates on the ONAP wiki; I wasn't aware they had their own copies of them.
I found https://wiki.onap.org/display/DW/Clearwater+vIMS+Onboarding+and+Instantiation . Is this what you've been working from?

When deploying with the templates, have you been specifying a "repo_url" option in the arguments? The Clearwater HEAT templates included steps to install the Clearwater packages from our public stable repo by default, but the templates on the ONAP wiki are now somewhat out of date. If you haven't specified a repo containing packages from the same point in time the templates were effectively forked, you're going to be hitting conflicts between the code version, and the orchestration steps.

I am not sure what differences there need to be for templates to run on ONAP, but I can point you towards our current set of heat templates: https://github.com/Metaswitch/clearwater-heat/tree/stable . I would suggest you try redeploying with these templates, as a fair number of things have changed in the code since the templates on the wiki were valid. If you hit any issues, do let us know.

Cheers,
Adam


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: 12 December 2017 13:46
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

I have installed Clearwater with heat templates (available on ONAP wiki) directly on openstack. Appreciate help on below issues.


  1.  When I run Clearwater live tests, all tests fail with below  error.



RuntimeError thrown:

   - Account creation failed with HTTP code 502, body {"status": 502, "message": "Bad Gateway", "reason": "Upstream request failed", "detail": {"Upstream error": "599", "Upstream URL": "None"}, "error": true}



  1.  ps for bono process shows this.



[bono]ubuntu at 0:/etc/clearwater$ ps -ef |grep bono

bono 6897 1 0 05:06 ? 00:00:11 /usr/share/clearwater/bin/bono --domain= --localhost=10.0.0.28,0.bono.me.cw-ngv.com --al ias=10.0.0.28,0.bono.me.cw-ngv.com, --pcscf=5060,5058 --webrtc-port=5062 --routing-proxy=icscf.,5052,50,600 --sas=0.0.0.0,bono at 0.bono.me.cw-ngv.com --dns-server=127.0.0.1 --worker-threads=2 --analytics=/var/log/bono --log-file=/var/log/bono --log-level=2 --daemon --pidfile=/var/run/bono/bono.pid



  1.  In bono, I saw these logs.

 UTC Error sip_connection_pool.cpp:190: Failed to resolve icscf. to an IP address - Not found (PJ_ENOTFOUND)

UTC Warning dnscachedresolver.cpp:828: Failed to retrieve record for icscf.: Domain name not found



  1.  To debug above issues, I ended up making these changes in /etc/init.d/bono and restarted bono service.



DAEMON_ARGS="--domain=me.cw-ngv.com  (instead of -domain=$home_domain)

upstream_hostname=icscf.sprout.me.cw-ngv.com (instead of upstream_hostname=icscf.$sprout_hostname)


  1.  But now, I get below error in bono. Port 5052 is not in listen mode on sprout.

UTC Warning pjsip: tcpc0x7f90cc07 TCP connect() error: Connection refused [code=120111]
UTC Warning pjsip: tcpc0x7f90cc07 Unable to connect to <sprout ip>:5052
============================================================================================================================
Disclaimer:  This message and the information contained herein is proprietary and confidential and subject to the Tech Mahindra policy statement, you may review the policy at http://www.techmahindra.com/Disclaimer.html externally http://tim.techmahindra.com/tim/disclaimer.html internally within TechMahindra.
============================================================================================================================
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20171218/7093479f/attachment.html>
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: bono_errors.txt
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20171218/7093479f/attachment.txt>
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: sprout_errors.txt
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20171218/7093479f/attachment-0001.txt>
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: ellis_errors.txt
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20171218/7093479f/attachment-0002.txt>

From Ying.Huang at metaswitch.com  Tue Dec 19 13:00:35 2017
From: Ying.Huang at metaswitch.com (Ying Huang)
Date: Tue, 19 Dec 2017 18:00:35 +0000
Subject: [Project Clearwater] Bono Send Invite using TCP,
 Header Reduction
In-Reply-To: <A7E1158244C52C428F0B61BDC9CF760C016D84D493@ex-mbx-prd02.gci.com>
References: <A7E1158244C52C428F0B61BDC9CF760C016D83B340@ex-mbx-prd02.gci.com>
	<DM5PR0201MB3623D60EE643F36F30B2EA16F8350@DM5PR0201MB3623.namprd02.prod.outlook.com>
	<A7E1158244C52C428F0B61BDC9CF760C016D84D493@ex-mbx-prd02.gci.com>
Message-ID: <DM5PR0201MB36238C158A91D9C0159E3051F80F0@DM5PR0201MB3623.namprd02.prod.outlook.com>

Hi Roger,

Apparently there is some protocol specifying that when the message is too large, the network should use TCP instead of UDP, so let?s focus on debugging the TCP. I have always registered my client to use TCP and expect it to work.

Just to clarify, the logging you sent is from Bono node? Would you turn on debug logging and send a more detailed log? Also if you can do a tcpdump on Bono it will be helpful as well.

Thanks!
Ying

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Roger Case
Sent: 15 December 2017 00:59
To: clearwater at lists.projectclearwater.org
Subject: Re: [Project Clearwater] Bono Send Invite using TCP, Header Reduction

Hi Ying,

Indeed I can successfully register my UE using TCP, but when I send an Invite from the UE it is met with 403 Forbidden.  UDP registration/Invite from UE works fine, but an Invite to UE is too big.
Where can I find the meaning of various log messages, such as:

15-12-2017 00:38:09.962 UTC Error pjsip: tcpc0x7f095455 TCP connect() error: Connection refused [code=120111]
And
15-12-2017 00:46:27.070 UTC Status sip_connection_pool.cpp:447: Recycle TCP connection slot 9
And
15-12-2017 00:46:49.225 UTC Status alarm.cpp:62: sprout issued 1004.1 alarm
15-12-2017 00:46:49.225 UTC Status alarm.cpp:62: sprout issued 1001.1 alarm
15-12-2017 00:46:49.225 UTC Status alarm.cpp:62: sprout issued 1002.1 alarm

Thanks!

Roger


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Ying Huang
Sent: Wednesday, December 13, 2017 9:46 AM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] Bono Send Invite using TCP, Header Reduction

[External Email]
Hi Roger,

Bono would be forwarding the message as how the message is. So if the client registered as TCP, Bono would be forwarding TCP messages.

As for topology hiding, no Bono doesn?t do it.

Thanks,
Ying

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Roger Case
Sent: 08 December 2017 20:14
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: [Project Clearwater] Bono Send Invite using TCP, Header Reduction

Dear Clearwater,

The PacketCable 2.0 eDVA UE endpoints I am using will not send responses to Invites if the response is greater than 1300 bytes, and it wants to respond using UDP.  Is there a way to get Bono to send the Invite to the UE using TCP?  These devices should then respond using TCP.

Also, the Bono P-CSCF includes all Record Route and Via headers for the call.  Is there a way to reduce the number of headers sent to the UE, making the Invite smaller?  Can Bono do a bit of topology hiding, to accomplish this?

Thanks very much.

Roger Case
GCI Alaska
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20171219/67050f67/attachment.html>

From Ying.Huang at metaswitch.com  Tue Dec 19 13:44:44 2017
From: Ying.Huang at metaswitch.com (Ying Huang)
Date: Tue, 19 Dec 2017 18:44:44 +0000
Subject: [Project Clearwater] 502 Bad Gateway and other errors while
 running live tests
In-Reply-To: <MA1PR0101MB1558C054087ED8884393C4D0A30E0@MA1PR0101MB1558.INDPRD01.PROD.OUTLOOK.COM>
References: <PN1PR0101MB1565F6502AF8CA8FE9E3E06CA3340@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<BY2PR02MB20378C8381AD633827882732E2340@BY2PR02MB2037.namprd02.prod.outlook.com>
	<BLUPR0201MB1889B9B407D22938B59ED116B0340@BLUPR0201MB1889.namprd02.prod.outlook.com>
	<BY2PR02MB2037FFD49230C6B498B0D35EE2340@BY2PR02MB2037.namprd02.prod.outlook.com>
	<PN1PR0101MB15651EE3174A2D040BB3AC5AA3350@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<PN1PR0101MB1565488BBCA00EE6E02B441FA30A0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<MA1PR0101MB155824EC66E0BBF4AA4235CEA30A0@MA1PR0101MB1558.INDPRD01.PROD.OUTLOOK.COM>
	<DM5PR0201MB36231D60D83A6D448BE67115F80B0@DM5PR0201MB3623.namprd02.prod.outlook.com>
	<CY1PR02MB20442B9F94B1E5A15A7F5E26E20B0@CY1PR02MB2044.namprd02.prod.outlook.com>
	<PN1PR0101MB156571D41BC08C9107D9C1B1A30E0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<MA1PR0101MB1558C054087ED8884393C4D0A30E0@MA1PR0101MB1558.INDPRD01.PROD.OUTLOOK.COM>
Message-ID: <DM5PR0201MB36235777FB5D60848418319CF80F0@DM5PR0201MB3623.namprd02.prod.outlook.com>

Hi Kedar,

Looks like a complicated situation to me. As far as I can see,


  1.  You should use log_level=5 to get more detailed logging
  2.  No the shared config shouldn't be the empty default template, this is an error
  3.  What you said about IP sounds suspicious, as one of the log file says "Failed to resolve icscf. to an IP address"

Must be frustrating to encounter errors everywhere. Shall we focus on the Sprout process and see why it fails. Would you please set log_level=5 in /etc/clearwater/user_settings on Sprout node and send a complete sprout_current.txt?


Thanks,
Ying



From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: 18 December 2017 14:00
To: clearwater at lists.projectclearwater.org
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

6 continued.

6-a. bono errors attached for log locations mentioned in troubleshooting page. I tried stopping bono service. It got started by monit but same errors continue.
6-b. sprout errors attached for log locations mentioned in troubleshooting page. Sprout service is not running, so didn't try to stop to let me restart by monit.
6-c. /var/log/ellis/ellis-err.log is empty.
        /var/log/ellis/ellis_<time>.txt has these entries INFO web.py:1447: 200 GET /ping (0.0.0.0) 0.53ms.
        I tried stopping ellis service. It got started by monit but don't see anything changed.
       /var/log/monit.log errors attached.

Appreciate any help here !

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Monday, December 18, 2017 11:34 AM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Adam, Ying,


  1.  When I said shared_config is empty on sprout instances, I wanted to say that no config statements in it.


[sprout]ubuntu at 1:/etc/clearwater$ more shared_config
#####################################################################
# No Shared Config has been provided
# Replace this file with the Shared Configuration for your deployment
#####################################################################


  1.  /var/log/sprout/sprout_current has these entries periodically.



UTC Status utils.cpp:607: Log level set to 2

UTC Status main.cpp:1618: Access logging enabled to /var/log/sprout

UTC Warning signalhandler.h:90: SIGNAL already hooked

UTC Warning main.cpp:1674: SAS server option was invalid or not configured - SAS is disabled

UTC Error main.cpp:1713: S/I-CSCF enabled with no Homestead server


  1.  So is it ok if only one node, that is going to push shared config to cluster (ellis in the heat based deployment), to have shared_config file with all the configuration and other nodes to have 'empty' file like above ?



  1.  PFA ellis's shared_config attached. I don't find any sproutlet related configuration there..OK ? I have attached tail of ellis's heat installation log. Looks ok to me. Couldn't find anything suspicious in remaining log file.



  1.  Btw, one thing I should have told this in the beginning - When I tried the heat templates as it is, I observed that DNS VM's IP was not being passed to all other components. So I ended up carving out DNS VM and instantiated that first and used its IP in env file. I could confirm that IP got used by heat instructions of other VMs and DNSMASQ on them got configured ok. nslookup for components' names also works ok. (may be we need to use wait condition in the heat template)



  1.  I am going through troubleshooting options and will update on that.

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Adam Lindley
Sent: Friday, December 15, 2017 11:51 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

As a few more pointers of where to look, our HEAT templates currently generate shared config on the Ellis node, and upload this to the cluster as a whole. It would be worth looking at the install log on the ellis node to see if there was some error there. You may have the shared_config file present, and be able to upload that to the etcd cluster to bring the deployment to life.
If that doesn't give you any joy, make sure that the template install process has completed successfully on each of your nodes. It seems odd that shared_config has not been generated, and so I'd want to sanity check that nothing else is going wrong. If all nodes are installed, but lacking config, you should be able to generate shared config based on the script in the ellis.yaml file.
As Ying has said, once those things are sorted, you can look in the process logs to see why you are hitting errors. Almost all of our components log to /var/log/<process_name> on their node, so that's a great place to start debugging. You may also find our troubleshooting guide helpful: https://clearwater.readthedocs.io/en/stable/Troubleshooting_and_Recovery.html

Cheers,
Adam

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Ying Huang
Sent: 15 December 2017 17:54
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Kedar,

Shared config shouldn't be empty. Looks like Sprout process has failed for some reason. It's worthwhile checking the sprout log under /var/sys/log/sprout/sprout_current or send it over to see what went wrong.

Thanks,
Ying

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: 14 December 2017 14:07
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

/etc/Clearwater/shared_config is empty on both the sprout instances post installation. Is this expected if I want to run sproutlets like ICSCF, SCSCF at least ?

Here are couple of commands I tried.

[sprout]ubuntu at 0:~$ sudo monit summary
Monit 5.18.1 uptime: 7h 12m
Service Name                     Status                      Type
node-0.sprout.me.cw-ngv.com      Running                     System
sprout_process                   Execution failed | Does...  Process
snmpd_process                    Running                     Process
ntp_process                      Running                     Process
nginx_process                    Running                     Process
memcached_process                Running                     Process
clearwater_queue_manager_pro...  Running                     Process
etcd_process                     Running                     Process
clearwater_diags_monitor_pro...  Running                     Process
clearwater_config_manager_pr...  Running                     Process
clearwater_cluster_manager_p...  Running                     Process
chronos_process                  Running                     Process
astaire_process                  Running                     Process
sprout_uptime                    Wait parent                 Program
poll_sprout_sip                  Wait parent                 Program
poll_sprout_http                 Wait parent                 Program
nginx_ping                       Status ok                   Program
nginx_uptime                     Status ok                   Program
monit_uptime                     Status ok                   Program
memcached_uptime                 Status ok                   Program
poll_memcached                   Status ok                   Program
clearwater_queue_manager_uptime  Status ok                   Program
etcd_uptime                      Status ok                   Program
poll_etcd_cluster                Status ok                   Program
poll_etcd                        Status ok                   Program
chronos_uptime                   Status ok                   Program
poll_chronos                     Status ok                   Program
astaire_uptime                   Status ok                   Program

[sprout]ubuntu at 0:~$ service sprout status
* sprout is not running
[sprout]ubuntu at 0:~$ sudo service sprout start
14-12-2017 14:06:17.215 UTC Status utils.cpp:496: Switching to daemon mode

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Thursday, December 14, 2017 12:29 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

I gave a try with release 127 ( repo URL  http://repo.cw-ngv.com/archive/repo127 in env file). But issues seem to be very same.


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Wednesday, December 13, 2017 12:30 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Adam, Mike,

Clearwater heat templates on ONAP wiki are put around July 13. Clearwater release 127, which is released on May 30th , seems to have been used for testing these templates.

If I want to give a try with release 127 installation via heat, how to do that ? I tried URL http://repo.cw-ngv.com/release-127/binary/Packages in browser, but got 404.

From: Kedar Ambekar
Sent: Wednesday, December 13, 2017 11:37 AM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: RE: 502 Bad Gateway and other errors while running live tests

Hi Adam,

Got the point. I had suspected the same.
I have repo_url http://repo.cw-ngv.com/stable in heat's env file.

Is it possible to use same release on which ONAP's heat templates are based, may be by changing this repo URL?

I will have a look at current heat template on Clearwater GitHub but I think those won't be ONAP compatible.

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Adam Lindley
Sent: Tuesday, December 12, 2017 10:50 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Do you know which release you based the templates on?
We should be able to take a look over our release notes between then and now, which should give a reasonable view of the changes, and then we can go from there. Equally, the commit history (https://github.com/Metaswitch/clearwater-heat/commits/stable) gives a fairly clear overview of what and why, with the pull requests adding a bit more detail.

Though as we're likely to hit similar problems in future as we continue to develop Project Clearwater and our heat templates. Are the ONAP changes something we could be pulling in to the main code base? I'd be interested to know the extent of the work needed to keep them running

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Mike Evans
Sent: 12 December 2017 17:00
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Adam

I put the ONAP templates together, so I'm happy to update them if they won't work with the latest Project Clearwater code.  Is there anywhere I can look for an explanation of the changes?

Mike

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Adam Lindley
Sent: 12 December 2017 16:41
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Kedar,

I've just had a look around for the templates on the ONAP wiki; I wasn't aware they had their own copies of them.
I found https://wiki.onap.org/display/DW/Clearwater+vIMS+Onboarding+and+Instantiation . Is this what you've been working from?

When deploying with the templates, have you been specifying a "repo_url" option in the arguments? The Clearwater HEAT templates included steps to install the Clearwater packages from our public stable repo by default, but the templates on the ONAP wiki are now somewhat out of date. If you haven't specified a repo containing packages from the same point in time the templates were effectively forked, you're going to be hitting conflicts between the code version, and the orchestration steps.

I am not sure what differences there need to be for templates to run on ONAP, but I can point you towards our current set of heat templates: https://github.com/Metaswitch/clearwater-heat/tree/stable . I would suggest you try redeploying with these templates, as a fair number of things have changed in the code since the templates on the wiki were valid. If you hit any issues, do let us know.

Cheers,
Adam


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: 12 December 2017 13:46
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

I have installed Clearwater with heat templates (available on ONAP wiki) directly on openstack. Appreciate help on below issues.


  1.  When I run Clearwater live tests, all tests fail with below  error.



RuntimeError thrown:

   - Account creation failed with HTTP code 502, body {"status": 502, "message": "Bad Gateway", "reason": "Upstream request failed", "detail": {"Upstream error": "599", "Upstream URL": "None"}, "error": true}



  1.  ps for bono process shows this.



[bono]ubuntu at 0:/etc/clearwater$ ps -ef |grep bono

bono 6897 1 0 05:06 ? 00:00:11 /usr/share/clearwater/bin/bono --domain= --localhost=10.0.0.28,0.bono.me.cw-ngv.com --al ias=10.0.0.28,0.bono.me.cw-ngv.com, --pcscf=5060,5058 --webrtc-port=5062 --routing-proxy=icscf.,5052,50,600 --sas=0.0.0.0,bono at 0.bono.me.cw-ngv.com --dns-server=127.0.0.1 --worker-threads=2 --analytics=/var/log/bono --log-file=/var/log/bono --log-level=2 --daemon --pidfile=/var/run/bono/bono.pid



  1.  In bono, I saw these logs.

 UTC Error sip_connection_pool.cpp:190: Failed to resolve icscf. to an IP address - Not found (PJ_ENOTFOUND)

UTC Warning dnscachedresolver.cpp:828: Failed to retrieve record for icscf.: Domain name not found



  1.  To debug above issues, I ended up making these changes in /etc/init.d/bono and restarted bono service.



DAEMON_ARGS="--domain=me.cw-ngv.com  (instead of -domain=$home_domain)

upstream_hostname=icscf.sprout.me.cw-ngv.com (instead of upstream_hostname=icscf.$sprout_hostname)


  1.  But now, I get below error in bono. Port 5052 is not in listen mode on sprout.

UTC Warning pjsip: tcpc0x7f90cc07 TCP connect() error: Connection refused [code=120111]
UTC Warning pjsip: tcpc0x7f90cc07 Unable to connect to <sprout ip>:5052
============================================================================================================================
Disclaimer:  This message and the information contained herein is proprietary and confidential and subject to the Tech Mahindra policy statement, you may review the policy at http://www.techmahindra.com/Disclaimer.html externally http://tim.techmahindra.com/tim/disclaimer.html internally within TechMahindra.
============================================================================================================================
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20171219/abe06e1c/attachment.html>

From akedar at TechMahindra.com  Wed Dec 20 00:00:07 2017
From: akedar at TechMahindra.com (Kedar Ambekar)
Date: Wed, 20 Dec 2017 05:00:07 +0000
Subject: [Project Clearwater] 502 Bad Gateway and other errors while
 running live tests
In-Reply-To: <DM5PR0201MB36235777FB5D60848418319CF80F0@DM5PR0201MB3623.namprd02.prod.outlook.com>
References: <PN1PR0101MB1565F6502AF8CA8FE9E3E06CA3340@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<BY2PR02MB20378C8381AD633827882732E2340@BY2PR02MB2037.namprd02.prod.outlook.com>
	<BLUPR0201MB1889B9B407D22938B59ED116B0340@BLUPR0201MB1889.namprd02.prod.outlook.com>
	<BY2PR02MB2037FFD49230C6B498B0D35EE2340@BY2PR02MB2037.namprd02.prod.outlook.com>
	<PN1PR0101MB15651EE3174A2D040BB3AC5AA3350@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<PN1PR0101MB1565488BBCA00EE6E02B441FA30A0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<MA1PR0101MB155824EC66E0BBF4AA4235CEA30A0@MA1PR0101MB1558.INDPRD01.PROD.OUTLOOK.COM>
	<DM5PR0201MB36231D60D83A6D448BE67115F80B0@DM5PR0201MB3623.namprd02.prod.outlook.com>
	<CY1PR02MB20442B9F94B1E5A15A7F5E26E20B0@CY1PR02MB2044.namprd02.prod.outlook.com>
	<PN1PR0101MB156571D41BC08C9107D9C1B1A30E0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<MA1PR0101MB1558C054087ED8884393C4D0A30E0@MA1PR0101MB1558.INDPRD01.PROD.OUTLOOK.COM>
	<DM5PR0201MB36235777FB5D60848418319CF80F0@DM5PR0201MB3623.namprd02.prod.outlook.com>
Message-ID: <PN1PR0101MB15653F5A90DA1B487F813570A30C0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>

Hi Ying,

After changing log level to 5 on sprout, we need to restart sprout service, right ?
In my case, sprout service is not running.

I guess for this, I need to change the heat template to create user_settings file with log level 5.

[sprout]ubuntu at 0:/var/log/sprout$ service sprout status
* sprout is not running

[sprout]ubuntu at 0:/var/log/sprout$ ps -ef |grep sprout
ubuntu    8475  7053  0 04:53 pts/5    00:00:00 grep --color=auto sprout
root     10876     1  0 Dec18 ?        00:04:44 /usr/share/clearwater/clearwater-queue-manager/env/bin/python /usr/share/clearwater/bin/clearwater-queue-manager --local-ip=10.0.0.26 --local-site=site1 --log-level=3 --log-directory=/var/log/clearwater-queue-manager --pidfile=/var/run/clearwater-queue-manager.pid --etcd-key=clearwater --node-type=sprout --wait-plugin-complete=Y
root     11042     1  0 Dec18 ?        00:04:41 /usr/share/clearwater/clearwater-cluster-manager/env/bin/python /usr/share/clearwater/bin/clearwater-cluster-manager --mgmt-local-ip=10.0.0.26 --sig-local-ip=10.0.0.26 --local-site=site1 --remote-site= --remote-cassandra-seeds= --signaling-namespace= --uuid=535133a6-cb33-44b0-9a36-9da6e47ae280 --etcd-key=clearwater --etcd-cluster-key=sprout --cluster-manager-enabled=Y --log-level=3 --log-directory=/var/log/clearwater-cluster-manager --pidfile=/var/run/clearwater-cluster-manager.pid



From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Ying Huang
Sent: Wednesday, December 20, 2017 12:15 AM
To: clearwater at lists.projectclearwater.org
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Kedar,

Looks like a complicated situation to me. As far as I can see,


  1.  You should use log_level=5 to get more detailed logging
  2.  No the shared config shouldn't be the empty default template, this is an error
  3.  What you said about IP sounds suspicious, as one of the log file says "Failed to resolve icscf. to an IP address"

Must be frustrating to encounter errors everywhere. Shall we focus on the Sprout process and see why it fails. Would you please set log_level=5 in /etc/clearwater/user_settings on Sprout node and send a complete sprout_current.txt?


Thanks,
Ying



From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: 18 December 2017 14:00
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

6 continued.

6-a. bono errors attached for log locations mentioned in troubleshooting page. I tried stopping bono service. It got started by monit but same errors continue.
6-b. sprout errors attached for log locations mentioned in troubleshooting page. Sprout service is not running, so didn't try to stop to let me restart by monit.
6-c. /var/log/ellis/ellis-err.log is empty.
        /var/log/ellis/ellis_<time>.txt has these entries INFO web.py:1447: 200 GET /ping (0.0.0.0) 0.53ms.
        I tried stopping ellis service. It got started by monit but don't see anything changed.
       /var/log/monit.log errors attached.

Appreciate any help here !

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Monday, December 18, 2017 11:34 AM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Adam, Ying,


  1.  When I said shared_config is empty on sprout instances, I wanted to say that no config statements in it.


[sprout]ubuntu at 1:/etc/clearwater$ more shared_config
#####################################################################
# No Shared Config has been provided
# Replace this file with the Shared Configuration for your deployment
#####################################################################


  1.  /var/log/sprout/sprout_current has these entries periodically.



UTC Status utils.cpp:607: Log level set to 2

UTC Status main.cpp:1618: Access logging enabled to /var/log/sprout

UTC Warning signalhandler.h:90: SIGNAL already hooked

UTC Warning main.cpp:1674: SAS server option was invalid or not configured - SAS is disabled

UTC Error main.cpp:1713: S/I-CSCF enabled with no Homestead server


  1.  So is it ok if only one node, that is going to push shared config to cluster (ellis in the heat based deployment), to have shared_config file with all the configuration and other nodes to have 'empty' file like above ?



  1.  PFA ellis's shared_config attached. I don't find any sproutlet related configuration there..OK ? I have attached tail of ellis's heat installation log. Looks ok to me. Couldn't find anything suspicious in remaining log file.



  1.  Btw, one thing I should have told this in the beginning - When I tried the heat templates as it is, I observed that DNS VM's IP was not being passed to all other components. So I ended up carving out DNS VM and instantiated that first and used its IP in env file. I could confirm that IP got used by heat instructions of other VMs and DNSMASQ on them got configured ok. nslookup for components' names also works ok. (may be we need to use wait condition in the heat template)



  1.  I am going through troubleshooting options and will update on that.

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Adam Lindley
Sent: Friday, December 15, 2017 11:51 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

As a few more pointers of where to look, our HEAT templates currently generate shared config on the Ellis node, and upload this to the cluster as a whole. It would be worth looking at the install log on the ellis node to see if there was some error there. You may have the shared_config file present, and be able to upload that to the etcd cluster to bring the deployment to life.
If that doesn't give you any joy, make sure that the template install process has completed successfully on each of your nodes. It seems odd that shared_config has not been generated, and so I'd want to sanity check that nothing else is going wrong. If all nodes are installed, but lacking config, you should be able to generate shared config based on the script in the ellis.yaml file.
As Ying has said, once those things are sorted, you can look in the process logs to see why you are hitting errors. Almost all of our components log to /var/log/<process_name> on their node, so that's a great place to start debugging. You may also find our troubleshooting guide helpful: https://clearwater.readthedocs.io/en/stable/Troubleshooting_and_Recovery.html

Cheers,
Adam

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Ying Huang
Sent: 15 December 2017 17:54
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Kedar,

Shared config shouldn't be empty. Looks like Sprout process has failed for some reason. It's worthwhile checking the sprout log under /var/sys/log/sprout/sprout_current or send it over to see what went wrong.

Thanks,
Ying

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: 14 December 2017 14:07
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

/etc/Clearwater/shared_config is empty on both the sprout instances post installation. Is this expected if I want to run sproutlets like ICSCF, SCSCF at least ?

Here are couple of commands I tried.

[sprout]ubuntu at 0:~$ sudo monit summary
Monit 5.18.1 uptime: 7h 12m
Service Name                     Status                      Type
node-0.sprout.me.cw-ngv.com      Running                     System
sprout_process                   Execution failed | Does...  Process
snmpd_process                    Running                     Process
ntp_process                      Running                     Process
nginx_process                    Running                     Process
memcached_process                Running                     Process
clearwater_queue_manager_pro...  Running                     Process
etcd_process                     Running                     Process
clearwater_diags_monitor_pro...  Running                     Process
clearwater_config_manager_pr...  Running                     Process
clearwater_cluster_manager_p...  Running                     Process
chronos_process                  Running                     Process
astaire_process                  Running                     Process
sprout_uptime                    Wait parent                 Program
poll_sprout_sip                  Wait parent                 Program
poll_sprout_http                 Wait parent                 Program
nginx_ping                       Status ok                   Program
nginx_uptime                     Status ok                   Program
monit_uptime                     Status ok                   Program
memcached_uptime                 Status ok                   Program
poll_memcached                   Status ok                   Program
clearwater_queue_manager_uptime  Status ok                   Program
etcd_uptime                      Status ok                   Program
poll_etcd_cluster                Status ok                   Program
poll_etcd                        Status ok                   Program
chronos_uptime                   Status ok                   Program
poll_chronos                     Status ok                   Program
astaire_uptime                   Status ok                   Program

[sprout]ubuntu at 0:~$ service sprout status
* sprout is not running
[sprout]ubuntu at 0:~$ sudo service sprout start
14-12-2017 14:06:17.215 UTC Status utils.cpp:496: Switching to daemon mode

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Thursday, December 14, 2017 12:29 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

I gave a try with release 127 ( repo URL  http://repo.cw-ngv.com/archive/repo127 in env file). But issues seem to be very same.


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Wednesday, December 13, 2017 12:30 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Adam, Mike,

Clearwater heat templates on ONAP wiki are put around July 13. Clearwater release 127, which is released on May 30th , seems to have been used for testing these templates.

If I want to give a try with release 127 installation via heat, how to do that ? I tried URL http://repo.cw-ngv.com/release-127/binary/Packages in browser, but got 404.

From: Kedar Ambekar
Sent: Wednesday, December 13, 2017 11:37 AM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: RE: 502 Bad Gateway and other errors while running live tests

Hi Adam,

Got the point. I had suspected the same.
I have repo_url http://repo.cw-ngv.com/stable in heat's env file.

Is it possible to use same release on which ONAP's heat templates are based, may be by changing this repo URL?

I will have a look at current heat template on Clearwater GitHub but I think those won't be ONAP compatible.

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Adam Lindley
Sent: Tuesday, December 12, 2017 10:50 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Do you know which release you based the templates on?
We should be able to take a look over our release notes between then and now, which should give a reasonable view of the changes, and then we can go from there. Equally, the commit history (https://github.com/Metaswitch/clearwater-heat/commits/stable) gives a fairly clear overview of what and why, with the pull requests adding a bit more detail.

Though as we're likely to hit similar problems in future as we continue to develop Project Clearwater and our heat templates. Are the ONAP changes something we could be pulling in to the main code base? I'd be interested to know the extent of the work needed to keep them running

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Mike Evans
Sent: 12 December 2017 17:00
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Adam

I put the ONAP templates together, so I'm happy to update them if they won't work with the latest Project Clearwater code.  Is there anywhere I can look for an explanation of the changes?

Mike

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Adam Lindley
Sent: 12 December 2017 16:41
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Kedar,

I've just had a look around for the templates on the ONAP wiki; I wasn't aware they had their own copies of them.
I found https://wiki.onap.org/display/DW/Clearwater+vIMS+Onboarding+and+Instantiation . Is this what you've been working from?

When deploying with the templates, have you been specifying a "repo_url" option in the arguments? The Clearwater HEAT templates included steps to install the Clearwater packages from our public stable repo by default, but the templates on the ONAP wiki are now somewhat out of date. If you haven't specified a repo containing packages from the same point in time the templates were effectively forked, you're going to be hitting conflicts between the code version, and the orchestration steps.

I am not sure what differences there need to be for templates to run on ONAP, but I can point you towards our current set of heat templates: https://github.com/Metaswitch/clearwater-heat/tree/stable . I would suggest you try redeploying with these templates, as a fair number of things have changed in the code since the templates on the wiki were valid. If you hit any issues, do let us know.

Cheers,
Adam


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: 12 December 2017 13:46
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

I have installed Clearwater with heat templates (available on ONAP wiki) directly on openstack. Appreciate help on below issues.


  1.  When I run Clearwater live tests, all tests fail with below  error.



RuntimeError thrown:

   - Account creation failed with HTTP code 502, body {"status": 502, "message": "Bad Gateway", "reason": "Upstream request failed", "detail": {"Upstream error": "599", "Upstream URL": "None"}, "error": true}



  1.  ps for bono process shows this.



[bono]ubuntu at 0:/etc/clearwater$ ps -ef |grep bono

bono 6897 1 0 05:06 ? 00:00:11 /usr/share/clearwater/bin/bono --domain= --localhost=10.0.0.28,0.bono.me.cw-ngv.com --al ias=10.0.0.28,0.bono.me.cw-ngv.com, --pcscf=5060,5058 --webrtc-port=5062 --routing-proxy=icscf.,5052,50,600 --sas=0.0.0.0,bono at 0.bono.me.cw-ngv.com --dns-server=127.0.0.1 --worker-threads=2 --analytics=/var/log/bono --log-file=/var/log/bono --log-level=2 --daemon --pidfile=/var/run/bono/bono.pid



  1.  In bono, I saw these logs.

 UTC Error sip_connection_pool.cpp:190: Failed to resolve icscf. to an IP address - Not found (PJ_ENOTFOUND)

UTC Warning dnscachedresolver.cpp:828: Failed to retrieve record for icscf.: Domain name not found



  1.  To debug above issues, I ended up making these changes in /etc/init.d/bono and restarted bono service.



DAEMON_ARGS="--domain=me.cw-ngv.com  (instead of -domain=$home_domain)

upstream_hostname=icscf.sprout.me.cw-ngv.com (instead of upstream_hostname=icscf.$sprout_hostname)


  1.  But now, I get below error in bono. Port 5052 is not in listen mode on sprout.

UTC Warning pjsip: tcpc0x7f90cc07 TCP connect() error: Connection refused [code=120111]
UTC Warning pjsip: tcpc0x7f90cc07 Unable to connect to <sprout ip>:5052
============================================================================================================================
Disclaimer:  This message and the information contained herein is proprietary and confidential and subject to the Tech Mahindra policy statement, you may review the policy at http://www.techmahindra.com/Disclaimer.html externally http://tim.techmahindra.com/tim/disclaimer.html internally within TechMahindra.
============================================================================================================================
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20171220/eb73863d/attachment.html>

From akedar at TechMahindra.com  Wed Dec 20 06:26:30 2017
From: akedar at TechMahindra.com (Kedar Ambekar)
Date: Wed, 20 Dec 2017 11:26:30 +0000
Subject: [Project Clearwater] 502 Bad Gateway and other errors while
 running live tests
In-Reply-To: <PN1PR0101MB15653F5A90DA1B487F813570A30C0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
References: <PN1PR0101MB1565F6502AF8CA8FE9E3E06CA3340@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<BY2PR02MB20378C8381AD633827882732E2340@BY2PR02MB2037.namprd02.prod.outlook.com>
	<BLUPR0201MB1889B9B407D22938B59ED116B0340@BLUPR0201MB1889.namprd02.prod.outlook.com>
	<BY2PR02MB2037FFD49230C6B498B0D35EE2340@BY2PR02MB2037.namprd02.prod.outlook.com>
	<PN1PR0101MB15651EE3174A2D040BB3AC5AA3350@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<PN1PR0101MB1565488BBCA00EE6E02B441FA30A0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<MA1PR0101MB155824EC66E0BBF4AA4235CEA30A0@MA1PR0101MB1558.INDPRD01.PROD.OUTLOOK.COM>
	<DM5PR0201MB36231D60D83A6D448BE67115F80B0@DM5PR0201MB3623.namprd02.prod.outlook.com>
	<CY1PR02MB20442B9F94B1E5A15A7F5E26E20B0@CY1PR02MB2044.namprd02.prod.outlook.com>
	<PN1PR0101MB156571D41BC08C9107D9C1B1A30E0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<MA1PR0101MB1558C054087ED8884393C4D0A30E0@MA1PR0101MB1558.INDPRD01.PROD.OUTLOOK.COM>
	<DM5PR0201MB36235777FB5D60848418319CF80F0@DM5PR0201MB3623.namprd02.prod.outlook.com>
	<PN1PR0101MB15653F5A90DA1B487F813570A30C0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
Message-ID: <PN1PR0101MB15656562DD59866E054E0593A30C0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>

Hi,

I have attached sprout_current.txt, which has some debug statements . I think that is giving some pointers.

My guess is /etc/clearwater/local_config (or some other appropriate config file) should have variables set for hostnames which are referred while composing these URLs.
e.g sip:scscf.;transport=TCP should be sip:scscf.<hostname<sip:scscf.%3chostname> of scscf>;transport=TCP

I will try is this direction..

Debug utils.cpp:405: Malformed host/port
Debug utils.cpp:405: Malformed host/port
Info main.cpp:1265: Sprout hostname set to
Info main.cpp:1243: S-CSCF node URI set to
Info main.cpp:1851: scscf enabled on 5054
Info main.cpp:1851: scscf prefix set to scscf
Info main.cpp:1851: scscf uri set to sip:scscf.;transport=TCP
Info main.cpp:1851: icscf enabled on 5052
Info main.cpp:1851: icscf prefix set to icscf
Info main.cpp:1851: icscf uri set to sip:icscf.;transport=TCP
Info main.cpp:1851: memento prefix set to memento
Info main.cpp:1851: memento uri set to sip:memento.;transport=TCP
Info main.cpp:1851: mangelwurzel prefix set to mangelwurzel
Info main.cpp:1851: mangelwurzel uri set to sip:mangelwurzel.;transport=TCP
Info main.cpp:1851: gemini prefix set to gemini
Info main.cpp:1851: gemini uri set to sip:gemini.;transport=TCP
Info main.cpp:1851: cdiv prefix set to cdiv
Info main.cpp:1851: cdiv uri set to sip:cdiv.;transport=TCP
Info main.cpp:1851: mmtel enabled on 5055
Info main.cpp:1851: mmtel prefix set to mmtel
Info main.cpp:1851: mmtel uri set to sip:mmtel.;transport=TCP
Info main.cpp:1851: bgcf enabled on 5053
Info main.cpp:1851: bgcf prefix set to bgcf
Info main.cpp:1851: bgcf uri set to sip:bgcf.;transport=TCP
Warning main.cpp:1855: SAS server option was invalid or not configured - SAS is disabled
Error main.cpp:1894: S/I-CSCF enabled with no Homestead server


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Wednesday, December 20, 2017 10:30 AM
To: clearwater at lists.projectclearwater.org
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Ying,

After changing log level to 5 on sprout, we need to restart sprout service, right ?
In my case, sprout service is not running.

I guess for this, I need to change the heat template to create user_settings file with log level 5.

[sprout]ubuntu at 0:/var/log/sprout$ service sprout status
* sprout is not running

[sprout]ubuntu at 0:/var/log/sprout$ ps -ef |grep sprout
ubuntu    8475  7053  0 04:53 pts/5    00:00:00 grep --color=auto sprout
root     10876     1  0 Dec18 ?        00:04:44 /usr/share/clearwater/clearwater-queue-manager/env/bin/python /usr/share/clearwater/bin/clearwater-queue-manager --local-ip=10.0.0.26 --local-site=site1 --log-level=3 --log-directory=/var/log/clearwater-queue-manager --pidfile=/var/run/clearwater-queue-manager.pid --etcd-key=clearwater --node-type=sprout --wait-plugin-complete=Y
root     11042     1  0 Dec18 ?        00:04:41 /usr/share/clearwater/clearwater-cluster-manager/env/bin/python /usr/share/clearwater/bin/clearwater-cluster-manager --mgmt-local-ip=10.0.0.26 --sig-local-ip=10.0.0.26 --local-site=site1 --remote-site= --remote-cassandra-seeds= --signaling-namespace= --uuid=535133a6-cb33-44b0-9a36-9da6e47ae280 --etcd-key=clearwater --etcd-cluster-key=sprout --cluster-manager-enabled=Y --log-level=3 --log-directory=/var/log/clearwater-cluster-manager --pidfile=/var/run/clearwater-cluster-manager.pid



From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Ying Huang
Sent: Wednesday, December 20, 2017 12:15 AM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Kedar,

Looks like a complicated situation to me. As far as I can see,


  1.  You should use log_level=5 to get more detailed logging
  2.  No the shared config shouldn't be the empty default template, this is an error
  3.  What you said about IP sounds suspicious, as one of the log file says "Failed to resolve icscf. to an IP address"

Must be frustrating to encounter errors everywhere. Shall we focus on the Sprout process and see why it fails. Would you please set log_level=5 in /etc/clearwater/user_settings on Sprout node and send a complete sprout_current.txt?


Thanks,
Ying



From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: 18 December 2017 14:00
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

6 continued.

6-a. bono errors attached for log locations mentioned in troubleshooting page. I tried stopping bono service. It got started by monit but same errors continue.
6-b. sprout errors attached for log locations mentioned in troubleshooting page. Sprout service is not running, so didn't try to stop to let me restart by monit.
6-c. /var/log/ellis/ellis-err.log is empty.
        /var/log/ellis/ellis_<time>.txt has these entries INFO web.py:1447: 200 GET /ping (0.0.0.0) 0.53ms.
        I tried stopping ellis service. It got started by monit but don't see anything changed.
       /var/log/monit.log errors attached.

Appreciate any help here !

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Monday, December 18, 2017 11:34 AM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Adam, Ying,


  1.  When I said shared_config is empty on sprout instances, I wanted to say that no config statements in it.


[sprout]ubuntu at 1:/etc/clearwater$ more shared_config
#####################################################################
# No Shared Config has been provided
# Replace this file with the Shared Configuration for your deployment
#####################################################################


  1.  /var/log/sprout/sprout_current has these entries periodically.



UTC Status utils.cpp:607: Log level set to 2

UTC Status main.cpp:1618: Access logging enabled to /var/log/sprout

UTC Warning signalhandler.h:90: SIGNAL already hooked

UTC Warning main.cpp:1674: SAS server option was invalid or not configured - SAS is disabled

UTC Error main.cpp:1713: S/I-CSCF enabled with no Homestead server


  1.  So is it ok if only one node, that is going to push shared config to cluster (ellis in the heat based deployment), to have shared_config file with all the configuration and other nodes to have 'empty' file like above ?



  1.  PFA ellis's shared_config attached. I don't find any sproutlet related configuration there..OK ? I have attached tail of ellis's heat installation log. Looks ok to me. Couldn't find anything suspicious in remaining log file.



  1.  Btw, one thing I should have told this in the beginning - When I tried the heat templates as it is, I observed that DNS VM's IP was not being passed to all other components. So I ended up carving out DNS VM and instantiated that first and used its IP in env file. I could confirm that IP got used by heat instructions of other VMs and DNSMASQ on them got configured ok. nslookup for components' names also works ok. (may be we need to use wait condition in the heat template)



  1.  I am going through troubleshooting options and will update on that.

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Adam Lindley
Sent: Friday, December 15, 2017 11:51 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

As a few more pointers of where to look, our HEAT templates currently generate shared config on the Ellis node, and upload this to the cluster as a whole. It would be worth looking at the install log on the ellis node to see if there was some error there. You may have the shared_config file present, and be able to upload that to the etcd cluster to bring the deployment to life.
If that doesn't give you any joy, make sure that the template install process has completed successfully on each of your nodes. It seems odd that shared_config has not been generated, and so I'd want to sanity check that nothing else is going wrong. If all nodes are installed, but lacking config, you should be able to generate shared config based on the script in the ellis.yaml file.
As Ying has said, once those things are sorted, you can look in the process logs to see why you are hitting errors. Almost all of our components log to /var/log/<process_name> on their node, so that's a great place to start debugging. You may also find our troubleshooting guide helpful: https://clearwater.readthedocs.io/en/stable/Troubleshooting_and_Recovery.html

Cheers,
Adam

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Ying Huang
Sent: 15 December 2017 17:54
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Kedar,

Shared config shouldn't be empty. Looks like Sprout process has failed for some reason. It's worthwhile checking the sprout log under /var/sys/log/sprout/sprout_current or send it over to see what went wrong.

Thanks,
Ying

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: 14 December 2017 14:07
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

/etc/Clearwater/shared_config is empty on both the sprout instances post installation. Is this expected if I want to run sproutlets like ICSCF, SCSCF at least ?

Here are couple of commands I tried.

[sprout]ubuntu at 0:~$ sudo monit summary
Monit 5.18.1 uptime: 7h 12m
Service Name                     Status                      Type
node-0.sprout.me.cw-ngv.com      Running                     System
sprout_process                   Execution failed | Does...  Process
snmpd_process                    Running                     Process
ntp_process                      Running                     Process
nginx_process                    Running                     Process
memcached_process                Running                     Process
clearwater_queue_manager_pro...  Running                     Process
etcd_process                     Running                     Process
clearwater_diags_monitor_pro...  Running                     Process
clearwater_config_manager_pr...  Running                     Process
clearwater_cluster_manager_p...  Running                     Process
chronos_process                  Running                     Process
astaire_process                  Running                     Process
sprout_uptime                    Wait parent                 Program
poll_sprout_sip                  Wait parent                 Program
poll_sprout_http                 Wait parent                 Program
nginx_ping                       Status ok                   Program
nginx_uptime                     Status ok                   Program
monit_uptime                     Status ok                   Program
memcached_uptime                 Status ok                   Program
poll_memcached                   Status ok                   Program
clearwater_queue_manager_uptime  Status ok                   Program
etcd_uptime                      Status ok                   Program
poll_etcd_cluster                Status ok                   Program
poll_etcd                        Status ok                   Program
chronos_uptime                   Status ok                   Program
poll_chronos                     Status ok                   Program
astaire_uptime                   Status ok                   Program

[sprout]ubuntu at 0:~$ service sprout status
* sprout is not running
[sprout]ubuntu at 0:~$ sudo service sprout start
14-12-2017 14:06:17.215 UTC Status utils.cpp:496: Switching to daemon mode

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Thursday, December 14, 2017 12:29 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

I gave a try with release 127 ( repo URL  http://repo.cw-ngv.com/archive/repo127 in env file). But issues seem to be very same.


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Wednesday, December 13, 2017 12:30 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Adam, Mike,

Clearwater heat templates on ONAP wiki are put around July 13. Clearwater release 127, which is released on May 30th , seems to have been used for testing these templates.

If I want to give a try with release 127 installation via heat, how to do that ? I tried URL http://repo.cw-ngv.com/release-127/binary/Packages in browser, but got 404.

From: Kedar Ambekar
Sent: Wednesday, December 13, 2017 11:37 AM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: RE: 502 Bad Gateway and other errors while running live tests

Hi Adam,

Got the point. I had suspected the same.
I have repo_url http://repo.cw-ngv.com/stable in heat's env file.

Is it possible to use same release on which ONAP's heat templates are based, may be by changing this repo URL?

I will have a look at current heat template on Clearwater GitHub but I think those won't be ONAP compatible.

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Adam Lindley
Sent: Tuesday, December 12, 2017 10:50 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Do you know which release you based the templates on?
We should be able to take a look over our release notes between then and now, which should give a reasonable view of the changes, and then we can go from there. Equally, the commit history (https://github.com/Metaswitch/clearwater-heat/commits/stable) gives a fairly clear overview of what and why, with the pull requests adding a bit more detail.

Though as we're likely to hit similar problems in future as we continue to develop Project Clearwater and our heat templates. Are the ONAP changes something we could be pulling in to the main code base? I'd be interested to know the extent of the work needed to keep them running

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Mike Evans
Sent: 12 December 2017 17:00
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Adam

I put the ONAP templates together, so I'm happy to update them if they won't work with the latest Project Clearwater code.  Is there anywhere I can look for an explanation of the changes?

Mike

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Adam Lindley
Sent: 12 December 2017 16:41
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Kedar,

I've just had a look around for the templates on the ONAP wiki; I wasn't aware they had their own copies of them.
I found https://wiki.onap.org/display/DW/Clearwater+vIMS+Onboarding+and+Instantiation . Is this what you've been working from?

When deploying with the templates, have you been specifying a "repo_url" option in the arguments? The Clearwater HEAT templates included steps to install the Clearwater packages from our public stable repo by default, but the templates on the ONAP wiki are now somewhat out of date. If you haven't specified a repo containing packages from the same point in time the templates were effectively forked, you're going to be hitting conflicts between the code version, and the orchestration steps.

I am not sure what differences there need to be for templates to run on ONAP, but I can point you towards our current set of heat templates: https://github.com/Metaswitch/clearwater-heat/tree/stable . I would suggest you try redeploying with these templates, as a fair number of things have changed in the code since the templates on the wiki were valid. If you hit any issues, do let us know.

Cheers,
Adam


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: 12 December 2017 13:46
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

I have installed Clearwater with heat templates (available on ONAP wiki) directly on openstack. Appreciate help on below issues.


  1.  When I run Clearwater live tests, all tests fail with below  error.



RuntimeError thrown:

   - Account creation failed with HTTP code 502, body {"status": 502, "message": "Bad Gateway", "reason": "Upstream request failed", "detail": {"Upstream error": "599", "Upstream URL": "None"}, "error": true}



  1.  ps for bono process shows this.



[bono]ubuntu at 0:/etc/clearwater$ ps -ef |grep bono

bono 6897 1 0 05:06 ? 00:00:11 /usr/share/clearwater/bin/bono --domain= --localhost=10.0.0.28,0.bono.me.cw-ngv.com --al ias=10.0.0.28,0.bono.me.cw-ngv.com, --pcscf=5060,5058 --webrtc-port=5062 --routing-proxy=icscf.,5052,50,600 --sas=0.0.0.0,bono at 0.bono.me.cw-ngv.com --dns-server=127.0.0.1 --worker-threads=2 --analytics=/var/log/bono --log-file=/var/log/bono --log-level=2 --daemon --pidfile=/var/run/bono/bono.pid



  1.  In bono, I saw these logs.

 UTC Error sip_connection_pool.cpp:190: Failed to resolve icscf. to an IP address - Not found (PJ_ENOTFOUND)

UTC Warning dnscachedresolver.cpp:828: Failed to retrieve record for icscf.: Domain name not found



  1.  To debug above issues, I ended up making these changes in /etc/init.d/bono and restarted bono service.



DAEMON_ARGS="--domain=me.cw-ngv.com  (instead of -domain=$home_domain)

upstream_hostname=icscf.sprout.me.cw-ngv.com (instead of upstream_hostname=icscf.$sprout_hostname)


  1.  But now, I get below error in bono. Port 5052 is not in listen mode on sprout.

UTC Warning pjsip: tcpc0x7f90cc07 TCP connect() error: Connection refused [code=120111]
UTC Warning pjsip: tcpc0x7f90cc07 Unable to connect to <sprout ip>:5052
============================================================================================================================
Disclaimer:  This message and the information contained herein is proprietary and confidential and subject to the Tech Mahindra policy statement, you may review the policy at http://www.techmahindra.com/Disclaimer.html externally http://tim.techmahindra.com/tim/disclaimer.html internally within TechMahindra.
============================================================================================================================
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20171220/4b6997c8/attachment.html>
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: sprout_current.txt
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20171220/4b6997c8/attachment.txt>

From Ying.Huang at metaswitch.com  Wed Dec 20 06:43:20 2017
From: Ying.Huang at metaswitch.com (Ying Huang)
Date: Wed, 20 Dec 2017 11:43:20 +0000
Subject: [Project Clearwater] 502 Bad Gateway and other errors while
 running live tests
In-Reply-To: <PN1PR0101MB15656562DD59866E054E0593A30C0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
References: <PN1PR0101MB1565F6502AF8CA8FE9E3E06CA3340@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<BY2PR02MB20378C8381AD633827882732E2340@BY2PR02MB2037.namprd02.prod.outlook.com>
	<BLUPR0201MB1889B9B407D22938B59ED116B0340@BLUPR0201MB1889.namprd02.prod.outlook.com>
	<BY2PR02MB2037FFD49230C6B498B0D35EE2340@BY2PR02MB2037.namprd02.prod.outlook.com>
	<PN1PR0101MB15651EE3174A2D040BB3AC5AA3350@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<PN1PR0101MB1565488BBCA00EE6E02B441FA30A0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<MA1PR0101MB155824EC66E0BBF4AA4235CEA30A0@MA1PR0101MB1558.INDPRD01.PROD.OUTLOOK.COM>
	<DM5PR0201MB36231D60D83A6D448BE67115F80B0@DM5PR0201MB3623.namprd02.prod.outlook.com>
	<CY1PR02MB20442B9F94B1E5A15A7F5E26E20B0@CY1PR02MB2044.namprd02.prod.outlook.com>
	<PN1PR0101MB156571D41BC08C9107D9C1B1A30E0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<MA1PR0101MB1558C054087ED8884393C4D0A30E0@MA1PR0101MB1558.INDPRD01.PROD.OUTLOOK.COM>
	<DM5PR0201MB36235777FB5D60848418319CF80F0@DM5PR0201MB3623.namprd02.prod.outlook.com>
	<PN1PR0101MB15653F5A90DA1B487F813570A30C0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<PN1PR0101MB15656562DD59866E054E0593A30C0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
Message-ID: <DM5PR0201MB362301954982927477896FBAF80C0@DM5PR0201MB3623.namprd02.prod.outlook.com>

Hi Kebar,

Yes as you noticed, the scscf uri is wrong and sprout uri isn't getting set either. This is because your nodes are missing shared_config. The shared_config on your Ellis looks right, so just run "sudo cw-upload config shared_confg" (detailed instruction here http://clearwater.readthedocs.io/en/stable/Clearwater_Configuration_Options_Reference.html#shared-config) to upload it to etcd cluster for other nodes to pick up. Then run "cw-check_restart_queue_state" on different types of nodes several times to see the nodes restarting one by one to pick up the changes. If something goes wrong here, we know the shared_config isn't being picked up correctly.


Thanks,
Ying

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: 20 December 2017 11:27
To: clearwater at lists.projectclearwater.org
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

I have attached sprout_current.txt, which has some debug statements . I think that is giving some pointers.

My guess is /etc/clearwater/local_config (or some other appropriate config file) should have variables set for hostnames which are referred while composing these URLs.
e.g sip:scscf.;transport=TCP should be sip:scscf.<hostname<sip:scscf.%3chostname> of scscf>;transport=TCP

I will try is this direction..

Debug utils.cpp:405: Malformed host/port
Debug utils.cpp:405: Malformed host/port
Info main.cpp:1265: Sprout hostname set to
Info main.cpp:1243: S-CSCF node URI set to
Info main.cpp:1851: scscf enabled on 5054
Info main.cpp:1851: scscf prefix set to scscf
Info main.cpp:1851: scscf uri set to sip:scscf.;transport=TCP
Info main.cpp:1851: icscf enabled on 5052
Info main.cpp:1851: icscf prefix set to icscf
Info main.cpp:1851: icscf uri set to sip:icscf.;transport=TCP
Info main.cpp:1851: memento prefix set to memento
Info main.cpp:1851: memento uri set to sip:memento.;transport=TCP
Info main.cpp:1851: mangelwurzel prefix set to mangelwurzel
Info main.cpp:1851: mangelwurzel uri set to sip:mangelwurzel.;transport=TCP
Info main.cpp:1851: gemini prefix set to gemini
Info main.cpp:1851: gemini uri set to sip:gemini.;transport=TCP
Info main.cpp:1851: cdiv prefix set to cdiv
Info main.cpp:1851: cdiv uri set to sip:cdiv.;transport=TCP
Info main.cpp:1851: mmtel enabled on 5055
Info main.cpp:1851: mmtel prefix set to mmtel
Info main.cpp:1851: mmtel uri set to sip:mmtel.;transport=TCP
Info main.cpp:1851: bgcf enabled on 5053
Info main.cpp:1851: bgcf prefix set to bgcf
Info main.cpp:1851: bgcf uri set to sip:bgcf.;transport=TCP
Warning main.cpp:1855: SAS server option was invalid or not configured - SAS is disabled
Error main.cpp:1894: S/I-CSCF enabled with no Homestead server


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Wednesday, December 20, 2017 10:30 AM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Ying,

After changing log level to 5 on sprout, we need to restart sprout service, right ?
In my case, sprout service is not running.

I guess for this, I need to change the heat template to create user_settings file with log level 5.

[sprout]ubuntu at 0:/var/log/sprout$ service sprout status
* sprout is not running

[sprout]ubuntu at 0:/var/log/sprout$ ps -ef |grep sprout
ubuntu    8475  7053  0 04:53 pts/5    00:00:00 grep --color=auto sprout
root     10876     1  0 Dec18 ?        00:04:44 /usr/share/clearwater/clearwater-queue-manager/env/bin/python /usr/share/clearwater/bin/clearwater-queue-manager --local-ip=10.0.0.26 --local-site=site1 --log-level=3 --log-directory=/var/log/clearwater-queue-manager --pidfile=/var/run/clearwater-queue-manager.pid --etcd-key=clearwater --node-type=sprout --wait-plugin-complete=Y
root     11042     1  0 Dec18 ?        00:04:41 /usr/share/clearwater/clearwater-cluster-manager/env/bin/python /usr/share/clearwater/bin/clearwater-cluster-manager --mgmt-local-ip=10.0.0.26 --sig-local-ip=10.0.0.26 --local-site=site1 --remote-site= --remote-cassandra-seeds= --signaling-namespace= --uuid=535133a6-cb33-44b0-9a36-9da6e47ae280 --etcd-key=clearwater --etcd-cluster-key=sprout --cluster-manager-enabled=Y --log-level=3 --log-directory=/var/log/clearwater-cluster-manager --pidfile=/var/run/clearwater-cluster-manager.pid



From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Ying Huang
Sent: Wednesday, December 20, 2017 12:15 AM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Kedar,

Looks like a complicated situation to me. As far as I can see,


  1.  You should use log_level=5 to get more detailed logging
  2.  No the shared config shouldn't be the empty default template, this is an error
  3.  What you said about IP sounds suspicious, as one of the log file says "Failed to resolve icscf. to an IP address"

Must be frustrating to encounter errors everywhere. Shall we focus on the Sprout process and see why it fails. Would you please set log_level=5 in /etc/clearwater/user_settings on Sprout node and send a complete sprout_current.txt?


Thanks,
Ying



From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: 18 December 2017 14:00
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

6 continued.

6-a. bono errors attached for log locations mentioned in troubleshooting page. I tried stopping bono service. It got started by monit but same errors continue.
6-b. sprout errors attached for log locations mentioned in troubleshooting page. Sprout service is not running, so didn't try to stop to let me restart by monit.
6-c. /var/log/ellis/ellis-err.log is empty.
        /var/log/ellis/ellis_<time>.txt has these entries INFO web.py:1447: 200 GET /ping (0.0.0.0) 0.53ms.
        I tried stopping ellis service. It got started by monit but don't see anything changed.
       /var/log/monit.log errors attached.

Appreciate any help here !

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Monday, December 18, 2017 11:34 AM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Adam, Ying,


  1.  When I said shared_config is empty on sprout instances, I wanted to say that no config statements in it.


[sprout]ubuntu at 1:/etc/clearwater$ more shared_config
#####################################################################
# No Shared Config has been provided
# Replace this file with the Shared Configuration for your deployment
#####################################################################


  1.  /var/log/sprout/sprout_current has these entries periodically.



UTC Status utils.cpp:607: Log level set to 2

UTC Status main.cpp:1618: Access logging enabled to /var/log/sprout

UTC Warning signalhandler.h:90: SIGNAL already hooked

UTC Warning main.cpp:1674: SAS server option was invalid or not configured - SAS is disabled

UTC Error main.cpp:1713: S/I-CSCF enabled with no Homestead server


  1.  So is it ok if only one node, that is going to push shared config to cluster (ellis in the heat based deployment), to have shared_config file with all the configuration and other nodes to have 'empty' file like above ?



  1.  PFA ellis's shared_config attached. I don't find any sproutlet related configuration there..OK ? I have attached tail of ellis's heat installation log. Looks ok to me. Couldn't find anything suspicious in remaining log file.



  1.  Btw, one thing I should have told this in the beginning - When I tried the heat templates as it is, I observed that DNS VM's IP was not being passed to all other components. So I ended up carving out DNS VM and instantiated that first and used its IP in env file. I could confirm that IP got used by heat instructions of other VMs and DNSMASQ on them got configured ok. nslookup for components' names also works ok. (may be we need to use wait condition in the heat template)



  1.  I am going through troubleshooting options and will update on that.

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Adam Lindley
Sent: Friday, December 15, 2017 11:51 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

As a few more pointers of where to look, our HEAT templates currently generate shared config on the Ellis node, and upload this to the cluster as a whole. It would be worth looking at the install log on the ellis node to see if there was some error there. You may have the shared_config file present, and be able to upload that to the etcd cluster to bring the deployment to life.
If that doesn't give you any joy, make sure that the template install process has completed successfully on each of your nodes. It seems odd that shared_config has not been generated, and so I'd want to sanity check that nothing else is going wrong. If all nodes are installed, but lacking config, you should be able to generate shared config based on the script in the ellis.yaml file.
As Ying has said, once those things are sorted, you can look in the process logs to see why you are hitting errors. Almost all of our components log to /var/log/<process_name> on their node, so that's a great place to start debugging. You may also find our troubleshooting guide helpful: https://clearwater.readthedocs.io/en/stable/Troubleshooting_and_Recovery.html

Cheers,
Adam

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Ying Huang
Sent: 15 December 2017 17:54
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Kedar,

Shared config shouldn't be empty. Looks like Sprout process has failed for some reason. It's worthwhile checking the sprout log under /var/sys/log/sprout/sprout_current or send it over to see what went wrong.

Thanks,
Ying

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: 14 December 2017 14:07
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

/etc/Clearwater/shared_config is empty on both the sprout instances post installation. Is this expected if I want to run sproutlets like ICSCF, SCSCF at least ?

Here are couple of commands I tried.

[sprout]ubuntu at 0:~$ sudo monit summary
Monit 5.18.1 uptime: 7h 12m
Service Name                     Status                      Type
node-0.sprout.me.cw-ngv.com      Running                     System
sprout_process                   Execution failed | Does...  Process
snmpd_process                    Running                     Process
ntp_process                      Running                     Process
nginx_process                    Running                     Process
memcached_process                Running                     Process
clearwater_queue_manager_pro...  Running                     Process
etcd_process                     Running                     Process
clearwater_diags_monitor_pro...  Running                     Process
clearwater_config_manager_pr...  Running                     Process
clearwater_cluster_manager_p...  Running                     Process
chronos_process                  Running                     Process
astaire_process                  Running                     Process
sprout_uptime                    Wait parent                 Program
poll_sprout_sip                  Wait parent                 Program
poll_sprout_http                 Wait parent                 Program
nginx_ping                       Status ok                   Program
nginx_uptime                     Status ok                   Program
monit_uptime                     Status ok                   Program
memcached_uptime                 Status ok                   Program
poll_memcached                   Status ok                   Program
clearwater_queue_manager_uptime  Status ok                   Program
etcd_uptime                      Status ok                   Program
poll_etcd_cluster                Status ok                   Program
poll_etcd                        Status ok                   Program
chronos_uptime                   Status ok                   Program
poll_chronos                     Status ok                   Program
astaire_uptime                   Status ok                   Program

[sprout]ubuntu at 0:~$ service sprout status
* sprout is not running
[sprout]ubuntu at 0:~$ sudo service sprout start
14-12-2017 14:06:17.215 UTC Status utils.cpp:496: Switching to daemon mode

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Thursday, December 14, 2017 12:29 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

I gave a try with release 127 ( repo URL  http://repo.cw-ngv.com/archive/repo127 in env file). But issues seem to be very same.


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Wednesday, December 13, 2017 12:30 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Adam, Mike,

Clearwater heat templates on ONAP wiki are put around July 13. Clearwater release 127, which is released on May 30th , seems to have been used for testing these templates.

If I want to give a try with release 127 installation via heat, how to do that ? I tried URL http://repo.cw-ngv.com/release-127/binary/Packages in browser, but got 404.

From: Kedar Ambekar
Sent: Wednesday, December 13, 2017 11:37 AM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: RE: 502 Bad Gateway and other errors while running live tests

Hi Adam,

Got the point. I had suspected the same.
I have repo_url http://repo.cw-ngv.com/stable in heat's env file.

Is it possible to use same release on which ONAP's heat templates are based, may be by changing this repo URL?

I will have a look at current heat template on Clearwater GitHub but I think those won't be ONAP compatible.

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Adam Lindley
Sent: Tuesday, December 12, 2017 10:50 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Do you know which release you based the templates on?
We should be able to take a look over our release notes between then and now, which should give a reasonable view of the changes, and then we can go from there. Equally, the commit history (https://github.com/Metaswitch/clearwater-heat/commits/stable) gives a fairly clear overview of what and why, with the pull requests adding a bit more detail.

Though as we're likely to hit similar problems in future as we continue to develop Project Clearwater and our heat templates. Are the ONAP changes something we could be pulling in to the main code base? I'd be interested to know the extent of the work needed to keep them running

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Mike Evans
Sent: 12 December 2017 17:00
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Adam

I put the ONAP templates together, so I'm happy to update them if they won't work with the latest Project Clearwater code.  Is there anywhere I can look for an explanation of the changes?

Mike

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Adam Lindley
Sent: 12 December 2017 16:41
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Kedar,

I've just had a look around for the templates on the ONAP wiki; I wasn't aware they had their own copies of them.
I found https://wiki.onap.org/display/DW/Clearwater+vIMS+Onboarding+and+Instantiation . Is this what you've been working from?

When deploying with the templates, have you been specifying a "repo_url" option in the arguments? The Clearwater HEAT templates included steps to install the Clearwater packages from our public stable repo by default, but the templates on the ONAP wiki are now somewhat out of date. If you haven't specified a repo containing packages from the same point in time the templates were effectively forked, you're going to be hitting conflicts between the code version, and the orchestration steps.

I am not sure what differences there need to be for templates to run on ONAP, but I can point you towards our current set of heat templates: https://github.com/Metaswitch/clearwater-heat/tree/stable . I would suggest you try redeploying with these templates, as a fair number of things have changed in the code since the templates on the wiki were valid. If you hit any issues, do let us know.

Cheers,
Adam


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: 12 December 2017 13:46
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

I have installed Clearwater with heat templates (available on ONAP wiki) directly on openstack. Appreciate help on below issues.


  1.  When I run Clearwater live tests, all tests fail with below  error.



RuntimeError thrown:

   - Account creation failed with HTTP code 502, body {"status": 502, "message": "Bad Gateway", "reason": "Upstream request failed", "detail": {"Upstream error": "599", "Upstream URL": "None"}, "error": true}



  1.  ps for bono process shows this.



[bono]ubuntu at 0:/etc/clearwater$ ps -ef |grep bono

bono 6897 1 0 05:06 ? 00:00:11 /usr/share/clearwater/bin/bono --domain= --localhost=10.0.0.28,0.bono.me.cw-ngv.com --al ias=10.0.0.28,0.bono.me.cw-ngv.com, --pcscf=5060,5058 --webrtc-port=5062 --routing-proxy=icscf.,5052,50,600 --sas=0.0.0.0,bono at 0.bono.me.cw-ngv.com --dns-server=127.0.0.1 --worker-threads=2 --analytics=/var/log/bono --log-file=/var/log/bono --log-level=2 --daemon --pidfile=/var/run/bono/bono.pid



  1.  In bono, I saw these logs.

 UTC Error sip_connection_pool.cpp:190: Failed to resolve icscf. to an IP address - Not found (PJ_ENOTFOUND)

UTC Warning dnscachedresolver.cpp:828: Failed to retrieve record for icscf.: Domain name not found



  1.  To debug above issues, I ended up making these changes in /etc/init.d/bono and restarted bono service.



DAEMON_ARGS="--domain=me.cw-ngv.com  (instead of -domain=$home_domain)

upstream_hostname=icscf.sprout.me.cw-ngv.com (instead of upstream_hostname=icscf.$sprout_hostname)


  1.  But now, I get below error in bono. Port 5052 is not in listen mode on sprout.

UTC Warning pjsip: tcpc0x7f90cc07 TCP connect() error: Connection refused [code=120111]
UTC Warning pjsip: tcpc0x7f90cc07 Unable to connect to <sprout ip>:5052
============================================================================================================================
Disclaimer:  This message and the information contained herein is proprietary and confidential and subject to the Tech Mahindra policy statement, you may review the policy at http://www.techmahindra.com/Disclaimer.html externally http://tim.techmahindra.com/tim/disclaimer.html internally within TechMahindra.
============================================================================================================================
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20171220/df1ff0a6/attachment.html>

From akedar at TechMahindra.com  Wed Dec 20 07:18:14 2017
From: akedar at TechMahindra.com (Kedar Ambekar)
Date: Wed, 20 Dec 2017 12:18:14 +0000
Subject: [Project Clearwater] 502 Bad Gateway and other errors while
 running live tests
In-Reply-To: <DM5PR0201MB362301954982927477896FBAF80C0@DM5PR0201MB3623.namprd02.prod.outlook.com>
References: <PN1PR0101MB1565F6502AF8CA8FE9E3E06CA3340@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<BY2PR02MB20378C8381AD633827882732E2340@BY2PR02MB2037.namprd02.prod.outlook.com>
	<BLUPR0201MB1889B9B407D22938B59ED116B0340@BLUPR0201MB1889.namprd02.prod.outlook.com>
	<BY2PR02MB2037FFD49230C6B498B0D35EE2340@BY2PR02MB2037.namprd02.prod.outlook.com>
	<PN1PR0101MB15651EE3174A2D040BB3AC5AA3350@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<PN1PR0101MB1565488BBCA00EE6E02B441FA30A0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<MA1PR0101MB155824EC66E0BBF4AA4235CEA30A0@MA1PR0101MB1558.INDPRD01.PROD.OUTLOOK.COM>
	<DM5PR0201MB36231D60D83A6D448BE67115F80B0@DM5PR0201MB3623.namprd02.prod.outlook.com>
	<CY1PR02MB20442B9F94B1E5A15A7F5E26E20B0@CY1PR02MB2044.namprd02.prod.outlook.com>
	<PN1PR0101MB156571D41BC08C9107D9C1B1A30E0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<MA1PR0101MB1558C054087ED8884393C4D0A30E0@MA1PR0101MB1558.INDPRD01.PROD.OUTLOOK.COM>
	<DM5PR0201MB36235777FB5D60848418319CF80F0@DM5PR0201MB3623.namprd02.prod.outlook.com>
	<PN1PR0101MB15653F5A90DA1B487F813570A30C0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<PN1PR0101MB15656562DD59866E054E0593A30C0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<DM5PR0201MB362301954982927477896FBAF80C0@DM5PR0201MB3623.namprd02.prod.outlook.com>
Message-ID: <PN1PR0101MB1565BF7911348F75CEC33023A30C0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>

Hi Ying,

[ellis]ubuntu at ellis-0:/etc/clearwater$ sudo cw-upload config shared_confg
sudo: cw-upload: command not found

Then tried below command as per  http://clearwater.readthedocs.io/en/stable/Modifying_Clearwater_settings.html

[ellis]ubuntu at ellis-0:/etc/clearwater$ sudo cw-upload_shared_config
sudo: cw-upload_shared_config: command not found

Am I missing anything ?

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Ying Huang
Sent: Wednesday, December 20, 2017 5:13 PM
To: clearwater at lists.projectclearwater.org
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Kebar,

Yes as you noticed, the scscf uri is wrong and sprout uri isn't getting set either. This is because your nodes are missing shared_config. The shared_config on your Ellis looks right, so just run "sudo cw-upload config shared_confg" (detailed instruction here http://clearwater.readthedocs.io/en/stable/Clearwater_Configuration_Options_Reference.html#shared-config) to upload it to etcd cluster for other nodes to pick up. Then run "cw-check_restart_queue_state" on different types of nodes several times to see the nodes restarting one by one to pick up the changes. If something goes wrong here, we know the shared_config isn't being picked up correctly.


Thanks,
Ying

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: 20 December 2017 11:27
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

I have attached sprout_current.txt, which has some debug statements . I think that is giving some pointers.

My guess is /etc/clearwater/local_config (or some other appropriate config file) should have variables set for hostnames which are referred while composing these URLs.
e.g sip:scscf.;transport=TCP should be sip:scscf.<hostname<sip:scscf.%3chostname> of scscf>;transport=TCP

I will try is this direction..

Debug utils.cpp:405: Malformed host/port
Debug utils.cpp:405: Malformed host/port
Info main.cpp:1265: Sprout hostname set to
Info main.cpp:1243: S-CSCF node URI set to
Info main.cpp:1851: scscf enabled on 5054
Info main.cpp:1851: scscf prefix set to scscf
Info main.cpp:1851: scscf uri set to sip:scscf.;transport=TCP
Info main.cpp:1851: icscf enabled on 5052
Info main.cpp:1851: icscf prefix set to icscf
Info main.cpp:1851: icscf uri set to sip:icscf.;transport=TCP
Info main.cpp:1851: memento prefix set to memento
Info main.cpp:1851: memento uri set to sip:memento.;transport=TCP
Info main.cpp:1851: mangelwurzel prefix set to mangelwurzel
Info main.cpp:1851: mangelwurzel uri set to sip:mangelwurzel.;transport=TCP
Info main.cpp:1851: gemini prefix set to gemini
Info main.cpp:1851: gemini uri set to sip:gemini.;transport=TCP
Info main.cpp:1851: cdiv prefix set to cdiv
Info main.cpp:1851: cdiv uri set to sip:cdiv.;transport=TCP
Info main.cpp:1851: mmtel enabled on 5055
Info main.cpp:1851: mmtel prefix set to mmtel
Info main.cpp:1851: mmtel uri set to sip:mmtel.;transport=TCP
Info main.cpp:1851: bgcf enabled on 5053
Info main.cpp:1851: bgcf prefix set to bgcf
Info main.cpp:1851: bgcf uri set to sip:bgcf.;transport=TCP
Warning main.cpp:1855: SAS server option was invalid or not configured - SAS is disabled
Error main.cpp:1894: S/I-CSCF enabled with no Homestead server


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Wednesday, December 20, 2017 10:30 AM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Ying,

After changing log level to 5 on sprout, we need to restart sprout service, right ?
In my case, sprout service is not running.

I guess for this, I need to change the heat template to create user_settings file with log level 5.

[sprout]ubuntu at 0:/var/log/sprout$ service sprout status
* sprout is not running

[sprout]ubuntu at 0:/var/log/sprout$ ps -ef |grep sprout
ubuntu    8475  7053  0 04:53 pts/5    00:00:00 grep --color=auto sprout
root     10876     1  0 Dec18 ?        00:04:44 /usr/share/clearwater/clearwater-queue-manager/env/bin/python /usr/share/clearwater/bin/clearwater-queue-manager --local-ip=10.0.0.26 --local-site=site1 --log-level=3 --log-directory=/var/log/clearwater-queue-manager --pidfile=/var/run/clearwater-queue-manager.pid --etcd-key=clearwater --node-type=sprout --wait-plugin-complete=Y
root     11042     1  0 Dec18 ?        00:04:41 /usr/share/clearwater/clearwater-cluster-manager/env/bin/python /usr/share/clearwater/bin/clearwater-cluster-manager --mgmt-local-ip=10.0.0.26 --sig-local-ip=10.0.0.26 --local-site=site1 --remote-site= --remote-cassandra-seeds= --signaling-namespace= --uuid=535133a6-cb33-44b0-9a36-9da6e47ae280 --etcd-key=clearwater --etcd-cluster-key=sprout --cluster-manager-enabled=Y --log-level=3 --log-directory=/var/log/clearwater-cluster-manager --pidfile=/var/run/clearwater-cluster-manager.pid



From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Ying Huang
Sent: Wednesday, December 20, 2017 12:15 AM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Kedar,

Looks like a complicated situation to me. As far as I can see,


  1.  You should use log_level=5 to get more detailed logging
  2.  No the shared config shouldn't be the empty default template, this is an error
  3.  What you said about IP sounds suspicious, as one of the log file says "Failed to resolve icscf. to an IP address"

Must be frustrating to encounter errors everywhere. Shall we focus on the Sprout process and see why it fails. Would you please set log_level=5 in /etc/clearwater/user_settings on Sprout node and send a complete sprout_current.txt?


Thanks,
Ying



From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: 18 December 2017 14:00
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

6 continued.

6-a. bono errors attached for log locations mentioned in troubleshooting page. I tried stopping bono service. It got started by monit but same errors continue.
6-b. sprout errors attached for log locations mentioned in troubleshooting page. Sprout service is not running, so didn't try to stop to let me restart by monit.
6-c. /var/log/ellis/ellis-err.log is empty.
        /var/log/ellis/ellis_<time>.txt has these entries INFO web.py:1447: 200 GET /ping (0.0.0.0) 0.53ms.
        I tried stopping ellis service. It got started by monit but don't see anything changed.
       /var/log/monit.log errors attached.

Appreciate any help here !

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Monday, December 18, 2017 11:34 AM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Adam, Ying,


  1.  When I said shared_config is empty on sprout instances, I wanted to say that no config statements in it.


[sprout]ubuntu at 1:/etc/clearwater$ more shared_config
#####################################################################
# No Shared Config has been provided
# Replace this file with the Shared Configuration for your deployment
#####################################################################


  1.  /var/log/sprout/sprout_current has these entries periodically.



UTC Status utils.cpp:607: Log level set to 2

UTC Status main.cpp:1618: Access logging enabled to /var/log/sprout

UTC Warning signalhandler.h:90: SIGNAL already hooked

UTC Warning main.cpp:1674: SAS server option was invalid or not configured - SAS is disabled

UTC Error main.cpp:1713: S/I-CSCF enabled with no Homestead server


  1.  So is it ok if only one node, that is going to push shared config to cluster (ellis in the heat based deployment), to have shared_config file with all the configuration and other nodes to have 'empty' file like above ?



  1.  PFA ellis's shared_config attached. I don't find any sproutlet related configuration there..OK ? I have attached tail of ellis's heat installation log. Looks ok to me. Couldn't find anything suspicious in remaining log file.



  1.  Btw, one thing I should have told this in the beginning - When I tried the heat templates as it is, I observed that DNS VM's IP was not being passed to all other components. So I ended up carving out DNS VM and instantiated that first and used its IP in env file. I could confirm that IP got used by heat instructions of other VMs and DNSMASQ on them got configured ok. nslookup for components' names also works ok. (may be we need to use wait condition in the heat template)



  1.  I am going through troubleshooting options and will update on that.

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Adam Lindley
Sent: Friday, December 15, 2017 11:51 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

As a few more pointers of where to look, our HEAT templates currently generate shared config on the Ellis node, and upload this to the cluster as a whole. It would be worth looking at the install log on the ellis node to see if there was some error there. You may have the shared_config file present, and be able to upload that to the etcd cluster to bring the deployment to life.
If that doesn't give you any joy, make sure that the template install process has completed successfully on each of your nodes. It seems odd that shared_config has not been generated, and so I'd want to sanity check that nothing else is going wrong. If all nodes are installed, but lacking config, you should be able to generate shared config based on the script in the ellis.yaml file.
As Ying has said, once those things are sorted, you can look in the process logs to see why you are hitting errors. Almost all of our components log to /var/log/<process_name> on their node, so that's a great place to start debugging. You may also find our troubleshooting guide helpful: https://clearwater.readthedocs.io/en/stable/Troubleshooting_and_Recovery.html

Cheers,
Adam

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Ying Huang
Sent: 15 December 2017 17:54
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Kedar,

Shared config shouldn't be empty. Looks like Sprout process has failed for some reason. It's worthwhile checking the sprout log under /var/sys/log/sprout/sprout_current or send it over to see what went wrong.

Thanks,
Ying

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: 14 December 2017 14:07
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

/etc/Clearwater/shared_config is empty on both the sprout instances post installation. Is this expected if I want to run sproutlets like ICSCF, SCSCF at least ?

Here are couple of commands I tried.

[sprout]ubuntu at 0:~$ sudo monit summary
Monit 5.18.1 uptime: 7h 12m
Service Name                     Status                      Type
node-0.sprout.me.cw-ngv.com      Running                     System
sprout_process                   Execution failed | Does...  Process
snmpd_process                    Running                     Process
ntp_process                      Running                     Process
nginx_process                    Running                     Process
memcached_process                Running                     Process
clearwater_queue_manager_pro...  Running                     Process
etcd_process                     Running                     Process
clearwater_diags_monitor_pro...  Running                     Process
clearwater_config_manager_pr...  Running                     Process
clearwater_cluster_manager_p...  Running                     Process
chronos_process                  Running                     Process
astaire_process                  Running                     Process
sprout_uptime                    Wait parent                 Program
poll_sprout_sip                  Wait parent                 Program
poll_sprout_http                 Wait parent                 Program
nginx_ping                       Status ok                   Program
nginx_uptime                     Status ok                   Program
monit_uptime                     Status ok                   Program
memcached_uptime                 Status ok                   Program
poll_memcached                   Status ok                   Program
clearwater_queue_manager_uptime  Status ok                   Program
etcd_uptime                      Status ok                   Program
poll_etcd_cluster                Status ok                   Program
poll_etcd                        Status ok                   Program
chronos_uptime                   Status ok                   Program
poll_chronos                     Status ok                   Program
astaire_uptime                   Status ok                   Program

[sprout]ubuntu at 0:~$ service sprout status
* sprout is not running
[sprout]ubuntu at 0:~$ sudo service sprout start
14-12-2017 14:06:17.215 UTC Status utils.cpp:496: Switching to daemon mode

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Thursday, December 14, 2017 12:29 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

I gave a try with release 127 ( repo URL  http://repo.cw-ngv.com/archive/repo127 in env file). But issues seem to be very same.


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Wednesday, December 13, 2017 12:30 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Adam, Mike,

Clearwater heat templates on ONAP wiki are put around July 13. Clearwater release 127, which is released on May 30th , seems to have been used for testing these templates.

If I want to give a try with release 127 installation via heat, how to do that ? I tried URL http://repo.cw-ngv.com/release-127/binary/Packages in browser, but got 404.

From: Kedar Ambekar
Sent: Wednesday, December 13, 2017 11:37 AM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: RE: 502 Bad Gateway and other errors while running live tests

Hi Adam,

Got the point. I had suspected the same.
I have repo_url http://repo.cw-ngv.com/stable in heat's env file.

Is it possible to use same release on which ONAP's heat templates are based, may be by changing this repo URL?

I will have a look at current heat template on Clearwater GitHub but I think those won't be ONAP compatible.

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Adam Lindley
Sent: Tuesday, December 12, 2017 10:50 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Do you know which release you based the templates on?
We should be able to take a look over our release notes between then and now, which should give a reasonable view of the changes, and then we can go from there. Equally, the commit history (https://github.com/Metaswitch/clearwater-heat/commits/stable) gives a fairly clear overview of what and why, with the pull requests adding a bit more detail.

Though as we're likely to hit similar problems in future as we continue to develop Project Clearwater and our heat templates. Are the ONAP changes something we could be pulling in to the main code base? I'd be interested to know the extent of the work needed to keep them running

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Mike Evans
Sent: 12 December 2017 17:00
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Adam

I put the ONAP templates together, so I'm happy to update them if they won't work with the latest Project Clearwater code.  Is there anywhere I can look for an explanation of the changes?

Mike

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Adam Lindley
Sent: 12 December 2017 16:41
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Kedar,

I've just had a look around for the templates on the ONAP wiki; I wasn't aware they had their own copies of them.
I found https://wiki.onap.org/display/DW/Clearwater+vIMS+Onboarding+and+Instantiation . Is this what you've been working from?

When deploying with the templates, have you been specifying a "repo_url" option in the arguments? The Clearwater HEAT templates included steps to install the Clearwater packages from our public stable repo by default, but the templates on the ONAP wiki are now somewhat out of date. If you haven't specified a repo containing packages from the same point in time the templates were effectively forked, you're going to be hitting conflicts between the code version, and the orchestration steps.

I am not sure what differences there need to be for templates to run on ONAP, but I can point you towards our current set of heat templates: https://github.com/Metaswitch/clearwater-heat/tree/stable . I would suggest you try redeploying with these templates, as a fair number of things have changed in the code since the templates on the wiki were valid. If you hit any issues, do let us know.

Cheers,
Adam


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: 12 December 2017 13:46
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

I have installed Clearwater with heat templates (available on ONAP wiki) directly on openstack. Appreciate help on below issues.


  1.  When I run Clearwater live tests, all tests fail with below  error.



RuntimeError thrown:

   - Account creation failed with HTTP code 502, body {"status": 502, "message": "Bad Gateway", "reason": "Upstream request failed", "detail": {"Upstream error": "599", "Upstream URL": "None"}, "error": true}



  1.  ps for bono process shows this.



[bono]ubuntu at 0:/etc/clearwater$ ps -ef |grep bono

bono 6897 1 0 05:06 ? 00:00:11 /usr/share/clearwater/bin/bono --domain= --localhost=10.0.0.28,0.bono.me.cw-ngv.com --al ias=10.0.0.28,0.bono.me.cw-ngv.com, --pcscf=5060,5058 --webrtc-port=5062 --routing-proxy=icscf.,5052,50,600 --sas=0.0.0.0,bono at 0.bono.me.cw-ngv.com --dns-server=127.0.0.1 --worker-threads=2 --analytics=/var/log/bono --log-file=/var/log/bono --log-level=2 --daemon --pidfile=/var/run/bono/bono.pid



  1.  In bono, I saw these logs.

 UTC Error sip_connection_pool.cpp:190: Failed to resolve icscf. to an IP address - Not found (PJ_ENOTFOUND)

UTC Warning dnscachedresolver.cpp:828: Failed to retrieve record for icscf.: Domain name not found



  1.  To debug above issues, I ended up making these changes in /etc/init.d/bono and restarted bono service.



DAEMON_ARGS="--domain=me.cw-ngv.com  (instead of -domain=$home_domain)

upstream_hostname=icscf.sprout.me.cw-ngv.com (instead of upstream_hostname=icscf.$sprout_hostname)


  1.  But now, I get below error in bono. Port 5052 is not in listen mode on sprout.

UTC Warning pjsip: tcpc0x7f90cc07 TCP connect() error: Connection refused [code=120111]
UTC Warning pjsip: tcpc0x7f90cc07 Unable to connect to <sprout ip>:5052
============================================================================================================================
Disclaimer:  This message and the information contained herein is proprietary and confidential and subject to the Tech Mahindra policy statement, you may review the policy at http://www.techmahindra.com/Disclaimer.html externally http://tim.techmahindra.com/tim/disclaimer.html internally within TechMahindra.
============================================================================================================================
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20171220/e6c4f177/attachment.html>

From Richard.Whitehouse at metaswitch.com  Wed Dec 20 10:06:14 2017
From: Richard.Whitehouse at metaswitch.com (Richard Whitehouse)
Date: Wed, 20 Dec 2017 15:06:14 +0000
Subject: [Project Clearwater] Release note for Ulmo
Message-ID: <BN6PR02MB336204DBD77EDBB3580B2635F00C0@BN6PR02MB3362.namprd02.prod.outlook.com>

Hi all,



We have cut the latest Project Clearwater Release: Ulmo. The code for this release has been tagged as release-129 in GitHub.



This release includes a couple of substantial pieces of work:



Improved Configuration Management



We've altered the workflow for making changes to Clearwater Settings - this will help avoid window conditions where the live configuration on an individual node is out of sync with the rest of the deployment, or if multiple updates are attempted simulatenously.



See http://clearwater.readthedocs.io/en/stable/Modifying_Clearwater_settings.html for more details



Users wishing to make changes to shared_config across their deployment should now:



Run `cw-config download shared_config` to get a copy of the latest shared_config file

Make changes to the downloaded copy

Run `cw-config upload shared_config` when the configuration is ready to be uploaded.



Users wishing to make changes to the static DNS overrides across their deployment should now:



Run `cw-config download dns_json` to get a copy of the latest dns.json file.

Make changes to the downloaded copy

Run `cw-config upload dns_json` when the configuration is ready to be uploaded.



Users wishing to make changes to a JSON file across their Sprout nodes should now:



On one of their Sprout nodes run `cw-config download {scscf|bcgf|enum|rph}_json` to get a copy of the latest JSON file

Make changes to the downloaded copy

Run `cw-config upload {scscf|bcgf|enum|rph}_json` when the configuration is ready to be uploaded.



Users wishing to make changes to an XML file across their Sprout nodes should now:



On one of their Sprout nodes run `cw-config download {shared|fallback}_ifcs` to get a copy of the lastest XML file

Make changes to the downloaded copy

Run `cw-config upload {shared|fallback}_ifcs` when the configuration is ready to be uploaded.



Astaire / Rogers



We've split apart the proxying function from Astaire into a new component, Rogers.



This was done to avoid the memcached proxying, replication and topology hiding functionality provided by Rogers from being impacted by resynchronization operations performed by Astaire.



Vellum nodes will now run Rogers in addition to Astaire. This should automatically be installed on upgrade.



Resource Priority Headers



We've added support for Resource Priority Headers. If a Resource Priority Header is present, and Clearwater is configured to honour it, requests with that resource priority will be prioritised when Clearwater is overloaded.



See http://clearwater.readthedocs.io/en/stable/Clearwater_Configuration_Options_Reference.html#rph-config for more detail on configuring RPH values.



SIP Graylisting and Lazy Targeting



This release improves SIP target selection to incorporate graylisting and lazy targeting, in a similar manner to the existing support for HTTP documented at http://www.projectclearwater.org/http-graylisting/





This release also includes a substantial number of bug fixes which improve Clearwater's performance at load, overload and with latency during call flows.





To upgrade to this release, follow the instructions at http://docs.projectclearwater.org/en/stable/Upgrading_a_Clearwater_deployment.html. If you are deploying an all-in-one node, the standard image (http://vm-images.cw-ngv.com/cw-aio.ova) has been updated for this release.





Richard Whitehouse




-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20171220/f5ab717e/attachment.html>

From akedar at TechMahindra.com  Thu Dec 21 00:59:50 2017
From: akedar at TechMahindra.com (Kedar Ambekar)
Date: Thu, 21 Dec 2017 05:59:50 +0000
Subject: [Project Clearwater] 502 Bad Gateway and other errors while
 running live tests
In-Reply-To: <PN1PR0101MB1565BF7911348F75CEC33023A30C0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
References: <PN1PR0101MB1565F6502AF8CA8FE9E3E06CA3340@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<BY2PR02MB20378C8381AD633827882732E2340@BY2PR02MB2037.namprd02.prod.outlook.com>
	<BLUPR0201MB1889B9B407D22938B59ED116B0340@BLUPR0201MB1889.namprd02.prod.outlook.com>
	<BY2PR02MB2037FFD49230C6B498B0D35EE2340@BY2PR02MB2037.namprd02.prod.outlook.com>
	<PN1PR0101MB15651EE3174A2D040BB3AC5AA3350@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<PN1PR0101MB1565488BBCA00EE6E02B441FA30A0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<MA1PR0101MB155824EC66E0BBF4AA4235CEA30A0@MA1PR0101MB1558.INDPRD01.PROD.OUTLOOK.COM>
	<DM5PR0201MB36231D60D83A6D448BE67115F80B0@DM5PR0201MB3623.namprd02.prod.outlook.com>
	<CY1PR02MB20442B9F94B1E5A15A7F5E26E20B0@CY1PR02MB2044.namprd02.prod.outlook.com>
	<PN1PR0101MB156571D41BC08C9107D9C1B1A30E0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<MA1PR0101MB1558C054087ED8884393C4D0A30E0@MA1PR0101MB1558.INDPRD01.PROD.OUTLOOK.COM>
	<DM5PR0201MB36235777FB5D60848418319CF80F0@DM5PR0201MB3623.namprd02.prod.outlook.com>
	<PN1PR0101MB15653F5A90DA1B487F813570A30C0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<PN1PR0101MB15656562DD59866E054E0593A30C0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<DM5PR0201MB362301954982927477896FBAF80C0@DM5PR0201MB3623.namprd02.prod.outlook.com>
	<PN1PR0101MB1565BF7911348F75CEC33023A30C0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
Message-ID: <PN1PR0101MB15658BF9A20726809BC61AF8A30D0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>

I had missed to notice this in ellis heat log. I think this is the culprit.

+ sudo /usr/share/clearwater/clearwater-config-manager/scripts/upload_shared_config
sudo: /usr/share/clearwater/clearwater-config-manager/scripts/upload_shared_config: command not found

Anyway, I did below to upload shared_config. Commands seem to have changed with latest release.

[ellis]ubuntu at ellis-0:/var/log$ cw-config download shared_config
shared_config downloaded to /home/ubuntu/clearwater-config-manager/ubuntu/shared_config

File was same as ellis shared_config file.  I had to modify it with a dummy change of putting dots in a comment line as upload command was detecting no change.

[ellis]ubuntu at ellis-0:/var/log$ cw-config upload shared_config
Config successfully validated
Configuration file change: user ubuntu has modified shared_config.
Lines removed:
"# Deployment definitions"
Lines added:
"# Deployment definitions.."

Please check the config changes and confirm that you wish to continue with the config upload.
Do you want to continue?  [yes/no] yes
shared_config successfully uploaded


[ellis]ubuntu at ellis-0:/var/log$ cw-check_restart_queue_state
Describing the current queue state for apply_config_ellis
  Nodes currently queued:
    Node ID: 10.0.0.14-ellis, Node status: processing


[ellis]ubuntu at ellis-0:/var/log$ cw-check_restart_queue_state
Describing the current queue state for apply_config_ellis
  No nodes are currently queued


[sprout]ubuntu at 0:~$ cw-check_restart_queue_state
Describing the current queue state for apply_config_sprout
  No nodes are currently queued

After this, if I download shared_config on sprout, I get the 'empty' file only in /home/ubuntu/clearwater-config-manager/ubuntu directory. So clearly sprout is not receiving the shared_config from cluster. Same is the case with bono, homestead etc.


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Wednesday, December 20, 2017 5:48 PM
To: clearwater at lists.projectclearwater.org
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Ying,

[ellis]ubuntu at ellis-0:/etc/clearwater$ sudo cw-upload config shared_confg
sudo: cw-upload: command not found

Then tried below command as per  http://clearwater.readthedocs.io/en/stable/Modifying_Clearwater_settings.html

[ellis]ubuntu at ellis-0:/etc/clearwater$ sudo cw-upload_shared_config
sudo: cw-upload_shared_config: command not found

Am I missing anything ?

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Ying Huang
Sent: Wednesday, December 20, 2017 5:13 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Kebar,

Yes as you noticed, the scscf uri is wrong and sprout uri isn't getting set either. This is because your nodes are missing shared_config. The shared_config on your Ellis looks right, so just run "sudo cw-upload config shared_confg" (detailed instruction here http://clearwater.readthedocs.io/en/stable/Clearwater_Configuration_Options_Reference.html#shared-config) to upload it to etcd cluster for other nodes to pick up. Then run "cw-check_restart_queue_state" on different types of nodes several times to see the nodes restarting one by one to pick up the changes. If something goes wrong here, we know the shared_config isn't being picked up correctly.


Thanks,
Ying

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: 20 December 2017 11:27
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

I have attached sprout_current.txt, which has some debug statements . I think that is giving some pointers.

My guess is /etc/clearwater/local_config (or some other appropriate config file) should have variables set for hostnames which are referred while composing these URLs.
e.g sip:scscf.;transport=TCP should be sip:scscf.<hostname<sip:scscf.%3chostname> of scscf>;transport=TCP

I will try is this direction..

Debug utils.cpp:405: Malformed host/port
Debug utils.cpp:405: Malformed host/port
Info main.cpp:1265: Sprout hostname set to
Info main.cpp:1243: S-CSCF node URI set to
Info main.cpp:1851: scscf enabled on 5054
Info main.cpp:1851: scscf prefix set to scscf
Info main.cpp:1851: scscf uri set to sip:scscf.;transport=TCP
Info main.cpp:1851: icscf enabled on 5052
Info main.cpp:1851: icscf prefix set to icscf
Info main.cpp:1851: icscf uri set to sip:icscf.;transport=TCP
Info main.cpp:1851: memento prefix set to memento
Info main.cpp:1851: memento uri set to sip:memento.;transport=TCP
Info main.cpp:1851: mangelwurzel prefix set to mangelwurzel
Info main.cpp:1851: mangelwurzel uri set to sip:mangelwurzel.;transport=TCP
Info main.cpp:1851: gemini prefix set to gemini
Info main.cpp:1851: gemini uri set to sip:gemini.;transport=TCP
Info main.cpp:1851: cdiv prefix set to cdiv
Info main.cpp:1851: cdiv uri set to sip:cdiv.;transport=TCP
Info main.cpp:1851: mmtel enabled on 5055
Info main.cpp:1851: mmtel prefix set to mmtel
Info main.cpp:1851: mmtel uri set to sip:mmtel.;transport=TCP
Info main.cpp:1851: bgcf enabled on 5053
Info main.cpp:1851: bgcf prefix set to bgcf
Info main.cpp:1851: bgcf uri set to sip:bgcf.;transport=TCP
Warning main.cpp:1855: SAS server option was invalid or not configured - SAS is disabled
Error main.cpp:1894: S/I-CSCF enabled with no Homestead server


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Wednesday, December 20, 2017 10:30 AM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Ying,

After changing log level to 5 on sprout, we need to restart sprout service, right ?
In my case, sprout service is not running.

I guess for this, I need to change the heat template to create user_settings file with log level 5.

[sprout]ubuntu at 0:/var/log/sprout$ service sprout status
* sprout is not running

[sprout]ubuntu at 0:/var/log/sprout$ ps -ef |grep sprout
ubuntu    8475  7053  0 04:53 pts/5    00:00:00 grep --color=auto sprout
root     10876     1  0 Dec18 ?        00:04:44 /usr/share/clearwater/clearwater-queue-manager/env/bin/python /usr/share/clearwater/bin/clearwater-queue-manager --local-ip=10.0.0.26 --local-site=site1 --log-level=3 --log-directory=/var/log/clearwater-queue-manager --pidfile=/var/run/clearwater-queue-manager.pid --etcd-key=clearwater --node-type=sprout --wait-plugin-complete=Y
root     11042     1  0 Dec18 ?        00:04:41 /usr/share/clearwater/clearwater-cluster-manager/env/bin/python /usr/share/clearwater/bin/clearwater-cluster-manager --mgmt-local-ip=10.0.0.26 --sig-local-ip=10.0.0.26 --local-site=site1 --remote-site= --remote-cassandra-seeds= --signaling-namespace= --uuid=535133a6-cb33-44b0-9a36-9da6e47ae280 --etcd-key=clearwater --etcd-cluster-key=sprout --cluster-manager-enabled=Y --log-level=3 --log-directory=/var/log/clearwater-cluster-manager --pidfile=/var/run/clearwater-cluster-manager.pid



From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Ying Huang
Sent: Wednesday, December 20, 2017 12:15 AM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Kedar,

Looks like a complicated situation to me. As far as I can see,


  1.  You should use log_level=5 to get more detailed logging
  2.  No the shared config shouldn't be the empty default template, this is an error
  3.  What you said about IP sounds suspicious, as one of the log file says "Failed to resolve icscf. to an IP address"

Must be frustrating to encounter errors everywhere. Shall we focus on the Sprout process and see why it fails. Would you please set log_level=5 in /etc/clearwater/user_settings on Sprout node and send a complete sprout_current.txt?


Thanks,
Ying



From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: 18 December 2017 14:00
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

6 continued.

6-a. bono errors attached for log locations mentioned in troubleshooting page. I tried stopping bono service. It got started by monit but same errors continue.
6-b. sprout errors attached for log locations mentioned in troubleshooting page. Sprout service is not running, so didn't try to stop to let me restart by monit.
6-c. /var/log/ellis/ellis-err.log is empty.
        /var/log/ellis/ellis_<time>.txt has these entries INFO web.py:1447: 200 GET /ping (0.0.0.0) 0.53ms.
        I tried stopping ellis service. It got started by monit but don't see anything changed.
       /var/log/monit.log errors attached.

Appreciate any help here !

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Monday, December 18, 2017 11:34 AM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Adam, Ying,


  1.  When I said shared_config is empty on sprout instances, I wanted to say that no config statements in it.


[sprout]ubuntu at 1:/etc/clearwater$ more shared_config
#####################################################################
# No Shared Config has been provided
# Replace this file with the Shared Configuration for your deployment
#####################################################################


  1.  /var/log/sprout/sprout_current has these entries periodically.



UTC Status utils.cpp:607: Log level set to 2

UTC Status main.cpp:1618: Access logging enabled to /var/log/sprout

UTC Warning signalhandler.h:90: SIGNAL already hooked

UTC Warning main.cpp:1674: SAS server option was invalid or not configured - SAS is disabled

UTC Error main.cpp:1713: S/I-CSCF enabled with no Homestead server


  1.  So is it ok if only one node, that is going to push shared config to cluster (ellis in the heat based deployment), to have shared_config file with all the configuration and other nodes to have 'empty' file like above ?



  1.  PFA ellis's shared_config attached. I don't find any sproutlet related configuration there..OK ? I have attached tail of ellis's heat installation log. Looks ok to me. Couldn't find anything suspicious in remaining log file.



  1.  Btw, one thing I should have told this in the beginning - When I tried the heat templates as it is, I observed that DNS VM's IP was not being passed to all other components. So I ended up carving out DNS VM and instantiated that first and used its IP in env file. I could confirm that IP got used by heat instructions of other VMs and DNSMASQ on them got configured ok. nslookup for components' names also works ok. (may be we need to use wait condition in the heat template)



  1.  I am going through troubleshooting options and will update on that.

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Adam Lindley
Sent: Friday, December 15, 2017 11:51 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

As a few more pointers of where to look, our HEAT templates currently generate shared config on the Ellis node, and upload this to the cluster as a whole. It would be worth looking at the install log on the ellis node to see if there was some error there. You may have the shared_config file present, and be able to upload that to the etcd cluster to bring the deployment to life.
If that doesn't give you any joy, make sure that the template install process has completed successfully on each of your nodes. It seems odd that shared_config has not been generated, and so I'd want to sanity check that nothing else is going wrong. If all nodes are installed, but lacking config, you should be able to generate shared config based on the script in the ellis.yaml file.
As Ying has said, once those things are sorted, you can look in the process logs to see why you are hitting errors. Almost all of our components log to /var/log/<process_name> on their node, so that's a great place to start debugging. You may also find our troubleshooting guide helpful: https://clearwater.readthedocs.io/en/stable/Troubleshooting_and_Recovery.html

Cheers,
Adam

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Ying Huang
Sent: 15 December 2017 17:54
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Kedar,

Shared config shouldn't be empty. Looks like Sprout process has failed for some reason. It's worthwhile checking the sprout log under /var/sys/log/sprout/sprout_current or send it over to see what went wrong.

Thanks,
Ying

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: 14 December 2017 14:07
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

/etc/Clearwater/shared_config is empty on both the sprout instances post installation. Is this expected if I want to run sproutlets like ICSCF, SCSCF at least ?

Here are couple of commands I tried.

[sprout]ubuntu at 0:~$ sudo monit summary
Monit 5.18.1 uptime: 7h 12m
Service Name                     Status                      Type
node-0.sprout.me.cw-ngv.com      Running                     System
sprout_process                   Execution failed | Does...  Process
snmpd_process                    Running                     Process
ntp_process                      Running                     Process
nginx_process                    Running                     Process
memcached_process                Running                     Process
clearwater_queue_manager_pro...  Running                     Process
etcd_process                     Running                     Process
clearwater_diags_monitor_pro...  Running                     Process
clearwater_config_manager_pr...  Running                     Process
clearwater_cluster_manager_p...  Running                     Process
chronos_process                  Running                     Process
astaire_process                  Running                     Process
sprout_uptime                    Wait parent                 Program
poll_sprout_sip                  Wait parent                 Program
poll_sprout_http                 Wait parent                 Program
nginx_ping                       Status ok                   Program
nginx_uptime                     Status ok                   Program
monit_uptime                     Status ok                   Program
memcached_uptime                 Status ok                   Program
poll_memcached                   Status ok                   Program
clearwater_queue_manager_uptime  Status ok                   Program
etcd_uptime                      Status ok                   Program
poll_etcd_cluster                Status ok                   Program
poll_etcd                        Status ok                   Program
chronos_uptime                   Status ok                   Program
poll_chronos                     Status ok                   Program
astaire_uptime                   Status ok                   Program

[sprout]ubuntu at 0:~$ service sprout status
* sprout is not running
[sprout]ubuntu at 0:~$ sudo service sprout start
14-12-2017 14:06:17.215 UTC Status utils.cpp:496: Switching to daemon mode

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Thursday, December 14, 2017 12:29 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

I gave a try with release 127 ( repo URL  http://repo.cw-ngv.com/archive/repo127 in env file). But issues seem to be very same.


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Wednesday, December 13, 2017 12:30 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Adam, Mike,

Clearwater heat templates on ONAP wiki are put around July 13. Clearwater release 127, which is released on May 30th , seems to have been used for testing these templates.

If I want to give a try with release 127 installation via heat, how to do that ? I tried URL http://repo.cw-ngv.com/release-127/binary/Packages in browser, but got 404.

From: Kedar Ambekar
Sent: Wednesday, December 13, 2017 11:37 AM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: RE: 502 Bad Gateway and other errors while running live tests

Hi Adam,

Got the point. I had suspected the same.
I have repo_url http://repo.cw-ngv.com/stable in heat's env file.

Is it possible to use same release on which ONAP's heat templates are based, may be by changing this repo URL?

I will have a look at current heat template on Clearwater GitHub but I think those won't be ONAP compatible.

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Adam Lindley
Sent: Tuesday, December 12, 2017 10:50 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Do you know which release you based the templates on?
We should be able to take a look over our release notes between then and now, which should give a reasonable view of the changes, and then we can go from there. Equally, the commit history (https://github.com/Metaswitch/clearwater-heat/commits/stable) gives a fairly clear overview of what and why, with the pull requests adding a bit more detail.

Though as we're likely to hit similar problems in future as we continue to develop Project Clearwater and our heat templates. Are the ONAP changes something we could be pulling in to the main code base? I'd be interested to know the extent of the work needed to keep them running

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Mike Evans
Sent: 12 December 2017 17:00
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Adam

I put the ONAP templates together, so I'm happy to update them if they won't work with the latest Project Clearwater code.  Is there anywhere I can look for an explanation of the changes?

Mike

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Adam Lindley
Sent: 12 December 2017 16:41
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Kedar,

I've just had a look around for the templates on the ONAP wiki; I wasn't aware they had their own copies of them.
I found https://wiki.onap.org/display/DW/Clearwater+vIMS+Onboarding+and+Instantiation . Is this what you've been working from?

When deploying with the templates, have you been specifying a "repo_url" option in the arguments? The Clearwater HEAT templates included steps to install the Clearwater packages from our public stable repo by default, but the templates on the ONAP wiki are now somewhat out of date. If you haven't specified a repo containing packages from the same point in time the templates were effectively forked, you're going to be hitting conflicts between the code version, and the orchestration steps.

I am not sure what differences there need to be for templates to run on ONAP, but I can point you towards our current set of heat templates: https://github.com/Metaswitch/clearwater-heat/tree/stable . I would suggest you try redeploying with these templates, as a fair number of things have changed in the code since the templates on the wiki were valid. If you hit any issues, do let us know.

Cheers,
Adam


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: 12 December 2017 13:46
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

I have installed Clearwater with heat templates (available on ONAP wiki) directly on openstack. Appreciate help on below issues.


  1.  When I run Clearwater live tests, all tests fail with below  error.



RuntimeError thrown:

   - Account creation failed with HTTP code 502, body {"status": 502, "message": "Bad Gateway", "reason": "Upstream request failed", "detail": {"Upstream error": "599", "Upstream URL": "None"}, "error": true}



  1.  ps for bono process shows this.



[bono]ubuntu at 0:/etc/clearwater$ ps -ef |grep bono

bono 6897 1 0 05:06 ? 00:00:11 /usr/share/clearwater/bin/bono --domain= --localhost=10.0.0.28,0.bono.me.cw-ngv.com --al ias=10.0.0.28,0.bono.me.cw-ngv.com, --pcscf=5060,5058 --webrtc-port=5062 --routing-proxy=icscf.,5052,50,600 --sas=0.0.0.0,bono at 0.bono.me.cw-ngv.com --dns-server=127.0.0.1 --worker-threads=2 --analytics=/var/log/bono --log-file=/var/log/bono --log-level=2 --daemon --pidfile=/var/run/bono/bono.pid



  1.  In bono, I saw these logs.

 UTC Error sip_connection_pool.cpp:190: Failed to resolve icscf. to an IP address - Not found (PJ_ENOTFOUND)

UTC Warning dnscachedresolver.cpp:828: Failed to retrieve record for icscf.: Domain name not found



  1.  To debug above issues, I ended up making these changes in /etc/init.d/bono and restarted bono service.



DAEMON_ARGS="--domain=me.cw-ngv.com  (instead of -domain=$home_domain)

upstream_hostname=icscf.sprout.me.cw-ngv.com (instead of upstream_hostname=icscf.$sprout_hostname)


  1.  But now, I get below error in bono. Port 5052 is not in listen mode on sprout.

UTC Warning pjsip: tcpc0x7f90cc07 TCP connect() error: Connection refused [code=120111]
UTC Warning pjsip: tcpc0x7f90cc07 Unable to connect to <sprout ip>:5052
============================================================================================================================
Disclaimer:  This message and the information contained herein is proprietary and confidential and subject to the Tech Mahindra policy statement, you may review the policy at http://www.techmahindra.com/Disclaimer.html externally http://tim.techmahindra.com/tim/disclaimer.html internally within TechMahindra.
============================================================================================================================
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20171221/e6e2f7eb/attachment.html>

From akedar at TechMahindra.com  Thu Dec 21 06:39:46 2017
From: akedar at TechMahindra.com (Kedar Ambekar)
Date: Thu, 21 Dec 2017 11:39:46 +0000
Subject: [Project Clearwater] 502 Bad Gateway and other errors while
 running live tests
In-Reply-To: <PN1PR0101MB15658BF9A20726809BC61AF8A30D0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
References: <PN1PR0101MB1565F6502AF8CA8FE9E3E06CA3340@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<BY2PR02MB20378C8381AD633827882732E2340@BY2PR02MB2037.namprd02.prod.outlook.com>
	<BLUPR0201MB1889B9B407D22938B59ED116B0340@BLUPR0201MB1889.namprd02.prod.outlook.com>
	<BY2PR02MB2037FFD49230C6B498B0D35EE2340@BY2PR02MB2037.namprd02.prod.outlook.com>
	<PN1PR0101MB15651EE3174A2D040BB3AC5AA3350@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<PN1PR0101MB1565488BBCA00EE6E02B441FA30A0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<MA1PR0101MB155824EC66E0BBF4AA4235CEA30A0@MA1PR0101MB1558.INDPRD01.PROD.OUTLOOK.COM>
	<DM5PR0201MB36231D60D83A6D448BE67115F80B0@DM5PR0201MB3623.namprd02.prod.outlook.com>
	<CY1PR02MB20442B9F94B1E5A15A7F5E26E20B0@CY1PR02MB2044.namprd02.prod.outlook.com>
	<PN1PR0101MB156571D41BC08C9107D9C1B1A30E0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<MA1PR0101MB1558C054087ED8884393C4D0A30E0@MA1PR0101MB1558.INDPRD01.PROD.OUTLOOK.COM>
	<DM5PR0201MB36235777FB5D60848418319CF80F0@DM5PR0201MB3623.namprd02.prod.outlook.com>
	<PN1PR0101MB15653F5A90DA1B487F813570A30C0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<PN1PR0101MB15656562DD59866E054E0593A30C0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<DM5PR0201MB362301954982927477896FBAF80C0@DM5PR0201MB3623.namprd02.prod.outlook.com>
	<PN1PR0101MB1565BF7911348F75CEC33023A30C0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<PN1PR0101MB15658BF9A20726809BC61AF8A30D0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
Message-ID: <PN1PR0101MB1565178B1639A0410047E5E6A30D0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>

I gave a try with putting shared_config in every components' heat ( instead of having only in Ellis and getting pushed from there). With that, it seems to be progressing further. I see bono service in running state, ports in listen mode etc..

When I run the live tests now, most are failing for -

Failed
  RuntimeError thrown:
   - Expected 401|200, got 403

I ran sprout with log level 5. See something wrong in sprout-homestead communication (getting 404) . I have kept log @ https://drive.google.com/open?id=1cP9CkQ4dZXF6rLorQVSFOTpmK2yP6xnH

Sprout IPs : 10.0.0.26 , 10.0.0.9
Homestead IPs : 10.0.0.3, 10.0.0.16
Bono IPs : 10.0.0.19, 10.0.0.29
Testsuite : 10.0.0.35

Can someone help please ?

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Thursday, December 21, 2017 11:30 AM
To: clearwater at lists.projectclearwater.org
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

I had missed to notice this in ellis heat log. I think this is the culprit.

+ sudo /usr/share/clearwater/clearwater-config-manager/scripts/upload_shared_config
sudo: /usr/share/clearwater/clearwater-config-manager/scripts/upload_shared_config: command not found

Anyway, I did below to upload shared_config. Commands seem to have changed with latest release.

[ellis]ubuntu at ellis-0:/var/log$ cw-config download shared_config
shared_config downloaded to /home/ubuntu/clearwater-config-manager/ubuntu/shared_config

File was same as ellis shared_config file.  I had to modify it with a dummy change of putting dots in a comment line as upload command was detecting no change.

[ellis]ubuntu at ellis-0:/var/log$ cw-config upload shared_config
Config successfully validated
Configuration file change: user ubuntu has modified shared_config.
Lines removed:
"# Deployment definitions"
Lines added:
"# Deployment definitions.."

Please check the config changes and confirm that you wish to continue with the config upload.
Do you want to continue?  [yes/no] yes
shared_config successfully uploaded


[ellis]ubuntu at ellis-0:/var/log$ cw-check_restart_queue_state
Describing the current queue state for apply_config_ellis
  Nodes currently queued:
    Node ID: 10.0.0.14-ellis, Node status: processing


[ellis]ubuntu at ellis-0:/var/log$ cw-check_restart_queue_state
Describing the current queue state for apply_config_ellis
  No nodes are currently queued


[sprout]ubuntu at 0:~$ cw-check_restart_queue_state
Describing the current queue state for apply_config_sprout
  No nodes are currently queued

After this, if I download shared_config on sprout, I get the 'empty' file only in /home/ubuntu/clearwater-config-manager/ubuntu directory. So clearly sprout is not receiving the shared_config from cluster. Same is the case with bono, homestead etc.


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Wednesday, December 20, 2017 5:48 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Ying,

[ellis]ubuntu at ellis-0:/etc/clearwater$ sudo cw-upload config shared_confg
sudo: cw-upload: command not found

Then tried below command as per  http://clearwater.readthedocs.io/en/stable/Modifying_Clearwater_settings.html

[ellis]ubuntu at ellis-0:/etc/clearwater$ sudo cw-upload_shared_config
sudo: cw-upload_shared_config: command not found

Am I missing anything ?

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Ying Huang
Sent: Wednesday, December 20, 2017 5:13 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Kebar,

Yes as you noticed, the scscf uri is wrong and sprout uri isn't getting set either. This is because your nodes are missing shared_config. The shared_config on your Ellis looks right, so just run "sudo cw-upload config shared_confg" (detailed instruction here http://clearwater.readthedocs.io/en/stable/Clearwater_Configuration_Options_Reference.html#shared-config) to upload it to etcd cluster for other nodes to pick up. Then run "cw-check_restart_queue_state" on different types of nodes several times to see the nodes restarting one by one to pick up the changes. If something goes wrong here, we know the shared_config isn't being picked up correctly.


Thanks,
Ying

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: 20 December 2017 11:27
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

I have attached sprout_current.txt, which has some debug statements . I think that is giving some pointers.

My guess is /etc/clearwater/local_config (or some other appropriate config file) should have variables set for hostnames which are referred while composing these URLs.
e.g sip:scscf.;transport=TCP should be sip:scscf.<hostname<sip:scscf.%3chostname> of scscf>;transport=TCP

I will try is this direction..

Debug utils.cpp:405: Malformed host/port
Debug utils.cpp:405: Malformed host/port
Info main.cpp:1265: Sprout hostname set to
Info main.cpp:1243: S-CSCF node URI set to
Info main.cpp:1851: scscf enabled on 5054
Info main.cpp:1851: scscf prefix set to scscf
Info main.cpp:1851: scscf uri set to sip:scscf.;transport=TCP
Info main.cpp:1851: icscf enabled on 5052
Info main.cpp:1851: icscf prefix set to icscf
Info main.cpp:1851: icscf uri set to sip:icscf.;transport=TCP
Info main.cpp:1851: memento prefix set to memento
Info main.cpp:1851: memento uri set to sip:memento.;transport=TCP
Info main.cpp:1851: mangelwurzel prefix set to mangelwurzel
Info main.cpp:1851: mangelwurzel uri set to sip:mangelwurzel.;transport=TCP
Info main.cpp:1851: gemini prefix set to gemini
Info main.cpp:1851: gemini uri set to sip:gemini.;transport=TCP
Info main.cpp:1851: cdiv prefix set to cdiv
Info main.cpp:1851: cdiv uri set to sip:cdiv.;transport=TCP
Info main.cpp:1851: mmtel enabled on 5055
Info main.cpp:1851: mmtel prefix set to mmtel
Info main.cpp:1851: mmtel uri set to sip:mmtel.;transport=TCP
Info main.cpp:1851: bgcf enabled on 5053
Info main.cpp:1851: bgcf prefix set to bgcf
Info main.cpp:1851: bgcf uri set to sip:bgcf.;transport=TCP
Warning main.cpp:1855: SAS server option was invalid or not configured - SAS is disabled
Error main.cpp:1894: S/I-CSCF enabled with no Homestead server


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Wednesday, December 20, 2017 10:30 AM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Ying,

After changing log level to 5 on sprout, we need to restart sprout service, right ?
In my case, sprout service is not running.

I guess for this, I need to change the heat template to create user_settings file with log level 5.

[sprout]ubuntu at 0:/var/log/sprout$ service sprout status
* sprout is not running

[sprout]ubuntu at 0:/var/log/sprout$ ps -ef |grep sprout
ubuntu    8475  7053  0 04:53 pts/5    00:00:00 grep --color=auto sprout
root     10876     1  0 Dec18 ?        00:04:44 /usr/share/clearwater/clearwater-queue-manager/env/bin/python /usr/share/clearwater/bin/clearwater-queue-manager --local-ip=10.0.0.26 --local-site=site1 --log-level=3 --log-directory=/var/log/clearwater-queue-manager --pidfile=/var/run/clearwater-queue-manager.pid --etcd-key=clearwater --node-type=sprout --wait-plugin-complete=Y
root     11042     1  0 Dec18 ?        00:04:41 /usr/share/clearwater/clearwater-cluster-manager/env/bin/python /usr/share/clearwater/bin/clearwater-cluster-manager --mgmt-local-ip=10.0.0.26 --sig-local-ip=10.0.0.26 --local-site=site1 --remote-site= --remote-cassandra-seeds= --signaling-namespace= --uuid=535133a6-cb33-44b0-9a36-9da6e47ae280 --etcd-key=clearwater --etcd-cluster-key=sprout --cluster-manager-enabled=Y --log-level=3 --log-directory=/var/log/clearwater-cluster-manager --pidfile=/var/run/clearwater-cluster-manager.pid



From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Ying Huang
Sent: Wednesday, December 20, 2017 12:15 AM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Kedar,

Looks like a complicated situation to me. As far as I can see,


  1.  You should use log_level=5 to get more detailed logging
  2.  No the shared config shouldn't be the empty default template, this is an error
  3.  What you said about IP sounds suspicious, as one of the log file says "Failed to resolve icscf. to an IP address"

Must be frustrating to encounter errors everywhere. Shall we focus on the Sprout process and see why it fails. Would you please set log_level=5 in /etc/clearwater/user_settings on Sprout node and send a complete sprout_current.txt?


Thanks,
Ying



From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: 18 December 2017 14:00
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

6 continued.

6-a. bono errors attached for log locations mentioned in troubleshooting page. I tried stopping bono service. It got started by monit but same errors continue.
6-b. sprout errors attached for log locations mentioned in troubleshooting page. Sprout service is not running, so didn't try to stop to let me restart by monit.
6-c. /var/log/ellis/ellis-err.log is empty.
        /var/log/ellis/ellis_<time>.txt has these entries INFO web.py:1447: 200 GET /ping (0.0.0.0) 0.53ms.
        I tried stopping ellis service. It got started by monit but don't see anything changed.
       /var/log/monit.log errors attached.

Appreciate any help here !

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Monday, December 18, 2017 11:34 AM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Adam, Ying,


  1.  When I said shared_config is empty on sprout instances, I wanted to say that no config statements in it.


[sprout]ubuntu at 1:/etc/clearwater$ more shared_config
#####################################################################
# No Shared Config has been provided
# Replace this file with the Shared Configuration for your deployment
#####################################################################


  1.  /var/log/sprout/sprout_current has these entries periodically.



UTC Status utils.cpp:607: Log level set to 2

UTC Status main.cpp:1618: Access logging enabled to /var/log/sprout

UTC Warning signalhandler.h:90: SIGNAL already hooked

UTC Warning main.cpp:1674: SAS server option was invalid or not configured - SAS is disabled

UTC Error main.cpp:1713: S/I-CSCF enabled with no Homestead server


  1.  So is it ok if only one node, that is going to push shared config to cluster (ellis in the heat based deployment), to have shared_config file with all the configuration and other nodes to have 'empty' file like above ?



  1.  PFA ellis's shared_config attached. I don't find any sproutlet related configuration there..OK ? I have attached tail of ellis's heat installation log. Looks ok to me. Couldn't find anything suspicious in remaining log file.



  1.  Btw, one thing I should have told this in the beginning - When I tried the heat templates as it is, I observed that DNS VM's IP was not being passed to all other components. So I ended up carving out DNS VM and instantiated that first and used its IP in env file. I could confirm that IP got used by heat instructions of other VMs and DNSMASQ on them got configured ok. nslookup for components' names also works ok. (may be we need to use wait condition in the heat template)



  1.  I am going through troubleshooting options and will update on that.

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Adam Lindley
Sent: Friday, December 15, 2017 11:51 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

As a few more pointers of where to look, our HEAT templates currently generate shared config on the Ellis node, and upload this to the cluster as a whole. It would be worth looking at the install log on the ellis node to see if there was some error there. You may have the shared_config file present, and be able to upload that to the etcd cluster to bring the deployment to life.
If that doesn't give you any joy, make sure that the template install process has completed successfully on each of your nodes. It seems odd that shared_config has not been generated, and so I'd want to sanity check that nothing else is going wrong. If all nodes are installed, but lacking config, you should be able to generate shared config based on the script in the ellis.yaml file.
As Ying has said, once those things are sorted, you can look in the process logs to see why you are hitting errors. Almost all of our components log to /var/log/<process_name> on their node, so that's a great place to start debugging. You may also find our troubleshooting guide helpful: https://clearwater.readthedocs.io/en/stable/Troubleshooting_and_Recovery.html

Cheers,
Adam

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Ying Huang
Sent: 15 December 2017 17:54
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Kedar,

Shared config shouldn't be empty. Looks like Sprout process has failed for some reason. It's worthwhile checking the sprout log under /var/sys/log/sprout/sprout_current or send it over to see what went wrong.

Thanks,
Ying

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: 14 December 2017 14:07
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

/etc/Clearwater/shared_config is empty on both the sprout instances post installation. Is this expected if I want to run sproutlets like ICSCF, SCSCF at least ?

Here are couple of commands I tried.

[sprout]ubuntu at 0:~$ sudo monit summary
Monit 5.18.1 uptime: 7h 12m
Service Name                     Status                      Type
node-0.sprout.me.cw-ngv.com      Running                     System
sprout_process                   Execution failed | Does...  Process
snmpd_process                    Running                     Process
ntp_process                      Running                     Process
nginx_process                    Running                     Process
memcached_process                Running                     Process
clearwater_queue_manager_pro...  Running                     Process
etcd_process                     Running                     Process
clearwater_diags_monitor_pro...  Running                     Process
clearwater_config_manager_pr...  Running                     Process
clearwater_cluster_manager_p...  Running                     Process
chronos_process                  Running                     Process
astaire_process                  Running                     Process
sprout_uptime                    Wait parent                 Program
poll_sprout_sip                  Wait parent                 Program
poll_sprout_http                 Wait parent                 Program
nginx_ping                       Status ok                   Program
nginx_uptime                     Status ok                   Program
monit_uptime                     Status ok                   Program
memcached_uptime                 Status ok                   Program
poll_memcached                   Status ok                   Program
clearwater_queue_manager_uptime  Status ok                   Program
etcd_uptime                      Status ok                   Program
poll_etcd_cluster                Status ok                   Program
poll_etcd                        Status ok                   Program
chronos_uptime                   Status ok                   Program
poll_chronos                     Status ok                   Program
astaire_uptime                   Status ok                   Program

[sprout]ubuntu at 0:~$ service sprout status
* sprout is not running
[sprout]ubuntu at 0:~$ sudo service sprout start
14-12-2017 14:06:17.215 UTC Status utils.cpp:496: Switching to daemon mode

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Thursday, December 14, 2017 12:29 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

I gave a try with release 127 ( repo URL  http://repo.cw-ngv.com/archive/repo127 in env file). But issues seem to be very same.


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Wednesday, December 13, 2017 12:30 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Adam, Mike,

Clearwater heat templates on ONAP wiki are put around July 13. Clearwater release 127, which is released on May 30th , seems to have been used for testing these templates.

If I want to give a try with release 127 installation via heat, how to do that ? I tried URL http://repo.cw-ngv.com/release-127/binary/Packages in browser, but got 404.

From: Kedar Ambekar
Sent: Wednesday, December 13, 2017 11:37 AM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: RE: 502 Bad Gateway and other errors while running live tests

Hi Adam,

Got the point. I had suspected the same.
I have repo_url http://repo.cw-ngv.com/stable in heat's env file.

Is it possible to use same release on which ONAP's heat templates are based, may be by changing this repo URL?

I will have a look at current heat template on Clearwater GitHub but I think those won't be ONAP compatible.

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Adam Lindley
Sent: Tuesday, December 12, 2017 10:50 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Do you know which release you based the templates on?
We should be able to take a look over our release notes between then and now, which should give a reasonable view of the changes, and then we can go from there. Equally, the commit history (https://github.com/Metaswitch/clearwater-heat/commits/stable) gives a fairly clear overview of what and why, with the pull requests adding a bit more detail.

Though as we're likely to hit similar problems in future as we continue to develop Project Clearwater and our heat templates. Are the ONAP changes something we could be pulling in to the main code base? I'd be interested to know the extent of the work needed to keep them running

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Mike Evans
Sent: 12 December 2017 17:00
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Adam

I put the ONAP templates together, so I'm happy to update them if they won't work with the latest Project Clearwater code.  Is there anywhere I can look for an explanation of the changes?

Mike

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Adam Lindley
Sent: 12 December 2017 16:41
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Kedar,

I've just had a look around for the templates on the ONAP wiki; I wasn't aware they had their own copies of them.
I found https://wiki.onap.org/display/DW/Clearwater+vIMS+Onboarding+and+Instantiation . Is this what you've been working from?

When deploying with the templates, have you been specifying a "repo_url" option in the arguments? The Clearwater HEAT templates included steps to install the Clearwater packages from our public stable repo by default, but the templates on the ONAP wiki are now somewhat out of date. If you haven't specified a repo containing packages from the same point in time the templates were effectively forked, you're going to be hitting conflicts between the code version, and the orchestration steps.

I am not sure what differences there need to be for templates to run on ONAP, but I can point you towards our current set of heat templates: https://github.com/Metaswitch/clearwater-heat/tree/stable . I would suggest you try redeploying with these templates, as a fair number of things have changed in the code since the templates on the wiki were valid. If you hit any issues, do let us know.

Cheers,
Adam


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: 12 December 2017 13:46
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

I have installed Clearwater with heat templates (available on ONAP wiki) directly on openstack. Appreciate help on below issues.


  1.  When I run Clearwater live tests, all tests fail with below  error.



RuntimeError thrown:

   - Account creation failed with HTTP code 502, body {"status": 502, "message": "Bad Gateway", "reason": "Upstream request failed", "detail": {"Upstream error": "599", "Upstream URL": "None"}, "error": true}



  1.  ps for bono process shows this.



[bono]ubuntu at 0:/etc/clearwater$ ps -ef |grep bono

bono 6897 1 0 05:06 ? 00:00:11 /usr/share/clearwater/bin/bono --domain= --localhost=10.0.0.28,0.bono.me.cw-ngv.com --al ias=10.0.0.28,0.bono.me.cw-ngv.com, --pcscf=5060,5058 --webrtc-port=5062 --routing-proxy=icscf.,5052,50,600 --sas=0.0.0.0,bono at 0.bono.me.cw-ngv.com --dns-server=127.0.0.1 --worker-threads=2 --analytics=/var/log/bono --log-file=/var/log/bono --log-level=2 --daemon --pidfile=/var/run/bono/bono.pid



  1.  In bono, I saw these logs.

 UTC Error sip_connection_pool.cpp:190: Failed to resolve icscf. to an IP address - Not found (PJ_ENOTFOUND)

UTC Warning dnscachedresolver.cpp:828: Failed to retrieve record for icscf.: Domain name not found



  1.  To debug above issues, I ended up making these changes in /etc/init.d/bono and restarted bono service.



DAEMON_ARGS="--domain=me.cw-ngv.com  (instead of -domain=$home_domain)

upstream_hostname=icscf.sprout.me.cw-ngv.com (instead of upstream_hostname=icscf.$sprout_hostname)


  1.  But now, I get below error in bono. Port 5052 is not in listen mode on sprout.

UTC Warning pjsip: tcpc0x7f90cc07 TCP connect() error: Connection refused [code=120111]
UTC Warning pjsip: tcpc0x7f90cc07 Unable to connect to <sprout ip>:5052
============================================================================================================================
Disclaimer:  This message and the information contained herein is proprietary and confidential and subject to the Tech Mahindra policy statement, you may review the policy at http://www.techmahindra.com/Disclaimer.html externally http://tim.techmahindra.com/tim/disclaimer.html internally within TechMahindra.
============================================================================================================================
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20171221/6888454a/attachment.html>

From akedar at TechMahindra.com  Thu Dec 21 07:24:54 2017
From: akedar at TechMahindra.com (Kedar Ambekar)
Date: Thu, 21 Dec 2017 12:24:54 +0000
Subject: [Project Clearwater] 502 Bad Gateway and other errors while
 running live tests
In-Reply-To: <PN1PR0101MB1565178B1639A0410047E5E6A30D0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
References: <PN1PR0101MB1565F6502AF8CA8FE9E3E06CA3340@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<BY2PR02MB20378C8381AD633827882732E2340@BY2PR02MB2037.namprd02.prod.outlook.com>
	<BLUPR0201MB1889B9B407D22938B59ED116B0340@BLUPR0201MB1889.namprd02.prod.outlook.com>
	<BY2PR02MB2037FFD49230C6B498B0D35EE2340@BY2PR02MB2037.namprd02.prod.outlook.com>
	<PN1PR0101MB15651EE3174A2D040BB3AC5AA3350@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<PN1PR0101MB1565488BBCA00EE6E02B441FA30A0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<MA1PR0101MB155824EC66E0BBF4AA4235CEA30A0@MA1PR0101MB1558.INDPRD01.PROD.OUTLOOK.COM>
	<DM5PR0201MB36231D60D83A6D448BE67115F80B0@DM5PR0201MB3623.namprd02.prod.outlook.com>
	<CY1PR02MB20442B9F94B1E5A15A7F5E26E20B0@CY1PR02MB2044.namprd02.prod.outlook.com>
	<PN1PR0101MB156571D41BC08C9107D9C1B1A30E0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<MA1PR0101MB1558C054087ED8884393C4D0A30E0@MA1PR0101MB1558.INDPRD01.PROD.OUTLOOK.COM>
	<DM5PR0201MB36235777FB5D60848418319CF80F0@DM5PR0201MB3623.namprd02.prod.outlook.com>
	<PN1PR0101MB15653F5A90DA1B487F813570A30C0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<PN1PR0101MB15656562DD59866E054E0593A30C0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<DM5PR0201MB362301954982927477896FBAF80C0@DM5PR0201MB3623.namprd02.prod.outlook.com>
	<PN1PR0101MB1565BF7911348F75CEC33023A30C0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<PN1PR0101MB15658BF9A20726809BC61AF8A30D0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<PN1PR0101MB1565178B1639A0410047E5E6A30D0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
Message-ID: <PN1PR0101MB1565CCC89C3F0B580AEA44C9A30D0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>

Homestead log may give some clue..

21-12-2017 12:08:27.182 UTC Verbose httpstack.cpp:327: Process request for URL /impi/2425553207%40me.cw-ngv.com/av, args impu=sip%3A2425553207%40me.cw-ngv.com&server-name=sip%3Ascscf.sprout.me.cw-ngv.com%3Btransport%3DTCP
21-12-2017 12:08:27.182 UTC Debug handlers.cpp:130: Parsed HTTP request: private ID 2425553207 at me.cw-ngv.com, public ID sip:2425553207 at me.cw-ngv.com, scheme Unknown, authorization
21-12-2017 12:08:27.182 UTC Debug handlers.cpp:156: Querying cache for authentication vector for 2425553207 at me.cw-ngv.com/sip:2425553207 at me.cw-ngv.com
21-12-2017 12:08:27.182 UTC Debug a_record_resolver.cpp:55: ARecordResolver::resolve_iter for host 127.0.0.1, port 9160, family 2
21-12-2017 12:08:27.182 UTC Debug baseresolver.cpp:400: Attempt to parse 127.0.0.1 as IP address
21-12-2017 12:08:27.182 UTC Debug a_record_resolver.cpp:63: Target is an IP address
21-12-2017 12:08:27.182 UTC Debug connection_pool.h:206: Request for connection to IP: 127.0.0.1, port: 9160
21-12-2017 12:08:27.182 UTC Debug connection_pool.h:219: Found existing connection 0x25f9980 in pool
21-12-2017 12:08:27.182 UTC Debug cache.cpp:656: Looking for authentication vector for 2425553207 at me.cw-ngv.com
21-12-2017 12:08:27.182 UTC Debug cache.cpp:668: Checking public ID sip:2425553207 at me.cw-ngv.com
21-12-2017 12:08:27.182 UTC Debug cache.cpp:678: Issuing cache query
21-12-2017 12:08:27.183 UTC Debug cassandra_store.cpp:115: Failed TWO read for get_columns. Try ONE
21-12-2017 12:08:27.183 UTC Debug baseresolver.cpp:805: Successful response from  127.0.0.1:9160 transport 6
21-12-2017 12:08:27.183 UTC Debug connection_pool.h:242: Release connection to IP: 127.0.0.1, port: 9160 to pool
21-12-2017 12:08:27.183 UTC Debug cassandra_store.cpp:536: Cassandra request failed: rc=2, Row 2425553207 at me.cw-ngv.com not present in column_family impi
21-12-2017 12:08:27.184 UTC Debug event_statistic_accumulator.cpp:32: Accumulate 1309 for 0x229aa60
21-12-2017 12:08:27.184 UTC Debug event_statistic_accumulator.cpp:32: Accumulate 1309 for 0x229aad8
21-12-2017 12:08:27.184 UTC Debug handlers.cpp:185: Cache query failed - reject request
21-12-2017 12:08:27.184 UTC Debug handlers.cpp:190: No cached av found for private ID 2425553207 at me.cw-ngv.com, public ID sip:2425553207 at me.cw-ngv.com - reject
21-12-2017 12:08:27.184 UTC Verbose httpstack.cpp:68: Sending response 404 to request for URL /impi/2425553207%40me.cw-ngv.com/av, args impu=sip%3A2425553207%40me.cw-ng
v.com&server-name=sip%3Ascscf.sprout.me.cw-ngv.com%3Btransport%3DTCP
21-12-2017 12:08:27.184 UTC Debug event_statistic_accumulator.cpp:32: Accumulate 1420 for 0x2295c30
21-12-2017 12:08:27.184 UTC Debug event_statistic_accumulator.cpp:32: Accumulate 1420 for 0x2295ca8


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Thursday, December 21, 2017 5:10 PM
To: clearwater at lists.projectclearwater.org
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

I gave a try with putting shared_config in every components' heat ( instead of having only in Ellis and getting pushed from there). With that, it seems to be progressing further. I see bono service in running state, ports in listen mode etc..

When I run the live tests now, most are failing for -

Failed
  RuntimeError thrown:
   - Expected 401|200, got 403

I ran sprout with log level 5. See something wrong in sprout-homestead communication (getting 404) . I have kept log @ https://drive.google.com/open?id=1cP9CkQ4dZXF6rLorQVSFOTpmK2yP6xnH

Sprout IPs : 10.0.0.26 , 10.0.0.9
Homestead IPs : 10.0.0.3, 10.0.0.16
Bono IPs : 10.0.0.19, 10.0.0.29
Testsuite : 10.0.0.35

Can someone help please ?

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Thursday, December 21, 2017 11:30 AM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

I had missed to notice this in ellis heat log. I think this is the culprit.

+ sudo /usr/share/clearwater/clearwater-config-manager/scripts/upload_shared_config
sudo: /usr/share/clearwater/clearwater-config-manager/scripts/upload_shared_config: command not found

Anyway, I did below to upload shared_config. Commands seem to have changed with latest release.

[ellis]ubuntu at ellis-0:/var/log$ cw-config download shared_config
shared_config downloaded to /home/ubuntu/clearwater-config-manager/ubuntu/shared_config

File was same as ellis shared_config file.  I had to modify it with a dummy change of putting dots in a comment line as upload command was detecting no change.

[ellis]ubuntu at ellis-0:/var/log$ cw-config upload shared_config
Config successfully validated
Configuration file change: user ubuntu has modified shared_config.
Lines removed:
"# Deployment definitions"
Lines added:
"# Deployment definitions.."

Please check the config changes and confirm that you wish to continue with the config upload.
Do you want to continue?  [yes/no] yes
shared_config successfully uploaded


[ellis]ubuntu at ellis-0:/var/log$ cw-check_restart_queue_state
Describing the current queue state for apply_config_ellis
  Nodes currently queued:
    Node ID: 10.0.0.14-ellis, Node status: processing


[ellis]ubuntu at ellis-0:/var/log$ cw-check_restart_queue_state
Describing the current queue state for apply_config_ellis
  No nodes are currently queued


[sprout]ubuntu at 0:~$ cw-check_restart_queue_state
Describing the current queue state for apply_config_sprout
  No nodes are currently queued

After this, if I download shared_config on sprout, I get the 'empty' file only in /home/ubuntu/clearwater-config-manager/ubuntu directory. So clearly sprout is not receiving the shared_config from cluster. Same is the case with bono, homestead etc.


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Wednesday, December 20, 2017 5:48 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Ying,

[ellis]ubuntu at ellis-0:/etc/clearwater$ sudo cw-upload config shared_confg
sudo: cw-upload: command not found

Then tried below command as per  http://clearwater.readthedocs.io/en/stable/Modifying_Clearwater_settings.html

[ellis]ubuntu at ellis-0:/etc/clearwater$ sudo cw-upload_shared_config
sudo: cw-upload_shared_config: command not found

Am I missing anything ?

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Ying Huang
Sent: Wednesday, December 20, 2017 5:13 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Kebar,

Yes as you noticed, the scscf uri is wrong and sprout uri isn't getting set either. This is because your nodes are missing shared_config. The shared_config on your Ellis looks right, so just run "sudo cw-upload config shared_confg" (detailed instruction here http://clearwater.readthedocs.io/en/stable/Clearwater_Configuration_Options_Reference.html#shared-config) to upload it to etcd cluster for other nodes to pick up. Then run "cw-check_restart_queue_state" on different types of nodes several times to see the nodes restarting one by one to pick up the changes. If something goes wrong here, we know the shared_config isn't being picked up correctly.


Thanks,
Ying

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: 20 December 2017 11:27
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

I have attached sprout_current.txt, which has some debug statements . I think that is giving some pointers.

My guess is /etc/clearwater/local_config (or some other appropriate config file) should have variables set for hostnames which are referred while composing these URLs.
e.g sip:scscf.;transport=TCP should be sip:scscf.<hostname<sip:scscf.%3chostname> of scscf>;transport=TCP

I will try is this direction..

Debug utils.cpp:405: Malformed host/port
Debug utils.cpp:405: Malformed host/port
Info main.cpp:1265: Sprout hostname set to
Info main.cpp:1243: S-CSCF node URI set to
Info main.cpp:1851: scscf enabled on 5054
Info main.cpp:1851: scscf prefix set to scscf
Info main.cpp:1851: scscf uri set to sip:scscf.;transport=TCP
Info main.cpp:1851: icscf enabled on 5052
Info main.cpp:1851: icscf prefix set to icscf
Info main.cpp:1851: icscf uri set to sip:icscf.;transport=TCP
Info main.cpp:1851: memento prefix set to memento
Info main.cpp:1851: memento uri set to sip:memento.;transport=TCP
Info main.cpp:1851: mangelwurzel prefix set to mangelwurzel
Info main.cpp:1851: mangelwurzel uri set to sip:mangelwurzel.;transport=TCP
Info main.cpp:1851: gemini prefix set to gemini
Info main.cpp:1851: gemini uri set to sip:gemini.;transport=TCP
Info main.cpp:1851: cdiv prefix set to cdiv
Info main.cpp:1851: cdiv uri set to sip:cdiv.;transport=TCP
Info main.cpp:1851: mmtel enabled on 5055
Info main.cpp:1851: mmtel prefix set to mmtel
Info main.cpp:1851: mmtel uri set to sip:mmtel.;transport=TCP
Info main.cpp:1851: bgcf enabled on 5053
Info main.cpp:1851: bgcf prefix set to bgcf
Info main.cpp:1851: bgcf uri set to sip:bgcf.;transport=TCP
Warning main.cpp:1855: SAS server option was invalid or not configured - SAS is disabled
Error main.cpp:1894: S/I-CSCF enabled with no Homestead server


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Wednesday, December 20, 2017 10:30 AM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Ying,

After changing log level to 5 on sprout, we need to restart sprout service, right ?
In my case, sprout service is not running.

I guess for this, I need to change the heat template to create user_settings file with log level 5.

[sprout]ubuntu at 0:/var/log/sprout$ service sprout status
* sprout is not running

[sprout]ubuntu at 0:/var/log/sprout$ ps -ef |grep sprout
ubuntu    8475  7053  0 04:53 pts/5    00:00:00 grep --color=auto sprout
root     10876     1  0 Dec18 ?        00:04:44 /usr/share/clearwater/clearwater-queue-manager/env/bin/python /usr/share/clearwater/bin/clearwater-queue-manager --local-ip=10.0.0.26 --local-site=site1 --log-level=3 --log-directory=/var/log/clearwater-queue-manager --pidfile=/var/run/clearwater-queue-manager.pid --etcd-key=clearwater --node-type=sprout --wait-plugin-complete=Y
root     11042     1  0 Dec18 ?        00:04:41 /usr/share/clearwater/clearwater-cluster-manager/env/bin/python /usr/share/clearwater/bin/clearwater-cluster-manager --mgmt-local-ip=10.0.0.26 --sig-local-ip=10.0.0.26 --local-site=site1 --remote-site= --remote-cassandra-seeds= --signaling-namespace= --uuid=535133a6-cb33-44b0-9a36-9da6e47ae280 --etcd-key=clearwater --etcd-cluster-key=sprout --cluster-manager-enabled=Y --log-level=3 --log-directory=/var/log/clearwater-cluster-manager --pidfile=/var/run/clearwater-cluster-manager.pid



From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Ying Huang
Sent: Wednesday, December 20, 2017 12:15 AM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Kedar,

Looks like a complicated situation to me. As far as I can see,


  1.  You should use log_level=5 to get more detailed logging
  2.  No the shared config shouldn't be the empty default template, this is an error
  3.  What you said about IP sounds suspicious, as one of the log file says "Failed to resolve icscf. to an IP address"

Must be frustrating to encounter errors everywhere. Shall we focus on the Sprout process and see why it fails. Would you please set log_level=5 in /etc/clearwater/user_settings on Sprout node and send a complete sprout_current.txt?


Thanks,
Ying



From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: 18 December 2017 14:00
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

6 continued.

6-a. bono errors attached for log locations mentioned in troubleshooting page. I tried stopping bono service. It got started by monit but same errors continue.
6-b. sprout errors attached for log locations mentioned in troubleshooting page. Sprout service is not running, so didn't try to stop to let me restart by monit.
6-c. /var/log/ellis/ellis-err.log is empty.
        /var/log/ellis/ellis_<time>.txt has these entries INFO web.py:1447: 200 GET /ping (0.0.0.0) 0.53ms.
        I tried stopping ellis service. It got started by monit but don't see anything changed.
       /var/log/monit.log errors attached.

Appreciate any help here !

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Monday, December 18, 2017 11:34 AM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Adam, Ying,


  1.  When I said shared_config is empty on sprout instances, I wanted to say that no config statements in it.


[sprout]ubuntu at 1:/etc/clearwater$ more shared_config
#####################################################################
# No Shared Config has been provided
# Replace this file with the Shared Configuration for your deployment
#####################################################################


  1.  /var/log/sprout/sprout_current has these entries periodically.



UTC Status utils.cpp:607: Log level set to 2

UTC Status main.cpp:1618: Access logging enabled to /var/log/sprout

UTC Warning signalhandler.h:90: SIGNAL already hooked

UTC Warning main.cpp:1674: SAS server option was invalid or not configured - SAS is disabled

UTC Error main.cpp:1713: S/I-CSCF enabled with no Homestead server


  1.  So is it ok if only one node, that is going to push shared config to cluster (ellis in the heat based deployment), to have shared_config file with all the configuration and other nodes to have 'empty' file like above ?



  1.  PFA ellis's shared_config attached. I don't find any sproutlet related configuration there..OK ? I have attached tail of ellis's heat installation log. Looks ok to me. Couldn't find anything suspicious in remaining log file.



  1.  Btw, one thing I should have told this in the beginning - When I tried the heat templates as it is, I observed that DNS VM's IP was not being passed to all other components. So I ended up carving out DNS VM and instantiated that first and used its IP in env file. I could confirm that IP got used by heat instructions of other VMs and DNSMASQ on them got configured ok. nslookup for components' names also works ok. (may be we need to use wait condition in the heat template)



  1.  I am going through troubleshooting options and will update on that.

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Adam Lindley
Sent: Friday, December 15, 2017 11:51 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

As a few more pointers of where to look, our HEAT templates currently generate shared config on the Ellis node, and upload this to the cluster as a whole. It would be worth looking at the install log on the ellis node to see if there was some error there. You may have the shared_config file present, and be able to upload that to the etcd cluster to bring the deployment to life.
If that doesn't give you any joy, make sure that the template install process has completed successfully on each of your nodes. It seems odd that shared_config has not been generated, and so I'd want to sanity check that nothing else is going wrong. If all nodes are installed, but lacking config, you should be able to generate shared config based on the script in the ellis.yaml file.
As Ying has said, once those things are sorted, you can look in the process logs to see why you are hitting errors. Almost all of our components log to /var/log/<process_name> on their node, so that's a great place to start debugging. You may also find our troubleshooting guide helpful: https://clearwater.readthedocs.io/en/stable/Troubleshooting_and_Recovery.html

Cheers,
Adam

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Ying Huang
Sent: 15 December 2017 17:54
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Kedar,

Shared config shouldn't be empty. Looks like Sprout process has failed for some reason. It's worthwhile checking the sprout log under /var/sys/log/sprout/sprout_current or send it over to see what went wrong.

Thanks,
Ying

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: 14 December 2017 14:07
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

/etc/Clearwater/shared_config is empty on both the sprout instances post installation. Is this expected if I want to run sproutlets like ICSCF, SCSCF at least ?

Here are couple of commands I tried.

[sprout]ubuntu at 0:~$ sudo monit summary
Monit 5.18.1 uptime: 7h 12m
Service Name                     Status                      Type
node-0.sprout.me.cw-ngv.com      Running                     System
sprout_process                   Execution failed | Does...  Process
snmpd_process                    Running                     Process
ntp_process                      Running                     Process
nginx_process                    Running                     Process
memcached_process                Running                     Process
clearwater_queue_manager_pro...  Running                     Process
etcd_process                     Running                     Process
clearwater_diags_monitor_pro...  Running                     Process
clearwater_config_manager_pr...  Running                     Process
clearwater_cluster_manager_p...  Running                     Process
chronos_process                  Running                     Process
astaire_process                  Running                     Process
sprout_uptime                    Wait parent                 Program
poll_sprout_sip                  Wait parent                 Program
poll_sprout_http                 Wait parent                 Program
nginx_ping                       Status ok                   Program
nginx_uptime                     Status ok                   Program
monit_uptime                     Status ok                   Program
memcached_uptime                 Status ok                   Program
poll_memcached                   Status ok                   Program
clearwater_queue_manager_uptime  Status ok                   Program
etcd_uptime                      Status ok                   Program
poll_etcd_cluster                Status ok                   Program
poll_etcd                        Status ok                   Program
chronos_uptime                   Status ok                   Program
poll_chronos                     Status ok                   Program
astaire_uptime                   Status ok                   Program

[sprout]ubuntu at 0:~$ service sprout status
* sprout is not running
[sprout]ubuntu at 0:~$ sudo service sprout start
14-12-2017 14:06:17.215 UTC Status utils.cpp:496: Switching to daemon mode

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Thursday, December 14, 2017 12:29 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

I gave a try with release 127 ( repo URL  http://repo.cw-ngv.com/archive/repo127 in env file). But issues seem to be very same.


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Wednesday, December 13, 2017 12:30 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Adam, Mike,

Clearwater heat templates on ONAP wiki are put around July 13. Clearwater release 127, which is released on May 30th , seems to have been used for testing these templates.

If I want to give a try with release 127 installation via heat, how to do that ? I tried URL http://repo.cw-ngv.com/release-127/binary/Packages in browser, but got 404.

From: Kedar Ambekar
Sent: Wednesday, December 13, 2017 11:37 AM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: RE: 502 Bad Gateway and other errors while running live tests

Hi Adam,

Got the point. I had suspected the same.
I have repo_url http://repo.cw-ngv.com/stable in heat's env file.

Is it possible to use same release on which ONAP's heat templates are based, may be by changing this repo URL?

I will have a look at current heat template on Clearwater GitHub but I think those won't be ONAP compatible.

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Adam Lindley
Sent: Tuesday, December 12, 2017 10:50 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Do you know which release you based the templates on?
We should be able to take a look over our release notes between then and now, which should give a reasonable view of the changes, and then we can go from there. Equally, the commit history (https://github.com/Metaswitch/clearwater-heat/commits/stable) gives a fairly clear overview of what and why, with the pull requests adding a bit more detail.

Though as we're likely to hit similar problems in future as we continue to develop Project Clearwater and our heat templates. Are the ONAP changes something we could be pulling in to the main code base? I'd be interested to know the extent of the work needed to keep them running

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Mike Evans
Sent: 12 December 2017 17:00
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Adam

I put the ONAP templates together, so I'm happy to update them if they won't work with the latest Project Clearwater code.  Is there anywhere I can look for an explanation of the changes?

Mike

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Adam Lindley
Sent: 12 December 2017 16:41
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Kedar,

I've just had a look around for the templates on the ONAP wiki; I wasn't aware they had their own copies of them.
I found https://wiki.onap.org/display/DW/Clearwater+vIMS+Onboarding+and+Instantiation . Is this what you've been working from?

When deploying with the templates, have you been specifying a "repo_url" option in the arguments? The Clearwater HEAT templates included steps to install the Clearwater packages from our public stable repo by default, but the templates on the ONAP wiki are now somewhat out of date. If you haven't specified a repo containing packages from the same point in time the templates were effectively forked, you're going to be hitting conflicts between the code version, and the orchestration steps.

I am not sure what differences there need to be for templates to run on ONAP, but I can point you towards our current set of heat templates: https://github.com/Metaswitch/clearwater-heat/tree/stable . I would suggest you try redeploying with these templates, as a fair number of things have changed in the code since the templates on the wiki were valid. If you hit any issues, do let us know.

Cheers,
Adam


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: 12 December 2017 13:46
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

I have installed Clearwater with heat templates (available on ONAP wiki) directly on openstack. Appreciate help on below issues.


  1.  When I run Clearwater live tests, all tests fail with below  error.



RuntimeError thrown:

   - Account creation failed with HTTP code 502, body {"status": 502, "message": "Bad Gateway", "reason": "Upstream request failed", "detail": {"Upstream error": "599", "Upstream URL": "None"}, "error": true}



  1.  ps for bono process shows this.



[bono]ubuntu at 0:/etc/clearwater$ ps -ef |grep bono

bono 6897 1 0 05:06 ? 00:00:11 /usr/share/clearwater/bin/bono --domain= --localhost=10.0.0.28,0.bono.me.cw-ngv.com --al ias=10.0.0.28,0.bono.me.cw-ngv.com, --pcscf=5060,5058 --webrtc-port=5062 --routing-proxy=icscf.,5052,50,600 --sas=0.0.0.0,bono at 0.bono.me.cw-ngv.com --dns-server=127.0.0.1 --worker-threads=2 --analytics=/var/log/bono --log-file=/var/log/bono --log-level=2 --daemon --pidfile=/var/run/bono/bono.pid



  1.  In bono, I saw these logs.

 UTC Error sip_connection_pool.cpp:190: Failed to resolve icscf. to an IP address - Not found (PJ_ENOTFOUND)

UTC Warning dnscachedresolver.cpp:828: Failed to retrieve record for icscf.: Domain name not found



  1.  To debug above issues, I ended up making these changes in /etc/init.d/bono and restarted bono service.



DAEMON_ARGS="--domain=me.cw-ngv.com  (instead of -domain=$home_domain)

upstream_hostname=icscf.sprout.me.cw-ngv.com (instead of upstream_hostname=icscf.$sprout_hostname)


  1.  But now, I get below error in bono. Port 5052 is not in listen mode on sprout.

UTC Warning pjsip: tcpc0x7f90cc07 TCP connect() error: Connection refused [code=120111]
UTC Warning pjsip: tcpc0x7f90cc07 Unable to connect to <sprout ip>:5052
============================================================================================================================
Disclaimer:  This message and the information contained herein is proprietary and confidential and subject to the Tech Mahindra policy statement, you may review the policy at http://www.techmahindra.com/Disclaimer.html externally http://tim.techmahindra.com/tim/disclaimer.html internally within TechMahindra.
============================================================================================================================
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20171221/d1a3be13/attachment.html>

From akedar at TechMahindra.com  Thu Dec 21 08:49:43 2017
From: akedar at TechMahindra.com (Kedar Ambekar)
Date: Thu, 21 Dec 2017 13:49:43 +0000
Subject: [Project Clearwater] 502 Bad Gateway and other errors while
 running live tests
References: <PN1PR0101MB1565F6502AF8CA8FE9E3E06CA3340@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<BY2PR02MB20378C8381AD633827882732E2340@BY2PR02MB2037.namprd02.prod.outlook.com>
	<BLUPR0201MB1889B9B407D22938B59ED116B0340@BLUPR0201MB1889.namprd02.prod.outlook.com>
	<BY2PR02MB2037FFD49230C6B498B0D35EE2340@BY2PR02MB2037.namprd02.prod.outlook.com>
	<PN1PR0101MB15651EE3174A2D040BB3AC5AA3350@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<PN1PR0101MB1565488BBCA00EE6E02B441FA30A0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<MA1PR0101MB155824EC66E0BBF4AA4235CEA30A0@MA1PR0101MB1558.INDPRD01.PROD.OUTLOOK.COM>
	<DM5PR0201MB36231D60D83A6D448BE67115F80B0@DM5PR0201MB3623.namprd02.prod.outlook.com>
	<CY1PR02MB20442B9F94B1E5A15A7F5E26E20B0@CY1PR02MB2044.namprd02.prod.outlook.com>
	<PN1PR0101MB156571D41BC08C9107D9C1B1A30E0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<MA1PR0101MB1558C054087ED8884393C4D0A30E0@MA1PR0101MB1558.INDPRD01.PROD.OUTLOOK.COM>
	<DM5PR0201MB36235777FB5D60848418319CF80F0@DM5PR0201MB3623.namprd02.prod.outlook.com>
	<PN1PR0101MB15653F5A90DA1B487F813570A30C0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<PN1PR0101MB15656562DD59866E054E0593A30C0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<DM5PR0201MB362301954982927477896FBAF80C0@DM5PR0201MB3623.namprd02.prod.outlook.com>
	<PN1PR0101MB1565BF7911348F75CEC33023A30C0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<PN1PR0101MB15658BF9A20726809BC61AF8A30D0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<PN1PR0101MB1565178B1639A0410047E5E6A30D0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
Message-ID: <PN1PR0101MB156592E388AB31D0EB0FF4A0A30D0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>

One observation is impu table is empty.

cqlsh:homestead_cache> select count(*) from impu
                   ... ;

count
-------
     0

Below is ellis heat log, which has create_numbers step. Is this supposed to populate that table ?

+ /usr/share/clearwater/ellis/env/bin/python /usr/share/clearwater/ellis/src/metaswitch/ellis/tools/create_numbers.py --start 2425550000 --count 10000
Created 10000 numbers, 0 already present in database

From: Kedar Ambekar
Sent: Thursday, December 21, 2017 5:55 PM
To: clearwater at lists.projectclearwater.org
Subject: RE: 502 Bad Gateway and other errors while running live tests

Homestead log may give some clue..

21-12-2017 12:08:27.182 UTC Verbose httpstack.cpp:327: Process request for URL /impi/2425553207%40me.cw-ngv.com/av, args impu=sip%3A2425553207%40me.cw-ngv.com&server-name=sip%3Ascscf.sprout.me.cw-ngv.com%3Btransport%3DTCP
21-12-2017 12:08:27.182 UTC Debug handlers.cpp:130: Parsed HTTP request: private ID 2425553207 at me.cw-ngv.com<mailto:2425553207 at me.cw-ngv.com>, public ID sip:2425553207 at me.cw-ngv.com, scheme Unknown, authorization
21-12-2017 12:08:27.182 UTC Debug handlers.cpp:156: Querying cache for authentication vector for 2425553207 at me.cw-ngv.com/sip:2425553207 at me.cw-ngv.com<mailto:2425553207 at me.cw-ngv.com/sip:2425553207 at me.cw-ngv.com>
21-12-2017 12:08:27.182 UTC Debug a_record_resolver.cpp:55: ARecordResolver::resolve_iter for host 127.0.0.1, port 9160, family 2
21-12-2017 12:08:27.182 UTC Debug baseresolver.cpp:400: Attempt to parse 127.0.0.1 as IP address
21-12-2017 12:08:27.182 UTC Debug a_record_resolver.cpp:63: Target is an IP address
21-12-2017 12:08:27.182 UTC Debug connection_pool.h:206: Request for connection to IP: 127.0.0.1, port: 9160
21-12-2017 12:08:27.182 UTC Debug connection_pool.h:219: Found existing connection 0x25f9980 in pool
21-12-2017 12:08:27.182 UTC Debug cache.cpp:656: Looking for authentication vector for 2425553207 at me.cw-ngv.com<mailto:2425553207 at me.cw-ngv.com>
21-12-2017 12:08:27.182 UTC Debug cache.cpp:668: Checking public ID sip:2425553207 at me.cw-ngv.com
21-12-2017 12:08:27.182 UTC Debug cache.cpp:678: Issuing cache query
21-12-2017 12:08:27.183 UTC Debug cassandra_store.cpp:115: Failed TWO read for get_columns. Try ONE
21-12-2017 12:08:27.183 UTC Debug baseresolver.cpp:805: Successful response from  127.0.0.1:9160 transport 6
21-12-2017 12:08:27.183 UTC Debug connection_pool.h:242: Release connection to IP: 127.0.0.1, port: 9160 to pool
21-12-2017 12:08:27.183 UTC Debug cassandra_store.cpp:536: Cassandra request failed: rc=2, Row 2425553207 at me.cw-ngv.com<mailto:2425553207 at me.cw-ngv.com> not present in column_family impi
21-12-2017 12:08:27.184 UTC Debug event_statistic_accumulator.cpp:32: Accumulate 1309 for 0x229aa60
21-12-2017 12:08:27.184 UTC Debug event_statistic_accumulator.cpp:32: Accumulate 1309 for 0x229aad8
21-12-2017 12:08:27.184 UTC Debug handlers.cpp:185: Cache query failed - reject request
21-12-2017 12:08:27.184 UTC Debug handlers.cpp:190: No cached av found for private ID 2425553207 at me.cw-ngv.com<mailto:2425553207 at me.cw-ngv.com>, public ID sip:2425553207 at me.cw-ngv.com - reject
21-12-2017 12:08:27.184 UTC Verbose httpstack.cpp:68: Sending response 404 to request for URL /impi/2425553207%40me.cw-ngv.com/av, args impu=sip%3A2425553207%40me.cw-ng
v.com&server-name=sip%3Ascscf.sprout.me.cw-ngv.com%3Btransport%3DTCP
21-12-2017 12:08:27.184 UTC Debug event_statistic_accumulator.cpp:32: Accumulate 1420 for 0x2295c30
21-12-2017 12:08:27.184 UTC Debug event_statistic_accumulator.cpp:32: Accumulate 1420 for 0x2295ca8


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Thursday, December 21, 2017 5:10 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

I gave a try with putting shared_config in every components' heat ( instead of having only in Ellis and getting pushed from there). With that, it seems to be progressing further. I see bono service in running state, ports in listen mode etc..

When I run the live tests now, most are failing for -

Failed
  RuntimeError thrown:
   - Expected 401|200, got 403

I ran sprout with log level 5. See something wrong in sprout-homestead communication (getting 404) . I have kept log @ https://drive.google.com/open?id=1cP9CkQ4dZXF6rLorQVSFOTpmK2yP6xnH

Sprout IPs : 10.0.0.26 , 10.0.0.9
Homestead IPs : 10.0.0.3, 10.0.0.16
Bono IPs : 10.0.0.19, 10.0.0.29
Testsuite : 10.0.0.35

Can someone help please ?

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Thursday, December 21, 2017 11:30 AM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

I had missed to notice this in ellis heat log. I think this is the culprit.

+ sudo /usr/share/clearwater/clearwater-config-manager/scripts/upload_shared_config
sudo: /usr/share/clearwater/clearwater-config-manager/scripts/upload_shared_config: command not found

Anyway, I did below to upload shared_config. Commands seem to have changed with latest release.

[ellis]ubuntu at ellis-0:/var/log$ cw-config download shared_config
shared_config downloaded to /home/ubuntu/clearwater-config-manager/ubuntu/shared_config

File was same as ellis shared_config file.  I had to modify it with a dummy change of putting dots in a comment line as upload command was detecting no change.

[ellis]ubuntu at ellis-0:/var/log$ cw-config upload shared_config
Config successfully validated
Configuration file change: user ubuntu has modified shared_config.
Lines removed:
"# Deployment definitions"
Lines added:
"# Deployment definitions.."

Please check the config changes and confirm that you wish to continue with the config upload.
Do you want to continue?  [yes/no] yes
shared_config successfully uploaded


[ellis]ubuntu at ellis-0:/var/log$ cw-check_restart_queue_state
Describing the current queue state for apply_config_ellis
  Nodes currently queued:
    Node ID: 10.0.0.14-ellis, Node status: processing


[ellis]ubuntu at ellis-0:/var/log$ cw-check_restart_queue_state
Describing the current queue state for apply_config_ellis
  No nodes are currently queued


[sprout]ubuntu at 0:~$ cw-check_restart_queue_state
Describing the current queue state for apply_config_sprout
  No nodes are currently queued

After this, if I download shared_config on sprout, I get the 'empty' file only in /home/ubuntu/clearwater-config-manager/ubuntu directory. So clearly sprout is not receiving the shared_config from cluster. Same is the case with bono, homestead etc.


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Wednesday, December 20, 2017 5:48 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Ying,

[ellis]ubuntu at ellis-0:/etc/clearwater$ sudo cw-upload config shared_confg
sudo: cw-upload: command not found

Then tried below command as per  http://clearwater.readthedocs.io/en/stable/Modifying_Clearwater_settings.html

[ellis]ubuntu at ellis-0:/etc/clearwater$ sudo cw-upload_shared_config
sudo: cw-upload_shared_config: command not found

Am I missing anything ?

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Ying Huang
Sent: Wednesday, December 20, 2017 5:13 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Kebar,

Yes as you noticed, the scscf uri is wrong and sprout uri isn't getting set either. This is because your nodes are missing shared_config. The shared_config on your Ellis looks right, so just run "sudo cw-upload config shared_confg" (detailed instruction here http://clearwater.readthedocs.io/en/stable/Clearwater_Configuration_Options_Reference.html#shared-config) to upload it to etcd cluster for other nodes to pick up. Then run "cw-check_restart_queue_state" on different types of nodes several times to see the nodes restarting one by one to pick up the changes. If something goes wrong here, we know the shared_config isn't being picked up correctly.


Thanks,
Ying

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: 20 December 2017 11:27
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

I have attached sprout_current.txt, which has some debug statements . I think that is giving some pointers.

My guess is /etc/clearwater/local_config (or some other appropriate config file) should have variables set for hostnames which are referred while composing these URLs.
e.g sip:scscf.;transport=TCP should be sip:scscf.<hostname<sip:scscf.%3chostname> of scscf>;transport=TCP

I will try is this direction..

Debug utils.cpp:405: Malformed host/port
Debug utils.cpp:405: Malformed host/port
Info main.cpp:1265: Sprout hostname set to
Info main.cpp:1243: S-CSCF node URI set to
Info main.cpp:1851: scscf enabled on 5054
Info main.cpp:1851: scscf prefix set to scscf
Info main.cpp:1851: scscf uri set to sip:scscf.;transport=TCP
Info main.cpp:1851: icscf enabled on 5052
Info main.cpp:1851: icscf prefix set to icscf
Info main.cpp:1851: icscf uri set to sip:icscf.;transport=TCP
Info main.cpp:1851: memento prefix set to memento
Info main.cpp:1851: memento uri set to sip:memento.;transport=TCP
Info main.cpp:1851: mangelwurzel prefix set to mangelwurzel
Info main.cpp:1851: mangelwurzel uri set to sip:mangelwurzel.;transport=TCP
Info main.cpp:1851: gemini prefix set to gemini
Info main.cpp:1851: gemini uri set to sip:gemini.;transport=TCP
Info main.cpp:1851: cdiv prefix set to cdiv
Info main.cpp:1851: cdiv uri set to sip:cdiv.;transport=TCP
Info main.cpp:1851: mmtel enabled on 5055
Info main.cpp:1851: mmtel prefix set to mmtel
Info main.cpp:1851: mmtel uri set to sip:mmtel.;transport=TCP
Info main.cpp:1851: bgcf enabled on 5053
Info main.cpp:1851: bgcf prefix set to bgcf
Info main.cpp:1851: bgcf uri set to sip:bgcf.;transport=TCP
Warning main.cpp:1855: SAS server option was invalid or not configured - SAS is disabled
Error main.cpp:1894: S/I-CSCF enabled with no Homestead server


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Wednesday, December 20, 2017 10:30 AM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Ying,

After changing log level to 5 on sprout, we need to restart sprout service, right ?
In my case, sprout service is not running.

I guess for this, I need to change the heat template to create user_settings file with log level 5.

[sprout]ubuntu at 0:/var/log/sprout$ service sprout status
* sprout is not running

[sprout]ubuntu at 0:/var/log/sprout$ ps -ef |grep sprout
ubuntu    8475  7053  0 04:53 pts/5    00:00:00 grep --color=auto sprout
root     10876     1  0 Dec18 ?        00:04:44 /usr/share/clearwater/clearwater-queue-manager/env/bin/python /usr/share/clearwater/bin/clearwater-queue-manager --local-ip=10.0.0.26 --local-site=site1 --log-level=3 --log-directory=/var/log/clearwater-queue-manager --pidfile=/var/run/clearwater-queue-manager.pid --etcd-key=clearwater --node-type=sprout --wait-plugin-complete=Y
root     11042     1  0 Dec18 ?        00:04:41 /usr/share/clearwater/clearwater-cluster-manager/env/bin/python /usr/share/clearwater/bin/clearwater-cluster-manager --mgmt-local-ip=10.0.0.26 --sig-local-ip=10.0.0.26 --local-site=site1 --remote-site= --remote-cassandra-seeds= --signaling-namespace= --uuid=535133a6-cb33-44b0-9a36-9da6e47ae280 --etcd-key=clearwater --etcd-cluster-key=sprout --cluster-manager-enabled=Y --log-level=3 --log-directory=/var/log/clearwater-cluster-manager --pidfile=/var/run/clearwater-cluster-manager.pid



From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Ying Huang
Sent: Wednesday, December 20, 2017 12:15 AM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Kedar,

Looks like a complicated situation to me. As far as I can see,


  1.  You should use log_level=5 to get more detailed logging
  2.  No the shared config shouldn't be the empty default template, this is an error
  3.  What you said about IP sounds suspicious, as one of the log file says "Failed to resolve icscf. to an IP address"

Must be frustrating to encounter errors everywhere. Shall we focus on the Sprout process and see why it fails. Would you please set log_level=5 in /etc/clearwater/user_settings on Sprout node and send a complete sprout_current.txt?


Thanks,
Ying



From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: 18 December 2017 14:00
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

6 continued.

6-a. bono errors attached for log locations mentioned in troubleshooting page. I tried stopping bono service. It got started by monit but same errors continue.
6-b. sprout errors attached for log locations mentioned in troubleshooting page. Sprout service is not running, so didn't try to stop to let me restart by monit.
6-c. /var/log/ellis/ellis-err.log is empty.
        /var/log/ellis/ellis_<time>.txt has these entries INFO web.py:1447: 200 GET /ping (0.0.0.0) 0.53ms.
        I tried stopping ellis service. It got started by monit but don't see anything changed.
       /var/log/monit.log errors attached.

Appreciate any help here !

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Monday, December 18, 2017 11:34 AM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Adam, Ying,


  1.  When I said shared_config is empty on sprout instances, I wanted to say that no config statements in it.


[sprout]ubuntu at 1:/etc/clearwater$ more shared_config
#####################################################################
# No Shared Config has been provided
# Replace this file with the Shared Configuration for your deployment
#####################################################################


  1.  /var/log/sprout/sprout_current has these entries periodically.



UTC Status utils.cpp:607: Log level set to 2

UTC Status main.cpp:1618: Access logging enabled to /var/log/sprout

UTC Warning signalhandler.h:90: SIGNAL already hooked

UTC Warning main.cpp:1674: SAS server option was invalid or not configured - SAS is disabled

UTC Error main.cpp:1713: S/I-CSCF enabled with no Homestead server


  1.  So is it ok if only one node, that is going to push shared config to cluster (ellis in the heat based deployment), to have shared_config file with all the configuration and other nodes to have 'empty' file like above ?



  1.  PFA ellis's shared_config attached. I don't find any sproutlet related configuration there..OK ? I have attached tail of ellis's heat installation log. Looks ok to me. Couldn't find anything suspicious in remaining log file.



  1.  Btw, one thing I should have told this in the beginning - When I tried the heat templates as it is, I observed that DNS VM's IP was not being passed to all other components. So I ended up carving out DNS VM and instantiated that first and used its IP in env file. I could confirm that IP got used by heat instructions of other VMs and DNSMASQ on them got configured ok. nslookup for components' names also works ok. (may be we need to use wait condition in the heat template)



  1.  I am going through troubleshooting options and will update on that.

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Adam Lindley
Sent: Friday, December 15, 2017 11:51 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

As a few more pointers of where to look, our HEAT templates currently generate shared config on the Ellis node, and upload this to the cluster as a whole. It would be worth looking at the install log on the ellis node to see if there was some error there. You may have the shared_config file present, and be able to upload that to the etcd cluster to bring the deployment to life.
If that doesn't give you any joy, make sure that the template install process has completed successfully on each of your nodes. It seems odd that shared_config has not been generated, and so I'd want to sanity check that nothing else is going wrong. If all nodes are installed, but lacking config, you should be able to generate shared config based on the script in the ellis.yaml file.
As Ying has said, once those things are sorted, you can look in the process logs to see why you are hitting errors. Almost all of our components log to /var/log/<process_name> on their node, so that's a great place to start debugging. You may also find our troubleshooting guide helpful: https://clearwater.readthedocs.io/en/stable/Troubleshooting_and_Recovery.html

Cheers,
Adam

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Ying Huang
Sent: 15 December 2017 17:54
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Kedar,

Shared config shouldn't be empty. Looks like Sprout process has failed for some reason. It's worthwhile checking the sprout log under /var/sys/log/sprout/sprout_current or send it over to see what went wrong.

Thanks,
Ying

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: 14 December 2017 14:07
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

/etc/Clearwater/shared_config is empty on both the sprout instances post installation. Is this expected if I want to run sproutlets like ICSCF, SCSCF at least ?

Here are couple of commands I tried.

[sprout]ubuntu at 0:~$ sudo monit summary
Monit 5.18.1 uptime: 7h 12m
Service Name                     Status                      Type
node-0.sprout.me.cw-ngv.com      Running                     System
sprout_process                   Execution failed | Does...  Process
snmpd_process                    Running                     Process
ntp_process                      Running                     Process
nginx_process                    Running                     Process
memcached_process                Running                     Process
clearwater_queue_manager_pro...  Running                     Process
etcd_process                     Running                     Process
clearwater_diags_monitor_pro...  Running                     Process
clearwater_config_manager_pr...  Running                     Process
clearwater_cluster_manager_p...  Running                     Process
chronos_process                  Running                     Process
astaire_process                  Running                     Process
sprout_uptime                    Wait parent                 Program
poll_sprout_sip                  Wait parent                 Program
poll_sprout_http                 Wait parent                 Program
nginx_ping                       Status ok                   Program
nginx_uptime                     Status ok                   Program
monit_uptime                     Status ok                   Program
memcached_uptime                 Status ok                   Program
poll_memcached                   Status ok                   Program
clearwater_queue_manager_uptime  Status ok                   Program
etcd_uptime                      Status ok                   Program
poll_etcd_cluster                Status ok                   Program
poll_etcd                        Status ok                   Program
chronos_uptime                   Status ok                   Program
poll_chronos                     Status ok                   Program
astaire_uptime                   Status ok                   Program

[sprout]ubuntu at 0:~$ service sprout status
* sprout is not running
[sprout]ubuntu at 0:~$ sudo service sprout start
14-12-2017 14:06:17.215 UTC Status utils.cpp:496: Switching to daemon mode

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Thursday, December 14, 2017 12:29 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

I gave a try with release 127 ( repo URL  http://repo.cw-ngv.com/archive/repo127 in env file). But issues seem to be very same.


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Wednesday, December 13, 2017 12:30 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Adam, Mike,

Clearwater heat templates on ONAP wiki are put around July 13. Clearwater release 127, which is released on May 30th , seems to have been used for testing these templates.

If I want to give a try with release 127 installation via heat, how to do that ? I tried URL http://repo.cw-ngv.com/release-127/binary/Packages in browser, but got 404.

From: Kedar Ambekar
Sent: Wednesday, December 13, 2017 11:37 AM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: RE: 502 Bad Gateway and other errors while running live tests

Hi Adam,

Got the point. I had suspected the same.
I have repo_url http://repo.cw-ngv.com/stable in heat's env file.

Is it possible to use same release on which ONAP's heat templates are based, may be by changing this repo URL?

I will have a look at current heat template on Clearwater GitHub but I think those won't be ONAP compatible.

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Adam Lindley
Sent: Tuesday, December 12, 2017 10:50 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Do you know which release you based the templates on?
We should be able to take a look over our release notes between then and now, which should give a reasonable view of the changes, and then we can go from there. Equally, the commit history (https://github.com/Metaswitch/clearwater-heat/commits/stable) gives a fairly clear overview of what and why, with the pull requests adding a bit more detail.

Though as we're likely to hit similar problems in future as we continue to develop Project Clearwater and our heat templates. Are the ONAP changes something we could be pulling in to the main code base? I'd be interested to know the extent of the work needed to keep them running

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Mike Evans
Sent: 12 December 2017 17:00
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Adam

I put the ONAP templates together, so I'm happy to update them if they won't work with the latest Project Clearwater code.  Is there anywhere I can look for an explanation of the changes?

Mike

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Adam Lindley
Sent: 12 December 2017 16:41
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Kedar,

I've just had a look around for the templates on the ONAP wiki; I wasn't aware they had their own copies of them.
I found https://wiki.onap.org/display/DW/Clearwater+vIMS+Onboarding+and+Instantiation . Is this what you've been working from?

When deploying with the templates, have you been specifying a "repo_url" option in the arguments? The Clearwater HEAT templates included steps to install the Clearwater packages from our public stable repo by default, but the templates on the ONAP wiki are now somewhat out of date. If you haven't specified a repo containing packages from the same point in time the templates were effectively forked, you're going to be hitting conflicts between the code version, and the orchestration steps.

I am not sure what differences there need to be for templates to run on ONAP, but I can point you towards our current set of heat templates: https://github.com/Metaswitch/clearwater-heat/tree/stable . I would suggest you try redeploying with these templates, as a fair number of things have changed in the code since the templates on the wiki were valid. If you hit any issues, do let us know.

Cheers,
Adam


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: 12 December 2017 13:46
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

I have installed Clearwater with heat templates (available on ONAP wiki) directly on openstack. Appreciate help on below issues.


  1.  When I run Clearwater live tests, all tests fail with below  error.



RuntimeError thrown:

   - Account creation failed with HTTP code 502, body {"status": 502, "message": "Bad Gateway", "reason": "Upstream request failed", "detail": {"Upstream error": "599", "Upstream URL": "None"}, "error": true}



  1.  ps for bono process shows this.



[bono]ubuntu at 0:/etc/clearwater$ ps -ef |grep bono

bono 6897 1 0 05:06 ? 00:00:11 /usr/share/clearwater/bin/bono --domain= --localhost=10.0.0.28,0.bono.me.cw-ngv.com --al ias=10.0.0.28,0.bono.me.cw-ngv.com, --pcscf=5060,5058 --webrtc-port=5062 --routing-proxy=icscf.,5052,50,600 --sas=0.0.0.0,bono at 0.bono.me.cw-ngv.com --dns-server=127.0.0.1 --worker-threads=2 --analytics=/var/log/bono --log-file=/var/log/bono --log-level=2 --daemon --pidfile=/var/run/bono/bono.pid



  1.  In bono, I saw these logs.

 UTC Error sip_connection_pool.cpp:190: Failed to resolve icscf. to an IP address - Not found (PJ_ENOTFOUND)

UTC Warning dnscachedresolver.cpp:828: Failed to retrieve record for icscf.: Domain name not found



  1.  To debug above issues, I ended up making these changes in /etc/init.d/bono and restarted bono service.



DAEMON_ARGS="--domain=me.cw-ngv.com  (instead of -domain=$home_domain)

upstream_hostname=icscf.sprout.me.cw-ngv.com (instead of upstream_hostname=icscf.$sprout_hostname)


  1.  But now, I get below error in bono. Port 5052 is not in listen mode on sprout.

UTC Warning pjsip: tcpc0x7f90cc07 TCP connect() error: Connection refused [code=120111]
UTC Warning pjsip: tcpc0x7f90cc07 Unable to connect to <sprout ip>:5052
============================================================================================================================
Disclaimer:  This message and the information contained herein is proprietary and confidential and subject to the Tech Mahindra policy statement, you may review the policy at http://www.techmahindra.com/Disclaimer.html externally http://tim.techmahindra.com/tim/disclaimer.html internally within TechMahindra.
============================================================================================================================
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20171221/8571fee8/attachment.html>

From Graeme.Robertson at metaswitch.com  Fri Dec 22 07:20:43 2017
From: Graeme.Robertson at metaswitch.com (Graeme Robertson)
Date: Fri, 22 Dec 2017 12:20:43 +0000
Subject: [Project Clearwater] 502 Bad Gateway and other errors while
 running live tests
In-Reply-To: <PN1PR0101MB156592E388AB31D0EB0FF4A0A30D0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
References: <PN1PR0101MB1565F6502AF8CA8FE9E3E06CA3340@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<BY2PR02MB20378C8381AD633827882732E2340@BY2PR02MB2037.namprd02.prod.outlook.com>
	<BLUPR0201MB1889B9B407D22938B59ED116B0340@BLUPR0201MB1889.namprd02.prod.outlook.com>
	<BY2PR02MB2037FFD49230C6B498B0D35EE2340@BY2PR02MB2037.namprd02.prod.outlook.com>
	<PN1PR0101MB15651EE3174A2D040BB3AC5AA3350@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<PN1PR0101MB1565488BBCA00EE6E02B441FA30A0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<MA1PR0101MB155824EC66E0BBF4AA4235CEA30A0@MA1PR0101MB1558.INDPRD01.PROD.OUTLOOK.COM>
	<DM5PR0201MB36231D60D83A6D448BE67115F80B0@DM5PR0201MB3623.namprd02.prod.outlook.com>
	<CY1PR02MB20442B9F94B1E5A15A7F5E26E20B0@CY1PR02MB2044.namprd02.prod.outlook.com>
	<PN1PR0101MB156571D41BC08C9107D9C1B1A30E0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<MA1PR0101MB1558C054087ED8884393C4D0A30E0@MA1PR0101MB1558.INDPRD01.PROD.OUTLOOK.COM>
	<DM5PR0201MB36235777FB5D60848418319CF80F0@DM5PR0201MB3623.namprd02.prod.outlook.com>
	<PN1PR0101MB15653F5A90DA1B487F813570A30C0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<PN1PR0101MB15656562DD59866E054E0593A30C0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<DM5PR0201MB362301954982927477896FBAF80C0@DM5PR0201MB3623.namprd02.prod.outlook.com>
	<PN1PR0101MB1565BF7911348F75CEC33023A30C0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<PN1PR0101MB15658BF9A20726809BC61AF8A30D0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<PN1PR0101MB1565178B1639A0410047E5E6A30D0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<PN1PR0101MB156592E388AB31D0EB0FF4A0A30D0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
Message-ID: <CY4PR02MB33343C9FAFB74316D1DEE7DCE3020@CY4PR02MB3334.namprd02.prod.outlook.com>

Hello Kedar,

The homestead_cache tables are only populated after traffic is running through the system; logically, the subscribers get provisioned in the homestead_prov tables and then information about them gets "cached" in the homestead_cache tables to avoid constantly looking things up in the HSS. Obviously this is less meaningful when you're using homestead-prov rather than a real HSS, but the key point is that it's fine for that table to be empty.

The thing I'm most concerned about right now is that you don't seem to have an etcd cluster, which basically means that nothing will work :). In theory your first node will form an etcd cluster with itself as the sole member (in this case, that's the Ellis node). Then subsequent nodes will join the same cluster. The mechanism for this to happen is via the etcd_cluster configuration option /etc/clearwater/local_config, so all of your nodes should have this set to the same value (the IP address of your Ellis node). It's crucial that this step has happened correctly because etcd is responsible for propagating configuration around your cluster (hence the lack of shared config!) and for clustering your databases (which may explain the Cassandra problems you're hitting). When you uploaded shared config on the Ellis node and nothing else was affected, that suggested to me that the Ellis node is the only node in the etcd cluster.

I suggest doing the following...

*        As per http://clearwater.readthedocs.io/en/stable/Troubleshooting_and_Recovery.html?highlight=troubleshooting, run the following commands (on your Ellis node?) to check the state of your etcd cluster

cw-check_cluster_state

clearwater-etcdctl cluster-health

clearwater-etcdctl member list



*        Check /etc/clearwater/local_config on each node and check etcd_cluster is set to the correct value. If it's not, you'll probably need to...

o   Correct the value

o   Delete existing etcd data on the node (rm -rf /var/lib/clearwater-etcd)

o   Restart clearwater-etcd (sudo service clearwater-etcd restart)

Good luck!
Graeme

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: 21 December 2017 13:50
To: clearwater at lists.projectclearwater.org
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

One observation is impu table is empty.

cqlsh:homestead_cache> select count(*) from impu
                   ... ;

count
-------
     0

Below is ellis heat log, which has create_numbers step. Is this supposed to populate that table ?

+ /usr/share/clearwater/ellis/env/bin/python /usr/share/clearwater/ellis/src/metaswitch/ellis/tools/create_numbers.py --start 2425550000 --count 10000
Created 10000 numbers, 0 already present in database

From: Kedar Ambekar
Sent: Thursday, December 21, 2017 5:55 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: RE: 502 Bad Gateway and other errors while running live tests

Homestead log may give some clue..

21-12-2017 12:08:27.182 UTC Verbose httpstack.cpp:327: Process request for URL /impi/2425553207%40me.cw-ngv.com/av, args impu=sip%3A2425553207%40me.cw-ngv.com&server-name=sip%3Ascscf.sprout.me.cw-ngv.com%3Btransport%3DTCP
21-12-2017 12:08:27.182 UTC Debug handlers.cpp:130: Parsed HTTP request: private ID 2425553207 at me.cw-ngv.com<mailto:2425553207 at me.cw-ngv.com>, public ID sip:2425553207 at me.cw-ngv.com, scheme Unknown, authorization
21-12-2017 12:08:27.182 UTC Debug handlers.cpp:156: Querying cache for authentication vector for 2425553207 at me.cw-ngv.com/sip:2425553207 at me.cw-ngv.com<mailto:2425553207 at me.cw-ngv.com/sip:2425553207 at me.cw-ngv.com>
21-12-2017 12:08:27.182 UTC Debug a_record_resolver.cpp:55: ARecordResolver::resolve_iter for host 127.0.0.1, port 9160, family 2
21-12-2017 12:08:27.182 UTC Debug baseresolver.cpp:400: Attempt to parse 127.0.0.1 as IP address
21-12-2017 12:08:27.182 UTC Debug a_record_resolver.cpp:63: Target is an IP address
21-12-2017 12:08:27.182 UTC Debug connection_pool.h:206: Request for connection to IP: 127.0.0.1, port: 9160
21-12-2017 12:08:27.182 UTC Debug connection_pool.h:219: Found existing connection 0x25f9980 in pool
21-12-2017 12:08:27.182 UTC Debug cache.cpp:656: Looking for authentication vector for 2425553207 at me.cw-ngv.com<mailto:2425553207 at me.cw-ngv.com>
21-12-2017 12:08:27.182 UTC Debug cache.cpp:668: Checking public ID sip:2425553207 at me.cw-ngv.com
21-12-2017 12:08:27.182 UTC Debug cache.cpp:678: Issuing cache query
21-12-2017 12:08:27.183 UTC Debug cassandra_store.cpp:115: Failed TWO read for get_columns. Try ONE
21-12-2017 12:08:27.183 UTC Debug baseresolver.cpp:805: Successful response from  127.0.0.1:9160 transport 6
21-12-2017 12:08:27.183 UTC Debug connection_pool.h:242: Release connection to IP: 127.0.0.1, port: 9160 to pool
21-12-2017 12:08:27.183 UTC Debug cassandra_store.cpp:536: Cassandra request failed: rc=2, Row 2425553207 at me.cw-ngv.com<mailto:2425553207 at me.cw-ngv.com> not present in column_family impi
21-12-2017 12:08:27.184 UTC Debug event_statistic_accumulator.cpp:32: Accumulate 1309 for 0x229aa60
21-12-2017 12:08:27.184 UTC Debug event_statistic_accumulator.cpp:32: Accumulate 1309 for 0x229aad8
21-12-2017 12:08:27.184 UTC Debug handlers.cpp:185: Cache query failed - reject request
21-12-2017 12:08:27.184 UTC Debug handlers.cpp:190: No cached av found for private ID 2425553207 at me.cw-ngv.com<mailto:2425553207 at me.cw-ngv.com>, public ID sip:2425553207 at me.cw-ngv.com - reject
21-12-2017 12:08:27.184 UTC Verbose httpstack.cpp:68: Sending response 404 to request for URL /impi/2425553207%40me.cw-ngv.com/av, args impu=sip%3A2425553207%40me.cw-ng
v.com&server-name=sip%3Ascscf.sprout.me.cw-ngv.com%3Btransport%3DTCP
21-12-2017 12:08:27.184 UTC Debug event_statistic_accumulator.cpp:32: Accumulate 1420 for 0x2295c30
21-12-2017 12:08:27.184 UTC Debug event_statistic_accumulator.cpp:32: Accumulate 1420 for 0x2295ca8


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Thursday, December 21, 2017 5:10 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

I gave a try with putting shared_config in every components' heat ( instead of having only in Ellis and getting pushed from there). With that, it seems to be progressing further. I see bono service in running state, ports in listen mode etc..

When I run the live tests now, most are failing for -

Failed
  RuntimeError thrown:
   - Expected 401|200, got 403

I ran sprout with log level 5. See something wrong in sprout-homestead communication (getting 404) . I have kept log @ https://drive.google.com/open?id=1cP9CkQ4dZXF6rLorQVSFOTpmK2yP6xnH

Sprout IPs : 10.0.0.26 , 10.0.0.9
Homestead IPs : 10.0.0.3, 10.0.0.16
Bono IPs : 10.0.0.19, 10.0.0.29
Testsuite : 10.0.0.35

Can someone help please ?

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Thursday, December 21, 2017 11:30 AM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

I had missed to notice this in ellis heat log. I think this is the culprit.

+ sudo /usr/share/clearwater/clearwater-config-manager/scripts/upload_shared_config
sudo: /usr/share/clearwater/clearwater-config-manager/scripts/upload_shared_config: command not found

Anyway, I did below to upload shared_config. Commands seem to have changed with latest release.

[ellis]ubuntu at ellis-0:/var/log$ cw-config download shared_config
shared_config downloaded to /home/ubuntu/clearwater-config-manager/ubuntu/shared_config

File was same as ellis shared_config file.  I had to modify it with a dummy change of putting dots in a comment line as upload command was detecting no change.

[ellis]ubuntu at ellis-0:/var/log$ cw-config upload shared_config
Config successfully validated
Configuration file change: user ubuntu has modified shared_config.
Lines removed:
"# Deployment definitions"
Lines added:
"# Deployment definitions.."

Please check the config changes and confirm that you wish to continue with the config upload.
Do you want to continue?  [yes/no] yes
shared_config successfully uploaded


[ellis]ubuntu at ellis-0:/var/log$ cw-check_restart_queue_state
Describing the current queue state for apply_config_ellis
  Nodes currently queued:
    Node ID: 10.0.0.14-ellis, Node status: processing


[ellis]ubuntu at ellis-0:/var/log$ cw-check_restart_queue_state
Describing the current queue state for apply_config_ellis
  No nodes are currently queued


[sprout]ubuntu at 0:~$ cw-check_restart_queue_state
Describing the current queue state for apply_config_sprout
  No nodes are currently queued

After this, if I download shared_config on sprout, I get the 'empty' file only in /home/ubuntu/clearwater-config-manager/ubuntu directory. So clearly sprout is not receiving the shared_config from cluster. Same is the case with bono, homestead etc.


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Wednesday, December 20, 2017 5:48 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Ying,

[ellis]ubuntu at ellis-0:/etc/clearwater$ sudo cw-upload config shared_confg
sudo: cw-upload: command not found

Then tried below command as per  http://clearwater.readthedocs.io/en/stable/Modifying_Clearwater_settings.html

[ellis]ubuntu at ellis-0:/etc/clearwater$ sudo cw-upload_shared_config
sudo: cw-upload_shared_config: command not found

Am I missing anything ?

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Ying Huang
Sent: Wednesday, December 20, 2017 5:13 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Kebar,

Yes as you noticed, the scscf uri is wrong and sprout uri isn't getting set either. This is because your nodes are missing shared_config. The shared_config on your Ellis looks right, so just run "sudo cw-upload config shared_confg" (detailed instruction here http://clearwater.readthedocs.io/en/stable/Clearwater_Configuration_Options_Reference.html#shared-config) to upload it to etcd cluster for other nodes to pick up. Then run "cw-check_restart_queue_state" on different types of nodes several times to see the nodes restarting one by one to pick up the changes. If something goes wrong here, we know the shared_config isn't being picked up correctly.


Thanks,
Ying

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: 20 December 2017 11:27
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

I have attached sprout_current.txt, which has some debug statements . I think that is giving some pointers.

My guess is /etc/clearwater/local_config (or some other appropriate config file) should have variables set for hostnames which are referred while composing these URLs.
e.g sip:scscf.;transport=TCP should be sip:scscf.<hostname<sip:scscf.%3chostname> of scscf>;transport=TCP

I will try is this direction..

Debug utils.cpp:405: Malformed host/port
Debug utils.cpp:405: Malformed host/port
Info main.cpp:1265: Sprout hostname set to
Info main.cpp:1243: S-CSCF node URI set to
Info main.cpp:1851: scscf enabled on 5054
Info main.cpp:1851: scscf prefix set to scscf
Info main.cpp:1851: scscf uri set to sip:scscf.;transport=TCP
Info main.cpp:1851: icscf enabled on 5052
Info main.cpp:1851: icscf prefix set to icscf
Info main.cpp:1851: icscf uri set to sip:icscf.;transport=TCP
Info main.cpp:1851: memento prefix set to memento
Info main.cpp:1851: memento uri set to sip:memento.;transport=TCP
Info main.cpp:1851: mangelwurzel prefix set to mangelwurzel
Info main.cpp:1851: mangelwurzel uri set to sip:mangelwurzel.;transport=TCP
Info main.cpp:1851: gemini prefix set to gemini
Info main.cpp:1851: gemini uri set to sip:gemini.;transport=TCP
Info main.cpp:1851: cdiv prefix set to cdiv
Info main.cpp:1851: cdiv uri set to sip:cdiv.;transport=TCP
Info main.cpp:1851: mmtel enabled on 5055
Info main.cpp:1851: mmtel prefix set to mmtel
Info main.cpp:1851: mmtel uri set to sip:mmtel.;transport=TCP
Info main.cpp:1851: bgcf enabled on 5053
Info main.cpp:1851: bgcf prefix set to bgcf
Info main.cpp:1851: bgcf uri set to sip:bgcf.;transport=TCP
Warning main.cpp:1855: SAS server option was invalid or not configured - SAS is disabled
Error main.cpp:1894: S/I-CSCF enabled with no Homestead server


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Wednesday, December 20, 2017 10:30 AM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Ying,

After changing log level to 5 on sprout, we need to restart sprout service, right ?
In my case, sprout service is not running.

I guess for this, I need to change the heat template to create user_settings file with log level 5.

[sprout]ubuntu at 0:/var/log/sprout$ service sprout status
* sprout is not running

[sprout]ubuntu at 0:/var/log/sprout$ ps -ef |grep sprout
ubuntu    8475  7053  0 04:53 pts/5    00:00:00 grep --color=auto sprout
root     10876     1  0 Dec18 ?        00:04:44 /usr/share/clearwater/clearwater-queue-manager/env/bin/python /usr/share/clearwater/bin/clearwater-queue-manager --local-ip=10.0.0.26 --local-site=site1 --log-level=3 --log-directory=/var/log/clearwater-queue-manager --pidfile=/var/run/clearwater-queue-manager.pid --etcd-key=clearwater --node-type=sprout --wait-plugin-complete=Y
root     11042     1  0 Dec18 ?        00:04:41 /usr/share/clearwater/clearwater-cluster-manager/env/bin/python /usr/share/clearwater/bin/clearwater-cluster-manager --mgmt-local-ip=10.0.0.26 --sig-local-ip=10.0.0.26 --local-site=site1 --remote-site= --remote-cassandra-seeds= --signaling-namespace= --uuid=535133a6-cb33-44b0-9a36-9da6e47ae280 --etcd-key=clearwater --etcd-cluster-key=sprout --cluster-manager-enabled=Y --log-level=3 --log-directory=/var/log/clearwater-cluster-manager --pidfile=/var/run/clearwater-cluster-manager.pid



From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Ying Huang
Sent: Wednesday, December 20, 2017 12:15 AM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Kedar,

Looks like a complicated situation to me. As far as I can see,


  1.  You should use log_level=5 to get more detailed logging
  2.  No the shared config shouldn't be the empty default template, this is an error
  3.  What you said about IP sounds suspicious, as one of the log file says "Failed to resolve icscf. to an IP address"

Must be frustrating to encounter errors everywhere. Shall we focus on the Sprout process and see why it fails. Would you please set log_level=5 in /etc/clearwater/user_settings on Sprout node and send a complete sprout_current.txt?


Thanks,
Ying



From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: 18 December 2017 14:00
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

6 continued.

6-a. bono errors attached for log locations mentioned in troubleshooting page. I tried stopping bono service. It got started by monit but same errors continue.
6-b. sprout errors attached for log locations mentioned in troubleshooting page. Sprout service is not running, so didn't try to stop to let me restart by monit.
6-c. /var/log/ellis/ellis-err.log is empty.
        /var/log/ellis/ellis_<time>.txt has these entries INFO web.py:1447: 200 GET /ping (0.0.0.0) 0.53ms.
        I tried stopping ellis service. It got started by monit but don't see anything changed.
       /var/log/monit.log errors attached.

Appreciate any help here !

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Monday, December 18, 2017 11:34 AM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Adam, Ying,


  1.  When I said shared_config is empty on sprout instances, I wanted to say that no config statements in it.


[sprout]ubuntu at 1:/etc/clearwater$ more shared_config
#####################################################################
# No Shared Config has been provided
# Replace this file with the Shared Configuration for your deployment
#####################################################################


  1.  /var/log/sprout/sprout_current has these entries periodically.



UTC Status utils.cpp:607: Log level set to 2

UTC Status main.cpp:1618: Access logging enabled to /var/log/sprout

UTC Warning signalhandler.h:90: SIGNAL already hooked

UTC Warning main.cpp:1674: SAS server option was invalid or not configured - SAS is disabled

UTC Error main.cpp:1713: S/I-CSCF enabled with no Homestead server


  1.  So is it ok if only one node, that is going to push shared config to cluster (ellis in the heat based deployment), to have shared_config file with all the configuration and other nodes to have 'empty' file like above ?



  1.  PFA ellis's shared_config attached. I don't find any sproutlet related configuration there..OK ? I have attached tail of ellis's heat installation log. Looks ok to me. Couldn't find anything suspicious in remaining log file.



  1.  Btw, one thing I should have told this in the beginning - When I tried the heat templates as it is, I observed that DNS VM's IP was not being passed to all other components. So I ended up carving out DNS VM and instantiated that first and used its IP in env file. I could confirm that IP got used by heat instructions of other VMs and DNSMASQ on them got configured ok. nslookup for components' names also works ok. (may be we need to use wait condition in the heat template)



  1.  I am going through troubleshooting options and will update on that.

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Adam Lindley
Sent: Friday, December 15, 2017 11:51 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

As a few more pointers of where to look, our HEAT templates currently generate shared config on the Ellis node, and upload this to the cluster as a whole. It would be worth looking at the install log on the ellis node to see if there was some error there. You may have the shared_config file present, and be able to upload that to the etcd cluster to bring the deployment to life.
If that doesn't give you any joy, make sure that the template install process has completed successfully on each of your nodes. It seems odd that shared_config has not been generated, and so I'd want to sanity check that nothing else is going wrong. If all nodes are installed, but lacking config, you should be able to generate shared config based on the script in the ellis.yaml file.
As Ying has said, once those things are sorted, you can look in the process logs to see why you are hitting errors. Almost all of our components log to /var/log/<process_name> on their node, so that's a great place to start debugging. You may also find our troubleshooting guide helpful: https://clearwater.readthedocs.io/en/stable/Troubleshooting_and_Recovery.html

Cheers,
Adam

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Ying Huang
Sent: 15 December 2017 17:54
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Kedar,

Shared config shouldn't be empty. Looks like Sprout process has failed for some reason. It's worthwhile checking the sprout log under /var/sys/log/sprout/sprout_current or send it over to see what went wrong.

Thanks,
Ying

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: 14 December 2017 14:07
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

/etc/Clearwater/shared_config is empty on both the sprout instances post installation. Is this expected if I want to run sproutlets like ICSCF, SCSCF at least ?

Here are couple of commands I tried.

[sprout]ubuntu at 0:~$ sudo monit summary
Monit 5.18.1 uptime: 7h 12m
Service Name                     Status                      Type
node-0.sprout.me.cw-ngv.com      Running                     System
sprout_process                   Execution failed | Does...  Process
snmpd_process                    Running                     Process
ntp_process                      Running                     Process
nginx_process                    Running                     Process
memcached_process                Running                     Process
clearwater_queue_manager_pro...  Running                     Process
etcd_process                     Running                     Process
clearwater_diags_monitor_pro...  Running                     Process
clearwater_config_manager_pr...  Running                     Process
clearwater_cluster_manager_p...  Running                     Process
chronos_process                  Running                     Process
astaire_process                  Running                     Process
sprout_uptime                    Wait parent                 Program
poll_sprout_sip                  Wait parent                 Program
poll_sprout_http                 Wait parent                 Program
nginx_ping                       Status ok                   Program
nginx_uptime                     Status ok                   Program
monit_uptime                     Status ok                   Program
memcached_uptime                 Status ok                   Program
poll_memcached                   Status ok                   Program
clearwater_queue_manager_uptime  Status ok                   Program
etcd_uptime                      Status ok                   Program
poll_etcd_cluster                Status ok                   Program
poll_etcd                        Status ok                   Program
chronos_uptime                   Status ok                   Program
poll_chronos                     Status ok                   Program
astaire_uptime                   Status ok                   Program

[sprout]ubuntu at 0:~$ service sprout status
* sprout is not running
[sprout]ubuntu at 0:~$ sudo service sprout start
14-12-2017 14:06:17.215 UTC Status utils.cpp:496: Switching to daemon mode

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Thursday, December 14, 2017 12:29 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

I gave a try with release 127 ( repo URL  http://repo.cw-ngv.com/archive/repo127 in env file). But issues seem to be very same.


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Wednesday, December 13, 2017 12:30 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Adam, Mike,

Clearwater heat templates on ONAP wiki are put around July 13. Clearwater release 127, which is released on May 30th , seems to have been used for testing these templates.

If I want to give a try with release 127 installation via heat, how to do that ? I tried URL http://repo.cw-ngv.com/release-127/binary/Packages in browser, but got 404.

From: Kedar Ambekar
Sent: Wednesday, December 13, 2017 11:37 AM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: RE: 502 Bad Gateway and other errors while running live tests

Hi Adam,

Got the point. I had suspected the same.
I have repo_url http://repo.cw-ngv.com/stable in heat's env file.

Is it possible to use same release on which ONAP's heat templates are based, may be by changing this repo URL?

I will have a look at current heat template on Clearwater GitHub but I think those won't be ONAP compatible.

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Adam Lindley
Sent: Tuesday, December 12, 2017 10:50 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Do you know which release you based the templates on?
We should be able to take a look over our release notes between then and now, which should give a reasonable view of the changes, and then we can go from there. Equally, the commit history (https://github.com/Metaswitch/clearwater-heat/commits/stable) gives a fairly clear overview of what and why, with the pull requests adding a bit more detail.

Though as we're likely to hit similar problems in future as we continue to develop Project Clearwater and our heat templates. Are the ONAP changes something we could be pulling in to the main code base? I'd be interested to know the extent of the work needed to keep them running

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Mike Evans
Sent: 12 December 2017 17:00
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Adam

I put the ONAP templates together, so I'm happy to update them if they won't work with the latest Project Clearwater code.  Is there anywhere I can look for an explanation of the changes?

Mike

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Adam Lindley
Sent: 12 December 2017 16:41
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Kedar,

I've just had a look around for the templates on the ONAP wiki; I wasn't aware they had their own copies of them.
I found https://wiki.onap.org/display/DW/Clearwater+vIMS+Onboarding+and+Instantiation . Is this what you've been working from?

When deploying with the templates, have you been specifying a "repo_url" option in the arguments? The Clearwater HEAT templates included steps to install the Clearwater packages from our public stable repo by default, but the templates on the ONAP wiki are now somewhat out of date. If you haven't specified a repo containing packages from the same point in time the templates were effectively forked, you're going to be hitting conflicts between the code version, and the orchestration steps.

I am not sure what differences there need to be for templates to run on ONAP, but I can point you towards our current set of heat templates: https://github.com/Metaswitch/clearwater-heat/tree/stable . I would suggest you try redeploying with these templates, as a fair number of things have changed in the code since the templates on the wiki were valid. If you hit any issues, do let us know.

Cheers,
Adam


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: 12 December 2017 13:46
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

I have installed Clearwater with heat templates (available on ONAP wiki) directly on openstack. Appreciate help on below issues.


  1.  When I run Clearwater live tests, all tests fail with below  error.



RuntimeError thrown:

   - Account creation failed with HTTP code 502, body {"status": 502, "message": "Bad Gateway", "reason": "Upstream request failed", "detail": {"Upstream error": "599", "Upstream URL": "None"}, "error": true}



  1.  ps for bono process shows this.



[bono]ubuntu at 0:/etc/clearwater$ ps -ef |grep bono

bono 6897 1 0 05:06 ? 00:00:11 /usr/share/clearwater/bin/bono --domain= --localhost=10.0.0.28,0.bono.me.cw-ngv.com --al ias=10.0.0.28,0.bono.me.cw-ngv.com, --pcscf=5060,5058 --webrtc-port=5062 --routing-proxy=icscf.,5052,50,600 --sas=0.0.0.0,bono at 0.bono.me.cw-ngv.com --dns-server=127.0.0.1 --worker-threads=2 --analytics=/var/log/bono --log-file=/var/log/bono --log-level=2 --daemon --pidfile=/var/run/bono/bono.pid



  1.  In bono, I saw these logs.

 UTC Error sip_connection_pool.cpp:190: Failed to resolve icscf. to an IP address - Not found (PJ_ENOTFOUND)

UTC Warning dnscachedresolver.cpp:828: Failed to retrieve record for icscf.: Domain name not found



  1.  To debug above issues, I ended up making these changes in /etc/init.d/bono and restarted bono service.



DAEMON_ARGS="--domain=me.cw-ngv.com  (instead of -domain=$home_domain)

upstream_hostname=icscf.sprout.me.cw-ngv.com (instead of upstream_hostname=icscf.$sprout_hostname)


  1.  But now, I get below error in bono. Port 5052 is not in listen mode on sprout.

UTC Warning pjsip: tcpc0x7f90cc07 TCP connect() error: Connection refused [code=120111]
UTC Warning pjsip: tcpc0x7f90cc07 Unable to connect to <sprout ip>:5052
============================================================================================================================
Disclaimer:  This message and the information contained herein is proprietary and confidential and subject to the Tech Mahindra policy statement, you may review the policy at http://www.techmahindra.com/Disclaimer.html externally http://tim.techmahindra.com/tim/disclaimer.html internally within TechMahindra.
============================================================================================================================
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20171222/16af3581/attachment.html>

From akedar at TechMahindra.com  Fri Dec 22 09:11:28 2017
From: akedar at TechMahindra.com (Kedar Ambekar)
Date: Fri, 22 Dec 2017 14:11:28 +0000
Subject: [Project Clearwater] 502 Bad Gateway and other errors while
 running live tests
In-Reply-To: <CY4PR02MB33343C9FAFB74316D1DEE7DCE3020@CY4PR02MB3334.namprd02.prod.outlook.com>
References: <PN1PR0101MB1565F6502AF8CA8FE9E3E06CA3340@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<BY2PR02MB20378C8381AD633827882732E2340@BY2PR02MB2037.namprd02.prod.outlook.com>
	<BLUPR0201MB1889B9B407D22938B59ED116B0340@BLUPR0201MB1889.namprd02.prod.outlook.com>
	<BY2PR02MB2037FFD49230C6B498B0D35EE2340@BY2PR02MB2037.namprd02.prod.outlook.com>
	<PN1PR0101MB15651EE3174A2D040BB3AC5AA3350@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<PN1PR0101MB1565488BBCA00EE6E02B441FA30A0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<MA1PR0101MB155824EC66E0BBF4AA4235CEA30A0@MA1PR0101MB1558.INDPRD01.PROD.OUTLOOK.COM>
	<DM5PR0201MB36231D60D83A6D448BE67115F80B0@DM5PR0201MB3623.namprd02.prod.outlook.com>
	<CY1PR02MB20442B9F94B1E5A15A7F5E26E20B0@CY1PR02MB2044.namprd02.prod.outlook.com>
	<PN1PR0101MB156571D41BC08C9107D9C1B1A30E0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<MA1PR0101MB1558C054087ED8884393C4D0A30E0@MA1PR0101MB1558.INDPRD01.PROD.OUTLOOK.COM>
	<DM5PR0201MB36235777FB5D60848418319CF80F0@DM5PR0201MB3623.namprd02.prod.outlook.com>
	<PN1PR0101MB15653F5A90DA1B487F813570A30C0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<PN1PR0101MB15656562DD59866E054E0593A30C0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<DM5PR0201MB362301954982927477896FBAF80C0@DM5PR0201MB3623.namprd02.prod.outlook.com>
	<PN1PR0101MB1565BF7911348F75CEC33023A30C0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<PN1PR0101MB15658BF9A20726809BC61AF8A30D0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<PN1PR0101MB1565178B1639A0410047E5E6A30D0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<PN1PR0101MB156592E388AB31D0EB0FF4A0A30D0@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>
	<CY4PR02MB33343C9FAFB74316D1DEE7DCE3020@CY4PR02MB3334.namprd02.prod.outlook.com>
Message-ID: <PN1PR0101MB1565B412AD53EF0896589EDAA3020@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>

Hi Graeme,

Thanks !

[ellis]ubuntu at ellis-0:~$ cw-check_cluster_state
This script prints the status of the Cassandra, Chronos, and Memcached clusters.
This node (10.0.0.24) should not be in any cluster.

[ellis]ubuntu at ellis-0:~$ clearwater-etcdctl cluster-health
member 1051384887a21c1a is healthy: got healthy result from http://10.0.0.24:4000
cluster is healthy

[ellis]ubuntu at ellis-0:~$ clearwater-etcdctl member list
1051384887a21c1a: name=10-0-0-24 peerURLs=http://10.0.0.24:2380 clientURLs=http://10.0.0.24:4000 isLeader=true

>>The mechanism for this to happen is via the etcd_cluster configuration option /etc/clearwater/local_config, so all of your nodes should have this set to the same value (the IP address of your Ellis node).

Every node has its own IP as /etc/clearwater/local_config :: etcd_cluster value. I checked few as below.

Ellis's IP is 24.

Sprout-0 local_config (Its own IP is 26)
etcd_cluster=10.0.0.26

Bono-0 local config (Its own IP is 19)
etcd_cluster=10.0.0.19

I checked the heat templates and found the cause for this.

# Get the public IP address from eth0
            sudo apt-get install ipcalc
            ADDR=`ip addr show eth0 | awk '/inet /{print $2}'`
            PUBLIC_ADDR=`ipcalc -n -b $ADDR | awk '/Address:/{print $2}'`

            # Configure /etc/clearwater/local_config.
            mkdir -p /etc/clearwater
            etcd_ip=__etcd_ip__
            [ -n "$etcd_ip" ] || etcd_ip=$PUBLIC_ADDR
            cat > /etc/clearwater/local_config << EOF
            management_local_ip=$PUBLIC_ADDR
            local_ip=$PUBLIC_ADDR
            public_ip=$PUBLIC_ADDR
            public_hostname=__index__.bono.__zone__
            etcd_cluster=$etcd_ip
            EOF

The way I had issue of DNS's IP not getting passed from base template to all resource templates, similarly Ellis's IP is not also getting passed to resource templates and they are using their own IP for etcd_cluster.

Race condition seems to be the cause and I think the wait condition is badly needed in heat. I mean once DNS is ready, then only spawn Ellis. Once Ellis is ready, then only spawn remaining nodes !

Anyway, first I will try to fix cluster manually as you suggested.

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Graeme Robertson
Sent: Friday, December 22, 2017 5:51 PM
To: clearwater at lists.projectclearwater.org
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hello Kedar,

The homestead_cache tables are only populated after traffic is running through the system; logically, the subscribers get provisioned in the homestead_prov tables and then information about them gets "cached" in the homestead_cache tables to avoid constantly looking things up in the HSS. Obviously this is less meaningful when you're using homestead-prov rather than a real HSS, but the key point is that it's fine for that table to be empty.

The thing I'm most concerned about right now is that you don't seem to have an etcd cluster, which basically means that nothing will work :). In theory your first node will form an etcd cluster with itself as the sole member (in this case, that's the Ellis node). Then subsequent nodes will join the same cluster. The mechanism for this to happen is via the etcd_cluster configuration option /etc/clearwater/local_config, so all of your nodes should have this set to the same value (the IP address of your Ellis node). It's crucial that this step has happened correctly because etcd is responsible for propagating configuration around your cluster (hence the lack of shared config!) and for clustering your databases (which may explain the Cassandra problems you're hitting). When you uploaded shared config on the Ellis node and nothing else was affected, that suggested to me that the Ellis node is the only node in the etcd cluster.

I suggest doing the following...

*         As per http://clearwater.readthedocs.io/en/stable/Troubleshooting_and_Recovery.html?highlight=troubleshooting, run the following commands (on your Ellis node?) to check the state of your etcd cluster

cw-check_cluster_state

clearwater-etcdctl cluster-health

clearwater-etcdctl member list



*         Check /etc/clearwater/local_config on each node and check etcd_cluster is set to the correct value. If it's not, you'll probably need to...

o   Correct the value

o   Delete existing etcd data on the node (rm -rf /var/lib/clearwater-etcd)

o   Restart clearwater-etcd (sudo service clearwater-etcd restart)

Good luck!
Graeme

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: 21 December 2017 13:50
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

One observation is impu table is empty.

cqlsh:homestead_cache> select count(*) from impu
                   ... ;

count
-------
     0

Below is ellis heat log, which has create_numbers step. Is this supposed to populate that table ?

+ /usr/share/clearwater/ellis/env/bin/python /usr/share/clearwater/ellis/src/metaswitch/ellis/tools/create_numbers.py --start 2425550000 --count 10000
Created 10000 numbers, 0 already present in database

From: Kedar Ambekar
Sent: Thursday, December 21, 2017 5:55 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: RE: 502 Bad Gateway and other errors while running live tests

Homestead log may give some clue..

21-12-2017 12:08:27.182 UTC Verbose httpstack.cpp:327: Process request for URL /impi/2425553207%40me.cw-ngv.com/av, args impu=sip%3A2425553207%40me.cw-ngv.com&server-name=sip%3Ascscf.sprout.me.cw-ngv.com%3Btransport%3DTCP
21-12-2017 12:08:27.182 UTC Debug handlers.cpp:130: Parsed HTTP request: private ID 2425553207 at me.cw-ngv.com<mailto:2425553207 at me.cw-ngv.com>, public ID sip:2425553207 at me.cw-ngv.com, scheme Unknown, authorization
21-12-2017 12:08:27.182 UTC Debug handlers.cpp:156: Querying cache for authentication vector for 2425553207 at me.cw-ngv.com/sip:2425553207 at me.cw-ngv.com<mailto:2425553207 at me.cw-ngv.com/sip:2425553207 at me.cw-ngv.com>
21-12-2017 12:08:27.182 UTC Debug a_record_resolver.cpp:55: ARecordResolver::resolve_iter for host 127.0.0.1, port 9160, family 2
21-12-2017 12:08:27.182 UTC Debug baseresolver.cpp:400: Attempt to parse 127.0.0.1 as IP address
21-12-2017 12:08:27.182 UTC Debug a_record_resolver.cpp:63: Target is an IP address
21-12-2017 12:08:27.182 UTC Debug connection_pool.h:206: Request for connection to IP: 127.0.0.1, port: 9160
21-12-2017 12:08:27.182 UTC Debug connection_pool.h:219: Found existing connection 0x25f9980 in pool
21-12-2017 12:08:27.182 UTC Debug cache.cpp:656: Looking for authentication vector for 2425553207 at me.cw-ngv.com<mailto:2425553207 at me.cw-ngv.com>
21-12-2017 12:08:27.182 UTC Debug cache.cpp:668: Checking public ID sip:2425553207 at me.cw-ngv.com
21-12-2017 12:08:27.182 UTC Debug cache.cpp:678: Issuing cache query
21-12-2017 12:08:27.183 UTC Debug cassandra_store.cpp:115: Failed TWO read for get_columns. Try ONE
21-12-2017 12:08:27.183 UTC Debug baseresolver.cpp:805: Successful response from  127.0.0.1:9160 transport 6
21-12-2017 12:08:27.183 UTC Debug connection_pool.h:242: Release connection to IP: 127.0.0.1, port: 9160 to pool
21-12-2017 12:08:27.183 UTC Debug cassandra_store.cpp:536: Cassandra request failed: rc=2, Row 2425553207 at me.cw-ngv.com<mailto:2425553207 at me.cw-ngv.com> not present in column_family impi
21-12-2017 12:08:27.184 UTC Debug event_statistic_accumulator.cpp:32: Accumulate 1309 for 0x229aa60
21-12-2017 12:08:27.184 UTC Debug event_statistic_accumulator.cpp:32: Accumulate 1309 for 0x229aad8
21-12-2017 12:08:27.184 UTC Debug handlers.cpp:185: Cache query failed - reject request
21-12-2017 12:08:27.184 UTC Debug handlers.cpp:190: No cached av found for private ID 2425553207 at me.cw-ngv.com<mailto:2425553207 at me.cw-ngv.com>, public ID sip:2425553207 at me.cw-ngv.com - reject
21-12-2017 12:08:27.184 UTC Verbose httpstack.cpp:68: Sending response 404 to request for URL /impi/2425553207%40me.cw-ngv.com/av, args impu=sip%3A2425553207%40me.cw-ng
v.com&server-name=sip%3Ascscf.sprout.me.cw-ngv.com%3Btransport%3DTCP
21-12-2017 12:08:27.184 UTC Debug event_statistic_accumulator.cpp:32: Accumulate 1420 for 0x2295c30
21-12-2017 12:08:27.184 UTC Debug event_statistic_accumulator.cpp:32: Accumulate 1420 for 0x2295ca8


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Thursday, December 21, 2017 5:10 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

I gave a try with putting shared_config in every components' heat ( instead of having only in Ellis and getting pushed from there). With that, it seems to be progressing further. I see bono service in running state, ports in listen mode etc..

When I run the live tests now, most are failing for -

Failed
  RuntimeError thrown:
   - Expected 401|200, got 403

I ran sprout with log level 5. See something wrong in sprout-homestead communication (getting 404) . I have kept log @ https://drive.google.com/open?id=1cP9CkQ4dZXF6rLorQVSFOTpmK2yP6xnH

Sprout IPs : 10.0.0.26 , 10.0.0.9
Homestead IPs : 10.0.0.3, 10.0.0.16
Bono IPs : 10.0.0.19, 10.0.0.29
Testsuite : 10.0.0.35

Can someone help please ?

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Thursday, December 21, 2017 11:30 AM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

I had missed to notice this in ellis heat log. I think this is the culprit.

+ sudo /usr/share/clearwater/clearwater-config-manager/scripts/upload_shared_config
sudo: /usr/share/clearwater/clearwater-config-manager/scripts/upload_shared_config: command not found

Anyway, I did below to upload shared_config. Commands seem to have changed with latest release.

[ellis]ubuntu at ellis-0:/var/log$ cw-config download shared_config
shared_config downloaded to /home/ubuntu/clearwater-config-manager/ubuntu/shared_config

File was same as ellis shared_config file.  I had to modify it with a dummy change of putting dots in a comment line as upload command was detecting no change.

[ellis]ubuntu at ellis-0:/var/log$ cw-config upload shared_config
Config successfully validated
Configuration file change: user ubuntu has modified shared_config.
Lines removed:
"# Deployment definitions"
Lines added:
"# Deployment definitions.."

Please check the config changes and confirm that you wish to continue with the config upload.
Do you want to continue?  [yes/no] yes
shared_config successfully uploaded


[ellis]ubuntu at ellis-0:/var/log$ cw-check_restart_queue_state
Describing the current queue state for apply_config_ellis
  Nodes currently queued:
    Node ID: 10.0.0.14-ellis, Node status: processing


[ellis]ubuntu at ellis-0:/var/log$ cw-check_restart_queue_state
Describing the current queue state for apply_config_ellis
  No nodes are currently queued


[sprout]ubuntu at 0:~$ cw-check_restart_queue_state
Describing the current queue state for apply_config_sprout
  No nodes are currently queued

After this, if I download shared_config on sprout, I get the 'empty' file only in /home/ubuntu/clearwater-config-manager/ubuntu directory. So clearly sprout is not receiving the shared_config from cluster. Same is the case with bono, homestead etc.


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Wednesday, December 20, 2017 5:48 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Ying,

[ellis]ubuntu at ellis-0:/etc/clearwater$ sudo cw-upload config shared_confg
sudo: cw-upload: command not found

Then tried below command as per  http://clearwater.readthedocs.io/en/stable/Modifying_Clearwater_settings.html

[ellis]ubuntu at ellis-0:/etc/clearwater$ sudo cw-upload_shared_config
sudo: cw-upload_shared_config: command not found

Am I missing anything ?

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Ying Huang
Sent: Wednesday, December 20, 2017 5:13 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Kebar,

Yes as you noticed, the scscf uri is wrong and sprout uri isn't getting set either. This is because your nodes are missing shared_config. The shared_config on your Ellis looks right, so just run "sudo cw-upload config shared_confg" (detailed instruction here http://clearwater.readthedocs.io/en/stable/Clearwater_Configuration_Options_Reference.html#shared-config) to upload it to etcd cluster for other nodes to pick up. Then run "cw-check_restart_queue_state" on different types of nodes several times to see the nodes restarting one by one to pick up the changes. If something goes wrong here, we know the shared_config isn't being picked up correctly.


Thanks,
Ying

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: 20 December 2017 11:27
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

I have attached sprout_current.txt, which has some debug statements . I think that is giving some pointers.

My guess is /etc/clearwater/local_config (or some other appropriate config file) should have variables set for hostnames which are referred while composing these URLs.
e.g sip:scscf.;transport=TCP should be sip:scscf.<hostname<sip:scscf.%3chostname> of scscf>;transport=TCP

I will try is this direction..

Debug utils.cpp:405: Malformed host/port
Debug utils.cpp:405: Malformed host/port
Info main.cpp:1265: Sprout hostname set to
Info main.cpp:1243: S-CSCF node URI set to
Info main.cpp:1851: scscf enabled on 5054
Info main.cpp:1851: scscf prefix set to scscf
Info main.cpp:1851: scscf uri set to sip:scscf.;transport=TCP
Info main.cpp:1851: icscf enabled on 5052
Info main.cpp:1851: icscf prefix set to icscf
Info main.cpp:1851: icscf uri set to sip:icscf.;transport=TCP
Info main.cpp:1851: memento prefix set to memento
Info main.cpp:1851: memento uri set to sip:memento.;transport=TCP
Info main.cpp:1851: mangelwurzel prefix set to mangelwurzel
Info main.cpp:1851: mangelwurzel uri set to sip:mangelwurzel.;transport=TCP
Info main.cpp:1851: gemini prefix set to gemini
Info main.cpp:1851: gemini uri set to sip:gemini.;transport=TCP
Info main.cpp:1851: cdiv prefix set to cdiv
Info main.cpp:1851: cdiv uri set to sip:cdiv.;transport=TCP
Info main.cpp:1851: mmtel enabled on 5055
Info main.cpp:1851: mmtel prefix set to mmtel
Info main.cpp:1851: mmtel uri set to sip:mmtel.;transport=TCP
Info main.cpp:1851: bgcf enabled on 5053
Info main.cpp:1851: bgcf prefix set to bgcf
Info main.cpp:1851: bgcf uri set to sip:bgcf.;transport=TCP
Warning main.cpp:1855: SAS server option was invalid or not configured - SAS is disabled
Error main.cpp:1894: S/I-CSCF enabled with no Homestead server


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Wednesday, December 20, 2017 10:30 AM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Ying,

After changing log level to 5 on sprout, we need to restart sprout service, right ?
In my case, sprout service is not running.

I guess for this, I need to change the heat template to create user_settings file with log level 5.

[sprout]ubuntu at 0:/var/log/sprout$ service sprout status
* sprout is not running

[sprout]ubuntu at 0:/var/log/sprout$ ps -ef |grep sprout
ubuntu    8475  7053  0 04:53 pts/5    00:00:00 grep --color=auto sprout
root     10876     1  0 Dec18 ?        00:04:44 /usr/share/clearwater/clearwater-queue-manager/env/bin/python /usr/share/clearwater/bin/clearwater-queue-manager --local-ip=10.0.0.26 --local-site=site1 --log-level=3 --log-directory=/var/log/clearwater-queue-manager --pidfile=/var/run/clearwater-queue-manager.pid --etcd-key=clearwater --node-type=sprout --wait-plugin-complete=Y
root     11042     1  0 Dec18 ?        00:04:41 /usr/share/clearwater/clearwater-cluster-manager/env/bin/python /usr/share/clearwater/bin/clearwater-cluster-manager --mgmt-local-ip=10.0.0.26 --sig-local-ip=10.0.0.26 --local-site=site1 --remote-site= --remote-cassandra-seeds= --signaling-namespace= --uuid=535133a6-cb33-44b0-9a36-9da6e47ae280 --etcd-key=clearwater --etcd-cluster-key=sprout --cluster-manager-enabled=Y --log-level=3 --log-directory=/var/log/clearwater-cluster-manager --pidfile=/var/run/clearwater-cluster-manager.pid



From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Ying Huang
Sent: Wednesday, December 20, 2017 12:15 AM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Kedar,

Looks like a complicated situation to me. As far as I can see,


  1.  You should use log_level=5 to get more detailed logging
  2.  No the shared config shouldn't be the empty default template, this is an error
  3.  What you said about IP sounds suspicious, as one of the log file says "Failed to resolve icscf. to an IP address"

Must be frustrating to encounter errors everywhere. Shall we focus on the Sprout process and see why it fails. Would you please set log_level=5 in /etc/clearwater/user_settings on Sprout node and send a complete sprout_current.txt?


Thanks,
Ying



From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: 18 December 2017 14:00
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

6 continued.

6-a. bono errors attached for log locations mentioned in troubleshooting page. I tried stopping bono service. It got started by monit but same errors continue.
6-b. sprout errors attached for log locations mentioned in troubleshooting page. Sprout service is not running, so didn't try to stop to let me restart by monit.
6-c. /var/log/ellis/ellis-err.log is empty.
        /var/log/ellis/ellis_<time>.txt has these entries INFO web.py:1447: 200 GET /ping (0.0.0.0) 0.53ms.
        I tried stopping ellis service. It got started by monit but don't see anything changed.
       /var/log/monit.log errors attached.

Appreciate any help here !

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Monday, December 18, 2017 11:34 AM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Adam, Ying,


  1.  When I said shared_config is empty on sprout instances, I wanted to say that no config statements in it.


[sprout]ubuntu at 1:/etc/clearwater$ more shared_config
#####################################################################
# No Shared Config has been provided
# Replace this file with the Shared Configuration for your deployment
#####################################################################


  1.  /var/log/sprout/sprout_current has these entries periodically.



UTC Status utils.cpp:607: Log level set to 2

UTC Status main.cpp:1618: Access logging enabled to /var/log/sprout

UTC Warning signalhandler.h:90: SIGNAL already hooked

UTC Warning main.cpp:1674: SAS server option was invalid or not configured - SAS is disabled

UTC Error main.cpp:1713: S/I-CSCF enabled with no Homestead server


  1.  So is it ok if only one node, that is going to push shared config to cluster (ellis in the heat based deployment), to have shared_config file with all the configuration and other nodes to have 'empty' file like above ?



  1.  PFA ellis's shared_config attached. I don't find any sproutlet related configuration there..OK ? I have attached tail of ellis's heat installation log. Looks ok to me. Couldn't find anything suspicious in remaining log file.



  1.  Btw, one thing I should have told this in the beginning - When I tried the heat templates as it is, I observed that DNS VM's IP was not being passed to all other components. So I ended up carving out DNS VM and instantiated that first and used its IP in env file. I could confirm that IP got used by heat instructions of other VMs and DNSMASQ on them got configured ok. nslookup for components' names also works ok. (may be we need to use wait condition in the heat template)



  1.  I am going through troubleshooting options and will update on that.

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Adam Lindley
Sent: Friday, December 15, 2017 11:51 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

As a few more pointers of where to look, our HEAT templates currently generate shared config on the Ellis node, and upload this to the cluster as a whole. It would be worth looking at the install log on the ellis node to see if there was some error there. You may have the shared_config file present, and be able to upload that to the etcd cluster to bring the deployment to life.
If that doesn't give you any joy, make sure that the template install process has completed successfully on each of your nodes. It seems odd that shared_config has not been generated, and so I'd want to sanity check that nothing else is going wrong. If all nodes are installed, but lacking config, you should be able to generate shared config based on the script in the ellis.yaml file.
As Ying has said, once those things are sorted, you can look in the process logs to see why you are hitting errors. Almost all of our components log to /var/log/<process_name> on their node, so that's a great place to start debugging. You may also find our troubleshooting guide helpful: https://clearwater.readthedocs.io/en/stable/Troubleshooting_and_Recovery.html

Cheers,
Adam

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Ying Huang
Sent: 15 December 2017 17:54
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Kedar,

Shared config shouldn't be empty. Looks like Sprout process has failed for some reason. It's worthwhile checking the sprout log under /var/sys/log/sprout/sprout_current or send it over to see what went wrong.

Thanks,
Ying

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: 14 December 2017 14:07
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

/etc/Clearwater/shared_config is empty on both the sprout instances post installation. Is this expected if I want to run sproutlets like ICSCF, SCSCF at least ?

Here are couple of commands I tried.

[sprout]ubuntu at 0:~$ sudo monit summary
Monit 5.18.1 uptime: 7h 12m
Service Name                     Status                      Type
node-0.sprout.me.cw-ngv.com      Running                     System
sprout_process                   Execution failed | Does...  Process
snmpd_process                    Running                     Process
ntp_process                      Running                     Process
nginx_process                    Running                     Process
memcached_process                Running                     Process
clearwater_queue_manager_pro...  Running                     Process
etcd_process                     Running                     Process
clearwater_diags_monitor_pro...  Running                     Process
clearwater_config_manager_pr...  Running                     Process
clearwater_cluster_manager_p...  Running                     Process
chronos_process                  Running                     Process
astaire_process                  Running                     Process
sprout_uptime                    Wait parent                 Program
poll_sprout_sip                  Wait parent                 Program
poll_sprout_http                 Wait parent                 Program
nginx_ping                       Status ok                   Program
nginx_uptime                     Status ok                   Program
monit_uptime                     Status ok                   Program
memcached_uptime                 Status ok                   Program
poll_memcached                   Status ok                   Program
clearwater_queue_manager_uptime  Status ok                   Program
etcd_uptime                      Status ok                   Program
poll_etcd_cluster                Status ok                   Program
poll_etcd                        Status ok                   Program
chronos_uptime                   Status ok                   Program
poll_chronos                     Status ok                   Program
astaire_uptime                   Status ok                   Program

[sprout]ubuntu at 0:~$ service sprout status
* sprout is not running
[sprout]ubuntu at 0:~$ sudo service sprout start
14-12-2017 14:06:17.215 UTC Status utils.cpp:496: Switching to daemon mode

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Thursday, December 14, 2017 12:29 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

I gave a try with release 127 ( repo URL  http://repo.cw-ngv.com/archive/repo127 in env file). But issues seem to be very same.


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: Wednesday, December 13, 2017 12:30 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Adam, Mike,

Clearwater heat templates on ONAP wiki are put around July 13. Clearwater release 127, which is released on May 30th , seems to have been used for testing these templates.

If I want to give a try with release 127 installation via heat, how to do that ? I tried URL http://repo.cw-ngv.com/release-127/binary/Packages in browser, but got 404.

From: Kedar Ambekar
Sent: Wednesday, December 13, 2017 11:37 AM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: RE: 502 Bad Gateway and other errors while running live tests

Hi Adam,

Got the point. I had suspected the same.
I have repo_url http://repo.cw-ngv.com/stable in heat's env file.

Is it possible to use same release on which ONAP's heat templates are based, may be by changing this repo URL?

I will have a look at current heat template on Clearwater GitHub but I think those won't be ONAP compatible.

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Adam Lindley
Sent: Tuesday, December 12, 2017 10:50 PM
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Do you know which release you based the templates on?
We should be able to take a look over our release notes between then and now, which should give a reasonable view of the changes, and then we can go from there. Equally, the commit history (https://github.com/Metaswitch/clearwater-heat/commits/stable) gives a fairly clear overview of what and why, with the pull requests adding a bit more detail.

Though as we're likely to hit similar problems in future as we continue to develop Project Clearwater and our heat templates. Are the ONAP changes something we could be pulling in to the main code base? I'd be interested to know the extent of the work needed to keep them running

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Mike Evans
Sent: 12 December 2017 17:00
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Adam

I put the ONAP templates together, so I'm happy to update them if they won't work with the latest Project Clearwater code.  Is there anywhere I can look for an explanation of the changes?

Mike

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Adam Lindley
Sent: 12 December 2017 16:41
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi Kedar,

I've just had a look around for the templates on the ONAP wiki; I wasn't aware they had their own copies of them.
I found https://wiki.onap.org/display/DW/Clearwater+vIMS+Onboarding+and+Instantiation . Is this what you've been working from?

When deploying with the templates, have you been specifying a "repo_url" option in the arguments? The Clearwater HEAT templates included steps to install the Clearwater packages from our public stable repo by default, but the templates on the ONAP wiki are now somewhat out of date. If you haven't specified a repo containing packages from the same point in time the templates were effectively forked, you're going to be hitting conflicts between the code version, and the orchestration steps.

I am not sure what differences there need to be for templates to run on ONAP, but I can point you towards our current set of heat templates: https://github.com/Metaswitch/clearwater-heat/tree/stable . I would suggest you try redeploying with these templates, as a fair number of things have changed in the code since the templates on the wiki were valid. If you hit any issues, do let us know.

Cheers,
Adam


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Kedar Ambekar
Sent: 12 December 2017 13:46
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: [Project Clearwater] 502 Bad Gateway and other errors while running live tests

Hi,

I have installed Clearwater with heat templates (available on ONAP wiki) directly on openstack. Appreciate help on below issues.


  1.  When I run Clearwater live tests, all tests fail with below  error.



RuntimeError thrown:

   - Account creation failed with HTTP code 502, body {"status": 502, "message": "Bad Gateway", "reason": "Upstream request failed", "detail": {"Upstream error": "599", "Upstream URL": "None"}, "error": true}



  1.  ps for bono process shows this.



[bono]ubuntu at 0:/etc/clearwater$ ps -ef |grep bono

bono 6897 1 0 05:06 ? 00:00:11 /usr/share/clearwater/bin/bono --domain= --localhost=10.0.0.28,0.bono.me.cw-ngv.com --al ias=10.0.0.28,0.bono.me.cw-ngv.com, --pcscf=5060,5058 --webrtc-port=5062 --routing-proxy=icscf.,5052,50,600 --sas=0.0.0.0,bono at 0.bono.me.cw-ngv.com --dns-server=127.0.0.1 --worker-threads=2 --analytics=/var/log/bono --log-file=/var/log/bono --log-level=2 --daemon --pidfile=/var/run/bono/bono.pid



  1.  In bono, I saw these logs.

 UTC Error sip_connection_pool.cpp:190: Failed to resolve icscf. to an IP address - Not found (PJ_ENOTFOUND)

UTC Warning dnscachedresolver.cpp:828: Failed to retrieve record for icscf.: Domain name not found



  1.  To debug above issues, I ended up making these changes in /etc/init.d/bono and restarted bono service.



DAEMON_ARGS="--domain=me.cw-ngv.com  (instead of -domain=$home_domain)

upstream_hostname=icscf.sprout.me.cw-ngv.com (instead of upstream_hostname=icscf.$sprout_hostname)


  1.  But now, I get below error in bono. Port 5052 is not in listen mode on sprout.

UTC Warning pjsip: tcpc0x7f90cc07 TCP connect() error: Connection refused [code=120111]
UTC Warning pjsip: tcpc0x7f90cc07 Unable to connect to <sprout ip>:5052
============================================================================================================================
Disclaimer:  This message and the information contained herein is proprietary and confidential and subject to the Tech Mahindra policy statement, you may review the policy at http://www.techmahindra.com/Disclaimer.html externally http://tim.techmahindra.com/tim/disclaimer.html internally within TechMahindra.
============================================================================================================================
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20171222/f7021d72/attachment.html>

From akedar at TechMahindra.com  Tue Dec 12 08:23:43 2017
From: akedar at TechMahindra.com (Kedar Ambekar)
Date: Tue, 12 Dec 2017 13:23:43 -0000
Subject: [Project Clearwater] 502 Bad Gateway and other errors while running
 live tests
Message-ID: <PN1PR0101MB1565566F284C9678CCCE3142A3340@PN1PR0101MB1565.INDPRD01.PROD.OUTLOOK.COM>

Hi,

I have installed Clearwater with heat templates (available on ONAP wiki) directly on openstack. Appreciate help on below issues.


1.       When I run Clearwater live tests, all tests fail with below  error.



RuntimeError thrown:

   - Account creation failed with HTTP code 502, body {"status": 502, "message": "Bad Gateway", "reason": "Upstream request failed", "detail": {"Upstream error": "599", "Upstream URL": "None"}, "error": true}



2.       ps for bono process shows this.



[bono]ubuntu at 0:/etc/clearwater$ ps -ef |grep bono

bono 6897 1 0 05:06 ? 00:00:11 /usr/share/clearwater/bin/bono --domain= --localhost=10.0.0.28,0.bono.me.cw-ngv.com --al ias=10.0.0.28,0.bono.me.cw-ngv.com, --pcscf=5060,5058 --webrtc-port=5062 --routing-proxy=icscf.,5052,50,600 --sas=0.0.0.0,bono at 0.bono.me.cw-ngv.com --dns-server=127.0.0.1 --worker-threads=2 --analytics=/var/log/bono --log-file=/var/log/bono --log-level=2 --daemon --pidfile=/var/run/bono/bono.pid



3.       In bono, I saw these logs.

 UTC Error sip_connection_pool.cpp:190: Failed to resolve icscf. to an IP address - Not found (PJ_ENOTFOUND)

UTC Warning dnscachedresolver.cpp:828: Failed to retrieve record for icscf.: Domain name not found



4.       To debug above issues, I ended up making these changes in /etc/init.d/bono and restarted bono service.



DAEMON_ARGS="--domain=me.cw-ngv.com  (instead of -domain=$home_domain)

upstream_hostname=icscf.sprout.me.cw-ngv.com (instead of upstream_hostname=icscf.$sprout_hostname)


5.       But now, I get below error in bono. Port 5052 is not in listen mode on sprout.

UTC Warning pjsip: tcpc0x7f90cc07 TCP connect() error: Connection refused [code=120111]
UTC Warning pjsip: tcpc0x7f90cc07 Unable to connect to <sprout ip>:5052
============================================================================================================================

Disclaimer:  This message and the information contained herein is proprietary and confidential and subject to the Tech Mahindra policy statement, you may review the policy at http://www.techmahindra.com/Disclaimer.html <http://www.techmahindra.com/Disclaimer.html> externally http://tim.techmahindra.com/tim/disclaimer.html <http://tim.techmahindra.com/tim/disclaimer.html> internally within TechMahindra.

============================================================================================================================
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20171212/dd80f814/attachment.html>

