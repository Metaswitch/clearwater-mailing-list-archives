From Robert.Day at metaswitch.com  Mon Sep  4 09:16:17 2017
From: Robert.Day at metaswitch.com (Robert Day)
Date: Mon, 4 Sep 2017 13:16:17 +0000
Subject: [Project Clearwater] Cassandra and etcd clustering problem
In-Reply-To: <CAEAO5tbL=UssM_fo2qEPX1Hwdc-QPPCPQQdPXeCQv2YvMDZ-EQ@mail.gmail.com>
References: <CAEAO5tZ3Bdm+b=BHDkag7dYztDeqJJyoatVMAuwFLrk+x9XA9w@mail.gmail.com>
	<CAEAO5tbL=UssM_fo2qEPX1Hwdc-QPPCPQQdPXeCQv2YvMDZ-EQ@mail.gmail.com>
Message-ID: <BY2PR02MB2149A6F00D9EB0A21BC96D87F4910@BY2PR02MB2149.namprd02.prod.outlook.com>

Hi Abdul,

Can you run ?ip netns exec signaling nodetool status?? What does that show?

Thanks,
Rob

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Abdul Basit Alvi
Sent: 30 August 2017 14:28
To: Clearwater at lists.projectclearwater.org
Subject: Re: [Project Clearwater] Cassandra and etcd clustering problem

Ok after stopping monit for Cassandra and restarting the service manually Cassandra has started. From the system logs I found the log vellum-0 cassandra: Found leaked cassandra 2934 (correct is 3812) - killing 2934. Cassndra is being killed. Now that i have stoped monit and restarted it manually it seems to be running fine. However homestead still cannot connect to Cassandra and I cannot run cqlsh either.
From netstat I can see cassandra listening on ports 9160 and 9042. However it is listening tcp6 as shown:

root at 0:/home/ubuntu# ip netns exec signaling netstat -tulnap
Active Internet connections (servers and established)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
tcp        0      0 192.168.1.7:11211<http://192.168.1.7:11211>       0.0.0.0:*               LISTEN      12491/memcached
tcp        0      0 127.0.0.1:7253<http://127.0.0.1:7253>          0.0.0.0:*               LISTEN      24241/chronos
tcp        0      0 192.168.1.7:7253<http://192.168.1.7:7253>        0.0.0.0:*               LISTEN      24241/chronos
tcp        0      0 192.168.1.7:37240<http://192.168.1.7:37240>       192.168.1.7:11211<http://192.168.1.7:11211>       TIME_WAIT   -
tcp        0      0 192.168.1.7:37221<http://192.168.1.7:37221>       192.168.1.7:11211<http://192.168.1.7:11211>       TIME_WAIT   -
tcp        0      0 192.168.1.7:37279<http://192.168.1.7:37279>       192.168.1.7:11211<http://192.168.1.7:11211>       TIME_WAIT   -
tcp        0      0 192.168.1.7:37251<http://192.168.1.7:37251>       192.168.1.7:11211<http://192.168.1.7:11211>       TIME_WAIT   -
tcp        0      0 127.0.0.1:36932<http://127.0.0.1:36932>         127.0.0.1:7253<http://127.0.0.1:7253>          TIME_WAIT   -
tcp        0      0 192.168.1.7:37256<http://192.168.1.7:37256>       192.168.1.7:11211<http://192.168.1.7:11211>       TIME_WAIT   -
tcp        0      0 192.168.1.7:37286<http://192.168.1.7:37286>       192.168.1.7:11211<http://192.168.1.7:11211>       TIME_WAIT   -
tcp        0      0 192.168.1.7:37261<http://192.168.1.7:37261>       192.168.1.7:11211<http://192.168.1.7:11211>       TIME_WAIT   -
tcp6       0      0 :::9160                 :::*                    LISTEN      29208/java
tcp6       0      0 :::11311                :::*                    LISTEN      2114/astaire
tcp6       0      0 :::9042                 :::*                    LISTEN      29208/java
tcp6       0      0 192.168.1.7:7000<http://192.168.1.7:7000>        :::*                    LISTEN      29208/java
tcp6       0      0 127.0.0.1:39805<http://127.0.0.1:39805>         :::*                    LISTEN      29208/java
tcp6       0      0 127.0.0.1:7199<http://127.0.0.1:7199>          :::*                    LISTEN      29208/java
tcp6       0      0 127.0.0.1:54410<http://127.0.0.1:54410>         127.0.0.1:39805<http://127.0.0.1:39805>         ESTABLISHED 29208/java
tcp6       0      0 127.0.0.1:39805<http://127.0.0.1:39805>         127.0.0.1:54410<http://127.0.0.1:54410>         ESTABLISHED 29208/java

Running cqlsh I encounter the following error:
root at 0:/home/ubuntu# ip netns exec signaling cqlsh ::1 9042
Connection error: ('Unable to connect to any servers', {'::1': ReadTimeout(u'code=1200 [Coordinator node timed out waiting for replica nodes\' responses] message="Operation timed out - received only 0 responses." info={\'received_responses\': 0, \'required_responses\': 1, \'consistency\': \'ONE\'}',)})

Does cassandra listen on tcp6 natively?
Also in the dime node homestead error logs show no more errors however in the homestead log I can see the following logs?

30-08-2017 12:45:58.760 UTC Status alarm.cpp:244: Reraising all alarms with a known state
30-08-2017 12:45:58.763 UTC Status a_record_resolver.cpp:29: Created ARecordResolver
30-08-2017 12:45:58.763 UTC Status a_record_resolver.cpp:29: Created ARecordResolver
30-08-2017 12:45:58.766 UTC Status cassandra_store.cpp:266: Configuring store connection
30-08-2017 12:45:58.766 UTC Status cassandra_store.cpp:267:   Hostname:  vellum.test.com<http://vellum.test.com>
30-08-2017 12:45:58.766 UTC Status cassandra_store.cpp:268:   Port:      9160
30-08-2017 12:45:58.766 UTC Status cassandra_store.cpp:296: Configuring store worker pool
30-08-2017 12:45:58.766 UTC Status cassandra_store.cpp:297:   Threads:   10
30-08-2017 12:45:58.766 UTC Status cassandra_store.cpp:298:   Max Queue: 0
30-08-2017 12:45:58.895 UTC Error main.cpp:752: Failed to initialize the Cassandra cache with error code 1.
30-08-2017 12:45:58.896 UTC Status main.cpp:753: Homestead is shutting down
In homestead netstat logs I cannot see any logs of homestead trying to connect to ports 9160
Proto Recv-Q Send-Q Local Address           Foreign Address         State
tcp        0      0 localhost:49146         localhost:8000          TIME_WAIT
tcp        0      0 192.168.0.4:45972<http://192.168.0.4:45972>       192.168.0.6:4000<http://192.168.0.6:4000>        ESTABLISHED
tcp       42      0 192.168.0.4:50479<http://192.168.0.4:50479>       192.168.0.7:2380<http://192.168.0.7:2380>        ESTABLISHED
tcp        0      0 192.168.0.4:2380<http://192.168.0.4:2380>        192.168.0.5:34559<http://192.168.0.5:34559>       ESTABLISHED
tcp        0      0 192.168.0.4:36437<http://192.168.0.4:36437>       192.168.0.4:4000<http://192.168.0.4:4000>        ESTABLISHED
tcp        0      0 192.168.0.4:39848<http://192.168.0.4:39848>       192.168.0.4:4000<http://192.168.0.4:4000>        ESTABLISHED
tcp        0      0 192.168.0.4:39863<http://192.168.0.4:39863>       192.168.0.4:4000<http://192.168.0.4:4000>        ESTABLISHED
tcp        0      0 192.168.0.4:2380<http://192.168.0.4:2380>        192.168.0.7:40964<http://192.168.0.7:40964>       TIME_WAIT
tcp        0      0 192.168.0.4:40269<http://192.168.0.4:40269>       192.168.0.4:4000<http://192.168.0.4:4000>        ESTABLISHED
tcp        0    103 192.168.0.4:47648<http://192.168.0.4:47648>       192.168.0.6:4000<http://192.168.0.6:4000>        ESTABLISHED
tcp        0      0 192.168.0.4:45663<http://192.168.0.4:45663>       192.168.0.6:4000<http://192.168.0.6:4000>        ESTABLISHED
tcp        0      0 192.168.0.4:2380<http://192.168.0.4:2380>        192.168.0.7:37374<http://192.168.0.7:37374>       ESTABLISHED
tcp        0      0 192.168.0.4:42474<http://192.168.0.4:42474>       192.168.0.6:4000<http://192.168.0.6:4000>        ESTABLISHED
tcp        0      0 192.168.0.4:2380<http://192.168.0.4:2380>        192.168.0.6:57924<http://192.168.0.6:57924>       ESTABLISHED
tcp        0      0 192.168.0.4:2380<http://192.168.0.4:2380>        192.168.0.5:35015<http://192.168.0.5:35015>       TIME_WAIT
tcp        0      0 192.168.0.4:2380<http://192.168.0.4:2380>        192.168.0.7:40812<http://192.168.0.7:40812>       TIME_WAIT
tcp        0      0 192.168.0.4:2380<http://192.168.0.4:2380>        192.168.0.6:53967<http://192.168.0.6:53967>       ESTABLISHED
tcp        0      0 192.168.0.4:40268<http://192.168.0.4:40268>       192.168.0.4:4000<http://192.168.0.4:4000>        TIME_WAIT
tcp        0      0 192.168.0.4:53551<http://192.168.0.4:53551>       192.168.0.5:2380<http://192.168.0.5:2380>        ESTABLISHED
tcp        0      0 192.168.0.4:2380<http://192.168.0.4:2380>        192.168.0.6:57810<http://192.168.0.6:57810>       TIME_WAIT
tcp        0      0 192.168.0.4:37873<http://192.168.0.4:37873>       192.168.0.4:4000<http://192.168.0.4:4000>        ESTABLISHED
tcp        0    103 192.168.0.4:46510<http://192.168.0.4:46510>       192.168.0.6:4000<http://192.168.0.6:4000>        ESTABLISHED
tcp        0      0 192.168.0.4:39859<http://192.168.0.4:39859>       192.168.0.4:4000<http://192.168.0.4:4000>        TIME_WAIT
tcp        0      0 192.168.0.4:2380<http://192.168.0.4:2380>        192.168.0.6:57904<http://192.168.0.6:57904>       ESTABLISHED
tcp        0      0 192.168.0.4:2380<http://192.168.0.4:2380>        192.168.0.6:57890<http://192.168.0.6:57890>       TIME_WAIT
tcp        0      0 192.168.0.4:60183<http://192.168.0.4:60183>       192.168.0.7:2380<http://192.168.0.7:2380>        ESTABLISHED
tcp        0      0 192.168.0.4:38186<http://192.168.0.4:38186>       192.168.0.4:4000<http://192.168.0.4:4000>        ESTABLISHED
tcp        0      0 192.168.0.4:37317<http://192.168.0.4:37317>       192.168.0.4:4000<http://192.168.0.4:4000>        ESTABLISHED
tcp        0      0 192.168.0.4:2380<http://192.168.0.4:2380>        192.168.0.5:58490<http://192.168.0.5:58490>       ESTABLISHED
tcp        0      0 192.168.0.4:44222<http://192.168.0.4:44222>       192.168.0.6:4000<http://192.168.0.6:4000>        ESTABLISHED
tcp        0      0 192.168.0.4:32981<http://192.168.0.4:32981>       192.168.0.7:2380<http://192.168.0.7:2380>        ESTABLISHED
tcp        0      0 192.168.0.4:38725<http://192.168.0.4:38725>       192.168.0.4:4000<http://192.168.0.4:4000>        ESTABLISHED
tcp        0      0 192.168.0.4:2380<http://192.168.0.4:2380>        192.168.0.7:40407<http://192.168.0.7:40407>       TIME_WAIT
tcp        0      0 192.168.0.4:35533<http://192.168.0.4:35533>       192.168.0.4:4000<http://192.168.0.4:4000>        ESTABLISHED
tcp        0      0 192.168.0.4:34686<http://192.168.0.4:34686>       192.168.0.4:4000<http://192.168.0.4:4000>        ESTABLISHED
tcp        0      0 192.168.0.4:43318<http://192.168.0.4:43318>       192.168.0.6:4000<http://192.168.0.6:4000>        ESTABLISHED
tcp        0      0 192.168.0.4:2380<http://192.168.0.4:2380>        192.168.0.6:57784<http://192.168.0.6:57784>       TIME_WAIT
tcp        0      0 192.168.0.4:54539<http://192.168.0.4:54539>       192.168.0.5:2380<http://192.168.0.5:2380>        ESTABLISHED
tcp        0      0 192.168.0.4:40293<http://192.168.0.4:40293>       192.168.0.4:4000<http://192.168.0.4:4000>        ESTABLISHED
tcp        0      0 192.168.0.4:2380<http://192.168.0.4:2380>        192.168.0.7:41168<http://192.168.0.7:41168>       ESTABLISHED
tcp        0      0 192.168.0.4:48057<http://192.168.0.4:48057>       192.168.0.6:2380<http://192.168.0.6:2380>        ESTABLISHED
tcp        0      0 192.168.0.4:47629<http://192.168.0.4:47629>       192.168.0.6:2380<http://192.168.0.6:2380>        ESTABLISHED
tcp        0      0 192.168.0.4:47663<http://192.168.0.4:47663>       192.168.0.6:2380<http://192.168.0.6:2380>        ESTABLISHED
tcp        0      0 192.168.0.4:45102<http://192.168.0.4:45102>       192.168.0.6:4000<http://192.168.0.6:4000>        ESTABLISHED
tcp        0      0 192.168.0.4:45341<http://192.168.0.4:45341>       192.168.0.5:2380<http://192.168.0.5:2380>        ESTABLISHED
tcp        0      0 192.168.0.4:2380<http://192.168.0.4:2380>        192.168.0.5:58487<http://192.168.0.5:58487>       ESTABLISHED
tcp        0    116 192.168.0.4:ssh         10.1.10.112:49603<http://10.1.10.112:49603>       ESTABLISHED
tcp        0      0 192.168.0.4:2380<http://192.168.0.4:2380>        192.168.0.7:38517<http://192.168.0.7:38517>       ESTABLISHED
tcp        0      0 192.168.0.4:2380<http://192.168.0.4:2380>        192.168.0.7:38517<http://192.168.0.7:38517>       ESTABLISHED
tcp6       0      0 192.168.0.4:4000<http://192.168.0.4:4000>        192.168.0.4:38725<http://192.168.0.4:38725>       ESTABLISHED
tcp6       0      0 ip6-localhost:50722     ip6-localhost:4000      ESTABLISHED
tcp6       0      0 192.168.0.4:4000<http://192.168.0.4:4000>        192.168.0.4:39848<http://192.168.0.4:39848>       ESTABLISHED
tcp6       0      0 ip6-localhost:4000      ip6-localhost:50724     ESTABLISHED
tcp6       0      0 ip6-localhost:50721     ip6-localhost:4000      ESTABLISHED
tcp6       0      0 ip6-localhost:50720     ip6-localhost:4000      ESTABLISHED
tcp6       0      0 192.168.0.4:4000<http://192.168.0.4:4000>        192.168.0.4:37873<http://192.168.0.4:37873>       ESTABLISHED
tcp6       0      0 192.168.0.4:4000<http://192.168.0.4:4000>        192.168.0.4:34686<http://192.168.0.4:34686>       ESTABLISHED
tcp6       0      0 ip6-localhost:4000      ip6-localhost:50717     ESTABLISHED
tcp6       0      0 192.168.0.4:4000<http://192.168.0.4:4000>        192.168.0.4:35533<http://192.168.0.4:35533>       ESTABLISHED
tcp6       0      0 ip6-localhost:4000      ip6-localhost:50721     ESTABLISHED
tcp6       0      0 192.168.0.4:4000<http://192.168.0.4:4000>        192.168.0.4:38186<http://192.168.0.4:38186>       ESTABLISHED
tcp6       0      0 ip6-localhost:4000      ip6-localhost:50723     ESTABLISHED
tcp6       0      0 ip6-localhost:50723     ip6-localhost:4000      ESTABLISHED
tcp6       0      0 ip6-localhost:50724     ip6-localhost:4000      ESTABLISHED
tcp6       0      0 ip6-localhost:50717     ip6-localhost:4000      ESTABLISHED
tcp6       0      0 ip6-localhost:4000      ip6-localhost:50722     ESTABLISHED
tcp6       0      0 192.168.0.4:4000<http://192.168.0.4:4000>        192.168.0.4:40294<http://192.168.0.4:40294>       ESTABLISHED
tcp6       0      0 192.168.0.4:4000<http://192.168.0.4:4000>        192.168.0.4:36437<http://192.168.0.4:36437>       ESTABLISHED
tcp6       0      0 192.168.0.4:4000<http://192.168.0.4:4000>        192.168.0.4:39863<http://192.168.0.4:39863>       ESTABLISHED
tcp6       0      0 192.168.0.4:4000<http://192.168.0.4:4000>        192.168.0.4:40293<http://192.168.0.4:40293>       ESTABLISHED
tcp6       0      0 192.168.0.4:4000<http://192.168.0.4:4000>        192.168.0.4:37317<http://192.168.0.4:37317>       ESTABLISHED
tcp6       0      0 ip6-localhost:4000      ip6-localhost:50720     ESTABLISHED

Kindly please guide me on what to do.
Regards,
Abdul Basit Alvi



On Sun, Aug 27, 2017 at 10:24 AM, Abdul Basit Alvi <abdulbasit.ta at gmail.com<mailto:abdulbasit.ta at gmail.com>> wrote:
Hi,
I have been trying to make the IMS work via manual install. I have followed all the instructions to the dot and have tried starting from scratch multiple times, but somehow I cant figure out why Cassandra and etcd clustering are not working properly.

In the Dime node homestead process is not running, this I know is because it cant connect to the vellum node cassandra via the thrift port 9160.

Next in the Vellum node the cassandra process is running but not working at all. I have attached the system log files as well as cassandra.yaml and the cassandra-env.sh file. For test purposes I have allowed all incomming TCP/UDP traffic to and from all nodes.

Can you kindly look at the logs and outputs and point out what am I doing wrong?

[Monit summary of dime]
root at dime-0:/home/ubuntu# monit summary
Monit 5.18.1 uptime: 6h 27m
 Service Name                     Status                      Type
 node-dime-0.test.com<http://node-dime-0.test.com>             Running                     System
 snmpd_process                    Running                     Process
 ralf_process                     Running                     Process
 ntp_process                      Running                     Process
 nginx_process                    Running                     Process
 homestead_process                Does not exist              Process
 homestead-prov_process           Running                     Process
 clearwater_queue_manager_pro...  Running                     Process
 etcd_process                     Running                     Process
 clearwater_diags_monitor_pro...  Running                     Process
 clearwater_config_manager_pr...  Running                     Process
 clearwater_cluster_manager_p...  Running                     Process
 ralf_uptime                      Status ok                   Program
 poll_ralf                        Status ok                   Program
 nginx_ping                       Status ok                   Program
 nginx_uptime                     Status ok                   Program
 monit_uptime                     Status ok                   Program
 homestead_uptime                 Wait parent                 Program
 poll_homestead                   Wait parent                 Program
 check_cx_health                  Wait parent                 Program
 poll_homestead-prov              Status failed               Program
 clearwater_queue_manager_uptime  Status ok                   Program
 etcd_uptime                      Status ok                   Program
 poll_etcd_cluster                Status failed               Program
 poll_etcd                        Status ok                   Program
[Dime Local config]

[etcd cluster health dime]
root at dime-0:/home/ubuntu# clearwater-etcdctl cluster-health
member 5cd7042180fbb2a is unhealthy: got unhealthy result from http://192.168.0.6:4000
failed to check the health of member 208dd0fbcefb149c on http://192.168.0.8:4000: Get http://192.168.0.8:4000/health: dial tcp 192.168.0.8:4000<http://192.168.0.8:4000>: getsockopt: connection refused
member 208dd0fbcefb149c is unreachable: [http://192.168.0.8:4000] are all unreachable
member 2457d2c8a20fc738 is unhealthy: got unhealthy result from http://192.168.0.5:4000
member 48fa49be2b2ae2c2 is unhealthy: got unhealthy result from http://192.168.0.3:4000
failed to check the health of member a48134f48b185ad9 on http://192.168.0.7:4000: Get http://192.168.0.7:4000/health: dial tcp 192.168.0.7:4000<http://192.168.0.7:4000>: getsockopt: connection refused
member a48134f48b185ad9 is unreachable: [http://192.168.0.7:4000] are all unreachable
member e7db4eebbdb94a11 is unhealthy: got unhealthy result from http://192.168.0.4:4000
cluster is unhealthy

[local config file dime]
root at dime-0:/home/ubuntu# cat /etc/clearwater/local_config
local_ip=192.168.0.4
public_ip=10.1.10.192
public_hostname=dime-0.test.com<http://dime-0.test.com>
etcd_cluster=192.168.0.3,192.168.0.4,192.168.0.5,192.168.0.6,192.168.0.7,192.168.0.8

[shared config file dime]
root at vellum-0:/home/ubuntu# cat /etc/clearwater/shared_config
# Deployment definitions
home_domain=test.com<http://test.com>
sprout_hostname=sprout.test.com<http://sprout.test.com>
hs_hostname=hs.test.com:8888<http://hs.test.com:8888>
hs_provisioning_hostname=hs-prov.test.com:8889<http://hs-prov.test.com:8889>
dime_hostname=dime.test.com:10888<http://dime.test.com:10888>
xdms_hostname=homer.test.com:7888<http://homer.test.com:7888>
sprout_impi_store=vellum.test.com<http://vellum.test.com>
sprout_registration_store=vellum.test.com<http://vellum.test.com>
cassandra_hostname=vellum.test.com<http://vellum.test.com>
chronos_hostname=vellum.test.com<http://vellum.test.com>
dime_session_store=vellum.test.com<http://vellum.test.com>

upstream_port=0

# Email server configuration
smtp_smarthost=localhost
smtp_username=username
smtp_password=password
email_recovery_sender=clearwater at example.org<mailto:clearwater at example.org>

# Keys
signup_key=secret
turn_workaround=secret
ellis_api_key=secret
ellis_cookie_key=secret

[Error Log Homestead]
Thrift: Sun Aug 27 05:04:01 2017 TSocket::open() error on socket (after THRIFT_POLL) <Host: 192.168.0.8 Port: 9160>Connection refused
Thrift: Sun Aug 27 05:04:02 2017 TSocket::open() error on socket (after THRIFT_POLL) <Host: 192.168.0.8 Port: 9160>Connection refused
Thrift: Sun Aug 27 05:04:44 2017 TSocket::open() error on socket (after THRIFT_POLL) <Host: 192.168.0.8 Port: 9160>Connection refused
Thrift: Sun Aug 27 05:04:44 2017 TSocket::open() error on socket (after THRIFT_POLL) <Host: 192.168.0.8 Port: 9160>Connection refused
Thrift: Sun Aug 27 05:05:08 2017 TSocket::open() error on socket (after THRIFT_POLL) <Host: 192.168.0.8 Port: 9160>Connection refused
Thrift: Sun Aug 27 05:05:08 2017 TSocket::open() error on socket (after THRIFT_POLL) <Host: 192.168.0.8 Port: 9160>Connection refused
Thrift: Sun Aug 27 05:05:30 2017 TSocket::open() error on socket (after THRIFT_POLL) <Host: 192.168.0.8 Port: 9160>Connection refused
Thrift: Sun Aug 27 05:05:30 2017 TSocket::open() error on socket (after THRIFT_POLL) <Host: 192.168.0.8 Port: 9160>Connection refused
Thrift: Sun Aug 27 05:05:38 2017 TSocket::open() error on socket (after THRIFT_POLL) <Host: 192.168.0.8 Port: 9160>Connection refused
Thrift: Sun Aug 27 05:05:38 2017 TSocket::open() error on socket (after THRIFT_POLL) <Host: 192.168.0.8 Port: 9160>Connection refused

[Running cqlsh on vellum]
root at vellum-0:/home/ubuntu# cqlsh
Connection error: ('Unable to connect to any servers', {'127.0.0.1': error(111, "Tried connecting to [('127.0.0.1', 9042)]. Last error: Connection refused")}

[Monit summary of vellum]
root at vellum-0:/home/ubuntu# monit summary
Monit 5.18.1 uptime: 6h 39m
 Service Name                     Status                      Type
 node-vellum-0.test.com<http://node-vellum-0.test.com>           Running                     System
 snmpd_process                    Running                     Process
 ntp_process                      Running                     Process
 memcached_process                Running                     Process
 clearwater_queue_manager_pro...  Running                     Process
 etcd_process                     Execution failed | Does...  Process
 clearwater_diags_monitor_pro...  Running                     Process
 clearwater_config_manager_pr...  Running                     Process
 clearwater_cluster_manager_p...  Running                     Process
 cassandra_process                Running                     Process
 chronos_process                  Running                     Process
 astaire_process                  Running                     Process
 monit_uptime                     Status ok                   Program
 memcached_uptime                 Status ok                   Program
 poll_memcached                   Status ok                   Program
 clearwater_queue_manager_uptime  Status ok                   Program
 etcd_uptime                      Wait parent                 Program
 poll_etcd_cluster                Wait parent                 Program
 poll_etcd                        Wait parent                 Program
 cassandra_uptime                 Status ok                   Program
 poll_cassandra                   Status ok                   Program
 poll_cqlsh                       Status ok                   Program
 chronos_uptime                   Status ok                   Program
 poll_chronos                     Status failed               Program
 astaire_uptime                   Status ok                   Program

[local config file vellum]
root at vellum-0:/home/ubuntu# cat /etc/clearwater/local_config
local_ip=192.168.0.8
public_ip=10.1.10.204
public_hostname=vellum-0.test.com<http://vellum-0.test.com>
etcd_cluster=192.168.0.3,192.168.0.4,192.168.0.5,192.168.0.6,192.168.0.7,192.168.0.8


[shared config file vellum]
root at vellum-0:/home/ubuntu# cat /etc/clearwater/shared_config
# Deployment definitions
home_domain=test.com<http://test.com>
sprout_hostname=sprout.test.com<http://sprout.test.com>
hs_hostname=hs.test.com:8888<http://hs.test.com:8888>
hs_provisioning_hostname=hs-prov.test.com:8889<http://hs-prov.test.com:8889>
dime_hostname=dime.test.com:10888<http://dime.test.com:10888>
xdms_hostname=homer.test.com:7888<http://homer.test.com:7888>
sprout_impi_store=vellum.test.com<http://vellum.test.com>
sprout_registration_store=vellum.test.com<http://vellum.test.com>
cassandra_hostname=vellum.test.com<http://vellum.test.com>
chronos_hostname=vellum.test.com<http://vellum.test.com>
dime_session_store=vellum.test.com<http://vellum.test.com>

upstream_port=0

# Email server configuration
smtp_smarthost=localhost
smtp_username=username
smtp_password=password
email_recovery_sender=clearwater at example.org<mailto:clearwater at example.org>

# Keys
signup_key=secret
turn_workaround=secret
ellis_api_key=secret
ellis_cookie_key=secret

[netstat on vellum]
root at vellum-0:/home/ubuntu# netstat -tulnap
Active Internet connections (servers and established)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
tcp        0      0 192.168.0.8:11211<http://192.168.0.8:11211>       0.0.0.0:*               LISTEN      27005/memcached
tcp        0      0 127.0.0.1:7253<http://127.0.0.1:7253>          0.0.0.0:*               LISTEN      27610/chronos
tcp        0      0 255.255.255.255:7253<http://255.255.255.255:7253>    0.0.0.0:*               LISTEN      27610/chronos
tcp        0      0 127.0.0.1:53<http://127.0.0.1:53>            0.0.0.0:*               LISTEN      7718/dnsmasq
tcp        0      0 0.0.0.0:22<http://0.0.0.0:22>              0.0.0.0:*               LISTEN      1189/sshd
tcp        0      0 127.0.0.1:2812<http://127.0.0.1:2812>          0.0.0.0:*               LISTEN      7833/monit
tcp        0      0 192.168.0.8:44035<http://192.168.0.8:44035>       192.168.0.8:11211<http://192.168.0.8:11211>       TIME_WAIT   -
tcp        0      0 127.0.0.1:54026<http://127.0.0.1:54026>         127.0.0.1:7253<http://127.0.0.1:7253>          TIME_WAIT   -
tcp        0      0 192.168.0.8:44064<http://192.168.0.8:44064>       192.168.0.8:11211<http://192.168.0.8:11211>       TIME_WAIT   -
tcp        0      0 192.168.0.8:44081<http://192.168.0.8:44081>       192.168.0.8:11211<http://192.168.0.8:11211>       TIME_WAIT   -
tcp        0      0 192.168.0.8:44053<http://192.168.0.8:44053>       192.168.0.8:11211<http://192.168.0.8:11211>       TIME_WAIT   -
tcp        0      0 192.168.0.8:44054<http://192.168.0.8:44054>       192.168.0.8:11211<http://192.168.0.8:11211>       TIME_WAIT   -
tcp        0      0 192.168.0.8:44048<http://192.168.0.8:44048>       192.168.0.8:11211<http://192.168.0.8:11211>       TIME_WAIT   -
tcp        0      0 192.168.0.8:22<http://192.168.0.8:22>          10.1.10.112:51998<http://10.1.10.112:51998>       ESTABLISHED 26454/sshd: ubuntu
tcp        0    268 192.168.0.8:22<http://192.168.0.8:22>          10.1.10.112:51933<http://10.1.10.112:51933>       ESTABLISHED 22779/sshd: ubuntu
tcp6       0      0 :::11311                :::*                    LISTEN      26657/astaire
tcp6       0      0 ::1:53                  :::*                    LISTEN      7718/dnsmasq
tcp6       0      0 :::22                   :::*                    LISTEN      1189/sshd
udp        0      0 127.0.0.1:53<http://127.0.0.1:53>            0.0.0.0:*                           7718/dnsmasq
udp        0      0 0.0.0.0:68<http://0.0.0.0:68>              0.0.0.0:*                           601/dhclient
udp        0      0 192.168.0.8:123<http://192.168.0.8:123>         0.0.0.0:*                           7362/ntpd
udp        0      0 127.0.0.1:123<http://127.0.0.1:123>           0.0.0.0:*                           7362/ntpd
udp        0      0 0.0.0.0:123<http://0.0.0.0:123>             0.0.0.0:*                           7362/ntpd
udp        0      0 0.0.0.0:161<http://0.0.0.0:161>             0.0.0.0:*                           7472/snmpd
udp        0      0 0.0.0.0:55423<http://0.0.0.0:55423>           0.0.0.0:*                           601/dhclient
udp6       0      0 :::23767                :::*                                601/dhclient
udp6       0      0 ::1:53                  :::*                                7718/dnsmasq
udp6       0      0 ::1:123                 :::*                                7362/ntpd
udp6       0      0 fe80::f816:3eff:fe3:123 :::*                                7362/ntpd
udp6       0      0 :::123                  :::*                                7362/ntpd
udp6       0      0 :::161                  :::*                                7472/snmpd

[Ping results]
root at vellum-0:/home/ubuntu# ping hs-prov.test.com<http://hs-prov.test.com>
PING hs-prov.test.com<http://hs-prov.test.com> (192.168.0.4) 56(84) bytes of data.
64 bytes from 192.168.0.4<http://192.168.0.4>: icmp_seq=1 ttl=64 time=10.3 ms
64 bytes from 192.168.0.4<http://192.168.0.4>: icmp_seq=2 ttl=64 time=12.1 ms
64 bytes from 192.168.0.4<http://192.168.0.4>: icmp_seq=3 ttl=64 time=9.06 ms
^C
--- hs-prov.test.com<http://hs-prov.test.com> ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2032ms
rtt min/avg/max/mdev = 9.063/10.529/12.151/1.270 ms
root at vellum-0:/home/ubuntu#
root at vellum-0:/home/ubuntu# ping hs.test.com<http://hs.test.com>
PING hs.test.com<http://hs.test.com> (192.168.0.4) 56(84) bytes of data.
64 bytes from 192.168.0.4<http://192.168.0.4>: icmp_seq=1 ttl=64 time=21.3 ms
64 bytes from 192.168.0.4<http://192.168.0.4>: icmp_seq=2 ttl=64 time=4.58 ms
64 bytes from 192.168.0.4<http://192.168.0.4>: icmp_seq=3 ttl=64 time=20.6 ms
^C
--- hs.test.com<http://hs.test.com> ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2070ms
rtt min/avg/max/mdev = 4.584/15.523/21.363/7.741 ms
root at vellum-0:/home/ubuntu# ping dime-0.test.com<http://dime-0.test.com>
PING dime-0.test.com<http://dime-0.test.com> (10.1.10.192) 56(84) bytes of data.
64 bytes from 10.1.10.192<http://10.1.10.192>: icmp_seq=1 ttl=63 time=25.9 ms
64 bytes from 10.1.10.192<http://10.1.10.192>: icmp_seq=2 ttl=63 time=58.9 ms
^C
--- dime-0.test.com<http://dime-0.test.com> ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1029ms
rtt min/avg/max/mdev = 25.954/42.459/58.964/16.505 ms

root at bono-0:/home/ubuntu# ping vellum-0.test.com<http://vellum-0.test.com>
PING vellum-0.test.com<http://vellum-0.test.com> (10.1.10.204) 56(84) bytes of data.
64 bytes from 10.1.10.204<http://10.1.10.204>: icmp_seq=1 ttl=63 time=36.7 ms
64 bytes from 10.1.10.204<http://10.1.10.204>: icmp_seq=2 ttl=63 time=25.2 ms
^C
--- vellum-0.test.com<http://vellum-0.test.com> ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1002ms
rtt min/avg/max/mdev = 25.240/30.985/36.730/5.745 ms
root at bono-0:/home/ubuntu# ping vellum.test.com<http://vellum.test.com>
PING vellum.test.com<http://vellum.test.com> (192.168.0.8) 56(84) bytes of data.
64 bytes from 192.168.0.8<http://192.168.0.8>: icmp_seq=1 ttl=64 time=51.4 ms
64 bytes from 192.168.0.8<http://192.168.0.8>: icmp_seq=2 ttl=64 time=3.93 ms
64 bytes from 192.168.0.8<http://192.168.0.8>: icmp_seq=3 ttl=64 time=4.22 ms

Regards,

Abdul Basit Alvi

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20170904/85841a27/attachment.html>

From Prashanth.Gonti at ril.com  Mon Sep  4 09:25:18 2017
From: Prashanth.Gonti at ril.com (Prashanth.Gonti at ril.com)
Date: Mon, 4 Sep 2017 13:25:18 +0000
Subject: [Project Clearwater] Request Timeout (408) error while trying to
 call
Message-ID: <c43c491b3188419fb72820c3bdfcabd2@SIDC1EXMBX14.in.ril.com>

Hi,

                I've installed Clearwater All-in-one image on t2.medium EC2 instance and am able to register the zoiper clients installed on android mobiles. But when I try to call from one device to another, Request Timeout (408) error is popping up. Could you please help me in resolving the error? Thank you

Regards,
Prashanth

"Confidentiality Warning: This message and any attachments are intended only for the use of the intended recipient(s). 
are confidential and may be privileged. If you are not the intended recipient. you are hereby notified that any 
review. re-transmission. conversion to hard copy. copying. circulation or other use of this message and any attachments is 
strictly prohibited. If you are not the intended recipient. please notify the sender immediately by return email. 
and delete this message and any attachments from your system.

Virus Warning: Although the company has taken reasonable precautions to ensure no viruses are present in this email. 
The company cannot accept responsibility for any loss or damage arising from the use of this email or attachment."
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20170904/dd5edb9f/attachment.html>

From pramchan at yahoo.com  Mon Sep 11 19:34:43 2017
From: pramchan at yahoo.com (prakash RAMCHANDRAN)
Date: Mon, 11 Sep 2017 23:34:43 +0000 (UTC)
Subject: [Project Clearwater] [Subject] clearwater-live-test using ruby rvm
 on Ubuntu 16.04 and package install issues
References: <1695540633.7309230.1505172883885.ref@mail.yahoo.com>
Message-ID: <1695540633.7309230.1505172883885@mail.yahoo.com>

Although I was able to install ruby? rvm 1.9.2? on gen1 Rackspace Ubuntu Xenial 16.04 server? have issues on some other private PODs. Due to the resource limitations there could not get vIMS running to run the celae-water-live tsts on the servers.
On the private vPOD, there was? no curl available on Xenial and in trying to overcome did use .deb curl package from ubuntu cloud 
So followed this to get .deb curl and installed it
https://packages.ubuntu.com/xenial/amd64/curl/download


Then following happened as you see the dependency failures for? this? part of per-requisite for ruby 1.9.3

https://github.com/Metaswitch/clearwater-live-test/

?
root at host1:/opt# rvm install 1.9.3Searching for binary rubies, this might take some time.
No binary rubies available for: ubuntu/16.04/x86_64/ruby-1.9.3-p551.
Continuing with compilation. Please read 'rvm help mount' to get more information on binary rubies.
Checking requirements for ubuntu.
Installing requirements for ubuntu.
Updating system..
Installing required packages: zlib1g-dev, libyaml-dev, libsqlite3-dev, sqlite3, autoconf, libgmp-dev, libgdbm-dev, libncurses5-dev, automake, libtool, bison, pkg-config, libffi-dev, libgmp-dev, libreadline6-dev, libssl-dev......
Error running 'requirements_debian_libs_install zlib1g-dev libyaml-dev libsqlite3-dev sqlite3 autoconf libgmp-dev libgdbm-dev libncurses5-dev automake libtool bison pkg-config libffi-dev libgmp-dev libreadline6-dev libssl-dev',
please read /usr/local/rvm/log/1505170731_ruby-1.9.3-p551/package_install_zlib1g-dev_libyaml-dev_libsqlite3-dev_sqlite3_autoconf_libgmp-dev_libgdbm-dev_libncurses5-dev_automake_libtool_bison_pkg-config_libffi-dev_libgmp-dev_libreadline6-dev_libssl-dev.log
Requirements installation failed with status: 100.


1. Suggesions listed were try rvm help mount:
root at host1:/opt# rvm help mountRuby enVironment Manager 1.29.3 (latest) (c) 2009-2017 Michal Papis, Piotr Kuczynski, Wayne E. Seguin
This is not a viable option.
2. please read /usr/local/rvm/log/1505166799_ruby-1.9.3-p551/package_install_zlib1g-dev_libyaml-dev_libsqlite3-dev_sqlite3_autoconf_libgmp-dev_libgdbm-dev_libncurses5-dev_automake_libtool_bison_pkg-config_libffi-dev_libgmp-dev_libreadline6-dev_libssl-dev.log
Requirements installation failed with status: 100.

E: Package 'zlib1g-dev' has no installation candidate
E: Unable to locate package libyaml-dev
E: Unable to locate package libsqlite3-dev
E: Package 'autoconf' has no installation candidate
E: Package 'libgmp-dev' has no installation candidate
E: Unable to locate package libgdbm-dev
E: Unable to locate package libncurses5-dev
E: Package 'automake' has no installation candidate
E: Package 'libtool' has no installation candidate
E: Package 'bison' has no installation candidate
E: Package 'pkg-config' has no installation candidate
E: Package 'libffi-dev' has no installation candidate
E: Package 'libgmp-dev' has no installation candidate
E: Unable to locate package libreadline6-dev


Now did anyone come across this and if so how did you solve it. If not what is your suggestions to overcoe this problem?

ThanksPrakash

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20170911/8645de6f/attachment.html>

From pramchan at yahoo.com  Tue Sep 12 12:35:18 2017
From: pramchan at yahoo.com (prakash RAMCHANDRAN)
Date: Tue, 12 Sep 2017 16:35:18 +0000 (UTC)
Subject: [Project Clearwater] [Subject] clearwater-live-test using ruby
 rvm on Ubuntu 16.04 and package install issues
In-Reply-To: <1695540633.7309230.1505172883885@mail.yahoo.com>
References: <1695540633.7309230.1505172883885.ref@mail.yahoo.com>
	<1695540633.7309230.1505172883885@mail.yahoo.com>
Message-ID: <2100180317.479365.1505234118432@mail.yahoo.com>

Hi all,Few answers here, but more questions to ruby experts in celearwater community?
Was able to resolve this errors by editing and adding following lines
vi /etc/apt/sources.list
 deb [arch=amd64] http://security.ubuntu.com/ubuntu xenial-security main
deb [arch=amd64] http://mirrors.opencas.org/ubuntu/ xenial main
deb-src [arch=amd64] http://mirrors.opencas.org/ubuntu/ xenial main
:wq!sudo apt-get update
source /etc/profile.d/rvm.sh
rvm autolibs enable
rvm install 1.9.3
rvm docs generate-ri
There was a warning for updaing to ruby-2.4.1
Please consider upgrading to ruby-2.4.1 which will have all of the latest security patches.

Question ? Has anyone tried ruby rake tests using ruby-2.4.1. Will the gems using rvm 1.9.3 need source re-build or ruby-2.4.1 backward compatible to be able to use existing gems as is?


    On Monday, September 11, 2017, 4:34:43 PM PDT, prakash RAMCHANDRAN <pramchan at yahoo.com> wrote:  
 
 Although I was able to install ruby? rvm 1.9.2? on gen1 Rackspace Ubuntu Xenial 16.04 server? have issues on some other private PODs. Due to the resource limitations there could not get vIMS running to run the celae-water-live tsts on the servers.
On the private vPOD, there was? no curl available on Xenial and in trying to overcome did use .deb curl package from ubuntu cloud 
So followed this to get .deb curl and installed it
https://packages.ubuntu.com/xenial/amd64/curl/download


Then following happened as you see the dependency failures for? this? part of per-requisite for ruby 1.9.3

https://github.com/Metaswitch/clearwater-live-test/

?
root at host1:/opt# rvm install 1.9.3Searching for binary rubies, this might take some time.
No binary rubies available for: ubuntu/16.04/x86_64/ruby-1.9.3-p551.
Continuing with compilation. Please read 'rvm help mount' to get more information on binary rubies.
Checking requirements for ubuntu.
Installing requirements for ubuntu.
Updating system..
Installing required packages: zlib1g-dev, libyaml-dev, libsqlite3-dev, sqlite3, autoconf, libgmp-dev, libgdbm-dev, libncurses5-dev, automake, libtool, bison, pkg-config, libffi-dev, libgmp-dev, libreadline6-dev, libssl-dev......
Error running 'requirements_debian_libs_install zlib1g-dev libyaml-dev libsqlite3-dev sqlite3 autoconf libgmp-dev libgdbm-dev libncurses5-dev automake libtool bison pkg-config libffi-dev libgmp-dev libreadline6-dev libssl-dev',
please read /usr/local/rvm/log/1505170731_ruby-1.9.3-p551/package_install_zlib1g-dev_libyaml-dev_libsqlite3-dev_sqlite3_autoconf_libgmp-dev_libgdbm-dev_libncurses5-dev_automake_libtool_bison_pkg-config_libffi-dev_libgmp-dev_libreadline6-dev_libssl-dev.log
Requirements installation failed with status: 100.


1. Suggesions listed were try rvm help mount:
root at host1:/opt# rvm help mountRuby enVironment Manager 1.29.3 (latest) (c) 2009-2017 Michal Papis, Piotr Kuczynski, Wayne E. Seguin
This is not a viable option.
2. please read /usr/local/rvm/log/1505166799_ruby-1.9.3-p551/package_install_zlib1g-dev_libyaml-dev_libsqlite3-dev_sqlite3_autoconf_libgmp-dev_libgdbm-dev_libncurses5-dev_automake_libtool_bison_pkg-config_libffi-dev_libgmp-dev_libreadline6-dev_libssl-dev.log
Requirements installation failed with status: 100.

E: Package 'zlib1g-dev' has no installation candidate
E: Unable to locate package libyaml-dev
E: Unable to locate package libsqlite3-dev
E: Package 'autoconf' has no installation candidate
E: Package 'libgmp-dev' has no installation candidate
E: Unable to locate package libgdbm-dev
E: Unable to locate package libncurses5-dev
E: Package 'automake' has no installation candidate
E: Package 'libtool' has no installation candidate
E: Package 'bison' has no installation candidate
E: Package 'pkg-config' has no installation candidate
E: Package 'libffi-dev' has no installation candidate
E: Package 'libgmp-dev' has no installation candidate
E: Unable to locate package libreadline6-dev


Now did anyone come across this and if so how did you solve it. If not what is your suggestions to overcoe this problem?

ThanksPrakash

  
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20170912/ee0665c8/attachment.html>

From Adam.Lindley at metaswitch.com  Wed Sep 13 12:20:00 2017
From: Adam.Lindley at metaswitch.com (Adam Lindley)
Date: Wed, 13 Sep 2017 16:20:00 +0000
Subject: [Project Clearwater] =?iso-8859-1?q?_Release_note_for_sprint_Nazg?=
 =?iso-8859-1?q?=FBl?=
Message-ID: <BY2PR02MB2037FEC6D30298074B2C5CBDE26E0@BY2PR02MB2037.namprd02.prod.outlook.com>

Hi all,

We have cut the latest Project Clearwater Release: Nazg?l. The code for this release has been tagged as release-128 in GitHub.

This release includes a couple of substantial pieces of work:

We've created a more clear distinction between data that Homestead is caching and data which is mastered by Homestead-Prov. Homestead now uses memcached to store its cached data, whereas Homestead-Prov still masters its data in Cassandra (if your deployment is not using an external HSS); provisioned subscriber data remains persistently stored on disk. This move should improve general performance, as well as bringing our infrastructure on the main call path closer together, with both Sprout and Homestead now using Memcached and Astaire. Because of these changes there are a few specific upgrade steps that need to be followed to take this release. Details are included at the bottom of this release note.

As well as this, we have performed some re-architecting of how the Sprout stores are laid out and set up (in particular the AoRStore and ImpiStore). This work has been undertaken to make Clearwater more flexible, and easier to maintain and develop. In general, we are seeing an increasing trend in the number of platform storage solutions available, ranging from those provided by generic cloud providers (e.g. EC2) to custom built data layers shared by a whole set of products. As ever, Project Clearwater is striving to lead the way in cloud-native architectures, and aims to leverage these technologies wherever possible. While you shouldn't see any difference caused by this as an end user, anyone interested in integrating Project Clearwater with their own choice of storage solution should find it a bit easier to crack into.


This release also includes the following bug fixes:

  *   `sudo service clearwater-etcd decommission` doesn't fully decommission Cassandra
  *   Race conditions in Memcached UTs causing failures
  *   Calls can fail in race condition between sites
  *   Intermittent memcached UT failed due to race condition
  *   Mark node failed can hang indefinitely if there's no etcd cluster
  *   Challenged unregisters failing due to different URL escaping methods
  *   typo in ralf alarm
  *   Our example ENUM rules may not work correctly
  *   OpenStack Heat templates didn't create homestead-cache schema on Vellum
  *   Homestead-prov doesn't respond to requests in an IPv6 deployment
  *   Ellis debian links were not configured correctly
  *   Sprout sends reg-event NOTIFYs when somebody else SUBSCRIBEs
  *   Sprout sends a reg-event NOTIFY to the UE whenever the P-CSCF refreshes its subscription
  *   Homestead cannot properly handle Charging-Information Push-Profile-Requests without an IMS subscription element


Upgrading to the new release
For this release, our changes have a couple of added implications:

  *   There's a new shared_config option which is required for homestead to run, `homestead_impu_store`
  *   Vellum nodes won't run Cassandra if your deployment isn't using homestead-prov

To upgrade to this release, perform the following steps:

For deployments currently using Homestead-prov:

?         before taking the update you should add the following option to your shared_config, and upload it using `cw-upload_shared_config`:
`homestead_impu_store=<the same as your existing sprout_registration_store option>`

?         then follow the instructions at http://docs.projectclearwater.org/en/stable/Upgrading_a_Clearwater_deployment.html.

For deployments integrated with an external HSS:

?         If you have a deployment that's using an external HSS rather than Homestead-Prov, we recommend you re-deploy to pick up these changes correctly, and avoid conflicts.

New deployments using Chef:

?         Chef has been updated to add the new shared_config option, so when you next want to create a Chef deployment, you should ensure you:

     *   Pull the latest Chef changes from master
     *   Re-upload your cookbook and roles:

`knife cookbook upload clearwater -o cookbooks/`
`find roles/*.rb -exec knife role from file {} \;`

All-in-one images:
If you are deploying an all-in-one node, the standard image (http://vm-images.cw-ngv.com/cw-aio.ova) has been updated for this release.


Any issues, get in touch with us and the wider community on the Project Clearwater mailing list http://www.projectclearwater.org/community

Cheers,
Adam

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20170913/472ed2eb/attachment.html>

From Robert.Day at metaswitch.com  Fri Sep 15 03:24:29 2017
From: Robert.Day at metaswitch.com (Robert Day)
Date: Fri, 15 Sep 2017 07:24:29 +0000
Subject: [Project Clearwater] Request Timeout (408) error while trying
 to call
In-Reply-To: <c43c491b3188419fb72820c3bdfcabd2@SIDC1EXMBX14.in.ril.com>
References: <c43c491b3188419fb72820c3bdfcabd2@SIDC1EXMBX14.in.ril.com>
Message-ID: <BY2PR02MB2149F85BC7742084F2711F30F46C0@BY2PR02MB2149.namprd02.prod.outlook.com>

Hi Prashanth,


A 408 Request Timeout could be coming from Clearwater (because its requests upstream are timing out) or from Zoiper (because its requests to Clearwater are timing out).


To help tell which is the case, could you increase Clearwater's log level (at http://clearwater.readthedocs.io/en/stable/Troubleshooting_and_Recovery.html) and see if the SIP INVITE and the 408 appear in Bono's logs?


Thanks,

Rob


________________________________
From: Clearwater <clearwater-bounces at lists.projectclearwater.org> on behalf of Prashanth.Gonti at ril.com <Prashanth.Gonti at ril.com>
Sent: 04 September 2017 14:25
To: clearwater at lists.projectclearwater.org
Subject: [Project Clearwater] Request Timeout (408) error while trying to call

Hi,

                I?ve installed Clearwater All-in-one image on t2.medium EC2 instance and am able to register the zoiper clients installed on android mobiles. But when I try to call from one device to another, Request Timeout (408) error is popping up. Could you please help me in resolving the error? Thank you

Regards,
Prashanth


"Confidentiality Warning: This message and any attachments are intended only for the use of the intended recipient(s), are confidential and may be privileged. If you are not the intended recipient, you are hereby notified that any review, re-transmission, conversion to hard copy, copying, circulation or other use of this message and any attachments is strictly prohibited. If you are not the intended recipient, please notify the sender immediately by return email and delete this message and any attachments from your system.

Virus Warning: Although the company has taken reasonable precautions to ensure no viruses are present in this email. The company cannot accept responsibility for any loss or damage arising from the use of this email or attachment."
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20170915/0b2926f4/attachment.html>

From Robert.Day at metaswitch.com  Fri Sep 15 03:30:11 2017
From: Robert.Day at metaswitch.com (Robert Day)
Date: Fri, 15 Sep 2017 07:30:11 +0000
Subject: [Project Clearwater] [Subject] clearwater-live-test using ruby
 rvm on Ubuntu 16.04 and package install issues
In-Reply-To: <2100180317.479365.1505234118432@mail.yahoo.com>
References: <1695540633.7309230.1505172883885.ref@mail.yahoo.com>
	<1695540633.7309230.1505172883885@mail.yahoo.com>,
	<2100180317.479365.1505234118432@mail.yahoo.com>
Message-ID: <BY2PR02MB21495B75E6DFDC998BAF819BF46C0@BY2PR02MB2149.namprd02.prod.outlook.com>

Hi Prakash,


We've never run the tests with a Ruby version other than 1.9.3 to my knowledge. My guess is that it wouldn't be very difficult to get working (the changes between Ruby versions are fairly small) but that it wouldn't just work - and there might be more problems with some of our Ruby dependencies requiring code changes.


Best,

Rob

________________________________
From: Clearwater <clearwater-bounces at lists.projectclearwater.org> on behalf of prakash RAMCHANDRAN <pramchan at yahoo.com>
Sent: 12 September 2017 17:35
To: clearwater at lists.projectclearwater.org
Subject: Re: [Project Clearwater] [Subject] clearwater-live-test using ruby rvm on Ubuntu 16.04 and package install issues

Hi all,
Few answers here, but more questions to ruby experts in celearwater community?

Was able to resolve this errors by editing and adding following lines
vi /etc/apt/sources.list
deb [arch=amd64] http://security.ubuntu.com/ubuntu xenial-security main
deb [arch=amd64] http://mirrors.opencas.org/ubuntu/ xenial main
deb-src [arch=amd64] http://mirrors.opencas.org/ubuntu/ xenial main
:wq!
sudo apt-get update
source /etc/profile.d/rvm.sh
rvm autolibs enable
rvm install 1.9.3
rvm docs generate-ri
There was a warning for updaing to ruby-2.4.1
Please consider upgrading to ruby-2.4.1 which will have all of the latest security patches.

Question ? Has anyone tried ruby rake tests using ruby-2.4.1. Will the gems using rvm 1.9.3 need source re-build or ruby-2.4.1 backward compatible to be able to use existing gems as is?


On Monday, September 11, 2017, 4:34:43 PM PDT, prakash RAMCHANDRAN <pramchan at yahoo.com> wrote:


Although I was able to install ruby  rvm 1.9.2  on gen1 Rackspace Ubuntu Xenial 16.04 server  have issues on some other private PODs.
Due to the resource limitations there could not get vIMS running to run the celae-water-live tsts on the servers.

On the private vPOD, there was  no curl available on Xenial and in trying to overcome did use .deb curl package from ubuntu cloud

So followed this to get .deb curl and installed it
https://packages.ubuntu.com/xenial/amd64/curl/download


Then following happened as you see the dependency failures for  this  part of per-requisite for ruby 1.9.3

https://github.com/Metaswitch/clearwater-live-test/



root at host1:/opt# rvm install 1.9.3
Searching for binary rubies, this might take some time.
No binary rubies available for: ubuntu/16.04/x86_64/ruby-1.9.3-p551.
Continuing with compilation. Please read 'rvm help mount' to get more information on binary rubies.
Checking requirements for ubuntu.
Installing requirements for ubuntu.
Updating system..
Installing required packages: zlib1g-dev, libyaml-dev, libsqlite3-dev, sqlite3, autoconf, libgmp-dev, libgdbm-dev, libncurses5-dev, automake, libtool, bison, pkg-config, libffi-dev, libgmp-dev, libreadline6-dev, libssl-dev......
Error running 'requirements_debian_libs_install zlib1g-dev libyaml-dev libsqlite3-dev sqlite3 autoconf libgmp-dev libgdbm-dev libncurses5-dev automake libtool bison pkg-config libffi-dev libgmp-dev libreadline6-dev libssl-dev',
please read /usr/local/rvm/log/1505170731_ruby-1.9.3-p551/package_install_zlib1g-dev_libyaml-dev_libsqlite3-dev_sqlite3_autoconf_libgmp-dev_libgdbm-dev_libncurses5-dev_automake_libtool_bison_pkg-config_libffi-dev_libgmp-dev_libreadline6-dev_libssl-dev.log
Requirements installation failed with status: 100.


1. Suggesions listed were try rvm help mount:
root at host1:/opt# rvm help mount
Ruby enVironment Manager 1.29.3 (latest) (c) 2009-2017 Michal Papis, Piotr Kuczynski, Wayne E. Seguin
This is not a viable option.

2. please read /usr/local/rvm/log/1505166799_ruby-1.9.3-p551/package_install_zlib1g-dev_libyaml-dev_libsqlite3-dev_sqlite3_autoconf_libgmp-dev_libgdbm-dev_libncurses5-dev_automake_libtool_bison_pkg-config_libffi-dev_libgmp-dev_libreadline6-dev_libssl-dev.log
Requirements installation failed with status: 100.

E: Package 'zlib1g-dev' has no installation candidate
E: Unable to locate package libyaml-dev
E: Unable to locate package libsqlite3-dev
E: Package 'autoconf' has no installation candidate
E: Package 'libgmp-dev' has no installation candidate
E: Unable to locate package libgdbm-dev
E: Unable to locate package libncurses5-dev
E: Package 'automake' has no installation candidate
E: Package 'libtool' has no installation candidate
E: Package 'bison' has no installation candidate
E: Package 'pkg-config' has no installation candidate
E: Package 'libffi-dev' has no installation candidate
E: Package 'libgmp-dev' has no installation candidate
E: Unable to locate package libreadline6-dev


Now did anyone come across this and if so how did you solve it. If not what is your suggestions to overcoe this problem?


Thanks
Prakash

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20170915/cb0f7659/attachment.html>

From jim.page at redmatter.com  Fri Sep 15 15:31:57 2017
From: jim.page at redmatter.com (Jim Page)
Date: Fri, 15 Sep 2017 19:31:57 +0000
Subject: [Project Clearwater] Chef setup for an AIO in a VPC
Message-ID: <852E4268-B118-4411-B22C-52C15BD440A8@redmatter.com>

Hi There

I am setting up a test install of clearwater in an AWS VPC in London (eu-west-2). Initially I would like to set up an All In One installation. Our virtual DC in AWS has a VPC containing a public part and a private part. I am aiming initially to set up in the public part, which allows external input. I have a Route53 domain set up: rmcore.net<http://rmcore.net>. I have a chef server and workstation set up and working in the VPC.

Initially I found no support for eu-west-2. I have been able to resolve that by adding appropriately to boxes.rb and fog/aws.rb. I also managed to figure out the necessary environment config required to add the AIO instance to a VPC. So far so good.

However, the installed instance doesn?t seem to be using much of the chef environment data when configuring the new instance:

- my domain is not being used for the home_domain (it?s still example.com<http://example.com>)
- the amazon public host names are being used instead of the Route53 domain I specified in the chef environment.
- I would prefer to be using private IPs or hostnames rather than public.

Probably I could spend more time on this and figure it all out for myself, but it?s taken me quite a while to get this far and I?d like to know if there is either

a) a resource that covers the use case I want
b) someone on here who might be able to help me with the environment config I need to do what I want.

Here?s my environment file:

ubuntu at chef-client:~$ cat chef/environments/clearwater.rb
name ?clearwater?
description "Clearwater deployment - clearwater?
cookbook_versions "clearwater" => "= 0.1.0?
override_attributes "clearwater" => {
  "root_domain" => ?rmcore.net<http://rmcore.net>?,
  "vpc" => {"vpc_id" => ?vpc-xxxxxxx", "subnet_id" => ?subnet-xxxxxxxx?},
  "region" => "eu-west-2?,
  "availability_zones" => ["eu-west-2b?],
  "repo_servers" => ["http://repo.cw-ngv.com/stable?],
  "number_start" => ?83555000000?,
  "number_count" => 1000,
  "keypair" => ?jimaws?,
  "keypair_dir" => "~/.chef/?,
  "pstn_number_count" => 0,

  # Signup key. Anyone with this key can create accounts
  # on the deployment. Set to a secure value.
  "signup_key" => ?xxxxxxxxx?,

  # TURN workaround password, used by faulty WebRTC clients.
  # Anyone with this password can use the deployment to send
  # arbitrary amounts of data. Set to a secure value.
  "turn_workaround" => ?xxxxxxxxx?,

  # Ellis API key. Used by internal scripts to
  # provision, update and delete user accounts without a password.
  # Set to a secure value.
  "ellis_api_key" => ?xxxxxxx?,

  # Ellis cookie key. Used to prevent spoofing of Ellis cookies. Set
  # to a secure value.
  "ellis_cookie_key" => ?xxxxxxxxx?,

  # SMTP credentials as supplied by your email provider.
  "smtp_server" => ?localhost?,
  "smtp_username" => ??,
  "smtp_password" => ??,

  # Sender to use for password recovery emails. For some
  # SMTP servers (e.g., Amazon SES) this email address
  # must be validated or email sending will fail.
  "email_sender" => "ims at redmatter.com<mailto:ims at redmatter.com>?
}

Here?s the created shared_config:

[cw-aio]ubuntu at ec2-52-56-82-175:~$ cat /etc/clearwater/shared_config
# Deployment definitions
home_domain=example.com<http://example.com>
sprout_hostname=ec2-52-56-82-175.eu-west-2.compute.amazonaws.com<http://ec2-52-56-82-175.eu-west-2.compute.amazonaws.com>
hs_hostname=ec2-52-56-82-175.eu-west-2.compute.amazonaws.com:8888<http://ec2-52-56-82-175.eu-west-2.compute.amazonaws.com:8888>
hs_provisioning_hostname=ec2-52-56-82-175.eu-west-2.compute.amazonaws.com:8889<http://ec2-52-56-82-175.eu-west-2.compute.amazonaws.com:8889>
xdms_hostname=ec2-52-56-82-175.eu-west-2.compute.amazonaws.com:7888<http://ec2-52-56-82-175.eu-west-2.compute.amazonaws.com:7888>
ralf_hostname=
chronos_hostname=
cassandra_hostname=
sprout_registration_store=ec2-52-56-82-175.eu-west-2.compute.amazonaws.com<http://ec2-52-56-82-175.eu-west-2.compute.amazonaws.com>
ralf_session_store=
homestead_impu_store=ec2-52-56-82-175.eu-west-2.compute.amazonaws.com<http://ec2-52-56-82-175.eu-west-2.compute.amazonaws.com>

# Email server configuration
smtp_smarthost=127.0.0.1
smtp_username=username
smtp_password=password
email_recovery_sender=clearwater at example.com<mailto:email_recovery_sender=clearwater at example.com>

# I-CSCF/S-CSCF configuration
upstream_hostname=ec2-52-56-82-175.eu-west-2.compute.amazonaws.com<http://ec2-52-56-82-175.eu-west-2.compute.amazonaws.com>
scscf_uri="sip:scscf.ec2-52-56-82-175.eu-west-2.compute.amazonaws.com:5054;transport=TCP?
icscf_uri="sip:icscf.ec2-52-56-82-175.eu-west-2.compute.amazonaws.com:5052;transport=TCP?
bgcf_uri="sip:bgcf.ec2-52-56-82-175.eu-west-2.compute.amazonaws.com:5053;transport=TCP?

# Keys
signup_key=secret
turn_workaround=secret
ellis_api_key=secret
ellis_cookie_key=secret

reduce_cassandra_mem_usage=Y

Any help or advice gratefully received!

Kind regards
Jim

RedMatter Ltd
Jim Page
VP Mobile Services
+44 (0)333 150 1666
+44 (0)7870 361412
jim.page at redmatter.com<mailto:jim.page at redmatter.com>

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20170915/868d68c0/attachment.html>

From jim.page at redmatter.com  Sat Sep 16 13:13:32 2017
From: jim.page at redmatter.com (Jim Page)
Date: Sat, 16 Sep 2017 17:13:32 +0000
Subject: [Project Clearwater] Chef setup for an AIO in a VPC
In-Reply-To: <852E4268-B118-4411-B22C-52C15BD440A8@redmatter.com>
References: <852E4268-B118-4411-B22C-52C15BD440A8@redmatter.com>
Message-ID: <2D835282-429B-4FFE-BCEF-645A2DA67DB6@redmatter.com>

I have resolved all my issues by doing a full install via chef. Very impressed so far.
Sorry to have wasted anyone?s time.
Cheers
Jim

RedMatter Ltd
Jim Page
VP Mobile Services
+44 (0)333 150 1666
+44 (0)7870 361412
jim.page at redmatter.com<mailto:jim.page at redmatter.com>

On 15 Sep 2017, at 20:32, Jim Page <jim.page at redmatter.com<mailto:jim.page at redmatter.com>> wrote:

Hi There

I am setting up a test install of clearwater in an AWS VPC in London (eu-west-2). Initially I would like to set up an All In One installation. Our virtual DC in AWS has a VPC containing a public part and a private part. I am aiming initially to set up in the public part, which allows external input. I have a Route53 domain set up: rmcore.net<http://rmcore.net/>. I have a chef server and workstation set up and working in the VPC.

Initially I found no support for eu-west-2. I have been able to resolve that by adding appropriately to boxes.rb and fog/aws.rb. I also managed to figure out the necessary environment config required to add the AIO instance to a VPC. So far so good.

However, the installed instance doesn?t seem to be using much of the chef environment data when configuring the new instance:

- my domain is not being used for the home_domain (it?s still example.com<http://example.com/>)
- the amazon public host names are being used instead of the Route53 domain I specified in the chef environment.
- I would prefer to be using private IPs or hostnames rather than public.

Probably I could spend more time on this and figure it all out for myself, but it?s taken me quite a while to get this far and I?d like to know if there is either

a) a resource that covers the use case I want
b) someone on here who might be able to help me with the environment config I need to do what I want.

Here?s my environment file:

ubuntu at chef-client:~$ cat chef/environments/clearwater.rb
name ?clearwater?
description "Clearwater deployment - clearwater?
cookbook_versions "clearwater" => "= 0.1.0?
override_attributes "clearwater" => {
  "root_domain" => ?rmcore.net<http://rmcore.net/>?,
  "vpc" => {"vpc_id" => ?vpc-xxxxxxx", "subnet_id" => ?subnet-xxxxxxxx?},
  "region" => "eu-west-2?,
  "availability_zones" => ["eu-west-2b?],
  "repo_servers" => ["http://repo.cw-ngv.com/stable?],
  "number_start" => ?83555000000?,
  "number_count" => 1000,
  "keypair" => ?jimaws?,
  "keypair_dir" => "~/.chef/?,
  "pstn_number_count" => 0,

  # Signup key. Anyone with this key can create accounts
  # on the deployment. Set to a secure value.
  "signup_key" => ?xxxxxxxxx?,

  # TURN workaround password, used by faulty WebRTC clients.
  # Anyone with this password can use the deployment to send
  # arbitrary amounts of data. Set to a secure value.
  "turn_workaround" => ?xxxxxxxxx?,

  # Ellis API key. Used by internal scripts to
  # provision, update and delete user accounts without a password.
  # Set to a secure value.
  "ellis_api_key" => ?xxxxxxx?,

  # Ellis cookie key. Used to prevent spoofing of Ellis cookies. Set
  # to a secure value.
  "ellis_cookie_key" => ?xxxxxxxxx?,

  # SMTP credentials as supplied by your email provider.
  "smtp_server" => ?localhost?,
  "smtp_username" => ??,
  "smtp_password" => ??,

  # Sender to use for password recovery emails. For some
  # SMTP servers (e.g., Amazon SES) this email address
  # must be validated or email sending will fail.
  "email_sender" => "ims at redmatter.com<mailto:ims at redmatter.com>?
}

Here?s the created shared_config:

[cw-aio]ubuntu at ec2-52-56-82-175:~$ cat /etc/clearwater/shared_config
# Deployment definitions
home_domain=example.com<http://example.com/>
sprout_hostname=ec2-52-56-82-175.eu-west-2.compute.amazonaws.com<http://ec2-52-56-82-175.eu-west-2.compute.amazonaws.com/>
hs_hostname=ec2-52-56-82-175.eu-west-2.compute.amazonaws.com:8888<http://ec2-52-56-82-175.eu-west-2.compute.amazonaws.com:8888/>
hs_provisioning_hostname=ec2-52-56-82-175.eu-west-2.compute.amazonaws.com:8889<http://ec2-52-56-82-175.eu-west-2.compute.amazonaws.com:8889/>
xdms_hostname=ec2-52-56-82-175.eu-west-2.compute.amazonaws.com:7888<http://ec2-52-56-82-175.eu-west-2.compute.amazonaws.com:7888/>
ralf_hostname=
chronos_hostname=
cassandra_hostname=
sprout_registration_store=ec2-52-56-82-175.eu-west-2.compute.amazonaws.com<http://ec2-52-56-82-175.eu-west-2.compute.amazonaws.com/>
ralf_session_store=
homestead_impu_store=ec2-52-56-82-175.eu-west-2.compute.amazonaws.com<http://ec2-52-56-82-175.eu-west-2.compute.amazonaws.com/>

# Email server configuration
smtp_smarthost=127.0.0.1
smtp_username=username
smtp_password=password
email_recovery_sender=clearwater at example.com<mailto:email_recovery_sender=clearwater at example.com>

# I-CSCF/S-CSCF configuration
upstream_hostname=ec2-52-56-82-175.eu-west-2.compute.amazonaws.com<http://ec2-52-56-82-175.eu-west-2.compute.amazonaws.com/>
scscf_uri="sip:scscf.ec2-52-56-82-175.eu-west-2.compute.amazonaws.com:5054;transport=TCP?
icscf_uri="sip:icscf.ec2-52-56-82-175.eu-west-2.compute.amazonaws.com:5052;transport=TCP?
bgcf_uri="sip:bgcf.ec2-52-56-82-175.eu-west-2.compute.amazonaws.com:5053;transport=TCP?

# Keys
signup_key=secret
turn_workaround=secret
ellis_api_key=secret
ellis_cookie_key=secret

reduce_cassandra_mem_usage=Y

Any help or advice gratefully received!

Kind regards
Jim

RedMatter Ltd
Jim Page
VP Mobile Services
+44 (0)333 150 1666
+44 (0)7870 361412
jim.page at redmatter.com<mailto:jim.page at redmatter.com>


-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20170916/3aa18c91/attachment.html>

From jim.page at redmatter.com  Sun Sep 17 13:38:38 2017
From: jim.page at redmatter.com (Jim Page)
Date: Sun, 17 Sep 2017 17:38:38 +0000
Subject: [Project Clearwater] Looping authentication with Bria
Message-ID: <A08CF3C9-DCAB-46F3-A7AE-3E597E865129@redmatter.com>

Hi There

I initially set up my IMS in an AWS VPC, using chef. It worked out of the box without an HSS, I was able to use Ellis to provision accounts and they registered no problem using Bria 4. I decided to add an HSS (using ?knife box? to add an openimscore HSS instance) so that I can test our application servers. Now that I have the HSS integrated (there were niggles in the installation), I provisioned a new user on the HSS but the Bria phone will not authenticate, and a feedback loop is generated on the first REGISTER attempt. The problem seems to be related to nonce counting. The process seems to go like this:

UE REGISTER -> Bono
Bono REGISTER -> icscf
  No Authorization. Challenge is built, and IMPI is created with nc=1, and stored
icscf 401 -> Bono
Bono 401 -> UE
  UE builds an Authorisation header
UE REGISTER -> Bono
Bono REGISTER -> icscf
  The Authorisation header contains nc=000001.
  IMPI is loaded and validation is successful.
  IMPI is stored with nc=2, log line 'Debug authenticationsproutlet.cpp:1033: Storing challenge because nonce counts are supported?
icscf REGISTER -> scscf-proxy
  The Authorisation header still contains nc=000001.
  IMPI is loaded, but log line says: 'Info authenticationsproutlet.cpp:971: Nonce count supplied (1) is lower than expected (2) - ignore it?
  The Authorisation header is ignored and another 401 challenge is issued, and the UE responds ?. and this causes a loop
scscf-proxy 401 -> icscf
icscf 401 -> Bono
Bono 401 -> UE

There seems to be a fundamental flaw here. The IMPI nc is incrementing, but the Authorisation header is not. I can?t see how this can work unless icscf increments nc in the authorisation header before sending it to the scscf

Also please note: I disabled nonce_count_supported in shared_config, but the result was a log line ?nonce count is supplied but not supported? (or words to that effect) and the Authorisation header is again ignored, and there is a loop.

How to move forward from here? I have searched in vain for a way to disable nonce count in Bria 4.

I can provide logs if helpful, but they are long and I don?t want to clog everyone?s inbox.

Kind regards
Jim

RedMatter Ltd
Jim Page
VP Mobile Services
+44 (0)333 150 1666
+44 (0)7870 361412
jim.page at redmatter.com<mailto:jim.page at redmatter.com>

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20170917/eb5b5de1/attachment.html>

From afriyie.abraham at gmail.com  Tue Sep 19 16:16:48 2017
From: afriyie.abraham at gmail.com (Afriyie Abraham Kwabena)
Date: Tue, 19 Sep 2017 23:16:48 +0300
Subject: [Project Clearwater] Clearwater source code
Message-ID: <377652B8-006A-4A1B-81DA-562EE8DFA987@gmail.com>

Hi,

I would like to install clearwater using the source code, please how would
i have access to it and the installation process.
I have install and tested using the various procedures from the clearwater 
documentation but i would like to add a QoS (Quality of Services) configuration.

I have an EPC and would like to connect clearwater to it such that i would be 
able to make a SIP call with a certain QoS parameters. 

UE ???????EPC???????IMS(clearwater)

BR
Abraham




From afriyie.abraham at hotmail.com  Thu Sep 21 06:59:27 2017
From: afriyie.abraham at hotmail.com (Afriyie Abraham)
Date: Thu, 21 Sep 2017 10:59:27 +0000
Subject: [Project Clearwater] clearwater Installation using source code --
 Help
Message-ID: <HE1PR05MB137061BF76FBAC3347167854FC660@HE1PR05MB1370.eurprd05.prod.outlook.com>

Hi,

I have tried installing clearwater using the source code following the procedure
in the documentation but not working.

My main aim is to be able to have a device to device call session through my EPC
connecting the IMS(clearwater).
Also i would like to add some QoS parameters to for every call session.
plan:

UE ??????EPC ??????IMS

Please can anyone help me with a working source code procedure to install clearwater
on ubuntu 14.04.

Thanks in advance.

BR
Abraham 
 

From jim.page at redmatter.com  Thu Sep 21 08:17:49 2017
From: jim.page at redmatter.com (Jim Page)
Date: Thu, 21 Sep 2017 12:17:49 +0000
Subject: [Project Clearwater] clearwater Installation using source code
 -- Help
In-Reply-To: <HE1PR05MB137061BF76FBAC3347167854FC660@HE1PR05MB1370.eurprd05.prod.outlook.com>
References: <HE1PR05MB137061BF76FBAC3347167854FC660@HE1PR05MB1370.eurprd05.prod.outlook.com>
Message-ID: <50C2CE0B-EBCA-4EB1-B493-F66DF7EEC5E8@redmatter.com>

My recommendation (as a newbie) is to build a working release version of clearwater first, using these installation instructions: http://clearwater.readthedocs.io/en/stable/Installation_Instructions.html

Once you have a basic working install, decide what component you want to rebuild, and build it on the host for that component. In my case I did this with sprout:

1. go to https://github.com/Metaswitch/sprout
2. Fork the repo: generic instructions here https://gist.github.com/Chaser324/ce0505fbed06b947d962
3. Carefully read README.md
4. go here for build instructions https://github.com/Metaswitch/sprout/blob/dev/docs/Development.md
5. Fork the repo and clone the forked repo on your local sprout host. Create a feature branch if you intend to push your changes back to clearwater.
6. Modify the sprout source as you see fit, and build sprout following the instructions in Development.md
7. When the build is complete, replace /usr/share/clearwater/bin/sprout and /sur/share/clearwater/sprout/plugins/*.so with links to your development builds in <your build dir>/sprout/build/bin.
8. ?sudo system sprout restart? - now you are running a fully working clearwater setup with your own sprout build (assuming you have not broken sprout with your changes!).

Hope this helps
Cheers
Jim

RedMatter Ltd
Jim Page
VP Mobile Services
+44 (0)333 150 1666
+44 (0)7870 361412
jim.page at redmatter.com<mailto:jim.page at redmatter.com>

On 21 Sep 2017, at 11:59, Afriyie Abraham <afriyie.abraham at hotmail.com<mailto:afriyie.abraham at hotmail.com>> wrote:

Hi,

I have tried installing clearwater using the source code following the procedure
in the documentation but not working.

My main aim is to be able to have a device to device call session through my EPC
connecting the IMS(clearwater).
Also i would like to add some QoS parameters to for every call session.
plan:

UE ??????EPC ??????IMS

Please can anyone help me with a working source code procedure to install clearwater
on ubuntu 14.04.

Thanks in advance.

BR
Abraham

_______________________________________________
Clearwater mailing list
Clearwater at lists.projectclearwater.org<mailto:Clearwater at lists.projectclearwater.org>
http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20170921/a1f4e03a/attachment.html>

From afriyie.abraham at gmail.com  Thu Sep 21 08:47:13 2017
From: afriyie.abraham at gmail.com (Afriyie Abraham Kwabena)
Date: Thu, 21 Sep 2017 15:47:13 +0300
Subject: [Project Clearwater] clearwater Installation using source code
 -- Help
In-Reply-To: <50C2CE0B-EBCA-4EB1-B493-F66DF7EEC5E8@redmatter.com>
References: <HE1PR05MB137061BF76FBAC3347167854FC660@HE1PR05MB1370.eurprd05.prod.outlook.com>
	<50C2CE0B-EBCA-4EB1-B493-F66DF7EEC5E8@redmatter.com>
Message-ID: <D8F81832-9566-464A-9D8B-8BD2F99B83FD@gmail.com>

Hi,

My task is to install all the components of Clearwater on the same machine (ubuntu 14.04). In your explanation it means I need to have different hosts for each component but that is not my plan. 
Is it possible to install all components without using docker or any virtualization platform. 
Also for QoS, which component do you suggest I should modify. 

Sorry I may be asking basics, am newbie. 

BR
Abraham



Sent from my iPhone

> On 21 Sep 2017, at 15.17, Jim Page <jim.page at redmatter.com> wrote:
> 
> My recommendation (as a newbie) is to build a working release version of clearwater first, using these installation instructions: http://clearwater.readthedocs.io/en/stable/Installation_Instructions.html
> 
> Once you have a basic working install, decide what component you want to rebuild, and build it on the host for that component. In my case I did this with sprout:
> 
> 1. go to https://github.com/Metaswitch/sprout
> 2. Fork the repo: generic instructions here https://gist.github.com/Chaser324/ce0505fbed06b947d962
> 3. Carefully read README.md
> 4. go here for build instructions https://github.com/Metaswitch/sprout/blob/dev/docs/Development.md
> 5. Fork the repo and clone the forked repo on your local sprout host. Create a feature branch if you intend to push your changes back to clearwater.
> 6. Modify the sprout source as you see fit, and build sprout following the instructions in Development.md
> 7. When the build is complete, replace /usr/share/clearwater/bin/sprout and /sur/share/clearwater/sprout/plugins/*.so with links to your development builds in <your build dir>/sprout/build/bin.
> 8. ?sudo system sprout restart? - now you are running a fully working clearwater setup with your own sprout build (assuming you have not broken sprout with your changes!).
> 
> Hope this helps
> Cheers
> Jim 
> 
> RedMatter Ltd
> Jim Page
> VP Mobile Services
> +44 (0)333 150 1666
> +44 (0)7870 361412
> jim.page at redmatter.com
> 
>> On 21 Sep 2017, at 11:59, Afriyie Abraham <afriyie.abraham at hotmail.com> wrote:
>> 
>> Hi,
>> 
>> I have tried installing clearwater using the source code following the procedure
>> in the documentation but not working.
>> 
>> My main aim is to be able to have a device to device call session through my EPC
>> connecting the IMS(clearwater).
>> Also i would like to add some QoS parameters to for every call session.
>> plan:
>> 
>> UE ??????EPC ??????IMS
>> 
>> Please can anyone help me with a working source code procedure to install clearwater
>> on ubuntu 14.04.
>> 
>> Thanks in advance.
>> 
>> BR
>> Abraham 
>> 
>> _______________________________________________
>> Clearwater mailing list
>> Clearwater at lists.projectclearwater.org
>> http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org
> 
> _______________________________________________
> Clearwater mailing list
> Clearwater at lists.projectclearwater.org
> http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20170921/172e6650/attachment.html>

From jim.page at redmatter.com  Thu Sep 21 09:00:21 2017
From: jim.page at redmatter.com (Jim Page)
Date: Thu, 21 Sep 2017 13:00:21 +0000
Subject: [Project Clearwater] clearwater Installation using source code
 -- Help
In-Reply-To: <D8F81832-9566-464A-9D8B-8BD2F99B83FD@gmail.com>
References: <HE1PR05MB137061BF76FBAC3347167854FC660@HE1PR05MB1370.eurprd05.prod.outlook.com>
	<50C2CE0B-EBCA-4EB1-B493-F66DF7EEC5E8@redmatter.com>
	<D8F81832-9566-464A-9D8B-8BD2F99B83FD@gmail.com>
Message-ID: <14312422-BE83-49E5-BADF-D1490E65B5D8@redmatter.com>

If you have to run it on a single machine built from source, I guess your best option is to start here http://clearwater.readthedocs.io/en/stable/Manual_Install.html and just use a single host instead of 6. I guess it must be possible to some degree otherwise it wouldn?t be possible to create an all-in-one image. But you are making life hard for yourself by not going down the VM route. I would do the same thing however - install clearwater using production packages using apt-get, then once you have it working, selectively rebuild the component you want to change.

I am not sure what you want to achieve by adding QOS to clearwater. I don?t see what relevance QOS has where the only service you have running is VOIP. QOS is only useful if you want to prioritise one type of traffic over another, and is only relevant where you have different types of traffic trying to get access to a limited resource such as an MPLS line or a broadband line, in which case you set the QOS up in the router that sends traffic down that line. What is it exactly that you are trying to do?

RedMatter Ltd
Jim Page
VP Mobile Services
+44 (0)333 150 1666
+44 (0)7870 361412
jim.page at redmatter.com<mailto:jim.page at redmatter.com>

On 21 Sep 2017, at 13:47, Afriyie Abraham Kwabena <afriyie.abraham at gmail.com<mailto:afriyie.abraham at gmail.com>> wrote:

Hi,

My task is to install all the components of Clearwater on the same machine (ubuntu 14.04). In your explanation it means I need to have different hosts for each component but that is not my plan.
Is it possible to install all components without using docker or any virtualization platform.
Also for QoS, which component do you suggest I should modify.

Sorry I may be asking basics, am newbie.

BR
Abraham



Sent from my iPhone

On 21 Sep 2017, at 15.17, Jim Page <jim.page at redmatter.com<mailto:jim.page at redmatter.com>> wrote:

My recommendation (as a newbie) is to build a working release version of clearwater first, using these installation instructions: http://clearwater.readthedocs.io/en/stable/Installation_Instructions.html

Once you have a basic working install, decide what component you want to rebuild, and build it on the host for that component. In my case I did this with sprout:

1. go to https://github.com/Metaswitch/sprout
2. Fork the repo: generic instructions here https://gist.github.com/Chaser324/ce0505fbed06b947d962
3. Carefully read README.md
4. go here for build instructions https://github.com/Metaswitch/sprout/blob/dev/docs/Development.md
5. Fork the repo and clone the forked repo on your local sprout host. Create a feature branch if you intend to push your changes back to clearwater.
6. Modify the sprout source as you see fit, and build sprout following the instructions in Development.md
7. When the build is complete, replace /usr/share/clearwater/bin/sprout and /sur/share/clearwater/sprout/plugins/*.so with links to your development builds in <your build dir>/sprout/build/bin.
8. ?sudo system sprout restart? - now you are running a fully working clearwater setup with your own sprout build (assuming you have not broken sprout with your changes!).

Hope this helps
Cheers
Jim

RedMatter Ltd
Jim Page
VP Mobile Services
+44 (0)333 150 1666
+44 (0)7870 361412
jim.page at redmatter.com<mailto:jim.page at redmatter.com>

On 21 Sep 2017, at 11:59, Afriyie Abraham <afriyie.abraham at hotmail.com<mailto:afriyie.abraham at hotmail.com>> wrote:

Hi,

I have tried installing clearwater using the source code following the procedure
in the documentation but not working.

My main aim is to be able to have a device to device call session through my EPC
connecting the IMS(clearwater).
Also i would like to add some QoS parameters to for every call session.
plan:

UE ??????EPC ??????IMS

Please can anyone help me with a working source code procedure to install clearwater
on ubuntu 14.04.

Thanks in advance.

BR
Abraham

_______________________________________________
Clearwater mailing list
Clearwater at lists.projectclearwater.org<mailto:Clearwater at lists.projectclearwater.org>
http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org

_______________________________________________
Clearwater mailing list
Clearwater at lists.projectclearwater.org<mailto:Clearwater at lists.projectclearwater.org>
http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org
_______________________________________________
Clearwater mailing list
Clearwater at lists.projectclearwater.org<mailto:Clearwater at lists.projectclearwater.org>
http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20170921/dfb81425/attachment.html>

From afriyie.abraham at gmail.com  Thu Sep 21 09:32:57 2017
From: afriyie.abraham at gmail.com (Afriyie Abraham Kwabena)
Date: Thu, 21 Sep 2017 16:32:57 +0300
Subject: [Project Clearwater] clearwater Installation using source code
 -- Help
In-Reply-To: <14312422-BE83-49E5-BADF-D1490E65B5D8@redmatter.com>
References: <HE1PR05MB137061BF76FBAC3347167854FC660@HE1PR05MB1370.eurprd05.prod.outlook.com>
	<50C2CE0B-EBCA-4EB1-B493-F66DF7EEC5E8@redmatter.com>
	<D8F81832-9566-464A-9D8B-8BD2F99B83FD@gmail.com>
	<14312422-BE83-49E5-BADF-D1490E65B5D8@redmatter.com>
Message-ID: <588DC1BC-44CC-443A-A8BC-2735CDCE88F5@gmail.com>

As part of my school special assignment, i have install an EPC and need to connect it to an IMS
such that a dedicated bearer is created with a specific QoS for clearwater traffic or a call session.
This is my task. However as you suggested, it would have been better to go the VM way but am not
required to do that, am ask to install using the source code and also have to install the components 
on a single machine which is very hard.

BTW,
I have tried to build Sprout and bono, link: https://github.com/Metaswitch/sprout/blob/dev/docs/Development.md
but running the following command hang on my terminal, how to 

./MIBS="" LD_LIBRARY_PATH=usr/lib:$LD_LIBRARY_PATH build/bin/sprout -t --domain=<Home Domain> --hss=<Homestead cluster>
Also what would be the parameter for the  - - hss=<Homestead cluster> ?  Do i need to have a DNS installed to handle the domain name
for all the components?

BR
Abraham


On 21 Sep 2017, at 16:00, Jim Page <jim.page at redmatter.com> wrote:
> 
> If you have to run it on a single machine built from source, I guess your best option is to start here http://clearwater.readthedocs.io/en/stable/Manual_Install.html <http://clearwater.readthedocs.io/en/stable/Manual_Install.html> and just use a single host instead of 6. I guess it must be possible to some degree otherwise it wouldn?t be possible to create an all-in-one image. But you are making life hard for yourself by not going down the VM route. I would do the same thing however - install clearwater using production packages using apt-get, then once you have it working, selectively rebuild the component you want to change.
> 
> I am not sure what you want to achieve by adding QOS to clearwater. I don?t see what relevance QOS has where the only service you have running is VOIP. QOS is only useful if you want to prioritise one type of traffic over another, and is only relevant where you have different types of traffic trying to get access to a limited resource such as an MPLS line or a broadband line, in which case you set the QOS up in the router that sends traffic down that line. What is it exactly that you are trying to do?
> 
> RedMatter Ltd
> Jim Page
> VP Mobile Services
> +44 (0)333 150 1666
> +44 (0)7870 361412
> jim.page at redmatter.com <mailto:jim.page at redmatter.com>
>> On 21 Sep 2017, at 13:47, Afriyie Abraham Kwabena <afriyie.abraham at gmail.com <mailto:afriyie.abraham at gmail.com>> wrote:
>> 
>> Hi,
>> 
>> My task is to install all the components of Clearwater on the same machine (ubuntu 14.04). In your explanation it means I need to have different hosts for each component but that is not my plan. 
>> Is it possible to install all components without using docker or any virtualization platform. 
>> Also for QoS, which component do you suggest I should modify. 
>> 
>> Sorry I may be asking basics, am newbie. 
>> 
>> BR
>> Abraham
>> 
>> 
>> 
>> Sent from my iPhone
>> 
>> On 21 Sep 2017, at 15.17, Jim Page <jim.page at redmatter.com <mailto:jim.page at redmatter.com>> wrote:
>> 
>>> My recommendation (as a newbie) is to build a working release version of clearwater first, using these installation instructions: http://clearwater.readthedocs.io/en/stable/Installation_Instructions.html <http://clearwater.readthedocs.io/en/stable/Installation_Instructions.html>
>>> 
>>> Once you have a basic working install, decide what component you want to rebuild, and build it on the host for that component. In my case I did this with sprout:
>>> 
>>> 1. go to https://github.com/Metaswitch/sprout <https://github.com/Metaswitch/sprout>
>>> 2. Fork the repo: generic instructions here https://gist.github.com/Chaser324/ce0505fbed06b947d962 <https://gist.github.com/Chaser324/ce0505fbed06b947d962>
>>> 3. Carefully read README.md
>>> 4. go here for build instructions https://github.com/Metaswitch/sprout/blob/dev/docs/Development.md <https://github.com/Metaswitch/sprout/blob/dev/docs/Development.md>
>>> 5. Fork the repo and clone the forked repo on your local sprout host. Create a feature branch if you intend to push your changes back to clearwater.
>>> 6. Modify the sprout source as you see fit, and build sprout following the instructions in Development.md
>>> 7. When the build is complete, replace /usr/share/clearwater/bin/sprout and /sur/share/clearwater/sprout/plugins/*.so with links to your development builds in <your build dir>/sprout/build/bin.
>>> 8. ?sudo system sprout restart? - now you are running a fully working clearwater setup with your own sprout build (assuming you have not broken sprout with your changes!).
>>> 
>>> Hope this helps
>>> Cheers
>>> Jim 
>>> 
>>> RedMatter Ltd
>>> Jim Page
>>> VP Mobile Services
>>> +44 (0)333 150 1666
>>> +44 (0)7870 361412
>>> jim.page at redmatter.com <mailto:jim.page at redmatter.com>
>>>> On 21 Sep 2017, at 11:59, Afriyie Abraham <afriyie.abraham at hotmail.com <mailto:afriyie.abraham at hotmail.com>> wrote:
>>>> 
>>>> Hi,
>>>> 
>>>> I have tried installing clearwater using the source code following the procedure
>>>> in the documentation but not working.
>>>> 
>>>> My main aim is to be able to have a device to device call session through my EPC
>>>> connecting the IMS(clearwater).
>>>> Also i would like to add some QoS parameters to for every call session.
>>>> plan:
>>>> 
>>>> UE ??????EPC ??????IMS
>>>> 
>>>> Please can anyone help me with a working source code procedure to install clearwater
>>>> on ubuntu 14.04.
>>>> 
>>>> Thanks in advance.
>>>> 
>>>> BR
>>>> Abraham 
>>>> 
>>>> _______________________________________________
>>>> Clearwater mailing list
>>>> Clearwater at lists.projectclearwater.org <mailto:Clearwater at lists.projectclearwater.org>
>>>> http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org <http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org>
>>> 
>>> _______________________________________________
>>> Clearwater mailing list
>>> Clearwater at lists.projectclearwater.org <mailto:Clearwater at lists.projectclearwater.org>
>>> http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org <http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org>
>> _______________________________________________
>> Clearwater mailing list
>> Clearwater at lists.projectclearwater.org <mailto:Clearwater at lists.projectclearwater.org>
>> http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org
> 
> _______________________________________________
> Clearwater mailing list
> Clearwater at lists.projectclearwater.org
> http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20170921/d71a11eb/attachment.html>

From jim.page at redmatter.com  Thu Sep 21 09:50:46 2017
From: jim.page at redmatter.com (Jim Page)
Date: Thu, 21 Sep 2017 13:50:46 +0000
Subject: [Project Clearwater] clearwater Installation using source code
 -- Help
In-Reply-To: <588DC1BC-44CC-443A-A8BC-2735CDCE88F5@gmail.com>
References: <HE1PR05MB137061BF76FBAC3347167854FC660@HE1PR05MB1370.eurprd05.prod.outlook.com>
	<50C2CE0B-EBCA-4EB1-B493-F66DF7EEC5E8@redmatter.com>
	<D8F81832-9566-464A-9D8B-8BD2F99B83FD@gmail.com>
	<14312422-BE83-49E5-BADF-D1490E65B5D8@redmatter.com>
	<588DC1BC-44CC-443A-A8BC-2735CDCE88F5@gmail.com>
Message-ID: <D66B6ECD-C978-40B7-AE1E-E51C85D677A8@redmatter.com>

Yes you have to have some DNS set up. Details are in the documentation. You need to have more than just A records to get this working properly ? so yes really you need to have DNS set up.

I have no idea what the parameters are though at a guess I would say that your home domain is everything to the right of the @ in your sip URIs, and the homestead cluster is the host name or IP address of the machine running homestead (dime, in my case). But that?s why I suggested actually running the binaries slightly differently; once you have installed the working system you can just create links from where the init scripts expect the production binaries to be to point to your built binaries.

It?s quite an assignment. If I were you I would consider using openimscore instead of clearwater. It looks easier to build from source and I can see QOS is something that has been discussed on their forums. You might also want to look at this: http://ieeexplore.ieee.org/document/5532766/?reload=true

The EPC I can?t help you with.

Good luck!


RedMatter Ltd
Jim Page
VP Mobile Services
+44 (0)333 150 1666
+44 (0)7870 361412
jim.page at redmatter.com<mailto:jim.page at redmatter.com>

On 21 Sep 2017, at 14:32, Afriyie Abraham Kwabena <afriyie.abraham at gmail.com<mailto:afriyie.abraham at gmail.com>> wrote:

As part of my school special assignment, i have install an EPC and need to connect it to an IMS
such that a dedicated bearer is created with a specific QoS for clearwater traffic or a call session.
This is my task. However as you suggested, it would have been better to go the VM way but am not
required to do that, am ask to install using the source code and also have to install the components
on a single machine which is very hard.

BTW,
I have tried to build Sprout and bono, link: https://github.com/Metaswitch/sprout/blob/dev/docs/Development.md
but running the following command hang on my terminal, how to


./MIBS="" LD_LIBRARY_PATH=usr/lib:$LD_LIBRARY_PATH build/bin/sprout -t --domain=<Home Domain> --hss=<Homestead cluster>

Also what would be the parameter for the  - - hss=<Homestead cluster> ?  Do i need to have a DNS installed to handle the domain name
for all the components?

BR
Abraham


On 21 Sep 2017, at 16:00, Jim Page <jim.page at redmatter.com<mailto:jim.page at redmatter.com>> wrote:

If you have to run it on a single machine built from source, I guess your best option is to start here http://clearwater.readthedocs.io/en/stable/Manual_Install.html and just use a single host instead of 6. I guess it must be possible to some degree otherwise it wouldn?t be possible to create an all-in-one image. But you are making life hard for yourself by not going down the VM route. I would do the same thing however - install clearwater using production packages using apt-get, then once you have it working, selectively rebuild the component you want to change.

I am not sure what you want to achieve by adding QOS to clearwater. I don?t see what relevance QOS has where the only service you have running is VOIP. QOS is only useful if you want to prioritise one type of traffic over another, and is only relevant where you have different types of traffic trying to get access to a limited resource such as an MPLS line or a broadband line, in which case you set the QOS up in the router that sends traffic down that line. What is it exactly that you are trying to do?

RedMatter Ltd
Jim Page
VP Mobile Services
+44 (0)333 150 1666
+44 (0)7870 361412
jim.page at redmatter.com<mailto:jim.page at redmatter.com>

On 21 Sep 2017, at 13:47, Afriyie Abraham Kwabena <afriyie.abraham at gmail.com<mailto:afriyie.abraham at gmail.com>> wrote:

Hi,

My task is to install all the components of Clearwater on the same machine (ubuntu 14.04). In your explanation it means I need to have different hosts for each component but that is not my plan.
Is it possible to install all components without using docker or any virtualization platform.
Also for QoS, which component do you suggest I should modify.

Sorry I may be asking basics, am newbie.

BR
Abraham



Sent from my iPhone

On 21 Sep 2017, at 15.17, Jim Page <jim.page at redmatter.com<mailto:jim.page at redmatter.com>> wrote:

My recommendation (as a newbie) is to build a working release version of clearwater first, using these installation instructions: http://clearwater.readthedocs.io/en/stable/Installation_Instructions.html

Once you have a basic working install, decide what component you want to rebuild, and build it on the host for that component. In my case I did this with sprout:

1. go to https://github.com/Metaswitch/sprout
2. Fork the repo: generic instructions here https://gist.github.com/Chaser324/ce0505fbed06b947d962
3. Carefully read README.md
4. go here for build instructions https://github.com/Metaswitch/sprout/blob/dev/docs/Development.md
5. Fork the repo and clone the forked repo on your local sprout host. Create a feature branch if you intend to push your changes back to clearwater.
6. Modify the sprout source as you see fit, and build sprout following the instructions in Development.md
7. When the build is complete, replace /usr/share/clearwater/bin/sprout and /sur/share/clearwater/sprout/plugins/*.so with links to your development builds in <your build dir>/sprout/build/bin.
8. ?sudo system sprout restart? - now you are running a fully working clearwater setup with your own sprout build (assuming you have not broken sprout with your changes!).

Hope this helps
Cheers
Jim

RedMatter Ltd
Jim Page
VP Mobile Services
+44 (0)333 150 1666
+44 (0)7870 361412
jim.page at redmatter.com<mailto:jim.page at redmatter.com>

On 21 Sep 2017, at 11:59, Afriyie Abraham <afriyie.abraham at hotmail.com<mailto:afriyie.abraham at hotmail.com>> wrote:

Hi,

I have tried installing clearwater using the source code following the procedure
in the documentation but not working.

My main aim is to be able to have a device to device call session through my EPC
connecting the IMS(clearwater).
Also i would like to add some QoS parameters to for every call session.
plan:

UE ??????EPC ??????IMS

Please can anyone help me with a working source code procedure to install clearwater
on ubuntu 14.04.

Thanks in advance.

BR
Abraham

_______________________________________________
Clearwater mailing list
Clearwater at lists.projectclearwater.org<mailto:Clearwater at lists.projectclearwater.org>
http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org

_______________________________________________
Clearwater mailing list
Clearwater at lists.projectclearwater.org<mailto:Clearwater at lists.projectclearwater.org>
http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org
_______________________________________________
Clearwater mailing list
Clearwater at lists.projectclearwater.org<mailto:Clearwater at lists.projectclearwater.org>
http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org

_______________________________________________
Clearwater mailing list
Clearwater at lists.projectclearwater.org<mailto:Clearwater at lists.projectclearwater.org>
http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org

_______________________________________________
Clearwater mailing list
Clearwater at lists.projectclearwater.org<mailto:Clearwater at lists.projectclearwater.org>
http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20170921/46acd7f6/attachment.html>

From afriyie.abraham at gmail.com  Thu Sep 21 10:20:01 2017
From: afriyie.abraham at gmail.com (Afriyie Abraham Kwabena)
Date: Thu, 21 Sep 2017 17:20:01 +0300
Subject: [Project Clearwater] clearwater Installation using source code
 -- Help
In-Reply-To: <D66B6ECD-C978-40B7-AE1E-E51C85D677A8@redmatter.com>
References: <HE1PR05MB137061BF76FBAC3347167854FC660@HE1PR05MB1370.eurprd05.prod.outlook.com>
	<50C2CE0B-EBCA-4EB1-B493-F66DF7EEC5E8@redmatter.com>
	<D8F81832-9566-464A-9D8B-8BD2F99B83FD@gmail.com>
	<14312422-BE83-49E5-BADF-D1490E65B5D8@redmatter.com>
	<588DC1BC-44CC-443A-A8BC-2735CDCE88F5@gmail.com>
	<D66B6ECD-C978-40B7-AE1E-E51C85D677A8@redmatter.com>
Message-ID: <E043E8C5-672B-46D4-AFEC-5AD2D1C67A77@gmail.com>


Thanks very much for your time.
Very grateful!

BR
Abraham

Sent from my iPhone

> On 21 Sep 2017, at 16.50, Jim Page <jim.page at redmatter.com> wrote:
> 
> Yes you have to have some DNS set up. Details are in the documentation. You need to have more than just A records to get this working properly ? so yes really you need to have DNS set up.
> 
> I have no idea what the parameters are though at a guess I would say that your home domain is everything to the right of the @ in your sip URIs, and the homestead cluster is the host name or IP address of the machine running homestead (dime, in my case). But that?s why I suggested actually running the binaries slightly differently; once you have installed the working system you can just create links from where the init scripts expect the production binaries to be to point to your built binaries.
> 
> It?s quite an assignment. If I were you I would consider using openimscore instead of clearwater. It looks easier to build from source and I can see QOS is something that has been discussed on their forums. You might also want to look at this: http://ieeexplore.ieee.org/document/5532766/?reload=true
> 
> The EPC I can?t help you with.
> 
> Good luck!
> 
> 
> RedMatter Ltd
> Jim Page
> VP Mobile Services
> +44 (0)333 150 1666
> +44 (0)7870 361412
> jim.page at redmatter.com
> 
>> On 21 Sep 2017, at 14:32, Afriyie Abraham Kwabena <afriyie.abraham at gmail.com> wrote:
>> 
>> As part of my school special assignment, i have install an EPC and need to connect it to an IMS
>> such that a dedicated bearer is created with a specific QoS for clearwater traffic or a call session.
>> This is my task. However as you suggested, it would have been better to go the VM way but am not
>> required to do that, am ask to install using the source code and also have to install the components 
>> on a single machine which is very hard.
>> 
>> BTW,
>> I have tried to build Sprout and bono, link: https://github.com/Metaswitch/sprout/blob/dev/docs/Development.md
>> but running the following command hang on my terminal, how to 
>> 
>> ./MIBS="" LD_LIBRARY_PATH=usr/lib:$LD_LIBRARY_PATH build/bin/sprout -t --domain=<Home Domain> --hss=<Homestead cluster>
>> Also what would be the parameter for the  - - hss=<Homestead cluster> ?  Do i need to have a DNS installed to handle the domain name
>> for all the components?
>> 
>> BR
>> Abraham
>> 
>> 
>>> On 21 Sep 2017, at 16:00, Jim Page <jim.page at redmatter.com> wrote:
>>> 
>>> If you have to run it on a single machine built from source, I guess your best option is to start here http://clearwater.readthedocs.io/en/stable/Manual_Install.html and just use a single host instead of 6. I guess it must be possible to some degree otherwise it wouldn?t be possible to create an all-in-one image. But you are making life hard for yourself by not going down the VM route. I would do the same thing however - install clearwater using production packages using apt-get, then once you have it working, selectively rebuild the component you want to change.
>>> 
>>> I am not sure what you want to achieve by adding QOS to clearwater. I don?t see what relevance QOS has where the only service you have running is VOIP. QOS is only useful if you want to prioritise one type of traffic over another, and is only relevant where you have different types of traffic trying to get access to a limited resource such as an MPLS line or a broadband line, in which case you set the QOS up in the router that sends traffic down that line. What is it exactly that you are trying to do?
>>> 
>>> RedMatter Ltd
>>> Jim Page
>>> VP Mobile Services
>>> +44 (0)333 150 1666
>>> +44 (0)7870 361412
>>> jim.page at redmatter.com
>>> 
>>>> On 21 Sep 2017, at 13:47, Afriyie Abraham Kwabena <afriyie.abraham at gmail.com> wrote:
>>>> 
>>>> Hi,
>>>> 
>>>> My task is to install all the components of Clearwater on the same machine (ubuntu 14.04). In your explanation it means I need to have different hosts for each component but that is not my plan. 
>>>> Is it possible to install all components without using docker or any virtualization platform. 
>>>> Also for QoS, which component do you suggest I should modify. 
>>>> 
>>>> Sorry I may be asking basics, am newbie. 
>>>> 
>>>> BR
>>>> Abraham
>>>> 
>>>> 
>>>> 
>>>> Sent from my iPhone
>>>> 
>>>> On 21 Sep 2017, at 15.17, Jim Page <jim.page at redmatter.com> wrote:
>>>> 
>>>>> My recommendation (as a newbie) is to build a working release version of clearwater first, using these installation instructions: http://clearwater.readthedocs.io/en/stable/Installation_Instructions.html
>>>>> 
>>>>> Once you have a basic working install, decide what component you want to rebuild, and build it on the host for that component. In my case I did this with sprout:
>>>>> 
>>>>> 1. go to https://github.com/Metaswitch/sprout
>>>>> 2. Fork the repo: generic instructions here https://gist.github.com/Chaser324/ce0505fbed06b947d962
>>>>> 3. Carefully read README.md
>>>>> 4. go here for build instructions https://github.com/Metaswitch/sprout/blob/dev/docs/Development.md
>>>>> 5. Fork the repo and clone the forked repo on your local sprout host. Create a feature branch if you intend to push your changes back to clearwater.
>>>>> 6. Modify the sprout source as you see fit, and build sprout following the instructions in Development.md
>>>>> 7. When the build is complete, replace /usr/share/clearwater/bin/sprout and /sur/share/clearwater/sprout/plugins/*.so with links to your development builds in <your build dir>/sprout/build/bin.
>>>>> 8. ?sudo system sprout restart? - now you are running a fully working clearwater setup with your own sprout build (assuming you have not broken sprout with your changes!).
>>>>> 
>>>>> Hope this helps
>>>>> Cheers
>>>>> Jim 
>>>>> 
>>>>> RedMatter Ltd
>>>>> Jim Page
>>>>> VP Mobile Services
>>>>> +44 (0)333 150 1666
>>>>> +44 (0)7870 361412
>>>>> jim.page at redmatter.com
>>>>> 
>>>>>> On 21 Sep 2017, at 11:59, Afriyie Abraham <afriyie.abraham at hotmail.com> wrote:
>>>>>> 
>>>>>> Hi,
>>>>>> 
>>>>>> I have tried installing clearwater using the source code following the procedure
>>>>>> in the documentation but not working.
>>>>>> 
>>>>>> My main aim is to be able to have a device to device call session through my EPC
>>>>>> connecting the IMS(clearwater).
>>>>>> Also i would like to add some QoS parameters to for every call session.
>>>>>> plan:
>>>>>> 
>>>>>> UE ??????EPC ??????IMS
>>>>>> 
>>>>>> Please can anyone help me with a working source code procedure to install clearwater
>>>>>> on ubuntu 14.04.
>>>>>> 
>>>>>> Thanks in advance.
>>>>>> 
>>>>>> BR
>>>>>> Abraham 
>>>>>> 
>>>>>> _______________________________________________
>>>>>> Clearwater mailing list
>>>>>> Clearwater at lists.projectclearwater.org
>>>>>> http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org
>>>>> 
>>>>> _______________________________________________
>>>>> Clearwater mailing list
>>>>> Clearwater at lists.projectclearwater.org
>>>>> http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org
>>>> _______________________________________________
>>>> Clearwater mailing list
>>>> Clearwater at lists.projectclearwater.org
>>>> http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org
>>> 
>>> _______________________________________________
>>> Clearwater mailing list
>>> Clearwater at lists.projectclearwater.org
>>> http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org
>> 
>> _______________________________________________
>> Clearwater mailing list
>> Clearwater at lists.projectclearwater.org
>> http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org
> 
> _______________________________________________
> Clearwater mailing list
> Clearwater at lists.projectclearwater.org
> http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20170921/a46724d9/attachment.html>

From jim.page at redmatter.com  Thu Sep 21 10:29:52 2017
From: jim.page at redmatter.com (Jim Page)
Date: Thu, 21 Sep 2017 14:29:52 +0000
Subject: [Project Clearwater] clearwater Installation using source code
 -- Help
In-Reply-To: <E043E8C5-672B-46D4-AFEC-5AD2D1C67A77@gmail.com>
References: <HE1PR05MB137061BF76FBAC3347167854FC660@HE1PR05MB1370.eurprd05.prod.outlook.com>
	<50C2CE0B-EBCA-4EB1-B493-F66DF7EEC5E8@redmatter.com>
	<D8F81832-9566-464A-9D8B-8BD2F99B83FD@gmail.com>
	<14312422-BE83-49E5-BADF-D1490E65B5D8@redmatter.com>
	<588DC1BC-44CC-443A-A8BC-2735CDCE88F5@gmail.com>
	<D66B6ECD-C978-40B7-AE1E-E51C85D677A8@redmatter.com>
	<E043E8C5-672B-46D4-AFEC-5AD2D1C67A77@gmail.com>
Message-ID: <250067FA-FAF3-4CF0-8834-7184874E6150@redmatter.com>

One other thing - the -t switch runs sprout in the foreground - you were probably doing everything correctly!

RedMatter Ltd
Jim Page
VP Mobile Services
+44 (0)333 150 1666
+44 (0)7870 361412
jim.page at redmatter.com<mailto:jim.page at redmatter.com>

On 21 Sep 2017, at 15:20, Afriyie Abraham Kwabena <afriyie.abraham at gmail.com<mailto:afriyie.abraham at gmail.com>> wrote:


./MIBS="" LD_LIBRARY_PATH=usr/lib:$LD_LIBRARY_PATH build/bin/sprout -t

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20170921/06efb41a/attachment.html>

From jim.page at redmatter.com  Thu Sep 21 10:38:16 2017
From: jim.page at redmatter.com (Jim Page)
Date: Thu, 21 Sep 2017 14:38:16 +0000
Subject: [Project Clearwater] Looping authentication with Bria
In-Reply-To: <A08CF3C9-DCAB-46F3-A7AE-3E597E865129@redmatter.com>
References: <A08CF3C9-DCAB-46F3-A7AE-3E597E865129@redmatter.com>
Message-ID: <C4025817-3A23-4856-8613-717AA07D40AC@redmatter.com>

Hi Clearwater people

I could really do with your help with the below. I have a pretty much bog standard setup, standard build with chef in AWS, plus an openimscore HSS instance. I am currently unable to get any sip devices to register due to an apparent issue nonce counting. Can you help? In parallel I am trying to hack the code to work around the issue ? but I can?t believe this isn?t a common scenario with a simple solution ? ?

Thanks in advance ?

Jim

RedMatter Ltd
Jim Page
VP Mobile Services
+44 (0)333 150 1666
+44 (0)7870 361412
jim.page at redmatter.com<mailto:jim.page at redmatter.com>

On 17 Sep 2017, at 18:38, Jim Page <jim.page at redmatter.com<mailto:jim.page at redmatter.com>> wrote:

Hi There

I initially set up my IMS in an AWS VPC, using chef. It worked out of the box without an HSS, I was able to use Ellis to provision accounts and they registered no problem using Bria 4. I decided to add an HSS (using ?knife box? to add an openimscore HSS instance) so that I can test our application servers. Now that I have the HSS integrated (there were niggles in the installation), I provisioned a new user on the HSS but the Bria phone will not authenticate, and a feedback loop is generated on the first REGISTER attempt. The problem seems to be related to nonce counting. The process seems to go like this:

UE REGISTER -> Bono
Bono REGISTER -> icscf
  No Authorization. Challenge is built, and IMPI is created with nc=1, and stored
icscf 401 -> Bono
Bono 401 -> UE
  UE builds an Authorisation header
UE REGISTER -> Bono
Bono REGISTER -> icscf
  The Authorisation header contains nc=000001.
  IMPI is loaded and validation is successful.
  IMPI is stored with nc=2, log line 'Debug authenticationsproutlet.cpp:1033: Storing challenge because nonce counts are supported?
icscf REGISTER -> scscf-proxy
  The Authorisation header still contains nc=000001.
  IMPI is loaded, but log line says: 'Info authenticationsproutlet.cpp:971: Nonce count supplied (1) is lower than expected (2) - ignore it?
  The Authorisation header is ignored and another 401 challenge is issued, and the UE responds ?. and this causes a loop
scscf-proxy 401 -> icscf
icscf 401 -> Bono
Bono 401 -> UE

There seems to be a fundamental flaw here. The IMPI nc is incrementing, but the Authorisation header is not. I can?t see how this can work unless icscf increments nc in the authorisation header before sending it to the scscf

Also please note: I disabled nonce_count_supported in shared_config, but the result was a log line ?nonce count is supplied but not supported? (or words to that effect) and the Authorisation header is again ignored, and there is a loop.

How to move forward from here? I have searched in vain for a way to disable nonce count in Bria 4.

I can provide logs if helpful, but they are long and I don?t want to clog everyone?s inbox.

Kind regards
Jim

RedMatter Ltd
Jim Page
VP Mobile Services
+44 (0)333 150 1666
+44 (0)7870 361412
jim.page at redmatter.com<mailto:jim.page at redmatter.com>

_______________________________________________
Clearwater mailing list
Clearwater at lists.projectclearwater.org<mailto:Clearwater at lists.projectclearwater.org>
http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20170921/7506466d/attachment.html>

From jim.page at redmatter.com  Thu Sep 21 13:25:42 2017
From: jim.page at redmatter.com (Jim Page)
Date: Thu, 21 Sep 2017 17:25:42 +0000
Subject: [Project Clearwater] Looping authentication with Bria
In-Reply-To: <C4025817-3A23-4856-8613-717AA07D40AC@redmatter.com>
References: <A08CF3C9-DCAB-46F3-A7AE-3E597E865129@redmatter.com>
	<C4025817-3A23-4856-8613-717AA07D40AC@redmatter.com>
Message-ID: <C0E6789C-515C-4A39-BDB1-28BCB1183EE9@redmatter.com>

Right - I have made a change in sprout that updates the REGISTER Authorisation header so that the nc is incremented and a new hash is written into the response. The authentication is now successful. Unfortunately what happens is that once the registration is complete, the same REGISTER request is sent over and over and over to the scscf-proxy sproutlet until the hops limit is reached.

What exactly is supposed to happen here? According to the flow I have, once the registration on the SCSCF is successful it should send an SAR to the HSS, after which the SCSCF should return 200 OK to the ISCSCF, and so on back to the UE. I cannot see any sign the SAR request is taking place, though I can see the UAR query from the ISCSCF. Here is a section of log from sprout from the moment the REGISTER is first presented to the scscf-proxy sproutlet until the start of the first loop:

21-09-2017 15:53:32.239 UTC Debug scscfsproutlet.cpp:489: S-CSCF Transaction (0x7f474c010e50) created
21-09-2017 15:53:32.239 UTC Verbose sproutletproxy.cpp:1298: Created Sproutlet scscf-proxy-0x7f474c010e50 for Request msg REGISTER/cseq=2 (tdta0x7f474c01ce90)
21-09-2017 15:53:32.239 UTC Verbose sproutletproxy.cpp:2290: Routing Request msg REGISTER/cseq=2 (tdta0x7f474c01ce90) (1399 bytes) to downstream sproutlet scscf-proxy:
--start msg?

REGISTER sip:scscf.ims.rmcore.net SIP/2.0
Route: <sip:ims.rmcore.net;lr;service=scscf-proxy>
Via: SIP/2.0/TCP 10.0.0.222:5058;rport=33214;received=10.0.0.222;branch=z9hG4bKPj1JagMaULIh8xrGTU49BsvwXp7aQVjv9S
Path: <sip:En9ykhc3CE at 10.0.0.222:5058;transport=TCP;lr;ob>
Via: SIP/2.0/UDP 212.159.106.131:59124;rport=59124;received=212.159.106.131;branch=z9hG4bK-524287-1?07005d66d0f9415a
Max-Forwards: 68
Contact: <sip:83555000001 at 212.159.106.131:59124;rinstance=39865f51c2a988a3>
To: "Jim at IMS" <sip:83555000001 at ims.rmcore.net>
From: "Jim at IMS" <sip:83555000001 at ims.rmcore.net>;tag=e2a4b510
Call-ID: 85656NGM0NGZkNDM3YjVhZTNhZWY3OWNmYzQ1NDc4MjM3ZTQ
CSeq: 2 REGISTER
Expires: 3600
Allow: SUBSCRIBE, NOTIFY, INVITE, ACK, CANCEL, BYE, REFER, INFO, OPTIONS
User-Agent: Bria 4 release 4.8.2 stamp 85656
P-Visited-Network-ID: ims.rmcore.net<http://ims.rmcore.net>
P-Charging-Function-Addresses: ccf=cdf.ims.rmcore.net<http://cdf.ims.rmcore.net>
P-Charging-Vector: icid-value="85656NGM0NGZkNDM3YjVhZTNhZWY3OWNmYzQ1NDc4MjM3ZTQ";icid-generated-at=ec2-52-56-52-145.eu-west-2.compute.amazonaws.com<http://ec2-52-56-52-145.eu-west-2.compute.amazonaws.com>
Authorization: Digest response="5a39ea19aeafcf955924b29a9a375451", username="83555000001 at ims.rmcore.net<mailto:83555000001 at ims.rmcore.net>", realm="ims.rmcore.net<http://ims.rmcore.net>", nonce="63bff4bb68c27b47", uri="sip:ims.rmcore.net", algorithm=MD5, cnonce="c549e7ca56a2867a6e23caf77a3c629a", opaque="5a5a8de45658f637", qop=auth, nc=00000002,integrity-protected=ip-assoc-pending
Content-Length:  0


--end msg?
21-09-2017 15:53:32.239 UTC Debug pjutils.cpp:700: Cloned tdta0x7f474c01ce90 to tdta0x7f474c020150
21-09-2017 15:53:32.239 UTC Debug sproutletproxy.cpp:1364: Remove top Route header Route: <sip:ims.rmcore.net;lr;service=scscf-proxy>
21-09-2017 15:53:32.239 UTC Debug sproutletproxy.cpp:1961: Adding message 0x7f474c020760 => txdata 0x7f474c0201f8 mapping
21-09-2017 15:53:32.239 UTC Verbose sproutletproxy.cpp:1806: scscf-proxy-0x7f474c010e50 pass initial request Request msg REGISTER/cseq=2 (tdta0x7f474c020150) to Sproutlet
21-09-2017 15:53:32.239 UTC Info scscfsproutlet.cpp:536: S-CSCF received initial request
21-09-2017 15:53:32.239 UTC Debug uri_classifier.cpp:139: home domain: true, local_to_node: false, is_gruu: false, enforce_user_phone: false, prefer_sip: true, treat_number_as_phone: false
21-09-2017 15:53:32.239 UTC Debug uri_classifier.cpp:185: Classified URI as 4
21-09-2017 15:53:32.239 UTC Debug scscfsproutlet.cpp:993: Route header references this system
21-09-2017 15:53:32.239 UTC Debug scscfsproutlet.cpp:1039: No ODI token, or invalid ODI token, on request - logging ICID marker 85656NGM0NGZkNDM3YjVhZTNhZWY3OWNmYzQ1NDc4MjM3ZTQ for B2BUA AS correlation
21-09-2017 15:53:32.239 UTC Debug scscfsproutlet.cpp:1052: Got our Route header, session case term, OD=None
21-09-2017 15:53:32.239 UTC Debug uri_classifier.cpp:139: home domain: false, local_to_node: false, is_gruu: false, enforce_user_phone: false, prefer_sip: true, treat_number_as_phone: false
21-09-2017 15:53:32.239 UTC Debug uri_classifier.cpp:185: Classified URI as 5
21-09-2017 15:53:32.239 UTC Debug scscfsproutlet.cpp:1396: URI is not locally hosted
21-09-2017 15:53:32.239 UTC Debug acr.cpp:1787: Create RalfACR for node type S-CSCF with role Terminating
21-09-2017 15:53:32.239 UTC Debug acr.cpp:24: Created ACR (0x7f474c022110)
21-09-2017 15:53:32.239 UTC Debug acr.cpp:164: Created S-CSCF Ralf ACR
21-09-2017 15:53:32.239 UTC Debug acr.cpp:29: Destroyed ACR (0x7f474c022110)
21-09-2017 15:53:32.239 UTC Info scscfsproutlet.cpp:714: Route request without applying services
21-09-2017 15:53:32.239 UTC Debug sproutletproxy.cpp:1535: Sproutlet send_request 0x7f474c020760
21-09-2017 15:53:32.239 UTC Verbose sproutletproxy.cpp:1576: scscf-proxy-0x7f474c010e50 sending Request msg REGISTER/cseq=2 (tdta0x7f474c020150) on fork 0
21-09-2017 15:53:32.239 UTC Debug sproutletproxy.cpp:1976: Processing actions from sproutlet - 0 responses, 1 requests, 0 timers
21-09-2017 15:53:32.239 UTC Debug sproutletproxy.cpp:2016: Processing request 0x7f474c0201f8, fork = 0
21-09-2017 15:53:32.239 UTC Debug sproutletproxy.cpp:2141: scscf-proxy-0x7f474c010e50 transmitting request on fork 0
21-09-2017 15:53:32.239 UTC Debug sproutletproxy.cpp:2156: scscf-proxy-0x7f474c010e50 store reference to non-ACK request Request msg REGISTER/cseq=2 (tdta0x7f474c020150) on fork 0
21-09-2017 15:53:32.239 UTC Debug sproutletproxy.cpp:1968: Removing message 0x7f474c020760 => txdata 0x7f474c0201f8 mapping
21-09-2017 15:53:32.239 UTC Debug sproutletproxy.cpp:163: Find target Sproutlet for request
21-09-2017 15:53:32.239 UTC Debug sproutletproxy.cpp:197: Found next routable URI: sip:scscf.ims.rmcore.net
21-09-2017 15:53:32.239 UTC Debug sproutletproxy.cpp:340: Possible service name scscf will be used if ims.rmcore.net<http://ims.rmcore.net> is a local hostname
21-09-2017 15:53:32.239 UTC Debug authenticationsproutlet.cpp:169: Authorization header in request
21-09-2017 15:53:32.239 UTC Debug authenticationsproutlet.cpp:177: Integrity protected with ip-assoc-pending
21-09-2017 15:53:32.239 UTC Verbose sproutletproxy.cpp:1298: Created Sproutlet authentication-0x7f474c022150 for Request msg REGISTER/cseq=2 (tdta0x7f474c020150)
21-09-2017 15:53:32.239 UTC Verbose sproutletproxy.cpp:2290: Routing Request msg REGISTER/cseq=2 (tdta0x7f474c020150) (1347 bytes) to downstream sproutlet authentication:
--start msg?

REGISTER sip:scscf.ims.rmcore.net SIP/2.0
Via: SIP/2.0/TCP 10.0.0.222:5058;rport=33214;received=10.0.0.222;branch=z9hG4bKPj1JagMaULIh8xrGTU49BsvwXp7aQVjv9S
Path: <sip:En9ykhc3CE at 10.0.0.222:5058;transport=TCP;lr;ob>
Via: SIP/2.0/UDP 212.159.106.131:59124;rport=59124;received=212.159.106.131;branch=z9hG4bK-524287-1?07005d66d0f9415a
Max-Forwards: 67
Contact: <sip:83555000001 at 212.159.106.131:59124;rinstance=39865f51c2a988a3>
To: "Jim at IMS" <sip:83555000001 at ims.rmcore.net>
From: "Jim at IMS" <sip:83555000001 at ims.rmcore.net>;tag=e2a4b510
Call-ID: 85656NGM0NGZkNDM3YjVhZTNhZWY3OWNmYzQ1NDc4MjM3ZTQ
CSeq: 2 REGISTER
Expires: 3600
Allow: SUBSCRIBE, NOTIFY, INVITE, ACK, CANCEL, BYE, REFER, INFO, OPTIONS
User-Agent: Bria 4 release 4.8.2 stamp 85656
P-Visited-Network-ID: ims.rmcore.net<http://ims.rmcore.net>
P-Charging-Function-Addresses: ccf=cdf.ims.rmcore.net<http://cdf.ims.rmcore.net>
P-Charging-Vector: icid-value="85656NGM0NGZkNDM3YjVhZTNhZWY3OWNmYzQ1NDc4MjM3ZTQ";icid-generated-at=ec2-52-56-52-145.eu-west-2.compute.amazonaws.com<http://ec2-52-56-52-145.eu-west-2.compute.amazonaws.com>
Authorization: Digest response="5a39ea19aeafcf955924b29a9a375451", username="83555000001 at ims.rmcore.net<mailto:83555000001 at ims.rmcore.net>", realm="ims.rmcore.net<http://ims.rmcore.net>", nonce="63bff4bb68c27b47", uri="sip:ims.rmcore.net", algorithm=MD5, cnonce="c549e7ca56a2867a6e23caf77a3c629a", opaque="5a5a8de45658f637", qop=auth, nc=00000002,integrity-protected=ip-assoc-pending
Content-Length:  0


--end msg?
21-09-2017 15:53:32.240 UTC Debug pjutils.cpp:700: Cloned tdta0x7f474c020150 to tdta0x7f474c022360
21-09-2017 15:53:32.240 UTC Debug sproutletproxy.cpp:1961: Adding message 0x7f474c022970 => txdata 0x7f474c022408 mapping
21-09-2017 15:53:32.240 UTC Verbose sproutletproxy.cpp:1806: authentication-0x7f474c022150 pass initial request Request msg REGISTER/cseq=2 (tdta0x7f474c022360) to Sproutlet
21-09-2017 15:53:32.240 UTC Debug authenticationsproutlet.cpp:873: Authentication module invoked
21-09-2017 15:53:32.240 UTC Debug sproutletproxy.cpp:340: Possible service name scscf will be used if sprout.ims.rmcore.net<http://sprout.ims.rmcore.net> is a local hostname
21-09-2017 15:53:32.240 UTC Debug sproutletproxy.cpp:340: Possible service name scscf will be used if ims.rmcore.net<http://ims.rmcore.net> is a local hostname
21-09-2017 15:53:32.240 UTC Debug authenticationsproutlet.cpp:1456: Lookup IMPI object: impi=83555000001 at ims.rmcore.net<mailto:impi=83555000001 at ims.rmcore.net>
21-09-2017 15:53:32.240 UTC Debug memcachedstore.cpp:295: Start GET from table impi for key 83555000001 at ims.rmcore.net<mailto:83555000001 at ims.rmcore.net>
21-09-2017 15:53:32.240 UTC Debug astaire_resolver.cpp:47: AstaireResolver::resolve for host vellum.ims.rmcore.net<http://vellum.ims.rmcore.net>, family 2
21-09-2017 15:53:32.240 UTC Debug utils.cpp:377: Malformed host/port vellum.ims.rmcore.net<http://vellum.ims.rmcore.net>
21-09-2017 15:53:32.240 UTC Debug utils.cpp:418: Attempt to parse vellum.ims.rmcore.net<http://vellum.ims.rmcore.net> as IP address
21-09-2017 15:53:32.240 UTC Verbose dnscachedresolver.cpp:468: Check cache for vellum.ims.rmcore.net<http://vellum.ims.rmcore.net> type 1
21-09-2017 15:53:32.240 UTC Debug dnscachedresolver.cpp:570: Pulling 1 records from cache for vellum.ims.rmcore.net<http://vellum.ims.rmcore.net> A
21-09-2017 15:53:32.240 UTC Debug baseresolver.cpp:369: Found 1 A/AAAA records, creating iterator
21-09-2017 15:53:32.240 UTC Debug baseresolver.cpp:920: Attempting to get 2 targets for host:vellum.ims.rmcore.net<http://vellum.ims.rmcore.net>. allowed_host_state = 3
21-09-2017 15:53:32.240 UTC Debug baseresolver.cpp:793: 10.0.0.6:11311;transport=TCP has state: WHITE
21-09-2017 15:53:32.240 UTC Debug baseresolver.cpp:793: 10.0.0.6:11311;transport=TCP has state: WHITE
21-09-2017 15:53:32.240 UTC Debug baseresolver.cpp:997: Added a whitelisted server to targets, now have 1 of 2
21-09-2017 15:53:32.240 UTC Debug memcachedstore.cpp:696: Found 1 targets for vellum.ims.rmcore.net<http://vellum.ims.rmcore.net>
21-09-2017 15:53:32.240 UTC Debug memcachedstore.cpp:721: Duplicate target IP=10.0.0.6, port= 11311 as it is the only target
21-09-2017 15:53:32.240 UTC Debug memcachedstore.cpp:249: Try server IP 10.0.0.6, port 11311
21-09-2017 15:53:32.240 UTC Debug connection_pool.h:207: Request for connection to IP: 10.0.0.6, port: 11311
21-09-2017 15:53:32.240 UTC Debug connection_pool.h:220: Found existing connection 0x7f470c06a3e0 in pool
21-09-2017 15:53:32.240 UTC Debug memcachedstore.cpp:74: Fetch result
21-09-2017 15:53:32.240 UTC Debug memcachedstore.cpp:82: Found record on replica
21-09-2017 15:53:32.240 UTC Debug memcachedstore.cpp:260: libmemcached returned 0
21-09-2017 15:53:32.240 UTC Debug connection_pool.h:244: Release connection to IP: 10.0.0.6, port: 11311 to pool
21-09-2017 15:53:32.240 UTC Debug memcachedstore.cpp:339: Read 268 bytes from table impi key 83555000001 at ims.rmcore.net<mailto:83555000001 at ims.rmcore.net>, CAS = 18873
21-09-2017 15:53:32.240 UTC Debug astaire_impistore.cpp:177: Retrieved IMPI for 83555000001 at ims.rmcore.net<mailto:83555000001 at ims.rmcore.net>
{"authChallenges":[{"type":"digest","nonce":"63bff4bb68c27b47","nc":2,"expires":1506009512,"correlator":"z9hG4bKPj868.WzubxOAj3T1s2dS1BU0qM0Zj-kpZ","scscf-uri":"sip:scscf.ims.rmcore.net","realm":"ims.rmcore.net<http://ims.rmcore.net>","qop":"auth","ha1":"b144b84f59356acbb86048bf3eb5f48f?}]}
21-09-2017 15:53:32.240 UTC Debug authenticationsproutlet.cpp:994: Verify authentication information in request
21-09-2017 15:53:32.240 UTC Debug authenticationsproutlet.cpp:482: Found Digest HA1 = b144b84f59356acbb86048bf3eb5f48f
21-09-2017 15:53:32.240 UTC Debug authenticationsproutlet.cpp:1006: Request authenticated successfully
21-09-2017 15:53:32.240 UTC Debug authenticationsproutlet.cpp:1033: Storing challenge because nonce counts are supported
21-09-2017 15:53:32.240 UTC Debug astaire_impistore.cpp:134: Storing IMPI for 83555000001 at ims.rmcore.net<mailto:83555000001 at ims.rmcore.net>
{"authChallenges":[{"type":"digest","nonce":"63bff4bb68c27b47","nc":3,"expires":1506009512,"correlator":"z9hG4bKPj868.WzubxOAj3T1s2dS1BU0qM0Zj-kpZ","scscf-uri":"sip:scscf.ims.rmcore.net","realm":"ims.rmcore.net<http://ims.rmcore.net>","qop":"auth","ha1":"b144b84f59356acbb86048bf3eb5f48f?}]}
21-09-2017 15:53:32.240 UTC Debug memcachedstore.cpp:413: Writing 268 bytes to table impi key 83555000001 at ims.rmcore.net<mailto:83555000001 at ims.rmcore.net>, CAS = 18873, expiry = 300
21-09-2017 15:53:32.240 UTC Debug astaire_resolver.cpp:47: AstaireResolver::resolve for host vellum.ims.rmcore.net<http://vellum.ims.rmcore.net>, family 2
21-09-2017 15:53:32.240 UTC Debug utils.cpp:377: Malformed host/port vellum.ims.rmcore.net<http://vellum.ims.rmcore.net>
21-09-2017 15:53:32.240 UTC Debug utils.cpp:418: Attempt to parse vellum.ims.rmcore.net<http://vellum.ims.rmcore.net> as IP address
21-09-2017 15:53:32.240 UTC Verbose dnscachedresolver.cpp:468: Check cache for vellum.ims.rmcore.net<http://vellum.ims.rmcore.net> type 1
21-09-2017 15:53:32.240 UTC Debug dnscachedresolver.cpp:570: Pulling 1 records from cache for vellum.ims.rmcore.net<http://vellum.ims.rmcore.net> A
21-09-2017 15:53:32.240 UTC Debug baseresolver.cpp:369: Found 1 A/AAAA records, creating iterator
21-09-2017 15:53:32.240 UTC Debug baseresolver.cpp:920: Attempting to get 2 targets for host:vellum.ims.rmcore.net<http://vellum.ims.rmcore.net>. allowed_host_state = 3
21-09-2017 15:53:32.240 UTC Debug baseresolver.cpp:793: 10.0.0.6:11311;transport=TCP has state: WHITE
21-09-2017 15:53:32.240 UTC Debug baseresolver.cpp:793: 10.0.0.6:11311;transport=TCP has state: WHITE
21-09-2017 15:53:32.240 UTC Debug baseresolver.cpp:997: Added a whitelisted server to targets, now have 1 of 2
21-09-2017 15:53:32.241 UTC Debug memcachedstore.cpp:696: Found 1 targets for vellum.ims.rmcore.net<http://vellum.ims.rmcore.net>
21-09-2017 15:53:32.241 UTC Debug memcachedstore.cpp:721: Duplicate target IP=10.0.0.6, port= 11311 as it is the only target
21-09-2017 15:53:32.241 UTC Debug memcachedstore.cpp:249: Try server IP 10.0.0.6, port 11311
21-09-2017 15:53:32.241 UTC Debug connection_pool.h:207: Request for connection to IP: 10.0.0.6, port: 11311
21-09-2017 15:53:32.241 UTC Debug connection_pool.h:220: Found existing connection 0x7f470c06a3e0 in pool
21-09-2017 15:53:32.241 UTC Debug memcachedstore.cpp:260: libmemcached returned 0
21-09-2017 15:53:32.241 UTC Debug connection_pool.h:244: Release connection to IP: 10.0.0.6, port: 11311 to pool
21-09-2017 15:53:32.241 UTC Debug memcachedstore.cpp:555: Write successful
21-09-2017 15:53:32.241 UTC Debug authenticationsproutlet.cpp:1178: Updated Authorization header with new nc and response
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:427: Creating URI for service registrar
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:340: Possible service name scscf will be used if ims.rmcore.net<http://ims.rmcore.net> is a local hostname
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:453: Constructed URI sip:ims.rmcore.net;lr;service=registrar
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:1535: Sproutlet send_request 0x7f474c022970
21-09-2017 15:53:32.241 UTC Verbose sproutletproxy.cpp:1576: authentication-0x7f474c022150 sending Request msg REGISTER/cseq=2 (tdta0x7f474c022360) on fork 0
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:1976: Processing actions from sproutlet - 0 responses, 1 requests, 0 timers
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:2016: Processing request 0x7f474c022408, fork = 0
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:2141: authentication-0x7f474c022150 transmitting request on fork 0
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:2156: authentication-0x7f474c022150 store reference to non-ACK request Request msg REGISTER/cseq=2 (tdta0x7f474c022360) on fork 0
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:1968: Removing message 0x7f474c022970 => txdata 0x7f474c022408 mapping
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:163: Find target Sproutlet for request
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:197: Found next routable URI: sip:ims.rmcore.net;lr;service=registrar
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:300: Found services param - registrar
21-09-2017 15:53:32.241 UTC Debug uri_classifier.cpp:139: home domain: false, local_to_node: false, is_gruu: false, enforce_user_phone: false, prefer_sip: true, treat_number_as_phone: false
21-09-2017 15:53:32.241 UTC Debug uri_classifier.cpp:185: Classified URI as 5
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:427: Creating URI for service subscription
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:300: Found services param - registrar
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:453: Constructed URI sip:ims.rmcore.net;lr;service=subscription
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:1200: Remove top Route header Route: <sip:ims.rmcore.net;lr;service=registrar>
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:163: Find target Sproutlet for request
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:197: Found next routable URI: sip:ims.rmcore.net;lr;service=subscription
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:300: Found services param - subscription
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:427: Creating URI for service scscf-proxy
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:300: Found services param - subscription
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:453: Constructed URI sip:ims.rmcore.net;lr;service=scscf-proxy
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:1200: Remove top Route header Route: <sip:ims.rmcore.net;lr;service=subscription>
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:163: Find target Sproutlet for request
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:197: Found next routable URI: sip:ims.rmcore.net;lr;service=scscf-proxy
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:300: Found services param - scscf-proxy
21-09-2017 15:53:32.241 UTC Debug scscfsproutlet.cpp:489: S-CSCF Transaction (0x7f474c011150) created
21-09-2017 15:53:32.241 UTC Verbose sproutletproxy.cpp:1298: Created Sproutlet scscf-proxy-0x7f474c011150 for Request msg REGISTER/cseq=2 (tdta0x7f474c022360)
21-09-2017 15:53:32.241 UTC Verbose sproutletproxy.cpp:2290: Routing Request msg REGISTER/cseq=2 (tdta0x7f474c022360) (1399 bytes) to downstream sproutlet scscf-proxy:
--start msg?

REGISTER sip:scscf.ims.rmcore.net SIP/2.0
Route: <sip:ims.rmcore.net;lr;service=scscf-proxy>
Via: SIP/2.0/TCP 10.0.0.222:5058;rport=33214;received=10.0.0.222;branch=z9hG4bKPj1JagMaULIh8xrGTU49BsvwXp7aQVjv9S
Path: <sip:En9ykhc3CE at 10.0.0.222:5058;transport=TCP;lr;ob>
Via: SIP/2.0/UDP 212.159.106.131:59124;rport=59124;received=212.159.106.131;branch=z9hG4bK-524287-1?07005d66d0f9415a
Max-Forwards: 66
Contact: <sip:83555000001 at 212.159.106.131:59124;rinstance=39865f51c2a988a3>
To: "Jim at IMS" <sip:83555000001 at ims.rmcore.net>
From: "Jim at IMS" <sip:83555000001 at ims.rmcore.net>;tag=e2a4b510
Call-ID: 85656NGM0NGZkNDM3YjVhZTNhZWY3OWNmYzQ1NDc4MjM3ZTQ
CSeq: 2 REGISTER
Expires: 3600
Allow: SUBSCRIBE, NOTIFY, INVITE, ACK, CANCEL, BYE, REFER, INFO, OPTIONS
User-Agent: Bria 4 release 4.8.2 stamp 85656
P-Visited-Network-ID: ims.rmcore.net<http://ims.rmcore.net>
P-Charging-Function-Addresses: ccf=cdf.ims.rmcore.net<http://cdf.ims.rmcore.net>
P-Charging-Vector: icid-value="85656NGM0NGZkNDM3YjVhZTNhZWY3OWNmYzQ1NDc4MjM3ZTQ";icid-generated-at=ec2-52-56-52-145.eu-west-2.compute.amazonaws.com<http://ec2-52-56-52-145.eu-west-2.compute.amazonaws.com>
Authorization: Digest response="54ade38e11b464bf9fcde6f464c7d9e8", username="83555000001 at ims.rmcore.net<mailto:83555000001 at ims.rmcore.net>", realm="ims.rmcore.net<http://ims.rmcore.net>", nonce="63bff4bb68c27b47", uri="sip:ims.rmcore.net", algorithm=MD5, cnonce="c549e7ca56a2867a6e23caf77a3c629a", opaque="5a5a8de45658f637", qop=auth, nc=00000003,integrity-protected=ip-assoc-pending
Content-Length:  0


--end msg?

Any idea what?s going wrong here?

Thanks
Jim

RedMatter Ltd
Jim Page
VP Mobile Services
+44 (0)333 150 1666
+44 (0)7870 361412
jim.page at redmatter.com<mailto:jim.page at redmatter.com>

On 21 Sep 2017, at 15:38, Jim Page <jim.page at redmatter.com<mailto:jim.page at redmatter.com>> wrote:

Hi Clearwater people

I could really do with your help with the below. I have a pretty much bog standard setup, standard build with chef in AWS, plus an openimscore HSS instance. I am currently unable to get any sip devices to register due to an apparent issue nonce counting. Can you help? In parallel I am trying to hack the code to work around the issue ? but I can?t believe this isn?t a common scenario with a simple solution ? ?

Thanks in advance ?

Jim

RedMatter Ltd
Jim Page
VP Mobile Services
+44 (0)333 150 1666
+44 (0)7870 361412
jim.page at redmatter.com<mailto:jim.page at redmatter.com>

On 17 Sep 2017, at 18:38, Jim Page <jim.page at redmatter.com<mailto:jim.page at redmatter.com>> wrote:

Hi There

I initially set up my IMS in an AWS VPC, using chef. It worked out of the box without an HSS, I was able to use Ellis to provision accounts and they registered no problem using Bria 4. I decided to add an HSS (using ?knife box? to add an openimscore HSS instance) so that I can test our application servers. Now that I have the HSS integrated (there were niggles in the installation), I provisioned a new user on the HSS but the Bria phone will not authenticate, and a feedback loop is generated on the first REGISTER attempt. The problem seems to be related to nonce counting. The process seems to go like this:

UE REGISTER -> Bono
Bono REGISTER -> icscf
  No Authorization. Challenge is built, and IMPI is created with nc=1, and stored
icscf 401 -> Bono
Bono 401 -> UE
  UE builds an Authorisation header
UE REGISTER -> Bono
Bono REGISTER -> icscf
  The Authorisation header contains nc=000001.
  IMPI is loaded and validation is successful.
  IMPI is stored with nc=2, log line 'Debug authenticationsproutlet.cpp:1033: Storing challenge because nonce counts are supported?
icscf REGISTER -> scscf-proxy
  The Authorisation header still contains nc=000001.
  IMPI is loaded, but log line says: 'Info authenticationsproutlet.cpp:971: Nonce count supplied (1) is lower than expected (2) - ignore it?
  The Authorisation header is ignored and another 401 challenge is issued, and the UE responds ?. and this causes a loop
scscf-proxy 401 -> icscf
icscf 401 -> Bono
Bono 401 -> UE

There seems to be a fundamental flaw here. The IMPI nc is incrementing, but the Authorisation header is not. I can?t see how this can work unless icscf increments nc in the authorisation header before sending it to the scscf

Also please note: I disabled nonce_count_supported in shared_config, but the result was a log line ?nonce count is supplied but not supported? (or words to that effect) and the Authorisation header is again ignored, and there is a loop.

How to move forward from here? I have searched in vain for a way to disable nonce count in Bria 4.

I can provide logs if helpful, but they are long and I don?t want to clog everyone?s inbox.

Kind regards
Jim

RedMatter Ltd
Jim Page
VP Mobile Services
+44 (0)333 150 1666
+44 (0)7870 361412
jim.page at redmatter.com<mailto:jim.page at redmatter.com>

_______________________________________________
Clearwater mailing list
Clearwater at lists.projectclearwater.org<mailto:Clearwater at lists.projectclearwater.org>
http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org

_______________________________________________
Clearwater mailing list
Clearwater at lists.projectclearwater.org<mailto:Clearwater at lists.projectclearwater.org>
http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20170921/c3479e8b/attachment.html>

From Matt.Williams at metaswitch.com  Fri Sep 22 04:55:03 2017
From: Matt.Williams at metaswitch.com (Matt Williams)
Date: Fri, 22 Sep 2017 08:55:03 +0000
Subject: [Project Clearwater] Looping authentication with Bria
In-Reply-To: <C4025817-3A23-4856-8613-717AA07D40AC@redmatter.com>
References: <A08CF3C9-DCAB-46F3-A7AE-3E597E865129@redmatter.com>
	<C4025817-3A23-4856-8613-717AA07D40AC@redmatter.com>
Message-ID: <CY4PR02MB28870EFEB84C692598F7121390670@CY4PR02MB2887.namprd02.prod.outlook.com>

Jim,

Sorry for the delay on this.

I wouldn't normally expect authentication to be performed at the I-CSCF as well as the S-CSCF - the I-CSCF should just look up where the subscriber is located and forward the request on.  Sprout determines whether the I-CSCF or S-CSCF should be invoked by looking at the SIP URI in the top Route header (or which port it was received on).  What does this Route header contain?

Apart from that, more detailed logs would be useful - in particular, it would be useful to see exactly what the Bria is sending, and what is being sent between Bono, the I-CSCF and the S-CSCF.  Hopefully the logs just around the time that the REGISTER happens shouldn't be too verbose!

Incidentally, you can disable nonce count support in Clearwater by setting "nonce_count_supported=N" (see http://clearwater.readthedocs.io/en/latest/Clearwater_Configuration_Options_Reference.html for more details).  I'm not sure that will solve your problem, though.

Thanks,

Matt


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Jim Page
Sent: 21 September 2017 15:38
To: clearwater at lists.projectclearwater.org
Subject: Re: [Project Clearwater] Looping authentication with Bria

Hi Clearwater people

I could really do with your help with the below. I have a pretty much bog standard setup, standard build with chef in AWS, plus an openimscore HSS instance. I am currently unable to get any sip devices to register due to an apparent issue nonce counting. Can you help? In parallel I am trying to hack the code to work around the issue ? but I can?t believe this isn?t a common scenario with a simple solution ? ?

Thanks in advance ?

Jim

RedMatter Ltd
Jim Page
VP Mobile Services
+44 (0)333 150 1666
+44 (0)7870 361412
jim.page at redmatter.com<mailto:jim.page at redmatter.com>

On 17 Sep 2017, at 18:38, Jim Page <jim.page at redmatter.com<mailto:jim.page at redmatter.com>> wrote:

Hi There

I initially set up my IMS in an AWS VPC, using chef. It worked out of the box without an HSS, I was able to use Ellis to provision accounts and they registered no problem using Bria 4. I decided to add an HSS (using ?knife box? to add an openimscore HSS instance) so that I can test our application servers. Now that I have the HSS integrated (there were niggles in the installation), I provisioned a new user on the HSS but the Bria phone will not authenticate, and a feedback loop is generated on the first REGISTER attempt. The problem seems to be related to nonce counting. The process seems to go like this:

UE REGISTER -> Bono
Bono REGISTER -> icscf
  No Authorization. Challenge is built, and IMPI is created with nc=1, and stored
icscf 401 -> Bono
Bono 401 -> UE
  UE builds an Authorisation header
UE REGISTER -> Bono
Bono REGISTER -> icscf
  The Authorisation header contains nc=000001.
  IMPI is loaded and validation is successful.
  IMPI is stored with nc=2, log line 'Debug authenticationsproutlet.cpp:1033: Storing challenge because nonce counts are supported?
icscf REGISTER -> scscf-proxy
  The Authorisation header still contains nc=000001.
  IMPI is loaded, but log line says: 'Info authenticationsproutlet.cpp:971: Nonce count supplied (1) is lower than expected (2) - ignore it?
  The Authorisation header is ignored and another 401 challenge is issued, and the UE responds ?. and this causes a loop
scscf-proxy 401 -> icscf
icscf 401 -> Bono
Bono 401 -> UE

There seems to be a fundamental flaw here. The IMPI nc is incrementing, but the Authorisation header is not. I can?t see how this can work unless icscf increments nc in the authorisation header before sending it to the scscf

Also please note: I disabled nonce_count_supported in shared_config, but the result was a log line ?nonce count is supplied but not supported? (or words to that effect) and the Authorisation header is again ignored, and there is a loop.

How to move forward from here? I have searched in vain for a way to disable nonce count in Bria 4.

I can provide logs if helpful, but they are long and I don?t want to clog everyone?s inbox.

Kind regards
Jim

RedMatter Ltd
Jim Page
VP Mobile Services
+44 (0)333 150 1666
+44 (0)7870 361412
jim.page at redmatter.com<mailto:jim.page at redmatter.com>

_______________________________________________
Clearwater mailing list
Clearwater at lists.projectclearwater.org<mailto:Clearwater at lists.projectclearwater.org>
http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20170922/dd54677c/attachment.html>

From Matt.Williams at metaswitch.com  Fri Sep 22 05:04:04 2017
From: Matt.Williams at metaswitch.com (Matt Williams)
Date: Fri, 22 Sep 2017 09:04:04 +0000
Subject: [Project Clearwater] Looping authentication with Bria
In-Reply-To: <C0E6789C-515C-4A39-BDB1-28BCB1183EE9@redmatter.com>
References: <A08CF3C9-DCAB-46F3-A7AE-3E597E865129@redmatter.com>
	<C4025817-3A23-4856-8613-717AA07D40AC@redmatter.com>
	<C0E6789C-515C-4A39-BDB1-28BCB1183EE9@redmatter.com>
Message-ID: <CY4PR02MB288723F16B75130EBE30F89290670@CY4PR02MB2887.namprd02.prod.outlook.com>

Jim,

Apologies - I didn't see this new email when I replied to your previous one.

The S-CSCF behavior is divided up into multiple chunks ("Sproutlets"), and we seem to be invoking the "scscf-proxy" chunk, which is responsible for processing dialog-related messages (rather than REGISTERs).  This is why it is trying to route the message on towards the "callee" (i.e. the request URI) - unfortunately, that also resolves to ourselves.

Would you be able to share the logs from the point that the request first hits Bono, right through until it gets into this loop?

(I think we just have a URI misconfigured somewhere - that should be set up correctly by the Chef scripts, but there must be a bug there.)

Thanks,

Matt


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Jim Page
Sent: 21 September 2017 18:26
To: clearwater at lists.projectclearwater.org
Subject: Re: [Project Clearwater] Looping authentication with Bria

Right - I have made a change in sprout that updates the REGISTER Authorisation header so that the nc is incremented and a new hash is written into the response. The authentication is now successful. Unfortunately what happens is that once the registration is complete, the same REGISTER request is sent over and over and over to the scscf-proxy sproutlet until the hops limit is reached.

What exactly is supposed to happen here? According to the flow I have, once the registration on the SCSCF is successful it should send an SAR to the HSS, after which the SCSCF should return 200 OK to the ISCSCF, and so on back to the UE. I cannot see any sign the SAR request is taking place, though I can see the UAR query from the ISCSCF. Here is a section of log from sprout from the moment the REGISTER is first presented to the scscf-proxy sproutlet until the start of the first loop:

21-09-2017 15:53:32.239 UTC Debug scscfsproutlet.cpp:489: S-CSCF Transaction (0x7f474c010e50) created
21-09-2017 15:53:32.239 UTC Verbose sproutletproxy.cpp:1298: Created Sproutlet scscf-proxy-0x7f474c010e50 for Request msg REGISTER/cseq=2 (tdta0x7f474c01ce90)
21-09-2017 15:53:32.239 UTC Verbose sproutletproxy.cpp:2290: Routing Request msg REGISTER/cseq=2 (tdta0x7f474c01ce90) (1399 bytes) to downstream sproutlet scscf-proxy:
--start msg?

REGISTER sip:scscf.ims.rmcore.net SIP/2.0
Route: <sip:ims.rmcore.net;lr;service=scscf-proxy>
Via: SIP/2.0/TCP 10.0.0.222:5058;rport=33214;received=10.0.0.222;branch=z9hG4bKPj1JagMaULIh8xrGTU49BsvwXp7aQVjv9S
Path: <sip:En9ykhc3CE at 10.0.0.222:5058;transport=TCP;lr;ob>
Via: SIP/2.0/UDP 212.159.106.131:59124;rport=59124;received=212.159.106.131;branch=z9hG4bK-524287-1?07005d66d0f9415a
Max-Forwards: 68
Contact: <sip:83555000001 at 212.159.106.131:59124;rinstance=39865f51c2a988a3>
To: "Jim at IMS" <sip:83555000001 at ims.rmcore.net>
From: "Jim at IMS" <sip:83555000001 at ims.rmcore.net>;tag=e2a4b510
Call-ID: 85656NGM0NGZkNDM3YjVhZTNhZWY3OWNmYzQ1NDc4MjM3ZTQ
CSeq: 2 REGISTER
Expires: 3600
Allow: SUBSCRIBE, NOTIFY, INVITE, ACK, CANCEL, BYE, REFER, INFO, OPTIONS
User-Agent: Bria 4 release 4.8.2 stamp 85656
P-Visited-Network-ID: ims.rmcore.net<http://ims.rmcore.net>
P-Charging-Function-Addresses: ccf=cdf.ims.rmcore.net<http://cdf.ims.rmcore.net>
P-Charging-Vector: icid-value="85656NGM0NGZkNDM3YjVhZTNhZWY3OWNmYzQ1NDc4MjM3ZTQ";icid-generated-at=ec2-52-56-52-145.eu-west-2.compute.amazonaws.com<http://ec2-52-56-52-145.eu-west-2.compute.amazonaws.com>
Authorization: Digest response="5a39ea19aeafcf955924b29a9a375451", username="83555000001 at ims.rmcore.net<mailto:83555000001 at ims.rmcore.net>", realm="ims.rmcore.net<http://ims.rmcore.net>", nonce="63bff4bb68c27b47", uri="sip:ims.rmcore.net", algorithm=MD5, cnonce="c549e7ca56a2867a6e23caf77a3c629a", opaque="5a5a8de45658f637", qop=auth, nc=00000002,integrity-protected=ip-assoc-pending
Content-Length:  0


--end msg?
21-09-2017 15:53:32.239 UTC Debug pjutils.cpp:700: Cloned tdta0x7f474c01ce90 to tdta0x7f474c020150
21-09-2017 15:53:32.239 UTC Debug sproutletproxy.cpp:1364: Remove top Route header Route: <sip:ims.rmcore.net;lr;service=scscf-proxy>
21-09-2017 15:53:32.239 UTC Debug sproutletproxy.cpp:1961: Adding message 0x7f474c020760 => txdata 0x7f474c0201f8 mapping
21-09-2017 15:53:32.239 UTC Verbose sproutletproxy.cpp:1806: scscf-proxy-0x7f474c010e50 pass initial request Request msg REGISTER/cseq=2 (tdta0x7f474c020150) to Sproutlet
21-09-2017 15:53:32.239 UTC Info scscfsproutlet.cpp:536: S-CSCF received initial request
21-09-2017 15:53:32.239 UTC Debug uri_classifier.cpp:139: home domain: true, local_to_node: false, is_gruu: false, enforce_user_phone: false, prefer_sip: true, treat_number_as_phone: false
21-09-2017 15:53:32.239 UTC Debug uri_classifier.cpp:185: Classified URI as 4
21-09-2017 15:53:32.239 UTC Debug scscfsproutlet.cpp:993: Route header references this system
21-09-2017 15:53:32.239 UTC Debug scscfsproutlet.cpp:1039: No ODI token, or invalid ODI token, on request - logging ICID marker 85656NGM0NGZkNDM3YjVhZTNhZWY3OWNmYzQ1NDc4MjM3ZTQ for B2BUA AS correlation
21-09-2017 15:53:32.239 UTC Debug scscfsproutlet.cpp:1052: Got our Route header, session case term, OD=None
21-09-2017 15:53:32.239 UTC Debug uri_classifier.cpp:139: home domain: false, local_to_node: false, is_gruu: false, enforce_user_phone: false, prefer_sip: true, treat_number_as_phone: false
21-09-2017 15:53:32.239 UTC Debug uri_classifier.cpp:185: Classified URI as 5
21-09-2017 15:53:32.239 UTC Debug scscfsproutlet.cpp:1396: URI is not locally hosted
21-09-2017 15:53:32.239 UTC Debug acr.cpp:1787: Create RalfACR for node type S-CSCF with role Terminating
21-09-2017 15:53:32.239 UTC Debug acr.cpp:24: Created ACR (0x7f474c022110)
21-09-2017 15:53:32.239 UTC Debug acr.cpp:164: Created S-CSCF Ralf ACR
21-09-2017 15:53:32.239 UTC Debug acr.cpp:29: Destroyed ACR (0x7f474c022110)
21-09-2017 15:53:32.239 UTC Info scscfsproutlet.cpp:714: Route request without applying services
21-09-2017 15:53:32.239 UTC Debug sproutletproxy.cpp:1535: Sproutlet send_request 0x7f474c020760
21-09-2017 15:53:32.239 UTC Verbose sproutletproxy.cpp:1576: scscf-proxy-0x7f474c010e50 sending Request msg REGISTER/cseq=2 (tdta0x7f474c020150) on fork 0
21-09-2017 15:53:32.239 UTC Debug sproutletproxy.cpp:1976: Processing actions from sproutlet - 0 responses, 1 requests, 0 timers
21-09-2017 15:53:32.239 UTC Debug sproutletproxy.cpp:2016: Processing request 0x7f474c0201f8, fork = 0
21-09-2017 15:53:32.239 UTC Debug sproutletproxy.cpp:2141: scscf-proxy-0x7f474c010e50 transmitting request on fork 0
21-09-2017 15:53:32.239 UTC Debug sproutletproxy.cpp:2156: scscf-proxy-0x7f474c010e50 store reference to non-ACK request Request msg REGISTER/cseq=2 (tdta0x7f474c020150) on fork 0
21-09-2017 15:53:32.239 UTC Debug sproutletproxy.cpp:1968: Removing message 0x7f474c020760 => txdata 0x7f474c0201f8 mapping
21-09-2017 15:53:32.239 UTC Debug sproutletproxy.cpp:163: Find target Sproutlet for request
21-09-2017 15:53:32.239 UTC Debug sproutletproxy.cpp:197: Found next routable URI: sip:scscf.ims.rmcore.net
21-09-2017 15:53:32.239 UTC Debug sproutletproxy.cpp:340: Possible service name scscf will be used if ims.rmcore.net<http://ims.rmcore.net> is a local hostname
21-09-2017 15:53:32.239 UTC Debug authenticationsproutlet.cpp:169: Authorization header in request
21-09-2017 15:53:32.239 UTC Debug authenticationsproutlet.cpp:177: Integrity protected with ip-assoc-pending
21-09-2017 15:53:32.239 UTC Verbose sproutletproxy.cpp:1298: Created Sproutlet authentication-0x7f474c022150 for Request msg REGISTER/cseq=2 (tdta0x7f474c020150)
21-09-2017 15:53:32.239 UTC Verbose sproutletproxy.cpp:2290: Routing Request msg REGISTER/cseq=2 (tdta0x7f474c020150) (1347 bytes) to downstream sproutlet authentication:
--start msg?

REGISTER sip:scscf.ims.rmcore.net SIP/2.0
Via: SIP/2.0/TCP 10.0.0.222:5058;rport=33214;received=10.0.0.222;branch=z9hG4bKPj1JagMaULIh8xrGTU49BsvwXp7aQVjv9S
Path: <sip:En9ykhc3CE at 10.0.0.222:5058;transport=TCP;lr;ob>
Via: SIP/2.0/UDP 212.159.106.131:59124;rport=59124;received=212.159.106.131;branch=z9hG4bK-524287-1?07005d66d0f9415a
Max-Forwards: 67
Contact: <sip:83555000001 at 212.159.106.131:59124;rinstance=39865f51c2a988a3>
To: "Jim at IMS" <sip:83555000001 at ims.rmcore.net>
From: "Jim at IMS" <sip:83555000001 at ims.rmcore.net>;tag=e2a4b510
Call-ID: 85656NGM0NGZkNDM3YjVhZTNhZWY3OWNmYzQ1NDc4MjM3ZTQ
CSeq: 2 REGISTER
Expires: 3600
Allow: SUBSCRIBE, NOTIFY, INVITE, ACK, CANCEL, BYE, REFER, INFO, OPTIONS
User-Agent: Bria 4 release 4.8.2 stamp 85656
P-Visited-Network-ID: ims.rmcore.net<http://ims.rmcore.net>
P-Charging-Function-Addresses: ccf=cdf.ims.rmcore.net<http://cdf.ims.rmcore.net>
P-Charging-Vector: icid-value="85656NGM0NGZkNDM3YjVhZTNhZWY3OWNmYzQ1NDc4MjM3ZTQ";icid-generated-at=ec2-52-56-52-145.eu-west-2.compute.amazonaws.com<http://ec2-52-56-52-145.eu-west-2.compute.amazonaws.com>
Authorization: Digest response="5a39ea19aeafcf955924b29a9a375451", username="83555000001 at ims.rmcore.net<mailto:83555000001 at ims.rmcore.net>", realm="ims.rmcore.net<http://ims.rmcore.net>", nonce="63bff4bb68c27b47", uri="sip:ims.rmcore.net", algorithm=MD5, cnonce="c549e7ca56a2867a6e23caf77a3c629a", opaque="5a5a8de45658f637", qop=auth, nc=00000002,integrity-protected=ip-assoc-pending
Content-Length:  0


--end msg?
21-09-2017 15:53:32.240 UTC Debug pjutils.cpp:700: Cloned tdta0x7f474c020150 to tdta0x7f474c022360
21-09-2017 15:53:32.240 UTC Debug sproutletproxy.cpp:1961: Adding message 0x7f474c022970 => txdata 0x7f474c022408 mapping
21-09-2017 15:53:32.240 UTC Verbose sproutletproxy.cpp:1806: authentication-0x7f474c022150 pass initial request Request msg REGISTER/cseq=2 (tdta0x7f474c022360) to Sproutlet
21-09-2017 15:53:32.240 UTC Debug authenticationsproutlet.cpp:873: Authentication module invoked
21-09-2017 15:53:32.240 UTC Debug sproutletproxy.cpp:340: Possible service name scscf will be used if sprout.ims.rmcore.net<http://sprout.ims.rmcore.net> is a local hostname
21-09-2017 15:53:32.240 UTC Debug sproutletproxy.cpp:340: Possible service name scscf will be used if ims.rmcore.net<http://ims.rmcore.net> is a local hostname
21-09-2017 15:53:32.240 UTC Debug authenticationsproutlet.cpp:1456: Lookup IMPI object: impi=83555000001 at ims.rmcore.net<mailto:impi=83555000001 at ims.rmcore.net>
21-09-2017 15:53:32.240 UTC Debug memcachedstore.cpp:295: Start GET from table impi for key 83555000001 at ims.rmcore.net<mailto:83555000001 at ims.rmcore.net>
21-09-2017 15:53:32.240 UTC Debug astaire_resolver.cpp:47: AstaireResolver::resolve for host vellum.ims.rmcore.net<http://vellum.ims.rmcore.net>, family 2
21-09-2017 15:53:32.240 UTC Debug utils.cpp:377: Malformed host/port vellum.ims.rmcore.net<http://vellum.ims.rmcore.net>
21-09-2017 15:53:32.240 UTC Debug utils.cpp:418: Attempt to parse vellum.ims.rmcore.net<http://vellum.ims.rmcore.net> as IP address
21-09-2017 15:53:32.240 UTC Verbose dnscachedresolver.cpp:468: Check cache for vellum.ims.rmcore.net<http://vellum.ims.rmcore.net> type 1
21-09-2017 15:53:32.240 UTC Debug dnscachedresolver.cpp:570: Pulling 1 records from cache for vellum.ims.rmcore.net<http://vellum.ims.rmcore.net> A
21-09-2017 15:53:32.240 UTC Debug baseresolver.cpp:369: Found 1 A/AAAA records, creating iterator
21-09-2017 15:53:32.240 UTC Debug baseresolver.cpp:920: Attempting to get 2 targets for host:vellum.ims.rmcore.net<http://vellum.ims.rmcore.net>. allowed_host_state = 3
21-09-2017 15:53:32.240 UTC Debug baseresolver.cpp:793: 10.0.0.6:11311;transport=TCP has state: WHITE
21-09-2017 15:53:32.240 UTC Debug baseresolver.cpp:793: 10.0.0.6:11311;transport=TCP has state: WHITE
21-09-2017 15:53:32.240 UTC Debug baseresolver.cpp:997: Added a whitelisted server to targets, now have 1 of 2
21-09-2017 15:53:32.240 UTC Debug memcachedstore.cpp:696: Found 1 targets for vellum.ims.rmcore.net<http://vellum.ims.rmcore.net>
21-09-2017 15:53:32.240 UTC Debug memcachedstore.cpp:721: Duplicate target IP=10.0.0.6, port= 11311 as it is the only target
21-09-2017 15:53:32.240 UTC Debug memcachedstore.cpp:249: Try server IP 10.0.0.6, port 11311
21-09-2017 15:53:32.240 UTC Debug connection_pool.h:207: Request for connection to IP: 10.0.0.6, port: 11311
21-09-2017 15:53:32.240 UTC Debug connection_pool.h:220: Found existing connection 0x7f470c06a3e0 in pool
21-09-2017 15:53:32.240 UTC Debug memcachedstore.cpp:74: Fetch result
21-09-2017 15:53:32.240 UTC Debug memcachedstore.cpp:82: Found record on replica
21-09-2017 15:53:32.240 UTC Debug memcachedstore.cpp:260: libmemcached returned 0
21-09-2017 15:53:32.240 UTC Debug connection_pool.h:244: Release connection to IP: 10.0.0.6, port: 11311 to pool
21-09-2017 15:53:32.240 UTC Debug memcachedstore.cpp:339: Read 268 bytes from table impi key 83555000001 at ims.rmcore.net<mailto:83555000001 at ims.rmcore.net>, CAS = 18873
21-09-2017 15:53:32.240 UTC Debug astaire_impistore.cpp:177: Retrieved IMPI for 83555000001 at ims.rmcore.net<mailto:83555000001 at ims.rmcore.net>
{"authChallenges":[{"type":"digest","nonce":"63bff4bb68c27b47","nc":2,"expires":1506009512,"correlator":"z9hG4bKPj868.WzubxOAj3T1s2dS1BU0qM0Zj-kpZ","scscf-uri":"sip:scscf.ims.rmcore.net","realm":"ims.rmcore.net<http://ims.rmcore.net>","qop":"auth","ha1":"b144b84f59356acbb86048bf3eb5f48f?}]}
21-09-2017 15:53:32.240 UTC Debug authenticationsproutlet.cpp:994: Verify authentication information in request
21-09-2017 15:53:32.240 UTC Debug authenticationsproutlet.cpp:482: Found Digest HA1 = b144b84f59356acbb86048bf3eb5f48f
21-09-2017 15:53:32.240 UTC Debug authenticationsproutlet.cpp:1006: Request authenticated successfully
21-09-2017 15:53:32.240 UTC Debug authenticationsproutlet.cpp:1033: Storing challenge because nonce counts are supported
21-09-2017 15:53:32.240 UTC Debug astaire_impistore.cpp:134: Storing IMPI for 83555000001 at ims.rmcore.net<mailto:83555000001 at ims.rmcore.net>
{"authChallenges":[{"type":"digest","nonce":"63bff4bb68c27b47","nc":3,"expires":1506009512,"correlator":"z9hG4bKPj868.WzubxOAj3T1s2dS1BU0qM0Zj-kpZ","scscf-uri":"sip:scscf.ims.rmcore.net","realm":"ims.rmcore.net<http://ims.rmcore.net>","qop":"auth","ha1":"b144b84f59356acbb86048bf3eb5f48f?}]}
21-09-2017 15:53:32.240 UTC Debug memcachedstore.cpp:413: Writing 268 bytes to table impi key 83555000001 at ims.rmcore.net<mailto:83555000001 at ims.rmcore.net>, CAS = 18873, expiry = 300
21-09-2017 15:53:32.240 UTC Debug astaire_resolver.cpp:47: AstaireResolver::resolve for host vellum.ims.rmcore.net<http://vellum.ims.rmcore.net>, family 2
21-09-2017 15:53:32.240 UTC Debug utils.cpp:377: Malformed host/port vellum.ims.rmcore.net<http://vellum.ims.rmcore.net>
21-09-2017 15:53:32.240 UTC Debug utils.cpp:418: Attempt to parse vellum.ims.rmcore.net<http://vellum.ims.rmcore.net> as IP address
21-09-2017 15:53:32.240 UTC Verbose dnscachedresolver.cpp:468: Check cache for vellum.ims.rmcore.net<http://vellum.ims.rmcore.net> type 1
21-09-2017 15:53:32.240 UTC Debug dnscachedresolver.cpp:570: Pulling 1 records from cache for vellum.ims.rmcore.net<http://vellum.ims.rmcore.net> A
21-09-2017 15:53:32.240 UTC Debug baseresolver.cpp:369: Found 1 A/AAAA records, creating iterator
21-09-2017 15:53:32.240 UTC Debug baseresolver.cpp:920: Attempting to get 2 targets for host:vellum.ims.rmcore.net<http://vellum.ims.rmcore.net>. allowed_host_state = 3
21-09-2017 15:53:32.240 UTC Debug baseresolver.cpp:793: 10.0.0.6:11311;transport=TCP has state: WHITE
21-09-2017 15:53:32.240 UTC Debug baseresolver.cpp:793: 10.0.0.6:11311;transport=TCP has state: WHITE
21-09-2017 15:53:32.240 UTC Debug baseresolver.cpp:997: Added a whitelisted server to targets, now have 1 of 2
21-09-2017 15:53:32.241 UTC Debug memcachedstore.cpp:696: Found 1 targets for vellum.ims.rmcore.net<http://vellum.ims.rmcore.net>
21-09-2017 15:53:32.241 UTC Debug memcachedstore.cpp:721: Duplicate target IP=10.0.0.6, port= 11311 as it is the only target
21-09-2017 15:53:32.241 UTC Debug memcachedstore.cpp:249: Try server IP 10.0.0.6, port 11311
21-09-2017 15:53:32.241 UTC Debug connection_pool.h:207: Request for connection to IP: 10.0.0.6, port: 11311
21-09-2017 15:53:32.241 UTC Debug connection_pool.h:220: Found existing connection 0x7f470c06a3e0 in pool
21-09-2017 15:53:32.241 UTC Debug memcachedstore.cpp:260: libmemcached returned 0
21-09-2017 15:53:32.241 UTC Debug connection_pool.h:244: Release connection to IP: 10.0.0.6, port: 11311 to pool
21-09-2017 15:53:32.241 UTC Debug memcachedstore.cpp:555: Write successful
21-09-2017 15:53:32.241 UTC Debug authenticationsproutlet.cpp:1178: Updated Authorization header with new nc and response
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:427: Creating URI for service registrar
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:340: Possible service name scscf will be used if ims.rmcore.net<http://ims.rmcore.net> is a local hostname
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:453: Constructed URI sip:ims.rmcore.net;lr;service=registrar
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:1535: Sproutlet send_request 0x7f474c022970
21-09-2017 15:53:32.241 UTC Verbose sproutletproxy.cpp:1576: authentication-0x7f474c022150 sending Request msg REGISTER/cseq=2 (tdta0x7f474c022360) on fork 0
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:1976: Processing actions from sproutlet - 0 responses, 1 requests, 0 timers
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:2016: Processing request 0x7f474c022408, fork = 0
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:2141: authentication-0x7f474c022150 transmitting request on fork 0
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:2156: authentication-0x7f474c022150 store reference to non-ACK request Request msg REGISTER/cseq=2 (tdta0x7f474c022360) on fork 0
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:1968: Removing message 0x7f474c022970 => txdata 0x7f474c022408 mapping
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:163: Find target Sproutlet for request
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:197: Found next routable URI: sip:ims.rmcore.net;lr;service=registrar
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:300: Found services param - registrar
21-09-2017 15:53:32.241 UTC Debug uri_classifier.cpp:139: home domain: false, local_to_node: false, is_gruu: false, enforce_user_phone: false, prefer_sip: true, treat_number_as_phone: false
21-09-2017 15:53:32.241 UTC Debug uri_classifier.cpp:185: Classified URI as 5
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:427: Creating URI for service subscription
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:300: Found services param - registrar
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:453: Constructed URI sip:ims.rmcore.net;lr;service=subscription
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:1200: Remove top Route header Route: <sip:ims.rmcore.net;lr;service=registrar>
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:163: Find target Sproutlet for request
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:197: Found next routable URI: sip:ims.rmcore.net;lr;service=subscription
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:300: Found services param - subscription
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:427: Creating URI for service scscf-proxy
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:300: Found services param - subscription
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:453: Constructed URI sip:ims.rmcore.net;lr;service=scscf-proxy
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:1200: Remove top Route header Route: <sip:ims.rmcore.net;lr;service=subscription>
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:163: Find target Sproutlet for request
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:197: Found next routable URI: sip:ims.rmcore.net;lr;service=scscf-proxy
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:300: Found services param - scscf-proxy
21-09-2017 15:53:32.241 UTC Debug scscfsproutlet.cpp:489: S-CSCF Transaction (0x7f474c011150) created
21-09-2017 15:53:32.241 UTC Verbose sproutletproxy.cpp:1298: Created Sproutlet scscf-proxy-0x7f474c011150 for Request msg REGISTER/cseq=2 (tdta0x7f474c022360)
21-09-2017 15:53:32.241 UTC Verbose sproutletproxy.cpp:2290: Routing Request msg REGISTER/cseq=2 (tdta0x7f474c022360) (1399 bytes) to downstream sproutlet scscf-proxy:
--start msg?

REGISTER sip:scscf.ims.rmcore.net SIP/2.0
Route: <sip:ims.rmcore.net;lr;service=scscf-proxy>
Via: SIP/2.0/TCP 10.0.0.222:5058;rport=33214;received=10.0.0.222;branch=z9hG4bKPj1JagMaULIh8xrGTU49BsvwXp7aQVjv9S
Path: <sip:En9ykhc3CE at 10.0.0.222:5058;transport=TCP;lr;ob>
Via: SIP/2.0/UDP 212.159.106.131:59124;rport=59124;received=212.159.106.131;branch=z9hG4bK-524287-1?07005d66d0f9415a
Max-Forwards: 66
Contact: <sip:83555000001 at 212.159.106.131:59124;rinstance=39865f51c2a988a3>
To: "Jim at IMS" <sip:83555000001 at ims.rmcore.net>
From: "Jim at IMS" <sip:83555000001 at ims.rmcore.net>;tag=e2a4b510
Call-ID: 85656NGM0NGZkNDM3YjVhZTNhZWY3OWNmYzQ1NDc4MjM3ZTQ
CSeq: 2 REGISTER
Expires: 3600
Allow: SUBSCRIBE, NOTIFY, INVITE, ACK, CANCEL, BYE, REFER, INFO, OPTIONS
User-Agent: Bria 4 release 4.8.2 stamp 85656
P-Visited-Network-ID: ims.rmcore.net<http://ims.rmcore.net>
P-Charging-Function-Addresses: ccf=cdf.ims.rmcore.net<http://cdf.ims.rmcore.net>
P-Charging-Vector: icid-value="85656NGM0NGZkNDM3YjVhZTNhZWY3OWNmYzQ1NDc4MjM3ZTQ";icid-generated-at=ec2-52-56-52-145.eu-west-2.compute.amazonaws.com<http://ec2-52-56-52-145.eu-west-2.compute.amazonaws.com>
Authorization: Digest response="54ade38e11b464bf9fcde6f464c7d9e8", username="83555000001 at ims.rmcore.net<mailto:83555000001 at ims.rmcore.net>", realm="ims.rmcore.net<http://ims.rmcore.net>", nonce="63bff4bb68c27b47", uri="sip:ims.rmcore.net", algorithm=MD5, cnonce="c549e7ca56a2867a6e23caf77a3c629a", opaque="5a5a8de45658f637", qop=auth, nc=00000003,integrity-protected=ip-assoc-pending
Content-Length:  0


--end msg?

Any idea what?s going wrong here?

Thanks
Jim

RedMatter Ltd
Jim Page
VP Mobile Services
+44 (0)333 150 1666
+44 (0)7870 361412
jim.page at redmatter.com<mailto:jim.page at redmatter.com>

On 21 Sep 2017, at 15:38, Jim Page <jim.page at redmatter.com<mailto:jim.page at redmatter.com>> wrote:

Hi Clearwater people

I could really do with your help with the below. I have a pretty much bog standard setup, standard build with chef in AWS, plus an openimscore HSS instance. I am currently unable to get any sip devices to register due to an apparent issue nonce counting. Can you help? In parallel I am trying to hack the code to work around the issue ? but I can?t believe this isn?t a common scenario with a simple solution ? ?

Thanks in advance ?

Jim

RedMatter Ltd
Jim Page
VP Mobile Services
+44 (0)333 150 1666
+44 (0)7870 361412
jim.page at redmatter.com<mailto:jim.page at redmatter.com>

On 17 Sep 2017, at 18:38, Jim Page <jim.page at redmatter.com<mailto:jim.page at redmatter.com>> wrote:

Hi There

I initially set up my IMS in an AWS VPC, using chef. It worked out of the box without an HSS, I was able to use Ellis to provision accounts and they registered no problem using Bria 4. I decided to add an HSS (using ?knife box? to add an openimscore HSS instance) so that I can test our application servers. Now that I have the HSS integrated (there were niggles in the installation), I provisioned a new user on the HSS but the Bria phone will not authenticate, and a feedback loop is generated on the first REGISTER attempt. The problem seems to be related to nonce counting. The process seems to go like this:

UE REGISTER -> Bono
Bono REGISTER -> icscf
  No Authorization. Challenge is built, and IMPI is created with nc=1, and stored
icscf 401 -> Bono
Bono 401 -> UE
  UE builds an Authorisation header
UE REGISTER -> Bono
Bono REGISTER -> icscf
  The Authorisation header contains nc=000001.
  IMPI is loaded and validation is successful.
  IMPI is stored with nc=2, log line 'Debug authenticationsproutlet.cpp:1033: Storing challenge because nonce counts are supported?
icscf REGISTER -> scscf-proxy
  The Authorisation header still contains nc=000001.
  IMPI is loaded, but log line says: 'Info authenticationsproutlet.cpp:971: Nonce count supplied (1) is lower than expected (2) - ignore it?
  The Authorisation header is ignored and another 401 challenge is issued, and the UE responds ?. and this causes a loop
scscf-proxy 401 -> icscf
icscf 401 -> Bono
Bono 401 -> UE

There seems to be a fundamental flaw here. The IMPI nc is incrementing, but the Authorisation header is not. I can?t see how this can work unless icscf increments nc in the authorisation header before sending it to the scscf

Also please note: I disabled nonce_count_supported in shared_config, but the result was a log line ?nonce count is supplied but not supported? (or words to that effect) and the Authorisation header is again ignored, and there is a loop.

How to move forward from here? I have searched in vain for a way to disable nonce count in Bria 4.

I can provide logs if helpful, but they are long and I don?t want to clog everyone?s inbox.

Kind regards
Jim

RedMatter Ltd
Jim Page
VP Mobile Services
+44 (0)333 150 1666
+44 (0)7870 361412
jim.page at redmatter.com<mailto:jim.page at redmatter.com>

_______________________________________________
Clearwater mailing list
Clearwater at lists.projectclearwater.org<mailto:Clearwater at lists.projectclearwater.org>
http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org

_______________________________________________
Clearwater mailing list
Clearwater at lists.projectclearwater.org<mailto:Clearwater at lists.projectclearwater.org>
http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20170922/be31524d/attachment.html>

From Matt.Williams at metaswitch.com  Fri Sep 22 05:31:07 2017
From: Matt.Williams at metaswitch.com (Matt Williams)
Date: Fri, 22 Sep 2017 09:31:07 +0000
Subject: [Project Clearwater] clearwater Installation using source code
 -- Help
In-Reply-To: <D66B6ECD-C978-40B7-AE1E-E51C85D677A8@redmatter.com>
References: <HE1PR05MB137061BF76FBAC3347167854FC660@HE1PR05MB1370.eurprd05.prod.outlook.com>
	<50C2CE0B-EBCA-4EB1-B493-F66DF7EEC5E8@redmatter.com>
	<D8F81832-9566-464A-9D8B-8BD2F99B83FD@gmail.com>
	<14312422-BE83-49E5-BADF-D1490E65B5D8@redmatter.com>
	<588DC1BC-44CC-443A-A8BC-2735CDCE88F5@gmail.com>
	<D66B6ECD-C978-40B7-AE1E-E51C85D677A8@redmatter.com>
Message-ID: <CY4PR02MB28875C8676FBB0C1A68588FB90670@CY4PR02MB2887.namprd02.prod.outlook.com>

Abraham,

Just to check, I think you're looking to create a basic VoLTE deployment:

?         an IMS core consisting of P-CSCF, I-CSCF, S-CSCF and HSS (no IR.92 TAS, but that's probably OK)

?         an EPC

?         the IMS core communicating with

o   the UE (via the EPC) over the (SIP) Gm interface for call signaling

o   the EPC via the (Diameter) Rx interface for QoS control?

Am I right in suggesting that you want to use Rx to control the EPC to set up the dedicated bearers?  (That would be the standard way.)

If so, unfortunately, Project Clearwater doesn't currently support the Rx interface to the EPC.  I don't believe OpenIMSCore does, either.  We'd be happy if you wanted to make this enhancement, but I suspect it's quite a big undertaking!

Metaswitch, the company that developed Clearwater (and for which I work) does have a VoLTE Solution (https://www.metaswitch.com/voice-over-lte-volte-and-voice-over-wifi-vowifi-solution) that supports the Rx interface, but this uses proprietary components which aren't part of open-source Project Clearwater.

I hope that helps!

Matt


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Jim Page
Sent: 21 September 2017 14:51
To: clearwater at lists.projectclearwater.org
Subject: Re: [Project Clearwater] clearwater Installation using source code -- Help

Yes you have to have some DNS set up. Details are in the documentation. You need to have more than just A records to get this working properly ? so yes really you need to have DNS set up.

I have no idea what the parameters are though at a guess I would say that your home domain is everything to the right of the @ in your sip URIs, and the homestead cluster is the host name or IP address of the machine running homestead (dime, in my case). But that?s why I suggested actually running the binaries slightly differently; once you have installed the working system you can just create links from where the init scripts expect the production binaries to be to point to your built binaries.

It?s quite an assignment. If I were you I would consider using openimscore instead of clearwater. It looks easier to build from source and I can see QOS is something that has been discussed on their forums. You might also want to look at this: http://ieeexplore.ieee.org/document/5532766/?reload=true

The EPC I can?t help you with.

Good luck!


RedMatter Ltd
Jim Page
VP Mobile Services
+44 (0)333 150 1666
+44 (0)7870 361412
jim.page at redmatter.com<mailto:jim.page at redmatter.com>

On 21 Sep 2017, at 14:32, Afriyie Abraham Kwabena <afriyie.abraham at gmail.com<mailto:afriyie.abraham at gmail.com>> wrote:

As part of my school special assignment, i have install an EPC and need to connect it to an IMS
such that a dedicated bearer is created with a specific QoS for clearwater traffic or a call session.
This is my task. However as you suggested, it would have been better to go the VM way but am not
required to do that, am ask to install using the source code and also have to install the components
on a single machine which is very hard.

BTW,
I have tried to build Sprout and bono, link: https://github.com/Metaswitch/sprout/blob/dev/docs/Development.md
but running the following command hang on my terminal, how to


./MIBS="" LD_LIBRARY_PATH=usr/lib:$LD_LIBRARY_PATH build/bin/sprout -t --domain=<Home Domain> --hss=<Homestead cluster>
Also what would be the parameter for the  - - hss=<Homestead cluster> ?  Do i need to have a DNS installed to handle the domain name
for all the components?

BR
Abraham


On 21 Sep 2017, at 16:00, Jim Page <jim.page at redmatter.com<mailto:jim.page at redmatter.com>> wrote:

If you have to run it on a single machine built from source, I guess your best option is to start here http://clearwater.readthedocs.io/en/stable/Manual_Install.html and just use a single host instead of 6. I guess it must be possible to some degree otherwise it wouldn?t be possible to create an all-in-one image. But you are making life hard for yourself by not going down the VM route. I would do the same thing however - install clearwater using production packages using apt-get, then once you have it working, selectively rebuild the component you want to change.

I am not sure what you want to achieve by adding QOS to clearwater. I don?t see what relevance QOS has where the only service you have running is VOIP. QOS is only useful if you want to prioritise one type of traffic over another, and is only relevant where you have different types of traffic trying to get access to a limited resource such as an MPLS line or a broadband line, in which case you set the QOS up in the router that sends traffic down that line. What is it exactly that you are trying to do?

RedMatter Ltd
Jim Page
VP Mobile Services
+44 (0)333 150 1666
+44 (0)7870 361412
jim.page at redmatter.com<mailto:jim.page at redmatter.com>

On 21 Sep 2017, at 13:47, Afriyie Abraham Kwabena <afriyie.abraham at gmail.com<mailto:afriyie.abraham at gmail.com>> wrote:

Hi,

My task is to install all the components of Clearwater on the same machine (ubuntu 14.04). In your explanation it means I need to have different hosts for each component but that is not my plan.
Is it possible to install all components without using docker or any virtualization platform.
Also for QoS, which component do you suggest I should modify.

Sorry I may be asking basics, am newbie.

BR
Abraham


Sent from my iPhone

On 21 Sep 2017, at 15.17, Jim Page <jim.page at redmatter.com<mailto:jim.page at redmatter.com>> wrote:
My recommendation (as a newbie) is to build a working release version of clearwater first, using these installation instructions: http://clearwater.readthedocs.io/en/stable/Installation_Instructions.html

Once you have a basic working install, decide what component you want to rebuild, and build it on the host for that component. In my case I did this with sprout:

1. go to https://github.com/Metaswitch/sprout
2. Fork the repo: generic instructions here https://gist.github.com/Chaser324/ce0505fbed06b947d962
3. Carefully read README.md
4. go here for build instructions https://github.com/Metaswitch/sprout/blob/dev/docs/Development.md
5. Fork the repo and clone the forked repo on your local sprout host. Create a feature branch if you intend to push your changes back to clearwater.
6. Modify the sprout source as you see fit, and build sprout following the instructions in Development.md
7. When the build is complete, replace /usr/share/clearwater/bin/sprout and /sur/share/clearwater/sprout/plugins/*.so with links to your development builds in <your build dir>/sprout/build/bin.
8. ?sudo system sprout restart? - now you are running a fully working clearwater setup with your own sprout build (assuming you have not broken sprout with your changes!).

Hope this helps
Cheers
Jim

RedMatter Ltd
Jim Page
VP Mobile Services
+44 (0)333 150 1666
+44 (0)7870 361412
jim.page at redmatter.com<mailto:jim.page at redmatter.com>

On 21 Sep 2017, at 11:59, Afriyie Abraham <afriyie.abraham at hotmail.com<mailto:afriyie.abraham at hotmail.com>> wrote:

Hi,

I have tried installing clearwater using the source code following the procedure
in the documentation but not working.

My main aim is to be able to have a device to device call session through my EPC
connecting the IMS(clearwater).
Also i would like to add some QoS parameters to for every call session.
plan:

UE ??????EPC ??????IMS

Please can anyone help me with a working source code procedure to install clearwater
on ubuntu 14.04.

Thanks in advance.

BR
Abraham

_______________________________________________
Clearwater mailing list
Clearwater at lists.projectclearwater.org<mailto:Clearwater at lists.projectclearwater.org>
http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org

_______________________________________________
Clearwater mailing list
Clearwater at lists.projectclearwater.org<mailto:Clearwater at lists.projectclearwater.org>
http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org
_______________________________________________
Clearwater mailing list
Clearwater at lists.projectclearwater.org<mailto:Clearwater at lists.projectclearwater.org>
http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org

_______________________________________________
Clearwater mailing list
Clearwater at lists.projectclearwater.org<mailto:Clearwater at lists.projectclearwater.org>
http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org

_______________________________________________
Clearwater mailing list
Clearwater at lists.projectclearwater.org<mailto:Clearwater at lists.projectclearwater.org>
http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20170922/1faa0616/attachment.html>

From jim.page at redmatter.com  Fri Sep 22 05:44:21 2017
From: jim.page at redmatter.com (Jim Page)
Date: Fri, 22 Sep 2017 09:44:21 +0000
Subject: [Project Clearwater] Looping authentication with Bria
In-Reply-To: <921BDA9A-996C-4A60-BF4F-5A855BB634C2@redmatter.com>
References: <A08CF3C9-DCAB-46F3-A7AE-3E597E865129@redmatter.com>
	<C4025817-3A23-4856-8613-717AA07D40AC@redmatter.com>
	<C0E6789C-515C-4A39-BDB1-28BCB1183EE9@redmatter.com>
	<CY4PR02MB288723F16B75130EBE30F89290670@CY4PR02MB2887.namprd02.prod.outlook.com>
	<921BDA9A-996C-4A60-BF4F-5A855BB634C2@redmatter.com>
Message-ID: <24D731B5-B35D-41F1-88EA-376D79916814@redmatter.com>

Looking at the bria pcap: it doesn?t supply a route header, and sends to port 5060. No problem to change the port, obviously, if that would help but I?m not sure how to get it to add a route header, it?s not very customisable.

The curious thing is that this worked on my setup before I added in the HSS.

Let me know if the debug info I sent didn?t get to you.

And regards
Jim

RedMatter Ltd
Jim Page
VP Mobile Services
+44 (0)333 150 1666
+44 (0)7870 361412
jim.page at redmatter.com<mailto:jim.page at redmatter.com>

On 22 Sep 2017, at 10:27, Jim Page <jim.page at redmatter.com<mailto:jim.page at redmatter.com>> wrote:

Hi Matt

Thanks a lot for getting in touch.

I have attached PCAPs of the bria (just sip) and the bono and sprout hosts (everything). Also the bono and sprout logs at log_level=5. I have copied this email to your metaswitch email in case the zip is removed from the forum emails, hope that?s ok.

Your explanation makes sense - let?s hope it?s an easy fix!

This is my #1 priority right now so please let me know if there?s anything else I can do to help debug this.

Kind regards
Jim
<BriaDebug.zip>

RedMatter Ltd
Jim Page
VP Mobile Services
+44 (0)333 150 1666
+44 (0)7870 361412
jim.page at redmatter.com<mailto:jim.page at redmatter.com>

On 22 Sep 2017, at 10:04, Matt Williams <Matt.Williams at metaswitch.com<mailto:Matt.Williams at metaswitch.com>> wrote:

Jim,

Apologies - I didn't see this new email when I replied to your previous one.

The S-CSCF behavior is divided up into multiple chunks ("Sproutlets"), and we seem to be invoking the "scscf-proxy" chunk, which is responsible for processing dialog-related messages (rather than REGISTERs).  This is why it is trying to route the message on towards the "callee" (i.e. the request URI) - unfortunately, that also resolves to ourselves.

Would you be able to share the logs from the point that the request first hits Bono, right through until it gets into this loop?

(I think we just have a URI misconfigured somewhere - that should be set up correctly by the Chef scripts, but there must be a bug there.)

Thanks,

Matt


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Jim Page
Sent: 21 September 2017 18:26
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] Looping authentication with Bria

Right - I have made a change in sprout that updates the REGISTER Authorisation header so that the nc is incremented and a new hash is written into the response. The authentication is now successful. Unfortunately what happens is that once the registration is complete, the same REGISTER request is sent over and over and over to the scscf-proxy sproutlet until the hops limit is reached.

What exactly is supposed to happen here? According to the flow I have, once the registration on the SCSCF is successful it should send an SAR to the HSS, after which the SCSCF should return 200 OK to the ISCSCF, and so on back to the UE. I cannot see any sign the SAR request is taking place, though I can see the UAR query from the ISCSCF. Here is a section of log from sprout from the moment the REGISTER is first presented to the scscf-proxy sproutlet until the start of the first loop:

21-09-2017 15:53:32.239 UTC Debug scscfsproutlet.cpp:489: S-CSCF Transaction (0x7f474c010e50) created
21-09-2017 15:53:32.239 UTC Verbose sproutletproxy.cpp:1298: Created Sproutlet scscf-proxy-0x7f474c010e50 for Request msg REGISTER/cseq=2 (tdta0x7f474c01ce90)
21-09-2017 15:53:32.239 UTC Verbose sproutletproxy.cpp:2290: Routing Request msg REGISTER/cseq=2 (tdta0x7f474c01ce90) (1399 bytes) to downstream sproutlet scscf-proxy:
--start msg?

REGISTER sip:scscf.ims.rmcore.net SIP/2.0
Route: <sip:ims.rmcore.net;lr;service=scscf-proxy>
Via: SIP/2.0/TCP 10.0.0.222:5058;rport=33214;received=10.0.0.222;branch=z9hG4bKPj1JagMaULIh8xrGTU49BsvwXp7aQVjv9S
Path: <sip:En9ykhc3CE at 10.0.0.222:5058;transport=TCP;lr;ob>
Via: SIP/2.0/UDP 212.159.106.131:59124;rport=59124;received=212.159.106.131;branch=z9hG4bK-524287-1?07005d66d0f9415a
Max-Forwards: 68
Contact: <sip:83555000001 at 212.159.106.131:59124;rinstance=39865f51c2a988a3>
To: "Jim at IMS" <sip:83555000001 at ims.rmcore.net>
From: "Jim at IMS" <sip:83555000001 at ims.rmcore.net>;tag=e2a4b510
Call-ID: 85656NGM0NGZkNDM3YjVhZTNhZWY3OWNmYzQ1NDc4MjM3ZTQ
CSeq: 2 REGISTER
Expires: 3600
Allow: SUBSCRIBE, NOTIFY, INVITE, ACK, CANCEL, BYE, REFER, INFO, OPTIONS
User-Agent: Bria 4 release 4.8.2 stamp 85656
P-Visited-Network-ID: ims.rmcore.net<http://ims.rmcore.net/>
P-Charging-Function-Addresses: ccf=cdf.ims.rmcore.net<http://cdf.ims.rmcore.net/>
P-Charging-Vector: icid-value="85656NGM0NGZkNDM3YjVhZTNhZWY3OWNmYzQ1NDc4MjM3ZTQ";icid-generated-at=ec2-52-56-52-145.eu-west-2.compute.amazonaws.com<http://ec2-52-56-52-145.eu-west-2.compute.amazonaws.com/>
Authorization: Digest response="5a39ea19aeafcf955924b29a9a375451", username="83555000001 at ims.rmcore.net<mailto:83555000001 at ims.rmcore.net>", realm="ims.rmcore.net<http://ims.rmcore.net/>", nonce="63bff4bb68c27b47", uri="sip:ims.rmcore.net", algorithm=MD5, cnonce="c549e7ca56a2867a6e23caf77a3c629a", opaque="5a5a8de45658f637", qop=auth, nc=00000002,integrity-protected=ip-assoc-pending
Content-Length:  0


--end msg?
21-09-2017 15:53:32.239 UTC Debug pjutils.cpp:700: Cloned tdta0x7f474c01ce90 to tdta0x7f474c020150
21-09-2017 15:53:32.239 UTC Debug sproutletproxy.cpp:1364: Remove top Route header Route: <sip:ims.rmcore.net;lr;service=scscf-proxy>
21-09-2017 15:53:32.239 UTC Debug sproutletproxy.cpp:1961: Adding message 0x7f474c020760 => txdata 0x7f474c0201f8 mapping
21-09-2017 15:53:32.239 UTC Verbose sproutletproxy.cpp:1806: scscf-proxy-0x7f474c010e50 pass initial request Request msg REGISTER/cseq=2 (tdta0x7f474c020150) to Sproutlet
21-09-2017 15:53:32.239 UTC Info scscfsproutlet.cpp:536: S-CSCF received initial request
21-09-2017 15:53:32.239 UTC Debug uri_classifier.cpp:139: home domain: true, local_to_node: false, is_gruu: false, enforce_user_phone: false, prefer_sip: true, treat_number_as_phone: false
21-09-2017 15:53:32.239 UTC Debug uri_classifier.cpp:185: Classified URI as 4
21-09-2017 15:53:32.239 UTC Debug scscfsproutlet.cpp:993: Route header references this system
21-09-2017 15:53:32.239 UTC Debug scscfsproutlet.cpp:1039: No ODI token, or invalid ODI token, on request - logging ICID marker 85656NGM0NGZkNDM3YjVhZTNhZWY3OWNmYzQ1NDc4MjM3ZTQ for B2BUA AS correlation
21-09-2017 15:53:32.239 UTC Debug scscfsproutlet.cpp:1052: Got our Route header, session case term, OD=None
21-09-2017 15:53:32.239 UTC Debug uri_classifier.cpp:139: home domain: false, local_to_node: false, is_gruu: false, enforce_user_phone: false, prefer_sip: true, treat_number_as_phone: false
21-09-2017 15:53:32.239 UTC Debug uri_classifier.cpp:185: Classified URI as 5
21-09-2017 15:53:32.239 UTC Debug scscfsproutlet.cpp:1396: URI is not locally hosted
21-09-2017 15:53:32.239 UTC Debug acr.cpp:1787: Create RalfACR for node type S-CSCF with role Terminating
21-09-2017 15:53:32.239 UTC Debug acr.cpp:24: Created ACR (0x7f474c022110)
21-09-2017 15:53:32.239 UTC Debug acr.cpp:164: Created S-CSCF Ralf ACR
21-09-2017 15:53:32.239 UTC Debug acr.cpp:29: Destroyed ACR (0x7f474c022110)
21-09-2017 15:53:32.239 UTC Info scscfsproutlet.cpp:714: Route request without applying services
21-09-2017 15:53:32.239 UTC Debug sproutletproxy.cpp:1535: Sproutlet send_request 0x7f474c020760
21-09-2017 15:53:32.239 UTC Verbose sproutletproxy.cpp:1576: scscf-proxy-0x7f474c010e50 sending Request msg REGISTER/cseq=2 (tdta0x7f474c020150) on fork 0
21-09-2017 15:53:32.239 UTC Debug sproutletproxy.cpp:1976: Processing actions from sproutlet - 0 responses, 1 requests, 0 timers
21-09-2017 15:53:32.239 UTC Debug sproutletproxy.cpp:2016: Processing request 0x7f474c0201f8, fork = 0
21-09-2017 15:53:32.239 UTC Debug sproutletproxy.cpp:2141: scscf-proxy-0x7f474c010e50 transmitting request on fork 0
21-09-2017 15:53:32.239 UTC Debug sproutletproxy.cpp:2156: scscf-proxy-0x7f474c010e50 store reference to non-ACK request Request msg REGISTER/cseq=2 (tdta0x7f474c020150) on fork 0
21-09-2017 15:53:32.239 UTC Debug sproutletproxy.cpp:1968: Removing message 0x7f474c020760 => txdata 0x7f474c0201f8 mapping
21-09-2017 15:53:32.239 UTC Debug sproutletproxy.cpp:163: Find target Sproutlet for request
21-09-2017 15:53:32.239 UTC Debug sproutletproxy.cpp:197: Found next routable URI: sip:scscf.ims.rmcore.net
21-09-2017 15:53:32.239 UTC Debug sproutletproxy.cpp:340: Possible service name scscf will be used if ims.rmcore.net<http://ims.rmcore.net/> is a local hostname
21-09-2017 15:53:32.239 UTC Debug authenticationsproutlet.cpp:169: Authorization header in request
21-09-2017 15:53:32.239 UTC Debug authenticationsproutlet.cpp:177: Integrity protected with ip-assoc-pending
21-09-2017 15:53:32.239 UTC Verbose sproutletproxy.cpp:1298: Created Sproutlet authentication-0x7f474c022150 for Request msg REGISTER/cseq=2 (tdta0x7f474c020150)
21-09-2017 15:53:32.239 UTC Verbose sproutletproxy.cpp:2290: Routing Request msg REGISTER/cseq=2 (tdta0x7f474c020150) (1347 bytes) to downstream sproutlet authentication:
--start msg?

REGISTER sip:scscf.ims.rmcore.net SIP/2.0
Via: SIP/2.0/TCP 10.0.0.222:5058;rport=33214;received=10.0.0.222;branch=z9hG4bKPj1JagMaULIh8xrGTU49BsvwXp7aQVjv9S
Path: <sip:En9ykhc3CE at 10.0.0.222:5058;transport=TCP;lr;ob>
Via: SIP/2.0/UDP 212.159.106.131:59124;rport=59124;received=212.159.106.131;branch=z9hG4bK-524287-1?07005d66d0f9415a
Max-Forwards: 67
Contact: <sip:83555000001 at 212.159.106.131:59124;rinstance=39865f51c2a988a3>
To: "Jim at IMS" <sip:83555000001 at ims.rmcore.net>
From: "Jim at IMS" <sip:83555000001 at ims.rmcore.net>;tag=e2a4b510
Call-ID: 85656NGM0NGZkNDM3YjVhZTNhZWY3OWNmYzQ1NDc4MjM3ZTQ
CSeq: 2 REGISTER
Expires: 3600
Allow: SUBSCRIBE, NOTIFY, INVITE, ACK, CANCEL, BYE, REFER, INFO, OPTIONS
User-Agent: Bria 4 release 4.8.2 stamp 85656
P-Visited-Network-ID: ims.rmcore.net<http://ims.rmcore.net/>
P-Charging-Function-Addresses: ccf=cdf.ims.rmcore.net<http://cdf.ims.rmcore.net/>
P-Charging-Vector: icid-value="85656NGM0NGZkNDM3YjVhZTNhZWY3OWNmYzQ1NDc4MjM3ZTQ";icid-generated-at=ec2-52-56-52-145.eu-west-2.compute.amazonaws.com<http://ec2-52-56-52-145.eu-west-2.compute.amazonaws.com/>
Authorization: Digest response="5a39ea19aeafcf955924b29a9a375451", username="83555000001 at ims.rmcore.net<mailto:83555000001 at ims.rmcore.net>", realm="ims.rmcore.net<http://ims.rmcore.net/>", nonce="63bff4bb68c27b47", uri="sip:ims.rmcore.net", algorithm=MD5, cnonce="c549e7ca56a2867a6e23caf77a3c629a", opaque="5a5a8de45658f637", qop=auth, nc=00000002,integrity-protected=ip-assoc-pending
Content-Length:  0


--end msg?
21-09-2017 15:53:32.240 UTC Debug pjutils.cpp:700: Cloned tdta0x7f474c020150 to tdta0x7f474c022360
21-09-2017 15:53:32.240 UTC Debug sproutletproxy.cpp:1961: Adding message 0x7f474c022970 => txdata 0x7f474c022408 mapping
21-09-2017 15:53:32.240 UTC Verbose sproutletproxy.cpp:1806: authentication-0x7f474c022150 pass initial request Request msg REGISTER/cseq=2 (tdta0x7f474c022360) to Sproutlet
21-09-2017 15:53:32.240 UTC Debug authenticationsproutlet.cpp:873: Authentication module invoked
21-09-2017 15:53:32.240 UTC Debug sproutletproxy.cpp:340: Possible service name scscf will be used ifsprout.ims.rmcore.net<http://sprout.ims.rmcore.net/> is a local hostname
21-09-2017 15:53:32.240 UTC Debug sproutletproxy.cpp:340: Possible service name scscf will be used if ims.rmcore.net<http://ims.rmcore.net/> is a local hostname
21-09-2017 15:53:32.240 UTC Debug authenticationsproutlet.cpp:1456: Lookup IMPI object: impi=83555000001 at ims.rmcore.net<mailto:impi=83555000001 at ims.rmcore.net>
21-09-2017 15:53:32.240 UTC Debug memcachedstore.cpp:295: Start GET from table impi for key 83555000001 at ims.rmcore.net<mailto:83555000001 at ims.rmcore.net>
21-09-2017 15:53:32.240 UTC Debug astaire_resolver.cpp:47: AstaireResolver::resolve for host vellum.ims.rmcore.net<http://vellum.ims.rmcore.net/>, family 2
21-09-2017 15:53:32.240 UTC Debug utils.cpp:377: Malformed host/port vellum.ims.rmcore.net<http://vellum.ims.rmcore.net/>
21-09-2017 15:53:32.240 UTC Debug utils.cpp:418: Attempt to parse vellum.ims.rmcore.net<http://vellum.ims.rmcore.net/> as IP address
21-09-2017 15:53:32.240 UTC Verbose dnscachedresolver.cpp:468: Check cache for vellum.ims.rmcore.net<http://vellum.ims.rmcore.net/> type 1
21-09-2017 15:53:32.240 UTC Debug dnscachedresolver.cpp:570: Pulling 1 records from cache for vellum.ims.rmcore.net<http://vellum.ims.rmcore.net/> A
21-09-2017 15:53:32.240 UTC Debug baseresolver.cpp:369: Found 1 A/AAAA records, creating iterator
21-09-2017 15:53:32.240 UTC Debug baseresolver.cpp:920: Attempting to get 2 targets for host:vellum.ims.rmcore.net<http://vellum.ims.rmcore.net/>. allowed_host_state = 3
21-09-2017 15:53:32.240 UTC Debug baseresolver.cpp:793: 10.0.0.6:11311;transport=TCP has state: WHITE
21-09-2017 15:53:32.240 UTC Debug baseresolver.cpp:793: 10.0.0.6:11311;transport=TCP has state: WHITE
21-09-2017 15:53:32.240 UTC Debug baseresolver.cpp:997: Added a whitelisted server to targets, now have 1 of 2
21-09-2017 15:53:32.240 UTC Debug memcachedstore.cpp:696: Found 1 targets for vellum.ims.rmcore.net<http://vellum.ims.rmcore.net/>
21-09-2017 15:53:32.240 UTC Debug memcachedstore.cpp:721: Duplicate target IP=10.0.0.6, port= 11311 as it is the only target
21-09-2017 15:53:32.240 UTC Debug memcachedstore.cpp:249: Try server IP 10.0.0.6, port 11311
21-09-2017 15:53:32.240 UTC Debug connection_pool.h:207: Request for connection to IP: 10.0.0.6, port: 11311
21-09-2017 15:53:32.240 UTC Debug connection_pool.h:220: Found existing connection 0x7f470c06a3e0 in pool
21-09-2017 15:53:32.240 UTC Debug memcachedstore.cpp:74: Fetch result
21-09-2017 15:53:32.240 UTC Debug memcachedstore.cpp:82: Found record on replica
21-09-2017 15:53:32.240 UTC Debug memcachedstore.cpp:260: libmemcached returned 0
21-09-2017 15:53:32.240 UTC Debug connection_pool.h:244: Release connection to IP: 10.0.0.6, port: 11311 to pool
21-09-2017 15:53:32.240 UTC Debug memcachedstore.cpp:339: Read 268 bytes from table impi key 83555000001 at ims.rmcore.net<mailto:83555000001 at ims.rmcore.net>, CAS = 18873
21-09-2017 15:53:32.240 UTC Debug astaire_impistore.cpp:177: Retrieved IMPI for 83555000001 at ims.rmcore.net<mailto:83555000001 at ims.rmcore.net>
{"authChallenges":[{"type":"digest","nonce":"63bff4bb68c27b47","nc":2,"expires":1506009512,"correlator":"z9hG4bKPj868.WzubxOAj3T1s2dS1BU0qM0Zj-kpZ","scscf-uri":"sip:scscf.ims.rmcore.net","realm":"ims.rmcore.net<http://ims.rmcore.net/>","qop":"auth","ha1":"b144b84f59356acbb86048bf3eb5f48f?}]}
21-09-2017 15:53:32.240 UTC Debug authenticationsproutlet.cpp:994: Verify authentication information in request
21-09-2017 15:53:32.240 UTC Debug authenticationsproutlet.cpp:482: Found Digest HA1 = b144b84f59356acbb86048bf3eb5f48f
21-09-2017 15:53:32.240 UTC Debug authenticationsproutlet.cpp:1006: Request authenticated successfully
21-09-2017 15:53:32.240 UTC Debug authenticationsproutlet.cpp:1033: Storing challenge because nonce counts are supported
21-09-2017 15:53:32.240 UTC Debug astaire_impistore.cpp:134: Storing IMPI for 83555000001 at ims.rmcore.net<mailto:83555000001 at ims.rmcore.net>
{"authChallenges":[{"type":"digest","nonce":"63bff4bb68c27b47","nc":3,"expires":1506009512,"correlator":"z9hG4bKPj868.WzubxOAj3T1s2dS1BU0qM0Zj-kpZ","scscf-uri":"sip:scscf.ims.rmcore.net","realm":"ims.rmcore.net<http://ims.rmcore.net/>","qop":"auth","ha1":"b144b84f59356acbb86048bf3eb5f48f?}]}
21-09-2017 15:53:32.240 UTC Debug memcachedstore.cpp:413: Writing 268 bytes to table impi key 83555000001 at ims.rmcore.net<mailto:83555000001 at ims.rmcore.net>, CAS = 18873, expiry = 300
21-09-2017 15:53:32.240 UTC Debug astaire_resolver.cpp:47: AstaireResolver::resolve for host vellum.ims.rmcore.net<http://vellum.ims.rmcore.net/>, family 2
21-09-2017 15:53:32.240 UTC Debug utils.cpp:377: Malformed host/port vellum.ims.rmcore.net<http://vellum.ims.rmcore.net/>
21-09-2017 15:53:32.240 UTC Debug utils.cpp:418: Attempt to parse vellum.ims.rmcore.net<http://vellum.ims.rmcore.net/> as IP address
21-09-2017 15:53:32.240 UTC Verbose dnscachedresolver.cpp:468: Check cache for vellum.ims.rmcore.net<http://vellum.ims.rmcore.net/> type 1
21-09-2017 15:53:32.240 UTC Debug dnscachedresolver.cpp:570: Pulling 1 records from cache for vellum.ims.rmcore.net<http://vellum.ims.rmcore.net/> A
21-09-2017 15:53:32.240 UTC Debug baseresolver.cpp:369: Found 1 A/AAAA records, creating iterator
21-09-2017 15:53:32.240 UTC Debug baseresolver.cpp:920: Attempting to get 2 targets for host:vellum.ims.rmcore.net<http://vellum.ims.rmcore.net/>. allowed_host_state = 3
21-09-2017 15:53:32.240 UTC Debug baseresolver.cpp:793: 10.0.0.6:11311;transport=TCP has state: WHITE
21-09-2017 15:53:32.240 UTC Debug baseresolver.cpp:793: 10.0.0.6:11311;transport=TCP has state: WHITE
21-09-2017 15:53:32.240 UTC Debug baseresolver.cpp:997: Added a whitelisted server to targets, now have 1 of 2
21-09-2017 15:53:32.241 UTC Debug memcachedstore.cpp:696: Found 1 targets for vellum.ims.rmcore.net<http://vellum.ims.rmcore.net/>
21-09-2017 15:53:32.241 UTC Debug memcachedstore.cpp:721: Duplicate target IP=10.0.0.6, port= 11311 as it is the only target
21-09-2017 15:53:32.241 UTC Debug memcachedstore.cpp:249: Try server IP 10.0.0.6, port 11311
21-09-2017 15:53:32.241 UTC Debug connection_pool.h:207: Request for connection to IP: 10.0.0.6, port: 11311
21-09-2017 15:53:32.241 UTC Debug connection_pool.h:220: Found existing connection 0x7f470c06a3e0 in pool
21-09-2017 15:53:32.241 UTC Debug memcachedstore.cpp:260: libmemcached returned 0
21-09-2017 15:53:32.241 UTC Debug connection_pool.h:244: Release connection to IP: 10.0.0.6, port: 11311 to pool
21-09-2017 15:53:32.241 UTC Debug memcachedstore.cpp:555: Write successful
21-09-2017 15:53:32.241 UTC Debug authenticationsproutlet.cpp:1178: Updated Authorization header with new nc and response
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:427: Creating URI for service registrar
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:340: Possible service name scscf will be used if ims.rmcore.net<http://ims.rmcore.net/> is a local hostname
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:453: Constructed URI sip:ims.rmcore.net;lr;service=registrar
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:1535: Sproutlet send_request 0x7f474c022970
21-09-2017 15:53:32.241 UTC Verbose sproutletproxy.cpp:1576: authentication-0x7f474c022150 sending Request msg REGISTER/cseq=2 (tdta0x7f474c022360) on fork 0
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:1976: Processing actions from sproutlet - 0 responses, 1 requests, 0 timers
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:2016: Processing request 0x7f474c022408, fork = 0
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:2141: authentication-0x7f474c022150 transmitting request on fork 0
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:2156: authentication-0x7f474c022150 store reference to non-ACK request Request msg REGISTER/cseq=2 (tdta0x7f474c022360) on fork 0
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:1968: Removing message 0x7f474c022970 => txdata 0x7f474c022408 mapping
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:163: Find target Sproutlet for request
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:197: Found next routable URI: sip:ims.rmcore.net;lr;service=registrar
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:300: Found services param - registrar
21-09-2017 15:53:32.241 UTC Debug uri_classifier.cpp:139: home domain: false, local_to_node: false, is_gruu: false, enforce_user_phone: false, prefer_sip: true, treat_number_as_phone: false
21-09-2017 15:53:32.241 UTC Debug uri_classifier.cpp:185: Classified URI as 5
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:427: Creating URI for service subscription
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:300: Found services param - registrar
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:453: Constructed URI sip:ims.rmcore.net;lr;service=subscription
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:1200: Remove top Route header Route: <sip:ims.rmcore.net;lr;service=registrar>
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:163: Find target Sproutlet for request
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:197: Found next routable URI:sip:ims.rmcore.net;lr;service=subscription
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:300: Found services param - subscription
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:427: Creating URI for service scscf-proxy
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:300: Found services param - subscription
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:453: Constructed URI sip:ims.rmcore.net;lr;service=scscf-proxy
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:1200: Remove top Route header Route: <sip:ims.rmcore.net;lr;service=subscription>
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:163: Find target Sproutlet for request
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:197: Found next routable URI: sip:ims.rmcore.net;lr;service=scscf-proxy
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:300: Found services param - scscf-proxy
21-09-2017 15:53:32.241 UTC Debug scscfsproutlet.cpp:489: S-CSCF Transaction (0x7f474c011150) created
21-09-2017 15:53:32.241 UTC Verbose sproutletproxy.cpp:1298: Created Sproutlet scscf-proxy-0x7f474c011150 for Request msg REGISTER/cseq=2 (tdta0x7f474c022360)
21-09-2017 15:53:32.241 UTC Verbose sproutletproxy.cpp:2290: Routing Request msg REGISTER/cseq=2 (tdta0x7f474c022360) (1399 bytes) to downstream sproutlet scscf-proxy:
--start msg?

REGISTER sip:scscf.ims.rmcore.net SIP/2.0
Route: <sip:ims.rmcore.net;lr;service=scscf-proxy>
Via: SIP/2.0/TCP 10.0.0.222:5058;rport=33214;received=10.0.0.222;branch=z9hG4bKPj1JagMaULIh8xrGTU49BsvwXp7aQVjv9S
Path: <sip:En9ykhc3CE at 10.0.0.222:5058;transport=TCP;lr;ob>
Via: SIP/2.0/UDP 212.159.106.131:59124;rport=59124;received=212.159.106.131;branch=z9hG4bK-524287-1?07005d66d0f9415a
Max-Forwards: 66
Contact: <sip:83555000001 at 212.159.106.131:59124;rinstance=39865f51c2a988a3>
To: "Jim at IMS" <sip:83555000001 at ims.rmcore.net>
From: "Jim at IMS" <sip:83555000001 at ims.rmcore.net>;tag=e2a4b510
Call-ID: 85656NGM0NGZkNDM3YjVhZTNhZWY3OWNmYzQ1NDc4MjM3ZTQ
CSeq: 2 REGISTER
Expires: 3600
Allow: SUBSCRIBE, NOTIFY, INVITE, ACK, CANCEL, BYE, REFER, INFO, OPTIONS
User-Agent: Bria 4 release 4.8.2 stamp 85656
P-Visited-Network-ID: ims.rmcore.net<http://ims.rmcore.net/>
P-Charging-Function-Addresses: ccf=cdf.ims.rmcore.net<http://cdf.ims.rmcore.net/>
P-Charging-Vector: icid-value="85656NGM0NGZkNDM3YjVhZTNhZWY3OWNmYzQ1NDc4MjM3ZTQ";icid-generated-at=ec2-52-56-52-145.eu-west-2.compute.amazonaws.com<http://ec2-52-56-52-145.eu-west-2.compute.amazonaws.com/>
Authorization: Digest response="54ade38e11b464bf9fcde6f464c7d9e8", username="83555000001 at ims.rmcore.net<mailto:83555000001 at ims.rmcore.net>", realm="ims.rmcore.net<http://ims.rmcore.net/>", nonce="63bff4bb68c27b47", uri="sip:ims.rmcore.net", algorithm=MD5, cnonce="c549e7ca56a2867a6e23caf77a3c629a", opaque="5a5a8de45658f637", qop=auth, nc=00000003,integrity-protected=ip-assoc-pending
Content-Length:  0


--end msg?

Any idea what?s going wrong here?

Thanks
Jim

RedMatter Ltd
Jim Page
VP Mobile Services
+44 (0)333 150 1666
+44 (0)7870 361412
jim.page at redmatter.com<mailto:jim.page at redmatter.com>

On 21 Sep 2017, at 15:38, Jim Page <jim.page at redmatter.com<mailto:jim.page at redmatter.com>> wrote:

Hi Clearwater people

I could really do with your help with the below. I have a pretty much bog standard setup, standard build with chef in AWS, plus an openimscore HSS instance. I am currently unable to get any sip devices to register due to an apparent issue nonce counting. Can you help? In parallel I am trying to hack the code to work around the issue ? but I can?t believe this isn?t a common scenario with a simple solution ? ?

Thanks in advance ?

Jim

RedMatter Ltd
Jim Page
VP Mobile Services
+44 (0)333 150 1666
+44 (0)7870 361412
jim.page at redmatter.com<mailto:jim.page at redmatter.com>

On 17 Sep 2017, at 18:38, Jim Page <jim.page at redmatter.com<mailto:jim.page at redmatter.com>> wrote:

Hi There

I initially set up my IMS in an AWS VPC, using chef. It worked out of the box without an HSS, I was able to use Ellis to provision accounts and they registered no problem using Bria 4. I decided to add an HSS (using ?knife box? to add an openimscore HSS instance) so that I can test our application servers. Now that I have the HSS integrated (there were niggles in the installation), I provisioned a new user on the HSS but the Bria phone will not authenticate, and a feedback loop is generated on the first REGISTER attempt. The problem seems to be related to nonce counting. The process seems to go like this:

UE REGISTER -> Bono
Bono REGISTER -> icscf
  No Authorization. Challenge is built, and IMPI is created with nc=1, and stored
icscf 401 -> Bono
Bono 401 -> UE
  UE builds an Authorisation header
UE REGISTER -> Bono
Bono REGISTER -> icscf
  The Authorisation header contains nc=000001.
  IMPI is loaded and validation is successful.
  IMPI is stored with nc=2, log line 'Debug authenticationsproutlet.cpp:1033: Storing challenge because nonce counts are supported?
icscf REGISTER -> scscf-proxy
  The Authorisation header still contains nc=000001.
  IMPI is loaded, but log line says: 'Info authenticationsproutlet.cpp:971: Nonce count supplied (1) is lower than expected (2) - ignore it?
  The Authorisation header is ignored and another 401 challenge is issued, and the UE responds ?. and this causes a loop
scscf-proxy 401 -> icscf
icscf 401 -> Bono
Bono 401 -> UE

There seems to be a fundamental flaw here. The IMPI nc is incrementing, but the Authorisation header is not. I can?t see how this can work unless icscf increments nc in the authorisation header before sending it to the scscf

Also please note: I disabled nonce_count_supported in shared_config, but the result was a log line ?nonce count is supplied but not supported? (or words to that effect) and the Authorisation header is again ignored, and there is a loop.

How to move forward from here? I have searched in vain for a way to disable nonce count in Bria 4.

I can provide logs if helpful, but they are long and I don?t want to clog everyone?s inbox.

Kind regards
Jim

RedMatter Ltd
Jim Page
VP Mobile Services
+44 (0)333 150 1666
+44 (0)7870 361412
jim.page at redmatter.com<mailto:jim.page at redmatter.com>

_______________________________________________
Clearwater mailing list
Clearwater at lists.projectclearwater.org<mailto:Clearwater at lists.projectclearwater.org>
http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org

_______________________________________________
Clearwater mailing list
Clearwater at lists.projectclearwater.org<mailto:Clearwater at lists.projectclearwater.org>
http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org

_______________________________________________
Clearwater mailing list
Clearwater at lists.projectclearwater.org<mailto:Clearwater at lists.projectclearwater.org>
http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org


-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20170922/5ba4d42b/attachment.html>

From Matt.Williams at metaswitch.com  Fri Sep 22 05:47:53 2017
From: Matt.Williams at metaswitch.com (Matt Williams)
Date: Fri, 22 Sep 2017 09:47:53 +0000
Subject: [Project Clearwater] Looping authentication with Bria
In-Reply-To: <921BDA9A-996C-4A60-BF4F-5A855BB634C2@redmatter.com>
References: <A08CF3C9-DCAB-46F3-A7AE-3E597E865129@redmatter.com>
	<C4025817-3A23-4856-8613-717AA07D40AC@redmatter.com>
	<C0E6789C-515C-4A39-BDB1-28BCB1183EE9@redmatter.com>
	<CY4PR02MB288723F16B75130EBE30F89290670@CY4PR02MB2887.namprd02.prod.outlook.com>
	<921BDA9A-996C-4A60-BF4F-5A855BB634C2@redmatter.com>
Message-ID: <CY4PR02MB2887B407AEA431AB857F07D090670@CY4PR02MB2887.namprd02.prod.outlook.com>

Jim,

Thanks for those diagnostics!  I think the problem occurs here - specifically the uri_classifier logs:

22-09-2017 09:04:02.770 UTC Debug sproutletproxy.cpp:163: Find target Sproutlet for request
22-09-2017 09:04:02.770 UTC Debug sproutletproxy.cpp:197: Found next routable URI: sip:ims.rmcore.net;lr;service=registrar
22-09-2017 09:04:02.770 UTC Debug sproutletproxy.cpp:300: Found services param - registrar
22-09-2017 09:04:02.770 UTC Debug uri_classifier.cpp:139: home domain: false, local_to_node: false, is_gruu: false, enforce_user_phone: false, prefer_sip: true, treat_number_as_phone: false
22-09-2017 09:04:02.770 UTC Debug uri_classifier.cpp:185: Classified URI as 5
22-09-2017 09:04:02.770 UTC Debug sproutletproxy.cpp:427: Creating URI for service subscription

Basically, we have a SIP URI that says "service=registrar".  This invokes the registrar Sproutlet.  However, the registrar Sproutlet checks that the URI looks right before it accepts it (using the URIClassifier), and it finds that it's not for our home domain (see "home domain: false").  This means that it classifies URI as "5", which is a bit cryptic but corresponds to the URIClass enum, and means OFFNET_SIP_URI... so we route it off net.

So why isn't ims.rmcore.net recognized as the home domain?  Please can you share the /etc/clearwater/shared_config file from your system?

Thanks,

Matt

From: Jim Page [mailto:jim.page at redmatter.com]
Sent: 22 September 2017 10:27
To: clearwater at lists.projectclearwater.org
Cc: Matt Williams <Matt.Williams at metaswitch.com>
Subject: Re: [Project Clearwater] Looping authentication with Bria

Hi Matt

Thanks a lot for getting in touch.

I have attached PCAPs of the bria (just sip) and the bono and sprout hosts (everything). Also the bono and sprout logs at log_level=5. I have copied this email to your metaswitch email in case the zip is removed from the forum emails, hope that?s ok.

Your explanation makes sense - let?s hope it?s an easy fix!

This is my #1 priority right now so please let me know if there?s anything else I can do to help debug this.

Kind regards
Jim
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20170922/6d4f72fc/attachment.html>

From Matt.Williams at metaswitch.com  Fri Sep 22 05:51:08 2017
From: Matt.Williams at metaswitch.com (Matt Williams)
Date: Fri, 22 Sep 2017 09:51:08 +0000
Subject: [Project Clearwater] Looping authentication with Bria
In-Reply-To: <24D731B5-B35D-41F1-88EA-376D79916814@redmatter.com>
References: <A08CF3C9-DCAB-46F3-A7AE-3E597E865129@redmatter.com>
	<C4025817-3A23-4856-8613-717AA07D40AC@redmatter.com>
	<C0E6789C-515C-4A39-BDB1-28BCB1183EE9@redmatter.com>
	<CY4PR02MB288723F16B75130EBE30F89290670@CY4PR02MB2887.namprd02.prod.outlook.com>
	<921BDA9A-996C-4A60-BF4F-5A855BB634C2@redmatter.com>
	<24D731B5-B35D-41F1-88EA-376D79916814@redmatter.com>
Message-ID: <CY4PR02MB28877C42719096026F4EA75690670@CY4PR02MB2887.namprd02.prod.outlook.com>

Jim,

Thanks!  The Route header (or absence of it) in the request for the UE shouldn't be a problem - Bono (the P-CSCF) should handle this.

As discussed in the other fork of this trail, I think the issue is that the home domain configured for the S-CSCF doesn't match the URI it is receiving.

Cheers,

Matt


From: Jim Page [mailto:jim.page at redmatter.com]
Sent: 22 September 2017 10:44
To: clearwater at lists.projectclearwater.org
Cc: Matt Williams <Matt.Williams at metaswitch.com>
Subject: Re: [Project Clearwater] Looping authentication with Bria

Looking at the bria pcap: it doesn?t supply a route header, and sends to port 5060. No problem to change the port, obviously, if that would help but I?m not sure how to get it to add a route header, it?s not very customisable.

The curious thing is that this worked on my setup before I added in the HSS.

Let me know if the debug info I sent didn?t get to you.

And regards
Jim

RedMatter Ltd
Jim Page
VP Mobile Services
+44 (0)333 150 1666
+44 (0)7870 361412
jim.page at redmatter.com<mailto:jim.page at redmatter.com>

On 22 Sep 2017, at 10:27, Jim Page <jim.page at redmatter.com<mailto:jim.page at redmatter.com>> wrote:

Hi Matt

Thanks a lot for getting in touch.

I have attached PCAPs of the bria (just sip) and the bono and sprout hosts (everything). Also the bono and sprout logs at log_level=5. I have copied this email to your metaswitch email in case the zip is removed from the forum emails, hope that?s ok.

Your explanation makes sense - let?s hope it?s an easy fix!

This is my #1 priority right now so please let me know if there?s anything else I can do to help debug this.

Kind regards
Jim
<BriaDebug.zip>

RedMatter Ltd
Jim Page
VP Mobile Services
+44 (0)333 150 1666
+44 (0)7870 361412
jim.page at redmatter.com<mailto:jim.page at redmatter.com>

On 22 Sep 2017, at 10:04, Matt Williams <Matt.Williams at metaswitch.com<mailto:Matt.Williams at metaswitch.com>> wrote:

Jim,

Apologies - I didn't see this new email when I replied to your previous one.

The S-CSCF behavior is divided up into multiple chunks ("Sproutlets"), and we seem to be invoking the "scscf-proxy" chunk, which is responsible for processing dialog-related messages (rather than REGISTERs).  This is why it is trying to route the message on towards the "callee" (i.e. the request URI) - unfortunately, that also resolves to ourselves.

Would you be able to share the logs from the point that the request first hits Bono, right through until it gets into this loop?

(I think we just have a URI misconfigured somewhere - that should be set up correctly by the Chef scripts, but there must be a bug there.)

Thanks,

Matt


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Jim Page
Sent: 21 September 2017 18:26
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] Looping authentication with Bria

Right - I have made a change in sprout that updates the REGISTER Authorisation header so that the nc is incremented and a new hash is written into the response. The authentication is now successful. Unfortunately what happens is that once the registration is complete, the same REGISTER request is sent over and over and over to the scscf-proxy sproutlet until the hops limit is reached.

What exactly is supposed to happen here? According to the flow I have, once the registration on the SCSCF is successful it should send an SAR to the HSS, after which the SCSCF should return 200 OK to the ISCSCF, and so on back to the UE. I cannot see any sign the SAR request is taking place, though I can see the UAR query from the ISCSCF. Here is a section of log from sprout from the moment the REGISTER is first presented to the scscf-proxy sproutlet until the start of the first loop:

21-09-2017 15:53:32.239 UTC Debug scscfsproutlet.cpp:489: S-CSCF Transaction (0x7f474c010e50) created
21-09-2017 15:53:32.239 UTC Verbose sproutletproxy.cpp:1298: Created Sproutlet scscf-proxy-0x7f474c010e50 for Request msg REGISTER/cseq=2 (tdta0x7f474c01ce90)
21-09-2017 15:53:32.239 UTC Verbose sproutletproxy.cpp:2290: Routing Request msg REGISTER/cseq=2 (tdta0x7f474c01ce90) (1399 bytes) to downstream sproutlet scscf-proxy:
--start msg?

REGISTER sip:scscf.ims.rmcore.net SIP/2.0
Route: <sip:ims.rmcore.net;lr;service=scscf-proxy>
Via: SIP/2.0/TCP 10.0.0.222:5058;rport=33214;received=10.0.0.222;branch=z9hG4bKPj1JagMaULIh8xrGTU49BsvwXp7aQVjv9S
Path: <sip:En9ykhc3CE at 10.0.0.222:5058;transport=TCP;lr;ob>
Via: SIP/2.0/UDP 212.159.106.131:59124;rport=59124;received=212.159.106.131;branch=z9hG4bK-524287-1?07005d66d0f9415a
Max-Forwards: 68
Contact: <sip:83555000001 at 212.159.106.131:59124;rinstance=39865f51c2a988a3>
To: "Jim at IMS" <sip:83555000001 at ims.rmcore.net>
From: "Jim at IMS" <sip:83555000001 at ims.rmcore.net>;tag=e2a4b510
Call-ID: 85656NGM0NGZkNDM3YjVhZTNhZWY3OWNmYzQ1NDc4MjM3ZTQ
CSeq: 2 REGISTER
Expires: 3600
Allow: SUBSCRIBE, NOTIFY, INVITE, ACK, CANCEL, BYE, REFER, INFO, OPTIONS
User-Agent: Bria 4 release 4.8.2 stamp 85656
P-Visited-Network-ID: ims.rmcore.net<http://ims.rmcore.net/>
P-Charging-Function-Addresses: ccf=cdf.ims.rmcore.net<http://cdf.ims.rmcore.net/>
P-Charging-Vector: icid-value="85656NGM0NGZkNDM3YjVhZTNhZWY3OWNmYzQ1NDc4MjM3ZTQ";icid-generated-at=ec2-52-56-52-145.eu-west-2.compute.amazonaws.com<http://ec2-52-56-52-145.eu-west-2.compute.amazonaws.com/>
Authorization: Digest response="5a39ea19aeafcf955924b29a9a375451", username="83555000001 at ims.rmcore.net<mailto:83555000001 at ims.rmcore.net>", realm="ims.rmcore.net<http://ims.rmcore.net/>", nonce="63bff4bb68c27b47", uri="sip:ims.rmcore.net", algorithm=MD5, cnonce="c549e7ca56a2867a6e23caf77a3c629a", opaque="5a5a8de45658f637", qop=auth, nc=00000002,integrity-protected=ip-assoc-pending
Content-Length:  0


--end msg?
21-09-2017 15:53:32.239 UTC Debug pjutils.cpp:700: Cloned tdta0x7f474c01ce90 to tdta0x7f474c020150
21-09-2017 15:53:32.239 UTC Debug sproutletproxy.cpp:1364: Remove top Route header Route: <sip:ims.rmcore.net;lr;service=scscf-proxy>
21-09-2017 15:53:32.239 UTC Debug sproutletproxy.cpp:1961: Adding message 0x7f474c020760 => txdata 0x7f474c0201f8 mapping
21-09-2017 15:53:32.239 UTC Verbose sproutletproxy.cpp:1806: scscf-proxy-0x7f474c010e50 pass initial request Request msg REGISTER/cseq=2 (tdta0x7f474c020150) to Sproutlet
21-09-2017 15:53:32.239 UTC Info scscfsproutlet.cpp:536: S-CSCF received initial request
21-09-2017 15:53:32.239 UTC Debug uri_classifier.cpp:139: home domain: true, local_to_node: false, is_gruu: false, enforce_user_phone: false, prefer_sip: true, treat_number_as_phone: false
21-09-2017 15:53:32.239 UTC Debug uri_classifier.cpp:185: Classified URI as 4
21-09-2017 15:53:32.239 UTC Debug scscfsproutlet.cpp:993: Route header references this system
21-09-2017 15:53:32.239 UTC Debug scscfsproutlet.cpp:1039: No ODI token, or invalid ODI token, on request - logging ICID marker 85656NGM0NGZkNDM3YjVhZTNhZWY3OWNmYzQ1NDc4MjM3ZTQ for B2BUA AS correlation
21-09-2017 15:53:32.239 UTC Debug scscfsproutlet.cpp:1052: Got our Route header, session case term, OD=None
21-09-2017 15:53:32.239 UTC Debug uri_classifier.cpp:139: home domain: false, local_to_node: false, is_gruu: false, enforce_user_phone: false, prefer_sip: true, treat_number_as_phone: false
21-09-2017 15:53:32.239 UTC Debug uri_classifier.cpp:185: Classified URI as 5
21-09-2017 15:53:32.239 UTC Debug scscfsproutlet.cpp:1396: URI is not locally hosted
21-09-2017 15:53:32.239 UTC Debug acr.cpp:1787: Create RalfACR for node type S-CSCF with role Terminating
21-09-2017 15:53:32.239 UTC Debug acr.cpp:24: Created ACR (0x7f474c022110)
21-09-2017 15:53:32.239 UTC Debug acr.cpp:164: Created S-CSCF Ralf ACR
21-09-2017 15:53:32.239 UTC Debug acr.cpp:29: Destroyed ACR (0x7f474c022110)
21-09-2017 15:53:32.239 UTC Info scscfsproutlet.cpp:714: Route request without applying services
21-09-2017 15:53:32.239 UTC Debug sproutletproxy.cpp:1535: Sproutlet send_request 0x7f474c020760
21-09-2017 15:53:32.239 UTC Verbose sproutletproxy.cpp:1576: scscf-proxy-0x7f474c010e50 sending Request msg REGISTER/cseq=2 (tdta0x7f474c020150) on fork 0
21-09-2017 15:53:32.239 UTC Debug sproutletproxy.cpp:1976: Processing actions from sproutlet - 0 responses, 1 requests, 0 timers
21-09-2017 15:53:32.239 UTC Debug sproutletproxy.cpp:2016: Processing request 0x7f474c0201f8, fork = 0
21-09-2017 15:53:32.239 UTC Debug sproutletproxy.cpp:2141: scscf-proxy-0x7f474c010e50 transmitting request on fork 0
21-09-2017 15:53:32.239 UTC Debug sproutletproxy.cpp:2156: scscf-proxy-0x7f474c010e50 store reference to non-ACK request Request msg REGISTER/cseq=2 (tdta0x7f474c020150) on fork 0
21-09-2017 15:53:32.239 UTC Debug sproutletproxy.cpp:1968: Removing message 0x7f474c020760 => txdata 0x7f474c0201f8 mapping
21-09-2017 15:53:32.239 UTC Debug sproutletproxy.cpp:163: Find target Sproutlet for request
21-09-2017 15:53:32.239 UTC Debug sproutletproxy.cpp:197: Found next routable URI: sip:scscf.ims.rmcore.net
21-09-2017 15:53:32.239 UTC Debug sproutletproxy.cpp:340: Possible service name scscf will be used if ims.rmcore.net<http://ims.rmcore.net/> is a local hostname
21-09-2017 15:53:32.239 UTC Debug authenticationsproutlet.cpp:169: Authorization header in request
21-09-2017 15:53:32.239 UTC Debug authenticationsproutlet.cpp:177: Integrity protected with ip-assoc-pending
21-09-2017 15:53:32.239 UTC Verbose sproutletproxy.cpp:1298: Created Sproutlet authentication-0x7f474c022150 for Request msg REGISTER/cseq=2 (tdta0x7f474c020150)
21-09-2017 15:53:32.239 UTC Verbose sproutletproxy.cpp:2290: Routing Request msg REGISTER/cseq=2 (tdta0x7f474c020150) (1347 bytes) to downstream sproutlet authentication:
--start msg?

REGISTER sip:scscf.ims.rmcore.net SIP/2.0
Via: SIP/2.0/TCP 10.0.0.222:5058;rport=33214;received=10.0.0.222;branch=z9hG4bKPj1JagMaULIh8xrGTU49BsvwXp7aQVjv9S
Path: <sip:En9ykhc3CE at 10.0.0.222:5058;transport=TCP;lr;ob>
Via: SIP/2.0/UDP 212.159.106.131:59124;rport=59124;received=212.159.106.131;branch=z9hG4bK-524287-1?07005d66d0f9415a
Max-Forwards: 67
Contact: <sip:83555000001 at 212.159.106.131:59124;rinstance=39865f51c2a988a3>
To: "Jim at IMS" <sip:83555000001 at ims.rmcore.net>
From: "Jim at IMS" <sip:83555000001 at ims.rmcore.net>;tag=e2a4b510
Call-ID: 85656NGM0NGZkNDM3YjVhZTNhZWY3OWNmYzQ1NDc4MjM3ZTQ
CSeq: 2 REGISTER
Expires: 3600
Allow: SUBSCRIBE, NOTIFY, INVITE, ACK, CANCEL, BYE, REFER, INFO, OPTIONS
User-Agent: Bria 4 release 4.8.2 stamp 85656
P-Visited-Network-ID: ims.rmcore.net<http://ims.rmcore.net/>
P-Charging-Function-Addresses: ccf=cdf.ims.rmcore.net<http://cdf.ims.rmcore.net/>
P-Charging-Vector: icid-value="85656NGM0NGZkNDM3YjVhZTNhZWY3OWNmYzQ1NDc4MjM3ZTQ";icid-generated-at=ec2-52-56-52-145.eu-west-2.compute.amazonaws.com<http://ec2-52-56-52-145.eu-west-2.compute.amazonaws.com/>
Authorization: Digest response="5a39ea19aeafcf955924b29a9a375451", username="83555000001 at ims.rmcore.net<mailto:83555000001 at ims.rmcore.net>", realm="ims.rmcore.net<http://ims.rmcore.net/>", nonce="63bff4bb68c27b47", uri="sip:ims.rmcore.net", algorithm=MD5, cnonce="c549e7ca56a2867a6e23caf77a3c629a", opaque="5a5a8de45658f637", qop=auth, nc=00000002,integrity-protected=ip-assoc-pending
Content-Length:  0


--end msg?
21-09-2017 15:53:32.240 UTC Debug pjutils.cpp:700: Cloned tdta0x7f474c020150 to tdta0x7f474c022360
21-09-2017 15:53:32.240 UTC Debug sproutletproxy.cpp:1961: Adding message 0x7f474c022970 => txdata 0x7f474c022408 mapping
21-09-2017 15:53:32.240 UTC Verbose sproutletproxy.cpp:1806: authentication-0x7f474c022150 pass initial request Request msg REGISTER/cseq=2 (tdta0x7f474c022360) to Sproutlet
21-09-2017 15:53:32.240 UTC Debug authenticationsproutlet.cpp:873: Authentication module invoked
21-09-2017 15:53:32.240 UTC Debug sproutletproxy.cpp:340: Possible service name scscf will be used ifsprout.ims.rmcore.net<http://sprout.ims.rmcore.net/> is a local hostname
21-09-2017 15:53:32.240 UTC Debug sproutletproxy.cpp:340: Possible service name scscf will be used if ims.rmcore.net<http://ims.rmcore.net/> is a local hostname
21-09-2017 15:53:32.240 UTC Debug authenticationsproutlet.cpp:1456: Lookup IMPI object: impi=83555000001 at ims.rmcore.net<mailto:impi=83555000001 at ims.rmcore.net>
21-09-2017 15:53:32.240 UTC Debug memcachedstore.cpp:295: Start GET from table impi for key 83555000001 at ims.rmcore.net<mailto:83555000001 at ims.rmcore.net>
21-09-2017 15:53:32.240 UTC Debug astaire_resolver.cpp:47: AstaireResolver::resolve for host vellum.ims.rmcore.net<http://vellum.ims.rmcore.net/>, family 2
21-09-2017 15:53:32.240 UTC Debug utils.cpp:377: Malformed host/port vellum.ims.rmcore.net<http://vellum.ims.rmcore.net/>
21-09-2017 15:53:32.240 UTC Debug utils.cpp:418: Attempt to parse vellum.ims.rmcore.net<http://vellum.ims.rmcore.net/> as IP address
21-09-2017 15:53:32.240 UTC Verbose dnscachedresolver.cpp:468: Check cache for vellum.ims.rmcore.net<http://vellum.ims.rmcore.net/> type 1
21-09-2017 15:53:32.240 UTC Debug dnscachedresolver.cpp:570: Pulling 1 records from cache for vellum.ims.rmcore.net<http://vellum.ims.rmcore.net/> A
21-09-2017 15:53:32.240 UTC Debug baseresolver.cpp:369: Found 1 A/AAAA records, creating iterator
21-09-2017 15:53:32.240 UTC Debug baseresolver.cpp:920: Attempting to get 2 targets for host:vellum.ims.rmcore.net<http://vellum.ims.rmcore.net/>. allowed_host_state = 3
21-09-2017 15:53:32.240 UTC Debug baseresolver.cpp:793: 10.0.0.6:11311;transport=TCP has state: WHITE
21-09-2017 15:53:32.240 UTC Debug baseresolver.cpp:793: 10.0.0.6:11311;transport=TCP has state: WHITE
21-09-2017 15:53:32.240 UTC Debug baseresolver.cpp:997: Added a whitelisted server to targets, now have 1 of 2
21-09-2017 15:53:32.240 UTC Debug memcachedstore.cpp:696: Found 1 targets for vellum.ims.rmcore.net<http://vellum.ims.rmcore.net/>
21-09-2017 15:53:32.240 UTC Debug memcachedstore.cpp:721: Duplicate target IP=10.0.0.6, port= 11311 as it is the only target
21-09-2017 15:53:32.240 UTC Debug memcachedstore.cpp:249: Try server IP 10.0.0.6, port 11311
21-09-2017 15:53:32.240 UTC Debug connection_pool.h:207: Request for connection to IP: 10.0.0.6, port: 11311
21-09-2017 15:53:32.240 UTC Debug connection_pool.h:220: Found existing connection 0x7f470c06a3e0 in pool
21-09-2017 15:53:32.240 UTC Debug memcachedstore.cpp:74: Fetch result
21-09-2017 15:53:32.240 UTC Debug memcachedstore.cpp:82: Found record on replica
21-09-2017 15:53:32.240 UTC Debug memcachedstore.cpp:260: libmemcached returned 0
21-09-2017 15:53:32.240 UTC Debug connection_pool.h:244: Release connection to IP: 10.0.0.6, port: 11311 to pool
21-09-2017 15:53:32.240 UTC Debug memcachedstore.cpp:339: Read 268 bytes from table impi key 83555000001 at ims.rmcore.net<mailto:83555000001 at ims.rmcore.net>, CAS = 18873
21-09-2017 15:53:32.240 UTC Debug astaire_impistore.cpp:177: Retrieved IMPI for 83555000001 at ims.rmcore.net<mailto:83555000001 at ims.rmcore.net>
{"authChallenges":[{"type":"digest","nonce":"63bff4bb68c27b47","nc":2,"expires":1506009512,"correlator":"z9hG4bKPj868.WzubxOAj3T1s2dS1BU0qM0Zj-kpZ","scscf-uri":"sip:scscf.ims.rmcore.net","realm":"ims.rmcore.net<http://ims.rmcore.net/>","qop":"auth","ha1":"b144b84f59356acbb86048bf3eb5f48f?}]}
21-09-2017 15:53:32.240 UTC Debug authenticationsproutlet.cpp:994: Verify authentication information in request
21-09-2017 15:53:32.240 UTC Debug authenticationsproutlet.cpp:482: Found Digest HA1 = b144b84f59356acbb86048bf3eb5f48f
21-09-2017 15:53:32.240 UTC Debug authenticationsproutlet.cpp:1006: Request authenticated successfully
21-09-2017 15:53:32.240 UTC Debug authenticationsproutlet.cpp:1033: Storing challenge because nonce counts are supported
21-09-2017 15:53:32.240 UTC Debug astaire_impistore.cpp:134: Storing IMPI for 83555000001 at ims.rmcore.net<mailto:83555000001 at ims.rmcore.net>
{"authChallenges":[{"type":"digest","nonce":"63bff4bb68c27b47","nc":3,"expires":1506009512,"correlator":"z9hG4bKPj868.WzubxOAj3T1s2dS1BU0qM0Zj-kpZ","scscf-uri":"sip:scscf.ims.rmcore.net","realm":"ims.rmcore.net<http://ims.rmcore.net/>","qop":"auth","ha1":"b144b84f59356acbb86048bf3eb5f48f?}]}
21-09-2017 15:53:32.240 UTC Debug memcachedstore.cpp:413: Writing 268 bytes to table impi key 83555000001 at ims.rmcore.net<mailto:83555000001 at ims.rmcore.net>, CAS = 18873, expiry = 300
21-09-2017 15:53:32.240 UTC Debug astaire_resolver.cpp:47: AstaireResolver::resolve for host vellum.ims.rmcore.net<http://vellum.ims.rmcore.net/>, family 2
21-09-2017 15:53:32.240 UTC Debug utils.cpp:377: Malformed host/port vellum.ims.rmcore.net<http://vellum.ims.rmcore.net/>
21-09-2017 15:53:32.240 UTC Debug utils.cpp:418: Attempt to parse vellum.ims.rmcore.net<http://vellum.ims.rmcore.net/> as IP address
21-09-2017 15:53:32.240 UTC Verbose dnscachedresolver.cpp:468: Check cache for vellum.ims.rmcore.net<http://vellum.ims.rmcore.net/> type 1
21-09-2017 15:53:32.240 UTC Debug dnscachedresolver.cpp:570: Pulling 1 records from cache for vellum.ims.rmcore.net<http://vellum.ims.rmcore.net/> A
21-09-2017 15:53:32.240 UTC Debug baseresolver.cpp:369: Found 1 A/AAAA records, creating iterator
21-09-2017 15:53:32.240 UTC Debug baseresolver.cpp:920: Attempting to get 2 targets for host:vellum.ims.rmcore.net<http://vellum.ims.rmcore.net/>. allowed_host_state = 3
21-09-2017 15:53:32.240 UTC Debug baseresolver.cpp:793: 10.0.0.6:11311;transport=TCP has state: WHITE
21-09-2017 15:53:32.240 UTC Debug baseresolver.cpp:793: 10.0.0.6:11311;transport=TCP has state: WHITE
21-09-2017 15:53:32.240 UTC Debug baseresolver.cpp:997: Added a whitelisted server to targets, now have 1 of 2
21-09-2017 15:53:32.241 UTC Debug memcachedstore.cpp:696: Found 1 targets for vellum.ims.rmcore.net<http://vellum.ims.rmcore.net/>
21-09-2017 15:53:32.241 UTC Debug memcachedstore.cpp:721: Duplicate target IP=10.0.0.6, port= 11311 as it is the only target
21-09-2017 15:53:32.241 UTC Debug memcachedstore.cpp:249: Try server IP 10.0.0.6, port 11311
21-09-2017 15:53:32.241 UTC Debug connection_pool.h:207: Request for connection to IP: 10.0.0.6, port: 11311
21-09-2017 15:53:32.241 UTC Debug connection_pool.h:220: Found existing connection 0x7f470c06a3e0 in pool
21-09-2017 15:53:32.241 UTC Debug memcachedstore.cpp:260: libmemcached returned 0
21-09-2017 15:53:32.241 UTC Debug connection_pool.h:244: Release connection to IP: 10.0.0.6, port: 11311 to pool
21-09-2017 15:53:32.241 UTC Debug memcachedstore.cpp:555: Write successful
21-09-2017 15:53:32.241 UTC Debug authenticationsproutlet.cpp:1178: Updated Authorization header with new nc and response
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:427: Creating URI for service registrar
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:340: Possible service name scscf will be used if ims.rmcore.net<http://ims.rmcore.net/> is a local hostname
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:453: Constructed URI sip:ims.rmcore.net;lr;service=registrar
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:1535: Sproutlet send_request 0x7f474c022970
21-09-2017 15:53:32.241 UTC Verbose sproutletproxy.cpp:1576: authentication-0x7f474c022150 sending Request msg REGISTER/cseq=2 (tdta0x7f474c022360) on fork 0
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:1976: Processing actions from sproutlet - 0 responses, 1 requests, 0 timers
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:2016: Processing request 0x7f474c022408, fork = 0
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:2141: authentication-0x7f474c022150 transmitting request on fork 0
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:2156: authentication-0x7f474c022150 store reference to non-ACK request Request msg REGISTER/cseq=2 (tdta0x7f474c022360) on fork 0
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:1968: Removing message 0x7f474c022970 => txdata 0x7f474c022408 mapping
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:163: Find target Sproutlet for request
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:197: Found next routable URI: sip:ims.rmcore.net;lr;service=registrar
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:300: Found services param - registrar
21-09-2017 15:53:32.241 UTC Debug uri_classifier.cpp:139: home domain: false, local_to_node: false, is_gruu: false, enforce_user_phone: false, prefer_sip: true, treat_number_as_phone: false
21-09-2017 15:53:32.241 UTC Debug uri_classifier.cpp:185: Classified URI as 5
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:427: Creating URI for service subscription
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:300: Found services param - registrar
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:453: Constructed URI sip:ims.rmcore.net;lr;service=subscription
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:1200: Remove top Route header Route: <sip:ims.rmcore.net;lr;service=registrar>
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:163: Find target Sproutlet for request
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:197: Found next routable URI:sip:ims.rmcore.net;lr;service=subscription
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:300: Found services param - subscription
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:427: Creating URI for service scscf-proxy
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:300: Found services param - subscription
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:453: Constructed URI sip:ims.rmcore.net;lr;service=scscf-proxy
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:1200: Remove top Route header Route: <sip:ims.rmcore.net;lr;service=subscription>
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:163: Find target Sproutlet for request
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:197: Found next routable URI: sip:ims.rmcore.net;lr;service=scscf-proxy
21-09-2017 15:53:32.241 UTC Debug sproutletproxy.cpp:300: Found services param - scscf-proxy
21-09-2017 15:53:32.241 UTC Debug scscfsproutlet.cpp:489: S-CSCF Transaction (0x7f474c011150) created
21-09-2017 15:53:32.241 UTC Verbose sproutletproxy.cpp:1298: Created Sproutlet scscf-proxy-0x7f474c011150 for Request msg REGISTER/cseq=2 (tdta0x7f474c022360)
21-09-2017 15:53:32.241 UTC Verbose sproutletproxy.cpp:2290: Routing Request msg REGISTER/cseq=2 (tdta0x7f474c022360) (1399 bytes) to downstream sproutlet scscf-proxy:
--start msg?

REGISTER sip:scscf.ims.rmcore.net SIP/2.0
Route: <sip:ims.rmcore.net;lr;service=scscf-proxy>
Via: SIP/2.0/TCP 10.0.0.222:5058;rport=33214;received=10.0.0.222;branch=z9hG4bKPj1JagMaULIh8xrGTU49BsvwXp7aQVjv9S
Path: <sip:En9ykhc3CE at 10.0.0.222:5058;transport=TCP;lr;ob>
Via: SIP/2.0/UDP 212.159.106.131:59124;rport=59124;received=212.159.106.131;branch=z9hG4bK-524287-1?07005d66d0f9415a
Max-Forwards: 66
Contact: <sip:83555000001 at 212.159.106.131:59124;rinstance=39865f51c2a988a3>
To: "Jim at IMS" <sip:83555000001 at ims.rmcore.net>
From: "Jim at IMS" <sip:83555000001 at ims.rmcore.net>;tag=e2a4b510
Call-ID: 85656NGM0NGZkNDM3YjVhZTNhZWY3OWNmYzQ1NDc4MjM3ZTQ
CSeq: 2 REGISTER
Expires: 3600
Allow: SUBSCRIBE, NOTIFY, INVITE, ACK, CANCEL, BYE, REFER, INFO, OPTIONS
User-Agent: Bria 4 release 4.8.2 stamp 85656
P-Visited-Network-ID: ims.rmcore.net<http://ims.rmcore.net/>
P-Charging-Function-Addresses: ccf=cdf.ims.rmcore.net<http://cdf.ims.rmcore.net/>
P-Charging-Vector: icid-value="85656NGM0NGZkNDM3YjVhZTNhZWY3OWNmYzQ1NDc4MjM3ZTQ";icid-generated-at=ec2-52-56-52-145.eu-west-2.compute.amazonaws.com<http://ec2-52-56-52-145.eu-west-2.compute.amazonaws.com/>
Authorization: Digest response="54ade38e11b464bf9fcde6f464c7d9e8", username="83555000001 at ims.rmcore.net<mailto:83555000001 at ims.rmcore.net>", realm="ims.rmcore.net<http://ims.rmcore.net/>", nonce="63bff4bb68c27b47", uri="sip:ims.rmcore.net", algorithm=MD5, cnonce="c549e7ca56a2867a6e23caf77a3c629a", opaque="5a5a8de45658f637", qop=auth, nc=00000003,integrity-protected=ip-assoc-pending
Content-Length:  0


--end msg?

Any idea what?s going wrong here?

Thanks
Jim

RedMatter Ltd
Jim Page
VP Mobile Services
+44 (0)333 150 1666
+44 (0)7870 361412
jim.page at redmatter.com<mailto:jim.page at redmatter.com>

On 21 Sep 2017, at 15:38, Jim Page <jim.page at redmatter.com<mailto:jim.page at redmatter.com>> wrote:

Hi Clearwater people

I could really do with your help with the below. I have a pretty much bog standard setup, standard build with chef in AWS, plus an openimscore HSS instance. I am currently unable to get any sip devices to register due to an apparent issue nonce counting. Can you help? In parallel I am trying to hack the code to work around the issue ? but I can?t believe this isn?t a common scenario with a simple solution ? ?

Thanks in advance ?

Jim

RedMatter Ltd
Jim Page
VP Mobile Services
+44 (0)333 150 1666
+44 (0)7870 361412
jim.page at redmatter.com<mailto:jim.page at redmatter.com>

On 17 Sep 2017, at 18:38, Jim Page <jim.page at redmatter.com<mailto:jim.page at redmatter.com>> wrote:

Hi There

I initially set up my IMS in an AWS VPC, using chef. It worked out of the box without an HSS, I was able to use Ellis to provision accounts and they registered no problem using Bria 4. I decided to add an HSS (using ?knife box? to add an openimscore HSS instance) so that I can test our application servers. Now that I have the HSS integrated (there were niggles in the installation), I provisioned a new user on the HSS but the Bria phone will not authenticate, and a feedback loop is generated on the first REGISTER attempt. The problem seems to be related to nonce counting. The process seems to go like this:

UE REGISTER -> Bono
Bono REGISTER -> icscf
  No Authorization. Challenge is built, and IMPI is created with nc=1, and stored
icscf 401 -> Bono
Bono 401 -> UE
  UE builds an Authorisation header
UE REGISTER -> Bono
Bono REGISTER -> icscf
  The Authorisation header contains nc=000001.
  IMPI is loaded and validation is successful.
  IMPI is stored with nc=2, log line 'Debug authenticationsproutlet.cpp:1033: Storing challenge because nonce counts are supported?
icscf REGISTER -> scscf-proxy
  The Authorisation header still contains nc=000001.
  IMPI is loaded, but log line says: 'Info authenticationsproutlet.cpp:971: Nonce count supplied (1) is lower than expected (2) - ignore it?
  The Authorisation header is ignored and another 401 challenge is issued, and the UE responds ?. and this causes a loop
scscf-proxy 401 -> icscf
icscf 401 -> Bono
Bono 401 -> UE

There seems to be a fundamental flaw here. The IMPI nc is incrementing, but the Authorisation header is not. I can?t see how this can work unless icscf increments nc in the authorisation header before sending it to the scscf

Also please note: I disabled nonce_count_supported in shared_config, but the result was a log line ?nonce count is supplied but not supported? (or words to that effect) and the Authorisation header is again ignored, and there is a loop.

How to move forward from here? I have searched in vain for a way to disable nonce count in Bria 4.

I can provide logs if helpful, but they are long and I don?t want to clog everyone?s inbox.

Kind regards
Jim

RedMatter Ltd
Jim Page
VP Mobile Services
+44 (0)333 150 1666
+44 (0)7870 361412
jim.page at redmatter.com<mailto:jim.page at redmatter.com>

_______________________________________________
Clearwater mailing list
Clearwater at lists.projectclearwater.org<mailto:Clearwater at lists.projectclearwater.org>
http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org

_______________________________________________
Clearwater mailing list
Clearwater at lists.projectclearwater.org<mailto:Clearwater at lists.projectclearwater.org>
http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org

_______________________________________________
Clearwater mailing list
Clearwater at lists.projectclearwater.org<mailto:Clearwater at lists.projectclearwater.org>
http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org


-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20170922/52515062/attachment.html>

From afriyie.abraham at gmail.com  Fri Sep 22 05:52:03 2017
From: afriyie.abraham at gmail.com (Afriyie Abraham Kwabena)
Date: Fri, 22 Sep 2017 12:52:03 +0300
Subject: [Project Clearwater] clearwater Installation using source code
 -- Help
In-Reply-To: <CY4PR02MB28875C8676FBB0C1A68588FB90670@CY4PR02MB2887.namprd02.prod.outlook.com>
References: <HE1PR05MB137061BF76FBAC3347167854FC660@HE1PR05MB1370.eurprd05.prod.outlook.com>
	<50C2CE0B-EBCA-4EB1-B493-F66DF7EEC5E8@redmatter.com>
	<D8F81832-9566-464A-9D8B-8BD2F99B83FD@gmail.com>
	<14312422-BE83-49E5-BADF-D1490E65B5D8@redmatter.com>
	<588DC1BC-44CC-443A-A8BC-2735CDCE88F5@gmail.com>
	<D66B6ECD-C978-40B7-AE1E-E51C85D677A8@redmatter.com>
	<CY4PR02MB28875C8676FBB0C1A68588FB90670@CY4PR02MB2887.namprd02.prod.outlook.com>
Message-ID: <2F8A7ACB-D541-463D-9DB6-045738B1806F@gmail.com>

Matt,

Thank you for this important information. 
Very good to know that Clearwater does not support Rx interface to EPC. 

BR
Abraham

Sent from my iPhone

> On 22 Sep 2017, at 12.31, Matt Williams <Matt.Williams at metaswitch.com> wrote:
> 
> Abraham,
>  
> Just to check, I think you're looking to create a basic VoLTE deployment:
> ?         an IMS core consisting of P-CSCF, I-CSCF, S-CSCF and HSS (no IR.92 TAS, but that's probably OK)
> ?         an EPC
> ?         the IMS core communicating with
> o   the UE (via the EPC) over the (SIP) Gm interface for call signaling
> o   the EPC via the (Diameter) Rx interface for QoS control?
>  
> Am I right in suggesting that you want to use Rx to control the EPC to set up the dedicated bearers?  (That would be the standard way.)
>  
> If so, unfortunately, Project Clearwater doesn't currently support the Rx interface to the EPC.  I don't believe OpenIMSCore does, either.  We'd be happy if you wanted to make this enhancement, but I suspect it's quite a big undertaking!
>  
> Metaswitch, the company that developed Clearwater (and for which I work) does have a VoLTE Solution (https://www.metaswitch.com/voice-over-lte-volte-and-voice-over-wifi-vowifi-solution) that supports the Rx interface, but this uses proprietary components which aren't part of open-source Project Clearwater.
>  
> I hope that helps!
>  
> Matt
>  
>  
> From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Jim Page
> Sent: 21 September 2017 14:51
> To: clearwater at lists.projectclearwater.org
> Subject: Re: [Project Clearwater] clearwater Installation using source code -- Help
>  
> Yes you have to have some DNS set up. Details are in the documentation. You need to have more than just A records to get this working properly ? so yes really you need to have DNS set up.
>  
> I have no idea what the parameters are though at a guess I would say that your home domain is everything to the right of the @ in your sip URIs, and the homestead cluster is the host name or IP address of the machine running homestead (dime, in my case). But that?s why I suggested actually running the binaries slightly differently; once you have installed the working system you can just create links from where the init scripts expect the production binaries to be to point to your built binaries.
>  
> It?s quite an assignment. If I were you I would consider using openimscore instead of clearwater. It looks easier to build from source and I can see QOS is something that has been discussed on their forums. You might also want to look at this: http://ieeexplore.ieee.org/document/5532766/?reload=true
>  
> The EPC I can?t help you with.
>  
> Good luck!
>  
>  
> RedMatter Ltd
> Jim Page
> VP Mobile Services
> +44 (0)333 150 1666
> +44 (0)7870 361412
> jim.page at redmatter.com
>  
> On 21 Sep 2017, at 14:32, Afriyie Abraham Kwabena <afriyie.abraham at gmail.com> wrote:
>  
> As part of my school special assignment, i have install an EPC and need to connect it to an IMS
> such that a dedicated bearer is created with a specific QoS for clearwater traffic or a call session.
> This is my task. However as you suggested, it would have been better to go the VM way but am not
> required to do that, am ask to install using the source code and also have to install the components 
> on a single machine which is very hard.
>  
> BTW,
> I have tried to build Sprout and bono, link: https://github.com/Metaswitch/sprout/blob/dev/docs/Development.md
> but running the following command hang on my terminal, how to 
>  
> ./MIBS="" LD_LIBRARY_PATH=usr/lib:$LD_LIBRARY_PATH build/bin/sprout -t --domain=<Home Domain> --hss=<Homestead cluster>
> Also what would be the parameter for the  - - hss=<Homestead cluster> ?  Do i need to have a DNS installed to handle the domain name
> for all the components?
>  
> BR
> Abraham
>  
>  
> On 21 Sep 2017, at 16:00, Jim Page <jim.page at redmatter.com> wrote:
>  
> If you have to run it on a single machine built from source, I guess your best option is to start here http://clearwater.readthedocs.io/en/stable/Manual_Install.html and just use a single host instead of 6. I guess it must be possible to some degree otherwise it wouldn?t be possible to create an all-in-one image. But you are making life hard for yourself by not going down the VM route. I would do the same thing however - install clearwater using production packages using apt-get, then once you have it working, selectively rebuild the component you want to change.
>  
> I am not sure what you want to achieve by adding QOS to clearwater. I don?t see what relevance QOS has where the only service you have running is VOIP. QOS is only useful if you want to prioritise one type of traffic over another, and is only relevant where you have different types of traffic trying to get access to a limited resource such as an MPLS line or a broadband line, in which case you set the QOS up in the router that sends traffic down that line. What is it exactly that you are trying to do?
>  
> RedMatter Ltd
> Jim Page
> VP Mobile Services
> +44 (0)333 150 1666
> +44 (0)7870 361412
> jim.page at redmatter.com
>  
> On 21 Sep 2017, at 13:47, Afriyie Abraham Kwabena <afriyie.abraham at gmail.com> wrote:
>  
> Hi,
>  
> My task is to install all the components of Clearwater on the same machine (ubuntu 14.04). In your explanation it means I need to have different hosts for each component but that is not my plan. 
> Is it possible to install all components without using docker or any virtualization platform. 
> Also for QoS, which component do you suggest I should modify. 
>  
> Sorry I may be asking basics, am newbie. 
>  
> BR
> Abraham
>  
>  
> 
> Sent from my iPhone
> 
> On 21 Sep 2017, at 15.17, Jim Page <jim.page at redmatter.com> wrote:
> 
> My recommendation (as a newbie) is to build a working release version of clearwater first, using these installation instructions: http://clearwater.readthedocs.io/en/stable/Installation_Instructions.html
>  
> Once you have a basic working install, decide what component you want to rebuild, and build it on the host for that component. In my case I did this with sprout:
>  
> 1. go to https://github.com/Metaswitch/sprout
> 2. Fork the repo: generic instructions here https://gist.github.com/Chaser324/ce0505fbed06b947d962
> 3. Carefully read README.md
> 4. go here for build instructions https://github.com/Metaswitch/sprout/blob/dev/docs/Development.md
> 5. Fork the repo and clone the forked repo on your local sprout host. Create a feature branch if you intend to push your changes back to clearwater.
> 6. Modify the sprout source as you see fit, and build sprout following the instructions in Development.md
> 7. When the build is complete, replace /usr/share/clearwater/bin/sprout and /sur/share/clearwater/sprout/plugins/*.so with links to your development builds in <your build dir>/sprout/build/bin.
> 8. ?sudo system sprout restart? - now you are running a fully working clearwater setup with your own sprout build (assuming you have not broken sprout with your changes!).
>  
> Hope this helps
> Cheers
> Jim 
>  
> RedMatter Ltd
> Jim Page
> VP Mobile Services
> +44 (0)333 150 1666
> +44 (0)7870 361412
> jim.page at redmatter.com
>  
> On 21 Sep 2017, at 11:59, Afriyie Abraham <afriyie.abraham at hotmail.com> wrote:
>  
> Hi,
> 
> I have tried installing clearwater using the source code following the procedure
> in the documentation but not working.
> 
> My main aim is to be able to have a device to device call session through my EPC
> connecting the IMS(clearwater).
> Also i would like to add some QoS parameters to for every call session.
> plan:
> 
> UE ??????EPC ??????IMS
> 
> Please can anyone help me with a working source code procedure to install clearwater
> on ubuntu 14.04.
> 
> Thanks in advance.
> 
> BR
> Abraham 
> 
> _______________________________________________
> Clearwater mailing list
> Clearwater at lists.projectclearwater.org
> http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org
>  
> _______________________________________________
> Clearwater mailing list
> Clearwater at lists.projectclearwater.org
> http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org
> _______________________________________________
> Clearwater mailing list
> Clearwater at lists.projectclearwater.org
> http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org
>  
> _______________________________________________
> Clearwater mailing list
> Clearwater at lists.projectclearwater.org
> http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org
>  
> _______________________________________________
> Clearwater mailing list
> Clearwater at lists.projectclearwater.org
> http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org
>  
> _______________________________________________
> Clearwater mailing list
> Clearwater at lists.projectclearwater.org
> http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20170922/abe5b4a4/attachment.html>

From jim.page at redmatter.com  Fri Sep 22 05:52:32 2017
From: jim.page at redmatter.com (Jim Page)
Date: Fri, 22 Sep 2017 09:52:32 +0000
Subject: [Project Clearwater] Looping authentication with Bria
In-Reply-To: <CY4PR02MB2887B407AEA431AB857F07D090670@CY4PR02MB2887.namprd02.prod.outlook.com>
References: <A08CF3C9-DCAB-46F3-A7AE-3E597E865129@redmatter.com>
	<C4025817-3A23-4856-8613-717AA07D40AC@redmatter.com>
	<C0E6789C-515C-4A39-BDB1-28BCB1183EE9@redmatter.com>
	<CY4PR02MB288723F16B75130EBE30F89290670@CY4PR02MB2887.namprd02.prod.outlook.com>
	<921BDA9A-996C-4A60-BF4F-5A855BB634C2@redmatter.com>
	<CY4PR02MB2887B407AEA431AB857F07D090670@CY4PR02MB2887.namprd02.prod.outlook.com>
Message-ID: <71FFD73F-02A6-4403-A8D7-28AD67141012@redmatter.com>

Hi Matt

Here it is:


[sprout-1]ubuntu at ec2-35-176-248-167:~$ cat /etc/clearwater/shared_config
# Deployment definitions
home_domain=ims.rmcore.net<http://ims.rmcore.net>
sprout_hostname=sprout.ims.rmcore.net<http://sprout.ims.rmcore.net>
sprout_hostname_mgmt=sprout.ims.rmcore.net:9886<http://sprout.ims.rmcore.net:9886>
hs_hostname=hs.ims.rmcore.net:8888<http://hs.ims.rmcore.net:8888>
hs_hostname_mgmt=hs.ims.rmcore.net:8886<http://hs.ims.rmcore.net:8886>
hs_provisioning_hostname=hs.ims.rmcore.net:8889<http://hs.ims.rmcore.net:8889>
homestead_impu_store="site1=vellum-site1.ims.rmcore.net<http://vellum-site1.ims.rmcore.net>?
xdms_hostname=homer.ims.rmcore.net:7888<http://homer.ims.rmcore.net:7888>
ralf_hostname=ralf.ims.rmcore.net:10888<http://ralf.ims.rmcore.net:10888>
cdf_identity=cdf.ims.rmcore.net<http://cdf.ims.rmcore.net>
sprout_impi_store=vellum.ims.rmcore.net<http://vellum.ims.rmcore.net>
sprout_registration_store="site1=vellum-site1.ims.rmcore.net<http://vellum-site1.ims.rmcore.net>?
cassandra_hostname=vellum.ims.rmcore.net<http://vellum.ims.rmcore.net>
chronos_hostname=vellum.ims.rmcore.net<http://vellum.ims.rmcore.net>
ralf_session_store="site1=vellum-site1.ims.rmcore.net<http://vellum-site1.ims.rmcore.net>?
memento_auth_store=vellum.ims.rmcore.net<http://vellum.ims.rmcore.net>
sas_server=0.0.0.0
enum_server=
alias_list=
scscf_uri=sip:scscf.sprout.ims.rmcore.net
upstream_port=0

# Email server configuration
smtp_smarthost=localhost
smtp_username=
smtp_password=
email_recovery_sender=ims at redmatter.com<mailto:email_recovery_sender=ims at redmatter.com>

# HSS configuration
hss_hostname=hss-site1.ims.rmcore.net<http://hss-site1.ims.rmcore.net>
hss_port=3868


# CDF configuration
billing_realm=cdf.ims.rmcore.net<http://cdf.ims.rmcore.net>

# Registrar configuration


# P-CSCF configuration


trusted_peers=??

# Sproutlet configuration



memento=5055
gemini=5055
cdiv=5055



# Keys
signup_key=?QEgRgtKh?
turn_workaround=?eHMwX98p?
ellis_api_key=?ENYNhvPg?
ellis_cookie_key=?FUZG1jMB?

# Advanced options
nonce_count_supported=Y

Kind regards
Jim

RedMatter Ltd
Jim Page
VP Mobile Services
+44 (0)333 150 1666
+44 (0)7870 361412
jim.page at redmatter.com<mailto:jim.page at redmatter.com>

On 22 Sep 2017, at 10:47, Matt Williams <Matt.Williams at metaswitch.com<mailto:Matt.Williams at metaswitch.com>> wrote:

Jim,

Thanks for those diagnostics!  I think the problem occurs here - specifically the uri_classifier logs:

22-09-2017 09:04:02.770 UTC Debug sproutletproxy.cpp:163: Find target Sproutlet for request
22-09-2017 09:04:02.770 UTC Debug sproutletproxy.cpp:197: Found next routable URI: sip:ims.rmcore.net;lr;service=registrar
22-09-2017 09:04:02.770 UTC Debug sproutletproxy.cpp:300: Found services param - registrar
22-09-2017 09:04:02.770 UTC Debug uri_classifier.cpp:139: home domain: false, local_to_node: false, is_gruu: false, enforce_user_phone: false, prefer_sip: true, treat_number_as_phone: false
22-09-2017 09:04:02.770 UTC Debug uri_classifier.cpp:185: Classified URI as 5
22-09-2017 09:04:02.770 UTC Debug sproutletproxy.cpp:427: Creating URI for service subscription

Basically, we have a SIP URI that says "service=registrar".  This invokes the registrar Sproutlet.  However, the registrar Sproutlet checks that the URI looks right before it accepts it (using the URIClassifier), and it finds that it's not for our home domain (see "home domain: false").  This means that it classifies URI as "5", which is a bit cryptic but corresponds to the URIClass enum, and means OFFNET_SIP_URI... so we route it off net.

So why isn't ims.rmcore.net<http://ims.rmcore.net/> recognized as the home domain?  Please can you share the /etc/clearwater/shared_config file from your system?

Thanks,

Matt

From: Jim Page [mailto:jim.page at redmatter.com]
Sent: 22 September 2017 10:27
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Cc: Matt Williams <Matt.Williams at metaswitch.com<mailto:Matt.Williams at metaswitch.com>>
Subject: Re: [Project Clearwater] Looping authentication with Bria

Hi Matt

Thanks a lot for getting in touch.

I have attached PCAPs of the bria (just sip) and the bono and sprout hosts (everything). Also the bono and sprout logs at log_level=5. I have copied this email to your metaswitch email in case the zip is removed from the forum emails, hope that?s ok.

Your explanation makes sense - let?s hope it?s an easy fix!

This is my #1 priority right now so please let me know if there?s anything else I can do to help debug this.

Kind regards
Jim
_______________________________________________
Clearwater mailing list
Clearwater at lists.projectclearwater.org<mailto:Clearwater at lists.projectclearwater.org>
http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20170922/5ab19129/attachment.html>

From jim.page at redmatter.com  Fri Sep 22 05:56:28 2017
From: jim.page at redmatter.com (Jim Page)
Date: Fri, 22 Sep 2017 09:56:28 +0000
Subject: [Project Clearwater] Looping authentication with Bria
In-Reply-To: <71FFD73F-02A6-4403-A8D7-28AD67141012@redmatter.com>
References: <A08CF3C9-DCAB-46F3-A7AE-3E597E865129@redmatter.com>
	<C4025817-3A23-4856-8613-717AA07D40AC@redmatter.com>
	<C0E6789C-515C-4A39-BDB1-28BCB1183EE9@redmatter.com>
	<CY4PR02MB288723F16B75130EBE30F89290670@CY4PR02MB2887.namprd02.prod.outlook.com>
	<921BDA9A-996C-4A60-BF4F-5A855BB634C2@redmatter.com>
	<CY4PR02MB2887B407AEA431AB857F07D090670@CY4PR02MB2887.namprd02.prod.outlook.com>
	<71FFD73F-02A6-4403-A8D7-28AD67141012@redmatter.com>
Message-ID: <3226A3C8-26C3-47D5-A8DF-13784F1706E7@redmatter.com>

Matt, does the HSS have any input into the process of deciding whether the URI is on the home domain? If so, is it possible I misconfigured the HSS? I have had a look through and cannot see anything obvious, but I am really not sure what HSS config might be relevant.
Kind regards
Jim

RedMatter Ltd
Jim Page
VP Mobile Services
+44 (0)333 150 1666
+44 (0)7870 361412
jim.page at redmatter.com<mailto:jim.page at redmatter.com>

On 22 Sep 2017, at 10:52, Jim Page <jim.page at redmatter.com<mailto:jim.page at redmatter.com>> wrote:

Hi Matt

Here it is:


[sprout-1]ubuntu at ec2-35-176-248-167:~$ cat /etc/clearwater/shared_config
# Deployment definitions
home_domain=ims.rmcore.net<http://ims.rmcore.net/>
sprout_hostname=sprout.ims.rmcore.net<http://sprout.ims.rmcore.net/>
sprout_hostname_mgmt=sprout.ims.rmcore.net:9886<http://sprout.ims.rmcore.net:9886/>
hs_hostname=hs.ims.rmcore.net:8888<http://hs.ims.rmcore.net:8888/>
hs_hostname_mgmt=hs.ims.rmcore.net:8886<http://hs.ims.rmcore.net:8886/>
hs_provisioning_hostname=hs.ims.rmcore.net:8889<http://hs.ims.rmcore.net:8889/>
homestead_impu_store="site1=vellum-site1.ims.rmcore.net<http://vellum-site1.ims.rmcore.net/>?
xdms_hostname=homer.ims.rmcore.net:7888<http://homer.ims.rmcore.net:7888/>
ralf_hostname=ralf.ims.rmcore.net:10888<http://ralf.ims.rmcore.net:10888/>
cdf_identity=cdf.ims.rmcore.net<http://cdf.ims.rmcore.net/>
sprout_impi_store=vellum.ims.rmcore.net<http://vellum.ims.rmcore.net/>
sprout_registration_store="site1=vellum-site1.ims.rmcore.net<http://vellum-site1.ims.rmcore.net/>?
cassandra_hostname=vellum.ims.rmcore.net<http://vellum.ims.rmcore.net/>
chronos_hostname=vellum.ims.rmcore.net<http://vellum.ims.rmcore.net/>
ralf_session_store="site1=vellum-site1.ims.rmcore.net<http://vellum-site1.ims.rmcore.net/>?
memento_auth_store=vellum.ims.rmcore.net<http://vellum.ims.rmcore.net/>
sas_server=0.0.0.0
enum_server=
alias_list=
scscf_uri=sip:scscf.sprout.ims.rmcore.net
upstream_port=0

# Email server configuration
smtp_smarthost=localhost
smtp_username=
smtp_password=
email_recovery_sender=ims at redmatter.com<mailto:email_recovery_sender=ims at redmatter.com>

# HSS configuration
hss_hostname=hss-site1.ims.rmcore.net<http://hss-site1.ims.rmcore.net/>
hss_port=3868


# CDF configuration
billing_realm=cdf.ims.rmcore.net<http://cdf.ims.rmcore.net/>

# Registrar configuration


# P-CSCF configuration


trusted_peers=??

# Sproutlet configuration



memento=5055
gemini=5055
cdiv=5055



# Keys
signup_key=?QEgRgtKh?
turn_workaround=?eHMwX98p?
ellis_api_key=?ENYNhvPg?
ellis_cookie_key=?FUZG1jMB?

# Advanced options
nonce_count_supported=Y

Kind regards
Jim

RedMatter Ltd
Jim Page
VP Mobile Services
+44 (0)333 150 1666
+44 (0)7870 361412
jim.page at redmatter.com<mailto:jim.page at redmatter.com>

On 22 Sep 2017, at 10:47, Matt Williams <Matt.Williams at metaswitch.com<mailto:Matt.Williams at metaswitch.com>> wrote:

Jim,

Thanks for those diagnostics!  I think the problem occurs here - specifically the uri_classifier logs:

22-09-2017 09:04:02.770 UTC Debug sproutletproxy.cpp:163: Find target Sproutlet for request
22-09-2017 09:04:02.770 UTC Debug sproutletproxy.cpp:197: Found next routable URI: sip:ims.rmcore.net;lr;service=registrar
22-09-2017 09:04:02.770 UTC Debug sproutletproxy.cpp:300: Found services param - registrar
22-09-2017 09:04:02.770 UTC Debug uri_classifier.cpp:139: home domain: false, local_to_node: false, is_gruu: false, enforce_user_phone: false, prefer_sip: true, treat_number_as_phone: false
22-09-2017 09:04:02.770 UTC Debug uri_classifier.cpp:185: Classified URI as 5
22-09-2017 09:04:02.770 UTC Debug sproutletproxy.cpp:427: Creating URI for service subscription

Basically, we have a SIP URI that says "service=registrar".  This invokes the registrar Sproutlet.  However, the registrar Sproutlet checks that the URI looks right before it accepts it (using the URIClassifier), and it finds that it's not for our home domain (see "home domain: false").  This means that it classifies URI as "5", which is a bit cryptic but corresponds to the URIClass enum, and means OFFNET_SIP_URI... so we route it off net.

So why isn't ims.rmcore.net<http://ims.rmcore.net/> recognized as the home domain?  Please can you share the /etc/clearwater/shared_config file from your system?

Thanks,

Matt

From: Jim Page [mailto:jim.page at redmatter.com]
Sent: 22 September 2017 10:27
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Cc: Matt Williams <Matt.Williams at metaswitch.com<mailto:Matt.Williams at metaswitch.com>>
Subject: Re: [Project Clearwater] Looping authentication with Bria

Hi Matt

Thanks a lot for getting in touch.

I have attached PCAPs of the bria (just sip) and the bono and sprout hosts (everything). Also the bono and sprout logs at log_level=5. I have copied this email to your metaswitch email in case the zip is removed from the forum emails, hope that?s ok.

Your explanation makes sense - let?s hope it?s an easy fix!

This is my #1 priority right now so please let me know if there?s anything else I can do to help debug this.

Kind regards
Jim
_______________________________________________
Clearwater mailing list
Clearwater at lists.projectclearwater.org<mailto:Clearwater at lists.projectclearwater.org>
http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org

_______________________________________________
Clearwater mailing list
Clearwater at lists.projectclearwater.org<mailto:Clearwater at lists.projectclearwater.org>
http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20170922/4fb7680c/attachment.html>

From jim.page at redmatter.com  Fri Sep 22 06:00:18 2017
From: jim.page at redmatter.com (Jim Page)
Date: Fri, 22 Sep 2017 10:00:18 +0000
Subject: [Project Clearwater] Looping authentication with Bria
In-Reply-To: <3226A3C8-26C3-47D5-A8DF-13784F1706E7@redmatter.com>
References: <A08CF3C9-DCAB-46F3-A7AE-3E597E865129@redmatter.com>
	<C4025817-3A23-4856-8613-717AA07D40AC@redmatter.com>
	<C0E6789C-515C-4A39-BDB1-28BCB1183EE9@redmatter.com>
	<CY4PR02MB288723F16B75130EBE30F89290670@CY4PR02MB2887.namprd02.prod.outlook.com>
	<921BDA9A-996C-4A60-BF4F-5A855BB634C2@redmatter.com>
	<CY4PR02MB2887B407AEA431AB857F07D090670@CY4PR02MB2887.namprd02.prod.outlook.com>
	<71FFD73F-02A6-4403-A8D7-28AD67141012@redmatter.com>
	<3226A3C8-26C3-47D5-A8DF-13784F1706E7@redmatter.com>
Message-ID: <9BF83C52-F561-4135-9F75-41133E97D7D2@redmatter.com>

One more factoid - the HSS installation via chef was not perfect. The HSS package postinstall scripts failed ? I -think- because mysql was already running when the package was installed, and also it wrote some bad config into /etc/resolv.conf which messed up DNS. Finally, the SCSCF and ICSCF ports were incorrectly configured. I think I sorted most of that out, and I can see diameter packets arriving and the HSS logs indicate that stuff is being processed, but I thought I should mention it in case it rings any bells.
Kind regards
Jim

RedMatter Ltd
Jim Page
VP Mobile Services
+44 (0)333 150 1666
+44 (0)7870 361412
jim.page at redmatter.com<mailto:jim.page at redmatter.com>

On 22 Sep 2017, at 10:56, Jim Page <jim.page at redmatter.com<mailto:jim.page at redmatter.com>> wrote:

Matt, does the HSS have any input into the process of deciding whether the URI is on the home domain? If so, is it possible I misconfigured the HSS? I have had a look through and cannot see anything obvious, but I am really not sure what HSS config might be relevant.
Kind regards
Jim

RedMatter Ltd
Jim Page
VP Mobile Services
+44 (0)333 150 1666
+44 (0)7870 361412
jim.page at redmatter.com<mailto:jim.page at redmatter.com>

On 22 Sep 2017, at 10:52, Jim Page <jim.page at redmatter.com<mailto:jim.page at redmatter.com>> wrote:

Hi Matt

Here it is:


[sprout-1]ubuntu at ec2-35-176-248-167:~$ cat /etc/clearwater/shared_config
# Deployment definitions
home_domain=ims.rmcore.net<http://ims.rmcore.net/>
sprout_hostname=sprout.ims.rmcore.net<http://sprout.ims.rmcore.net/>
sprout_hostname_mgmt=sprout.ims.rmcore.net:9886<http://sprout.ims.rmcore.net:9886/>
hs_hostname=hs.ims.rmcore.net:8888<http://hs.ims.rmcore.net:8888/>
hs_hostname_mgmt=hs.ims.rmcore.net:8886<http://hs.ims.rmcore.net:8886/>
hs_provisioning_hostname=hs.ims.rmcore.net:8889<http://hs.ims.rmcore.net:8889/>
homestead_impu_store="site1=vellum-site1.ims.rmcore.net<http://vellum-site1.ims.rmcore.net/>?
xdms_hostname=homer.ims.rmcore.net:7888<http://homer.ims.rmcore.net:7888/>
ralf_hostname=ralf.ims.rmcore.net:10888<http://ralf.ims.rmcore.net:10888/>
cdf_identity=cdf.ims.rmcore.net<http://cdf.ims.rmcore.net/>
sprout_impi_store=vellum.ims.rmcore.net<http://vellum.ims.rmcore.net/>
sprout_registration_store="site1=vellum-site1.ims.rmcore.net<http://vellum-site1.ims.rmcore.net/>?
cassandra_hostname=vellum.ims.rmcore.net<http://vellum.ims.rmcore.net/>
chronos_hostname=vellum.ims.rmcore.net<http://vellum.ims.rmcore.net/>
ralf_session_store="site1=vellum-site1.ims.rmcore.net<http://vellum-site1.ims.rmcore.net/>?
memento_auth_store=vellum.ims.rmcore.net<http://vellum.ims.rmcore.net/>
sas_server=0.0.0.0
enum_server=
alias_list=
scscf_uri=sip:scscf.sprout.ims.rmcore.net
upstream_port=0

# Email server configuration
smtp_smarthost=localhost
smtp_username=
smtp_password=
email_recovery_sender=ims at redmatter.com<mailto:email_recovery_sender=ims at redmatter.com>

# HSS configuration
hss_hostname=hss-site1.ims.rmcore.net<http://hss-site1.ims.rmcore.net/>
hss_port=3868


# CDF configuration
billing_realm=cdf.ims.rmcore.net<http://cdf.ims.rmcore.net/>

# Registrar configuration


# P-CSCF configuration


trusted_peers=??

# Sproutlet configuration



memento=5055
gemini=5055
cdiv=5055



# Keys
signup_key=?QEgRgtKh?
turn_workaround=?eHMwX98p?
ellis_api_key=?ENYNhvPg?
ellis_cookie_key=?FUZG1jMB?

# Advanced options
nonce_count_supported=Y

Kind regards
Jim

RedMatter Ltd
Jim Page
VP Mobile Services
+44 (0)333 150 1666
+44 (0)7870 361412
jim.page at redmatter.com<mailto:jim.page at redmatter.com>

On 22 Sep 2017, at 10:47, Matt Williams <Matt.Williams at metaswitch.com<mailto:Matt.Williams at metaswitch.com>> wrote:

Jim,

Thanks for those diagnostics!  I think the problem occurs here - specifically the uri_classifier logs:

22-09-2017 09:04:02.770 UTC Debug sproutletproxy.cpp:163: Find target Sproutlet for request
22-09-2017 09:04:02.770 UTC Debug sproutletproxy.cpp:197: Found next routable URI: sip:ims.rmcore.net;lr;service=registrar
22-09-2017 09:04:02.770 UTC Debug sproutletproxy.cpp:300: Found services param - registrar
22-09-2017 09:04:02.770 UTC Debug uri_classifier.cpp:139: home domain: false, local_to_node: false, is_gruu: false, enforce_user_phone: false, prefer_sip: true, treat_number_as_phone: false
22-09-2017 09:04:02.770 UTC Debug uri_classifier.cpp:185: Classified URI as 5
22-09-2017 09:04:02.770 UTC Debug sproutletproxy.cpp:427: Creating URI for service subscription

Basically, we have a SIP URI that says "service=registrar".  This invokes the registrar Sproutlet.  However, the registrar Sproutlet checks that the URI looks right before it accepts it (using the URIClassifier), and it finds that it's not for our home domain (see "home domain: false").  This means that it classifies URI as "5", which is a bit cryptic but corresponds to the URIClass enum, and means OFFNET_SIP_URI... so we route it off net.

So why isn't ims.rmcore.net<http://ims.rmcore.net/> recognized as the home domain?  Please can you share the /etc/clearwater/shared_config file from your system?

Thanks,

Matt

From: Jim Page [mailto:jim.page at redmatter.com]
Sent: 22 September 2017 10:27
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Cc: Matt Williams <Matt.Williams at metaswitch.com<mailto:Matt.Williams at metaswitch.com>>
Subject: Re: [Project Clearwater] Looping authentication with Bria

Hi Matt

Thanks a lot for getting in touch.

I have attached PCAPs of the bria (just sip) and the bono and sprout hosts (everything). Also the bono and sprout logs at log_level=5. I have copied this email to your metaswitch email in case the zip is removed from the forum emails, hope that?s ok.

Your explanation makes sense - let?s hope it?s an easy fix!

This is my #1 priority right now so please let me know if there?s anything else I can do to help debug this.

Kind regards
Jim
_______________________________________________
Clearwater mailing list
Clearwater at lists.projectclearwater.org<mailto:Clearwater at lists.projectclearwater.org>
http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org

_______________________________________________
Clearwater mailing list
Clearwater at lists.projectclearwater.org<mailto:Clearwater at lists.projectclearwater.org>
http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org


-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20170922/c061f014/attachment.html>

From Matt.Williams at metaswitch.com  Fri Sep 22 06:05:00 2017
From: Matt.Williams at metaswitch.com (Matt Williams)
Date: Fri, 22 Sep 2017 10:05:00 +0000
Subject: [Project Clearwater] clearwater Installation using source code
 -- Help
In-Reply-To: <2F8A7ACB-D541-463D-9DB6-045738B1806F@gmail.com>
References: <HE1PR05MB137061BF76FBAC3347167854FC660@HE1PR05MB1370.eurprd05.prod.outlook.com>
	<50C2CE0B-EBCA-4EB1-B493-F66DF7EEC5E8@redmatter.com>
	<D8F81832-9566-464A-9D8B-8BD2F99B83FD@gmail.com>
	<14312422-BE83-49E5-BADF-D1490E65B5D8@redmatter.com>
	<588DC1BC-44CC-443A-A8BC-2735CDCE88F5@gmail.com>
	<D66B6ECD-C978-40B7-AE1E-E51C85D677A8@redmatter.com>
	<CY4PR02MB28875C8676FBB0C1A68588FB90670@CY4PR02MB2887.namprd02.prod.outlook.com>
	<2F8A7ACB-D541-463D-9DB6-045738B1806F@gmail.com>
Message-ID: <CY4PR02MB28878361E79A78451D7279E290670@CY4PR02MB2887.namprd02.prod.outlook.com>

Just for completeness, while Project Clearwater does not support the Rx interface to EPC, in our VoLTE Solution we replace the Bono P-CSCF with our proprietary Perimeta product (https://www.metaswitch.com/perimeta-session-border-controller-sbc) - it is this that provides the Rx interface in that solution.

Matt


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Afriyie Abraham Kwabena
Sent: 22 September 2017 10:52
To: clearwater at lists.projectclearwater.org
Subject: Re: [Project Clearwater] clearwater Installation using source code -- Help

Matt,

Thank you for this important information.
Very good to know that Clearwater does not support Rx interface to EPC.

BR
Abraham

Sent from my iPhone

On 22 Sep 2017, at 12.31, Matt Williams <Matt.Williams at metaswitch.com<mailto:Matt.Williams at metaswitch.com>> wrote:
Abraham,

Just to check, I think you're looking to create a basic VoLTE deployment:

?         an IMS core consisting of P-CSCF, I-CSCF, S-CSCF and HSS (no IR.92 TAS, but that's probably OK)

?         an EPC

?         the IMS core communicating with

o   the UE (via the EPC) over the (SIP) Gm interface for call signaling

o   the EPC via the (Diameter) Rx interface for QoS control?

Am I right in suggesting that you want to use Rx to control the EPC to set up the dedicated bearers?  (That would be the standard way.)

If so, unfortunately, Project Clearwater doesn't currently support the Rx interface to the EPC.  I don't believe OpenIMSCore does, either.  We'd be happy if you wanted to make this enhancement, but I suspect it's quite a big undertaking!

Metaswitch, the company that developed Clearwater (and for which I work) does have a VoLTE Solution (https://www.metaswitch.com/voice-over-lte-volte-and-voice-over-wifi-vowifi-solution) that supports the Rx interface, but this uses proprietary components which aren't part of open-source Project Clearwater.

I hope that helps!

Matt


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Jim Page
Sent: 21 September 2017 14:51
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] clearwater Installation using source code -- Help

Yes you have to have some DNS set up. Details are in the documentation. You need to have more than just A records to get this working properly ? so yes really you need to have DNS set up.

I have no idea what the parameters are though at a guess I would say that your home domain is everything to the right of the @ in your sip URIs, and the homestead cluster is the host name or IP address of the machine running homestead (dime, in my case). But that?s why I suggested actually running the binaries slightly differently; once you have installed the working system you can just create links from where the init scripts expect the production binaries to be to point to your built binaries.

It?s quite an assignment. If I were you I would consider using openimscore instead of clearwater. It looks easier to build from source and I can see QOS is something that has been discussed on their forums. You might also want to look at this: http://ieeexplore.ieee.org/document/5532766/?reload=true

The EPC I can?t help you with.

Good luck!


RedMatter Ltd
Jim Page
VP Mobile Services
+44 (0)333 150 1666
+44 (0)7870 361412
jim.page at redmatter.com<mailto:jim.page at redmatter.com>

On 21 Sep 2017, at 14:32, Afriyie Abraham Kwabena <afriyie.abraham at gmail.com<mailto:afriyie.abraham at gmail.com>> wrote:

As part of my school special assignment, i have install an EPC and need to connect it to an IMS
such that a dedicated bearer is created with a specific QoS for clearwater traffic or a call session.
This is my task. However as you suggested, it would have been better to go the VM way but am not
required to do that, am ask to install using the source code and also have to install the components
on a single machine which is very hard.

BTW,
I have tried to build Sprout and bono, link: https://github.com/Metaswitch/sprout/blob/dev/docs/Development.md
but running the following command hang on my terminal, how to


./MIBS="" LD_LIBRARY_PATH=usr/lib:$LD_LIBRARY_PATH build/bin/sprout -t --domain=<Home Domain> --hss=<Homestead cluster>
Also what would be the parameter for the  - - hss=<Homestead cluster> ?  Do i need to have a DNS installed to handle the domain name
for all the components?

BR
Abraham


On 21 Sep 2017, at 16:00, Jim Page <jim.page at redmatter.com<mailto:jim.page at redmatter.com>> wrote:

If you have to run it on a single machine built from source, I guess your best option is to start here http://clearwater.readthedocs.io/en/stable/Manual_Install.html and just use a single host instead of 6. I guess it must be possible to some degree otherwise it wouldn?t be possible to create an all-in-one image. But you are making life hard for yourself by not going down the VM route. I would do the same thing however - install clearwater using production packages using apt-get, then once you have it working, selectively rebuild the component you want to change.

I am not sure what you want to achieve by adding QOS to clearwater. I don?t see what relevance QOS has where the only service you have running is VOIP. QOS is only useful if you want to prioritise one type of traffic over another, and is only relevant where you have different types of traffic trying to get access to a limited resource such as an MPLS line or a broadband line, in which case you set the QOS up in the router that sends traffic down that line. What is it exactly that you are trying to do?

RedMatter Ltd
Jim Page
VP Mobile Services
+44 (0)333 150 1666
+44 (0)7870 361412
jim.page at redmatter.com<mailto:jim.page at redmatter.com>

On 21 Sep 2017, at 13:47, Afriyie Abraham Kwabena <afriyie.abraham at gmail.com<mailto:afriyie.abraham at gmail.com>> wrote:

Hi,

My task is to install all the components of Clearwater on the same machine (ubuntu 14.04). In your explanation it means I need to have different hosts for each component but that is not my plan.
Is it possible to install all components without using docker or any virtualization platform.
Also for QoS, which component do you suggest I should modify.

Sorry I may be asking basics, am newbie.

BR
Abraham


Sent from my iPhone

On 21 Sep 2017, at 15.17, Jim Page <jim.page at redmatter.com<mailto:jim.page at redmatter.com>> wrote:
My recommendation (as a newbie) is to build a working release version of clearwater first, using these installation instructions: http://clearwater.readthedocs.io/en/stable/Installation_Instructions.html

Once you have a basic working install, decide what component you want to rebuild, and build it on the host for that component. In my case I did this with sprout:

1. go to https://github.com/Metaswitch/sprout
2. Fork the repo: generic instructions here https://gist.github.com/Chaser324/ce0505fbed06b947d962
3. Carefully read README.md
4. go here for build instructions https://github.com/Metaswitch/sprout/blob/dev/docs/Development.md
5. Fork the repo and clone the forked repo on your local sprout host. Create a feature branch if you intend to push your changes back to clearwater.
6. Modify the sprout source as you see fit, and build sprout following the instructions in Development.md
7. When the build is complete, replace /usr/share/clearwater/bin/sprout and /sur/share/clearwater/sprout/plugins/*.so with links to your development builds in <your build dir>/sprout/build/bin.
8. ?sudo system sprout restart? - now you are running a fully working clearwater setup with your own sprout build (assuming you have not broken sprout with your changes!).

Hope this helps
Cheers
Jim

RedMatter Ltd
Jim Page
VP Mobile Services
+44 (0)333 150 1666
+44 (0)7870 361412
jim.page at redmatter.com<mailto:jim.page at redmatter.com>

On 21 Sep 2017, at 11:59, Afriyie Abraham <afriyie.abraham at hotmail.com<mailto:afriyie.abraham at hotmail.com>> wrote:

Hi,

I have tried installing clearwater using the source code following the procedure
in the documentation but not working.

My main aim is to be able to have a device to device call session through my EPC
connecting the IMS(clearwater).
Also i would like to add some QoS parameters to for every call session.
plan:

UE ??????EPC ??????IMS

Please can anyone help me with a working source code procedure to install clearwater
on ubuntu 14.04.

Thanks in advance.

BR
Abraham

_______________________________________________
Clearwater mailing list
Clearwater at lists.projectclearwater.org<mailto:Clearwater at lists.projectclearwater.org>
http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org

_______________________________________________
Clearwater mailing list
Clearwater at lists.projectclearwater.org<mailto:Clearwater at lists.projectclearwater.org>
http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org
_______________________________________________
Clearwater mailing list
Clearwater at lists.projectclearwater.org<mailto:Clearwater at lists.projectclearwater.org>
http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org

_______________________________________________
Clearwater mailing list
Clearwater at lists.projectclearwater.org<mailto:Clearwater at lists.projectclearwater.org>
http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org

_______________________________________________
Clearwater mailing list
Clearwater at lists.projectclearwater.org<mailto:Clearwater at lists.projectclearwater.org>
http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org

_______________________________________________
Clearwater mailing list
Clearwater at lists.projectclearwater.org<mailto:Clearwater at lists.projectclearwater.org>
http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20170922/e02ea64d/attachment.html>

From Matt.Williams at metaswitch.com  Fri Sep 22 06:23:26 2017
From: Matt.Williams at metaswitch.com (Matt Williams)
Date: Fri, 22 Sep 2017 10:23:26 +0000
Subject: [Project Clearwater] Looping authentication with Bria
In-Reply-To: <9BF83C52-F561-4135-9F75-41133E97D7D2@redmatter.com>
References: <A08CF3C9-DCAB-46F3-A7AE-3E597E865129@redmatter.com>
	<C4025817-3A23-4856-8613-717AA07D40AC@redmatter.com>
	<C0E6789C-515C-4A39-BDB1-28BCB1183EE9@redmatter.com>
	<CY4PR02MB288723F16B75130EBE30F89290670@CY4PR02MB2887.namprd02.prod.outlook.com>
	<921BDA9A-996C-4A60-BF4F-5A855BB634C2@redmatter.com>
	<CY4PR02MB2887B407AEA431AB857F07D090670@CY4PR02MB2887.namprd02.prod.outlook.com>
	<71FFD73F-02A6-4403-A8D7-28AD67141012@redmatter.com>
	<3226A3C8-26C3-47D5-A8DF-13784F1706E7@redmatter.com>
	<9BF83C52-F561-4135-9F75-41133E97D7D2@redmatter.com>
Message-ID: <CY4PR02MB2887F6CD39205F89C2A7D7BF90670@CY4PR02MB2887.namprd02.prod.outlook.com>

Thanks!  When the I-CSCF receives the User-Authentication-Answer from the HSS, the HSS returns "sip:scscf.ims.rmcore.net" as the S-CSCF to which the subscriber is assigned... but the configuration below is such that the S-CSCF doesn't recognize this as itself.  Normally, the I-CSCF would then route the request to this other S-CSCF, except the domain name resolves to our own S-CSCF again.

I'm not quite sure how the HSS got into this state (maybe the first registration was while the S-CSCF was still being reconfigured?), but please can you either try forcing de-registration on the HSS or (if this isn't easy with your HSS) creating a new subscriber and registering with that?  It would be great if you could grab the same logs and network captures as before for the first registration attempt, in case this doesn't fix it itself.

Thanks,

Matt


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Jim Page
Sent: 22 September 2017 11:00
To: clearwater at lists.projectclearwater.org
Subject: Re: [Project Clearwater] Looping authentication with Bria

One more factoid - the HSS installation via chef was not perfect. The HSS package postinstall scripts failed ? I -think- because mysql was already running when the package was installed, and also it wrote some bad config into /etc/resolv.conf which messed up DNS. Finally, the SCSCF and ICSCF ports were incorrectly configured. I think I sorted most of that out, and I can see diameter packets arriving and the HSS logs indicate that stuff is being processed, but I thought I should mention it in case it rings any bells.
Kind regards
Jim

RedMatter Ltd
Jim Page
VP Mobile Services
+44 (0)333 150 1666
+44 (0)7870 361412
jim.page at redmatter.com<mailto:jim.page at redmatter.com>

On 22 Sep 2017, at 10:56, Jim Page <jim.page at redmatter.com<mailto:jim.page at redmatter.com>> wrote:

Matt, does the HSS have any input into the process of deciding whether the URI is on the home domain? If so, is it possible I misconfigured the HSS? I have had a look through and cannot see anything obvious, but I am really not sure what HSS config might be relevant.
Kind regards
Jim

RedMatter Ltd
Jim Page
VP Mobile Services
+44 (0)333 150 1666
+44 (0)7870 361412
jim.page at redmatter.com<mailto:jim.page at redmatter.com>

On 22 Sep 2017, at 10:52, Jim Page <jim.page at redmatter.com<mailto:jim.page at redmatter.com>> wrote:

Hi Matt

Here it is:


[sprout-1]ubuntu at ec2-35-176-248-167:~$ cat /etc/clearwater/shared_config
# Deployment definitions
home_domain=ims.rmcore.net<http://ims.rmcore.net/>
sprout_hostname=sprout.ims.rmcore.net<http://sprout.ims.rmcore.net/>
sprout_hostname_mgmt=sprout.ims.rmcore.net:9886<http://sprout.ims.rmcore.net:9886/>
hs_hostname=hs.ims.rmcore.net:8888<http://hs.ims.rmcore.net:8888/>
hs_hostname_mgmt=hs.ims.rmcore.net:8886<http://hs.ims.rmcore.net:8886/>
hs_provisioning_hostname=hs.ims.rmcore.net:8889<http://hs.ims.rmcore.net:8889/>
homestead_impu_store="site1=vellum-site1.ims.rmcore.net<http://vellum-site1.ims.rmcore.net/>?
xdms_hostname=homer.ims.rmcore.net:7888<http://homer.ims.rmcore.net:7888/>
ralf_hostname=ralf.ims.rmcore.net:10888<http://ralf.ims.rmcore.net:10888/>
cdf_identity=cdf.ims.rmcore.net<http://cdf.ims.rmcore.net/>
sprout_impi_store=vellum.ims.rmcore.net<http://vellum.ims.rmcore.net/>
sprout_registration_store="site1=vellum-site1.ims.rmcore.net<http://vellum-site1.ims.rmcore.net/>?
cassandra_hostname=vellum.ims.rmcore.net<http://vellum.ims.rmcore.net/>
chronos_hostname=vellum.ims.rmcore.net<http://vellum.ims.rmcore.net/>
ralf_session_store="site1=vellum-site1.ims.rmcore.net<http://vellum-site1.ims.rmcore.net/>?
memento_auth_store=vellum.ims.rmcore.net<http://vellum.ims.rmcore.net/>
sas_server=0.0.0.0
enum_server=
alias_list=
scscf_uri=sip:scscf.sprout.ims.rmcore.net
upstream_port=0

# Email server configuration
smtp_smarthost=localhost
smtp_username=
smtp_password=
email_recovery_sender=ims at redmatter.com<mailto:email_recovery_sender=ims at redmatter.com>

# HSS configuration
hss_hostname=hss-site1.ims.rmcore.net<http://hss-site1.ims.rmcore.net/>
hss_port=3868


# CDF configuration
billing_realm=cdf.ims.rmcore.net<http://cdf.ims.rmcore.net/>

# Registrar configuration


# P-CSCF configuration


trusted_peers=??

# Sproutlet configuration



memento=5055
gemini=5055
cdiv=5055



# Keys
signup_key=?QEgRgtKh?
turn_workaround=?eHMwX98p?
ellis_api_key=?ENYNhvPg?
ellis_cookie_key=?FUZG1jMB?

# Advanced options
nonce_count_supported=Y

Kind regards
Jim

RedMatter Ltd
Jim Page
VP Mobile Services
+44 (0)333 150 1666
+44 (0)7870 361412
jim.page at redmatter.com<mailto:jim.page at redmatter.com>

On 22 Sep 2017, at 10:47, Matt Williams <Matt.Williams at metaswitch.com<mailto:Matt.Williams at metaswitch.com>> wrote:

Jim,

Thanks for those diagnostics!  I think the problem occurs here - specifically the uri_classifier logs:

22-09-2017 09:04:02.770 UTC Debug sproutletproxy.cpp:163: Find target Sproutlet for request
22-09-2017 09:04:02.770 UTC Debug sproutletproxy.cpp:197: Found next routable URI: sip:ims.rmcore.net;lr;service=registrar
22-09-2017 09:04:02.770 UTC Debug sproutletproxy.cpp:300: Found services param - registrar
22-09-2017 09:04:02.770 UTC Debug uri_classifier.cpp:139: home domain: false, local_to_node: false, is_gruu: false, enforce_user_phone: false, prefer_sip: true, treat_number_as_phone: false
22-09-2017 09:04:02.770 UTC Debug uri_classifier.cpp:185: Classified URI as 5
22-09-2017 09:04:02.770 UTC Debug sproutletproxy.cpp:427: Creating URI for service subscription

Basically, we have a SIP URI that says "service=registrar".  This invokes the registrar Sproutlet.  However, the registrar Sproutlet checks that the URI looks right before it accepts it (using the URIClassifier), and it finds that it's not for our home domain (see "home domain: false").  This means that it classifies URI as "5", which is a bit cryptic but corresponds to the URIClass enum, and means OFFNET_SIP_URI... so we route it off net.

So why isn't ims.rmcore.net<http://ims.rmcore.net/> recognized as the home domain?  Please can you share the /etc/clearwater/shared_config file from your system?

Thanks,

Matt

From: Jim Page [mailto:jim.page at redmatter.com]
Sent: 22 September 2017 10:27
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Cc: Matt Williams <Matt.Williams at metaswitch.com<mailto:Matt.Williams at metaswitch.com>>
Subject: Re: [Project Clearwater] Looping authentication with Bria

Hi Matt

Thanks a lot for getting in touch.

I have attached PCAPs of the bria (just sip) and the bono and sprout hosts (everything). Also the bono and sprout logs at log_level=5. I have copied this email to your metaswitch email in case the zip is removed from the forum emails, hope that?s ok.

Your explanation makes sense - let?s hope it?s an easy fix!

This is my #1 priority right now so please let me know if there?s anything else I can do to help debug this.

Kind regards
Jim
_______________________________________________
Clearwater mailing list
Clearwater at lists.projectclearwater.org<mailto:Clearwater at lists.projectclearwater.org>
http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org

_______________________________________________
Clearwater mailing list
Clearwater at lists.projectclearwater.org<mailto:Clearwater at lists.projectclearwater.org>
http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org


-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20170922/883ef68f/attachment.html>

From jim.page at redmatter.com  Fri Sep 22 06:45:18 2017
From: jim.page at redmatter.com (Jim Page)
Date: Fri, 22 Sep 2017 10:45:18 +0000
Subject: [Project Clearwater] Looping authentication with Bria
In-Reply-To: <CY4PR02MB2887F6CD39205F89C2A7D7BF90670@CY4PR02MB2887.namprd02.prod.outlook.com>
References: <A08CF3C9-DCAB-46F3-A7AE-3E597E865129@redmatter.com>
	<C4025817-3A23-4856-8613-717AA07D40AC@redmatter.com>
	<C0E6789C-515C-4A39-BDB1-28BCB1183EE9@redmatter.com>
	<CY4PR02MB288723F16B75130EBE30F89290670@CY4PR02MB2887.namprd02.prod.outlook.com>
	<921BDA9A-996C-4A60-BF4F-5A855BB634C2@redmatter.com>
	<CY4PR02MB2887B407AEA431AB857F07D090670@CY4PR02MB2887.namprd02.prod.outlook.com>
	<71FFD73F-02A6-4403-A8D7-28AD67141012@redmatter.com>
	<3226A3C8-26C3-47D5-A8DF-13784F1706E7@redmatter.com>
	<9BF83C52-F561-4135-9F75-41133E97D7D2@redmatter.com>
	<CY4PR02MB2887F6CD39205F89C2A7D7BF90670@CY4PR02MB2887.namprd02.prod.outlook.com>
Message-ID: <D36ABEF5-066B-4126-9196-31051ED30A3F@redmatter.com>

Hi Matt

You nailed it. The SCSCF name I provisioned in the HSS was a CNAME that pointed to one of the route 53 A records chef created. I reprovisioned the SCSCF with one of the A record host names, deleted and recreated my user and voila - I am registered.

Thank you so much!

Kind regards
Jim


RedMatter Ltd
Jim Page
VP Mobile Services
+44 (0)333 150 1666
+44 (0)7870 361412
jim.page at redmatter.com<mailto:jim.page at redmatter.com>

On 22 Sep 2017, at 11:23, Matt Williams <Matt.Williams at metaswitch.com<mailto:Matt.Williams at metaswitch.com>> wrote:

Thanks!  When the I-CSCF receives the User-Authentication-Answer from the HSS, the HSS returns "sip:scscf.ims.rmcore.net" as the S-CSCF to which the subscriber is assigned... but the configuration below is such that the S-CSCF doesn't recognize this as itself.  Normally, the I-CSCF would then route the request to this other S-CSCF, except the domain name resolves to our own S-CSCF again.

I'm not quite sure how the HSS got into this state (maybe the first registration was while the S-CSCF was still being reconfigured?), but please can you either try forcing de-registration on the HSS or (if this isn't easy with your HSS) creating a new subscriber and registering with that?  It would be great if you could grab the same logs and network captures as before for the first registration attempt, in case this doesn't fix it itself.

Thanks,

Matt


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Jim Page
Sent: 22 September 2017 11:00
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] Looping authentication with Bria

One more factoid - the HSS installation via chef was not perfect. The HSS package postinstall scripts failed ? I -think- because mysql was already running when the package was installed, and also it wrote some bad config into /etc/resolv.conf which messed up DNS. Finally, the SCSCF and ICSCF ports were incorrectly configured. I think I sorted most of that out, and I can see diameter packets arriving and the HSS logs indicate that stuff is being processed, but I thought I should mention it in case it rings any bells.
Kind regards
Jim

RedMatter Ltd
Jim Page
VP Mobile Services
+44 (0)333 150 1666
+44 (0)7870 361412
jim.page at redmatter.com<mailto:jim.page at redmatter.com>

On 22 Sep 2017, at 10:56, Jim Page <jim.page at redmatter.com<mailto:jim.page at redmatter.com>> wrote:

Matt, does the HSS have any input into the process of deciding whether the URI is on the home domain? If so, is it possible I misconfigured the HSS? I have had a look through and cannot see anything obvious, but I am really not sure what HSS config might be relevant.
Kind regards
Jim

RedMatter Ltd
Jim Page
VP Mobile Services
+44 (0)333 150 1666
+44 (0)7870 361412
jim.page at redmatter.com<mailto:jim.page at redmatter.com>

On 22 Sep 2017, at 10:52, Jim Page <jim.page at redmatter.com<mailto:jim.page at redmatter.com>> wrote:

Hi Matt

Here it is:


[sprout-1]ubuntu at ec2-35-176-248-167:~$ cat /etc/clearwater/shared_config
# Deployment definitions
home_domain=ims.rmcore.net<http://ims.rmcore.net/>
sprout_hostname=sprout.ims.rmcore.net<http://sprout.ims.rmcore.net/>
sprout_hostname_mgmt=sprout.ims.rmcore.net:9886<http://sprout.ims.rmcore.net:9886/>
hs_hostname=hs.ims.rmcore.net:8888<http://hs.ims.rmcore.net:8888/>
hs_hostname_mgmt=hs.ims.rmcore.net:8886<http://hs.ims.rmcore.net:8886/>
hs_provisioning_hostname=hs.ims.rmcore.net:8889<http://hs.ims.rmcore.net:8889/>
homestead_impu_store="site1=vellum-site1.ims.rmcore.net<http://vellum-site1.ims.rmcore.net/>?
xdms_hostname=homer.ims.rmcore.net:7888<http://homer.ims.rmcore.net:7888/>
ralf_hostname=ralf.ims.rmcore.net:10888<http://ralf.ims.rmcore.net:10888/>
cdf_identity=cdf.ims.rmcore.net<http://cdf.ims.rmcore.net/>
sprout_impi_store=vellum.ims.rmcore.net<http://vellum.ims.rmcore.net/>
sprout_registration_store="site1=vellum-site1.ims.rmcore.net<http://vellum-site1.ims.rmcore.net/>?
cassandra_hostname=vellum.ims.rmcore.net<http://vellum.ims.rmcore.net/>
chronos_hostname=vellum.ims.rmcore.net<http://vellum.ims.rmcore.net/>
ralf_session_store="site1=vellum-site1.ims.rmcore.net<http://vellum-site1.ims.rmcore.net/>?
memento_auth_store=vellum.ims.rmcore.net<http://vellum.ims.rmcore.net/>
sas_server=0.0.0.0
enum_server=
alias_list=
scscf_uri=sip:scscf.sprout.ims.rmcore.net
upstream_port=0

# Email server configuration
smtp_smarthost=localhost
smtp_username=
smtp_password=
email_recovery_sender=ims at redmatter.com<mailto:email_recovery_sender=ims at redmatter.com>

# HSS configuration
hss_hostname=hss-site1.ims.rmcore.net<http://hss-site1.ims.rmcore.net/>
hss_port=3868


# CDF configuration
billing_realm=cdf.ims.rmcore.net<http://cdf.ims.rmcore.net/>

# Registrar configuration


# P-CSCF configuration


trusted_peers=??

# Sproutlet configuration



memento=5055
gemini=5055
cdiv=5055



# Keys
signup_key=?QEgRgtKh?
turn_workaround=?eHMwX98p?
ellis_api_key=?ENYNhvPg?
ellis_cookie_key=?FUZG1jMB?

# Advanced options
nonce_count_supported=Y

Kind regards
Jim

RedMatter Ltd
Jim Page
VP Mobile Services
+44 (0)333 150 1666
+44 (0)7870 361412
jim.page at redmatter.com<mailto:jim.page at redmatter.com>

On 22 Sep 2017, at 10:47, Matt Williams <Matt.Williams at metaswitch.com<mailto:Matt.Williams at metaswitch.com>> wrote:

Jim,

Thanks for those diagnostics!  I think the problem occurs here - specifically the uri_classifier logs:

22-09-2017 09:04:02.770 UTC Debug sproutletproxy.cpp:163: Find target Sproutlet for request
22-09-2017 09:04:02.770 UTC Debug sproutletproxy.cpp:197: Found next routable URI: sip:ims.rmcore.net;lr;service=registrar
22-09-2017 09:04:02.770 UTC Debug sproutletproxy.cpp:300: Found services param - registrar
22-09-2017 09:04:02.770 UTC Debug uri_classifier.cpp:139: home domain: false, local_to_node: false, is_gruu: false, enforce_user_phone: false, prefer_sip: true, treat_number_as_phone: false
22-09-2017 09:04:02.770 UTC Debug uri_classifier.cpp:185: Classified URI as 5
22-09-2017 09:04:02.770 UTC Debug sproutletproxy.cpp:427: Creating URI for service subscription

Basically, we have a SIP URI that says "service=registrar".  This invokes the registrar Sproutlet.  However, the registrar Sproutlet checks that the URI looks right before it accepts it (using the URIClassifier), and it finds that it's not for our home domain (see "home domain: false").  This means that it classifies URI as "5", which is a bit cryptic but corresponds to the URIClass enum, and means OFFNET_SIP_URI... so we route it off net.

So why isn't ims.rmcore.net<http://ims.rmcore.net/> recognized as the home domain?  Please can you share the /etc/clearwater/shared_config file from your system?

Thanks,

Matt

From: Jim Page [mailto:jim.page at redmatter.com]
Sent: 22 September 2017 10:27
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Cc: Matt Williams <Matt.Williams at metaswitch.com<mailto:Matt.Williams at metaswitch.com>>
Subject: Re: [Project Clearwater] Looping authentication with Bria

Hi Matt

Thanks a lot for getting in touch.

I have attached PCAPs of the bria (just sip) and the bono and sprout hosts (everything). Also the bono and sprout logs at log_level=5. I have copied this email to your metaswitch email in case the zip is removed from the forum emails, hope that?s ok.

Your explanation makes sense - let?s hope it?s an easy fix!

This is my #1 priority right now so please let me know if there?s anything else I can do to help debug this.

Kind regards
Jim
_______________________________________________
Clearwater mailing list
Clearwater at lists.projectclearwater.org<mailto:Clearwater at lists.projectclearwater.org>
http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org

_______________________________________________
Clearwater mailing list
Clearwater at lists.projectclearwater.org<mailto:Clearwater at lists.projectclearwater.org>
http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org


_______________________________________________
Clearwater mailing list
Clearwater at lists.projectclearwater.org<mailto:Clearwater at lists.projectclearwater.org>
http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20170922/c4be1d17/attachment.html>

From Matt.Williams at metaswitch.com  Fri Sep 22 06:49:53 2017
From: Matt.Williams at metaswitch.com (Matt Williams)
Date: Fri, 22 Sep 2017 10:49:53 +0000
Subject: [Project Clearwater] Looping authentication with Bria
In-Reply-To: <D36ABEF5-066B-4126-9196-31051ED30A3F@redmatter.com>
References: <A08CF3C9-DCAB-46F3-A7AE-3E597E865129@redmatter.com>
	<C4025817-3A23-4856-8613-717AA07D40AC@redmatter.com>
	<C0E6789C-515C-4A39-BDB1-28BCB1183EE9@redmatter.com>
	<CY4PR02MB288723F16B75130EBE30F89290670@CY4PR02MB2887.namprd02.prod.outlook.com>
	<921BDA9A-996C-4A60-BF4F-5A855BB634C2@redmatter.com>
	<CY4PR02MB2887B407AEA431AB857F07D090670@CY4PR02MB2887.namprd02.prod.outlook.com>
	<71FFD73F-02A6-4403-A8D7-28AD67141012@redmatter.com>
	<3226A3C8-26C3-47D5-A8DF-13784F1706E7@redmatter.com>
	<9BF83C52-F561-4135-9F75-41133E97D7D2@redmatter.com>
	<CY4PR02MB2887F6CD39205F89C2A7D7BF90670@CY4PR02MB2887.namprd02.prod.outlook.com>
	<D36ABEF5-066B-4126-9196-31051ED30A3F@redmatter.com>
Message-ID: <CY4PR02MB2887C69B848F49653B6982D290670@CY4PR02MB2887.namprd02.prod.outlook.com>

Great news!

(You should now be able to take out your authentication tweak if you'd like to.)

Cheers,

Matt

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Jim Page
Sent: 22 September 2017 11:45
To: clearwater at lists.projectclearwater.org
Subject: Re: [Project Clearwater] Looping authentication with Bria

Hi Matt

You nailed it. The SCSCF name I provisioned in the HSS was a CNAME that pointed to one of the route 53 A records chef created. I reprovisioned the SCSCF with one of the A record host names, deleted and recreated my user and voila - I am registered.

Thank you so much!

Kind regards
Jim


RedMatter Ltd
Jim Page
VP Mobile Services
+44 (0)333 150 1666
+44 (0)7870 361412
jim.page at redmatter.com<mailto:jim.page at redmatter.com>

On 22 Sep 2017, at 11:23, Matt Williams <Matt.Williams at metaswitch.com<mailto:Matt.Williams at metaswitch.com>> wrote:

Thanks!  When the I-CSCF receives the User-Authentication-Answer from the HSS, the HSS returns "sip:scscf.ims.rmcore.net" as the S-CSCF to which the subscriber is assigned... but the configuration below is such that the S-CSCF doesn't recognize this as itself.  Normally, the I-CSCF would then route the request to this other S-CSCF, except the domain name resolves to our own S-CSCF again.

I'm not quite sure how the HSS got into this state (maybe the first registration was while the S-CSCF was still being reconfigured?), but please can you either try forcing de-registration on the HSS or (if this isn't easy with your HSS) creating a new subscriber and registering with that?  It would be great if you could grab the same logs and network captures as before for the first registration attempt, in case this doesn't fix it itself.

Thanks,

Matt


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Jim Page
Sent: 22 September 2017 11:00
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] Looping authentication with Bria

One more factoid - the HSS installation via chef was not perfect. The HSS package postinstall scripts failed ? I -think- because mysql was already running when the package was installed, and also it wrote some bad config into /etc/resolv.conf which messed up DNS. Finally, the SCSCF and ICSCF ports were incorrectly configured. I think I sorted most of that out, and I can see diameter packets arriving and the HSS logs indicate that stuff is being processed, but I thought I should mention it in case it rings any bells.
Kind regards
Jim

RedMatter Ltd
Jim Page
VP Mobile Services
+44 (0)333 150 1666
+44 (0)7870 361412
jim.page at redmatter.com<mailto:jim.page at redmatter.com>

On 22 Sep 2017, at 10:56, Jim Page <jim.page at redmatter.com<mailto:jim.page at redmatter.com>> wrote:

Matt, does the HSS have any input into the process of deciding whether the URI is on the home domain? If so, is it possible I misconfigured the HSS? I have had a look through and cannot see anything obvious, but I am really not sure what HSS config might be relevant.
Kind regards
Jim

RedMatter Ltd
Jim Page
VP Mobile Services
+44 (0)333 150 1666
+44 (0)7870 361412
jim.page at redmatter.com<mailto:jim.page at redmatter.com>

On 22 Sep 2017, at 10:52, Jim Page <jim.page at redmatter.com<mailto:jim.page at redmatter.com>> wrote:

Hi Matt

Here it is:


[sprout-1]ubuntu at ec2-35-176-248-167:~$ cat /etc/clearwater/shared_config
# Deployment definitions
home_domain=ims.rmcore.net<http://ims.rmcore.net/>
sprout_hostname=sprout.ims.rmcore.net<http://sprout.ims.rmcore.net/>
sprout_hostname_mgmt=sprout.ims.rmcore.net:9886<http://sprout.ims.rmcore.net:9886/>
hs_hostname=hs.ims.rmcore.net:8888<http://hs.ims.rmcore.net:8888/>
hs_hostname_mgmt=hs.ims.rmcore.net:8886<http://hs.ims.rmcore.net:8886/>
hs_provisioning_hostname=hs.ims.rmcore.net:8889<http://hs.ims.rmcore.net:8889/>
homestead_impu_store="site1=vellum-site1.ims.rmcore.net<http://vellum-site1.ims.rmcore.net/>?
xdms_hostname=homer.ims.rmcore.net:7888<http://homer.ims.rmcore.net:7888/>
ralf_hostname=ralf.ims.rmcore.net:10888<http://ralf.ims.rmcore.net:10888/>
cdf_identity=cdf.ims.rmcore.net<http://cdf.ims.rmcore.net/>
sprout_impi_store=vellum.ims.rmcore.net<http://vellum.ims.rmcore.net/>
sprout_registration_store="site1=vellum-site1.ims.rmcore.net<http://vellum-site1.ims.rmcore.net/>?
cassandra_hostname=vellum.ims.rmcore.net<http://vellum.ims.rmcore.net/>
chronos_hostname=vellum.ims.rmcore.net<http://vellum.ims.rmcore.net/>
ralf_session_store="site1=vellum-site1.ims.rmcore.net<http://vellum-site1.ims.rmcore.net/>?
memento_auth_store=vellum.ims.rmcore.net<http://vellum.ims.rmcore.net/>
sas_server=0.0.0.0
enum_server=
alias_list=
scscf_uri=sip:scscf.sprout.ims.rmcore.net
upstream_port=0

# Email server configuration
smtp_smarthost=localhost
smtp_username=
smtp_password=
email_recovery_sender=ims at redmatter.com<mailto:email_recovery_sender=ims at redmatter.com>

# HSS configuration
hss_hostname=hss-site1.ims.rmcore.net<http://hss-site1.ims.rmcore.net/>
hss_port=3868


# CDF configuration
billing_realm=cdf.ims.rmcore.net<http://cdf.ims.rmcore.net/>

# Registrar configuration


# P-CSCF configuration


trusted_peers=??

# Sproutlet configuration



memento=5055
gemini=5055
cdiv=5055



# Keys
signup_key=?QEgRgtKh?
turn_workaround=?eHMwX98p?
ellis_api_key=?ENYNhvPg?
ellis_cookie_key=?FUZG1jMB?

# Advanced options
nonce_count_supported=Y

Kind regards
Jim

RedMatter Ltd
Jim Page
VP Mobile Services
+44 (0)333 150 1666
+44 (0)7870 361412
jim.page at redmatter.com<mailto:jim.page at redmatter.com>

On 22 Sep 2017, at 10:47, Matt Williams <Matt.Williams at metaswitch.com<mailto:Matt.Williams at metaswitch.com>> wrote:

Jim,

Thanks for those diagnostics!  I think the problem occurs here - specifically the uri_classifier logs:

22-09-2017 09:04:02.770 UTC Debug sproutletproxy.cpp:163: Find target Sproutlet for request
22-09-2017 09:04:02.770 UTC Debug sproutletproxy.cpp:197: Found next routable URI: sip:ims.rmcore.net;lr;service=registrar
22-09-2017 09:04:02.770 UTC Debug sproutletproxy.cpp:300: Found services param - registrar
22-09-2017 09:04:02.770 UTC Debug uri_classifier.cpp:139: home domain: false, local_to_node: false, is_gruu: false, enforce_user_phone: false, prefer_sip: true, treat_number_as_phone: false
22-09-2017 09:04:02.770 UTC Debug uri_classifier.cpp:185: Classified URI as 5
22-09-2017 09:04:02.770 UTC Debug sproutletproxy.cpp:427: Creating URI for service subscription

Basically, we have a SIP URI that says "service=registrar".  This invokes the registrar Sproutlet.  However, the registrar Sproutlet checks that the URI looks right before it accepts it (using the URIClassifier), and it finds that it's not for our home domain (see "home domain: false").  This means that it classifies URI as "5", which is a bit cryptic but corresponds to the URIClass enum, and means OFFNET_SIP_URI... so we route it off net.

So why isn't ims.rmcore.net<http://ims.rmcore.net/> recognized as the home domain?  Please can you share the /etc/clearwater/shared_config file from your system?

Thanks,

Matt

From: Jim Page [mailto:jim.page at redmatter.com]
Sent: 22 September 2017 10:27
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Cc: Matt Williams <Matt.Williams at metaswitch.com<mailto:Matt.Williams at metaswitch.com>>
Subject: Re: [Project Clearwater] Looping authentication with Bria

Hi Matt

Thanks a lot for getting in touch.

I have attached PCAPs of the bria (just sip) and the bono and sprout hosts (everything). Also the bono and sprout logs at log_level=5. I have copied this email to your metaswitch email in case the zip is removed from the forum emails, hope that?s ok.

Your explanation makes sense - let?s hope it?s an easy fix!

This is my #1 priority right now so please let me know if there?s anything else I can do to help debug this.

Kind regards
Jim
_______________________________________________
Clearwater mailing list
Clearwater at lists.projectclearwater.org<mailto:Clearwater at lists.projectclearwater.org>
http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org

_______________________________________________
Clearwater mailing list
Clearwater at lists.projectclearwater.org<mailto:Clearwater at lists.projectclearwater.org>
http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org


_______________________________________________
Clearwater mailing list
Clearwater at lists.projectclearwater.org<mailto:Clearwater at lists.projectclearwater.org>
http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20170922/87b774b0/attachment.html>

From jim.page at redmatter.com  Fri Sep 22 06:53:15 2017
From: jim.page at redmatter.com (Jim Page)
Date: Fri, 22 Sep 2017 10:53:15 +0000
Subject: [Project Clearwater] Looping authentication with Bria
In-Reply-To: <CY4PR02MB2887C69B848F49653B6982D290670@CY4PR02MB2887.namprd02.prod.outlook.com>
References: <A08CF3C9-DCAB-46F3-A7AE-3E597E865129@redmatter.com>
	<C4025817-3A23-4856-8613-717AA07D40AC@redmatter.com>
	<C0E6789C-515C-4A39-BDB1-28BCB1183EE9@redmatter.com>
	<CY4PR02MB288723F16B75130EBE30F89290670@CY4PR02MB2887.namprd02.prod.outlook.com>
	<921BDA9A-996C-4A60-BF4F-5A855BB634C2@redmatter.com>
	<CY4PR02MB2887B407AEA431AB857F07D090670@CY4PR02MB2887.namprd02.prod.outlook.com>
	<71FFD73F-02A6-4403-A8D7-28AD67141012@redmatter.com>
	<3226A3C8-26C3-47D5-A8DF-13784F1706E7@redmatter.com>
	<9BF83C52-F561-4135-9F75-41133E97D7D2@redmatter.com>
	<CY4PR02MB2887F6CD39205F89C2A7D7BF90670@CY4PR02MB2887.namprd02.prod.outlook.com>
	<D36ABEF5-066B-4126-9196-31051ED30A3F@redmatter.com>
	<CY4PR02MB2887C69B848F49653B6982D290670@CY4PR02MB2887.namprd02.prod.outlook.com>
Message-ID: <B99DD877-30F4-42F9-B488-8D2BB8EA0912@redmatter.com>

It was a work of art but I am glad to see the back of it! :)
Cheers
Jim

RedMatter Ltd
Jim Page
VP Mobile Services
+44 (0)333 150 1666
+44 (0)7870 361412
jim.page at redmatter.com<mailto:jim.page at redmatter.com>

On 22 Sep 2017, at 11:49, Matt Williams <Matt.Williams at metaswitch.com<mailto:Matt.Williams at metaswitch.com>> wrote:

Great news!

(You should now be able to take out your authentication tweak if you'd like to.)

Cheers,

Matt

From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Jim Page
Sent: 22 September 2017 11:45
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] Looping authentication with Bria

Hi Matt

You nailed it. The SCSCF name I provisioned in the HSS was a CNAME that pointed to one of the route 53 A records chef created. I reprovisioned the SCSCF with one of the A record host names, deleted and recreated my user and voila - I am registered.

Thank you so much!

Kind regards
Jim


RedMatter Ltd
Jim Page
VP Mobile Services
+44 (0)333 150 1666
+44 (0)7870 361412
jim.page at redmatter.com<mailto:jim.page at redmatter.com>

On 22 Sep 2017, at 11:23, Matt Williams <Matt.Williams at metaswitch.com<mailto:Matt.Williams at metaswitch.com>> wrote:

Thanks!  When the I-CSCF receives the User-Authentication-Answer from the HSS, the HSS returns "sip:scscf.ims.rmcore.net" as the S-CSCF to which the subscriber is assigned... but the configuration below is such that the S-CSCF doesn't recognize this as itself.  Normally, the I-CSCF would then route the request to this other S-CSCF, except the domain name resolves to our own S-CSCF again.

I'm not quite sure how the HSS got into this state (maybe the first registration was while the S-CSCF was still being reconfigured?), but please can you either try forcing de-registration on the HSS or (if this isn't easy with your HSS) creating a new subscriber and registering with that?  It would be great if you could grab the same logs and network captures as before for the first registration attempt, in case this doesn't fix it itself.

Thanks,

Matt


From: Clearwater [mailto:clearwater-bounces at lists.projectclearwater.org] On Behalf Of Jim Page
Sent: 22 September 2017 11:00
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Subject: Re: [Project Clearwater] Looping authentication with Bria

One more factoid - the HSS installation via chef was not perfect. The HSS package postinstall scripts failed ? I -think- because mysql was already running when the package was installed, and also it wrote some bad config into /etc/resolv.conf which messed up DNS. Finally, the SCSCF and ICSCF ports were incorrectly configured. I think I sorted most of that out, and I can see diameter packets arriving and the HSS logs indicate that stuff is being processed, but I thought I should mention it in case it rings any bells.
Kind regards
Jim

RedMatter Ltd
Jim Page
VP Mobile Services
+44 (0)333 150 1666
+44 (0)7870 361412
jim.page at redmatter.com<mailto:jim.page at redmatter.com>

On 22 Sep 2017, at 10:56, Jim Page <jim.page at redmatter.com<mailto:jim.page at redmatter.com>> wrote:

Matt, does the HSS have any input into the process of deciding whether the URI is on the home domain? If so, is it possible I misconfigured the HSS? I have had a look through and cannot see anything obvious, but I am really not sure what HSS config might be relevant.
Kind regards
Jim

RedMatter Ltd
Jim Page
VP Mobile Services
+44 (0)333 150 1666
+44 (0)7870 361412
jim.page at redmatter.com<mailto:jim.page at redmatter.com>

On 22 Sep 2017, at 10:52, Jim Page <jim.page at redmatter.com<mailto:jim.page at redmatter.com>> wrote:

Hi Matt

Here it is:


[sprout-1]ubuntu at ec2-35-176-248-167:~$ cat /etc/clearwater/shared_config
# Deployment definitions
home_domain=ims.rmcore.net<http://ims.rmcore.net/>
sprout_hostname=sprout.ims.rmcore.net<http://sprout.ims.rmcore.net/>
sprout_hostname_mgmt=sprout.ims.rmcore.net:9886<http://sprout.ims.rmcore.net:9886/>
hs_hostname=hs.ims.rmcore.net:8888<http://hs.ims.rmcore.net:8888/>
hs_hostname_mgmt=hs.ims.rmcore.net:8886<http://hs.ims.rmcore.net:8886/>
hs_provisioning_hostname=hs.ims.rmcore.net:8889<http://hs.ims.rmcore.net:8889/>
homestead_impu_store="site1=vellum-site1.ims.rmcore.net<http://vellum-site1.ims.rmcore.net/>?
xdms_hostname=homer.ims.rmcore.net:7888<http://homer.ims.rmcore.net:7888/>
ralf_hostname=ralf.ims.rmcore.net:10888<http://ralf.ims.rmcore.net:10888/>
cdf_identity=cdf.ims.rmcore.net<http://cdf.ims.rmcore.net/>
sprout_impi_store=vellum.ims.rmcore.net<http://vellum.ims.rmcore.net/>
sprout_registration_store="site1=vellum-site1.ims.rmcore.net<http://vellum-site1.ims.rmcore.net/>?
cassandra_hostname=vellum.ims.rmcore.net<http://vellum.ims.rmcore.net/>
chronos_hostname=vellum.ims.rmcore.net<http://vellum.ims.rmcore.net/>
ralf_session_store="site1=vellum-site1.ims.rmcore.net<http://vellum-site1.ims.rmcore.net/>?
memento_auth_store=vellum.ims.rmcore.net<http://vellum.ims.rmcore.net/>
sas_server=0.0.0.0
enum_server=
alias_list=
scscf_uri=sip:scscf.sprout.ims.rmcore.net
upstream_port=0

# Email server configuration
smtp_smarthost=localhost
smtp_username=
smtp_password=
email_recovery_sender=ims at redmatter.com<mailto:email_recovery_sender=ims at redmatter.com>

# HSS configuration
hss_hostname=hss-site1.ims.rmcore.net<http://hss-site1.ims.rmcore.net/>
hss_port=3868


# CDF configuration
billing_realm=cdf.ims.rmcore.net<http://cdf.ims.rmcore.net/>

# Registrar configuration


# P-CSCF configuration


trusted_peers=??

# Sproutlet configuration



memento=5055
gemini=5055
cdiv=5055



# Keys
signup_key=?QEgRgtKh?
turn_workaround=?eHMwX98p?
ellis_api_key=?ENYNhvPg?
ellis_cookie_key=?FUZG1jMB?

# Advanced options
nonce_count_supported=Y

Kind regards
Jim

RedMatter Ltd
Jim Page
VP Mobile Services
+44 (0)333 150 1666
+44 (0)7870 361412
jim.page at redmatter.com<mailto:jim.page at redmatter.com>

On 22 Sep 2017, at 10:47, Matt Williams <Matt.Williams at metaswitch.com<mailto:Matt.Williams at metaswitch.com>> wrote:

Jim,

Thanks for those diagnostics!  I think the problem occurs here - specifically the uri_classifier logs:

22-09-2017 09:04:02.770 UTC Debug sproutletproxy.cpp:163: Find target Sproutlet for request
22-09-2017 09:04:02.770 UTC Debug sproutletproxy.cpp:197: Found next routable URI: sip:ims.rmcore.net;lr;service=registrar
22-09-2017 09:04:02.770 UTC Debug sproutletproxy.cpp:300: Found services param - registrar
22-09-2017 09:04:02.770 UTC Debug uri_classifier.cpp:139: home domain: false, local_to_node: false, is_gruu: false, enforce_user_phone: false, prefer_sip: true, treat_number_as_phone: false
22-09-2017 09:04:02.770 UTC Debug uri_classifier.cpp:185: Classified URI as 5
22-09-2017 09:04:02.770 UTC Debug sproutletproxy.cpp:427: Creating URI for service subscription

Basically, we have a SIP URI that says "service=registrar".  This invokes the registrar Sproutlet.  However, the registrar Sproutlet checks that the URI looks right before it accepts it (using the URIClassifier), and it finds that it's not for our home domain (see "home domain: false").  This means that it classifies URI as "5", which is a bit cryptic but corresponds to the URIClass enum, and means OFFNET_SIP_URI... so we route it off net.

So why isn't ims.rmcore.net<http://ims.rmcore.net/> recognized as the home domain?  Please can you share the /etc/clearwater/shared_config file from your system?

Thanks,

Matt

From: Jim Page [mailto:jim.page at redmatter.com]
Sent: 22 September 2017 10:27
To: clearwater at lists.projectclearwater.org<mailto:clearwater at lists.projectclearwater.org>
Cc: Matt Williams <Matt.Williams at metaswitch.com<mailto:Matt.Williams at metaswitch.com>>
Subject: Re: [Project Clearwater] Looping authentication with Bria

Hi Matt

Thanks a lot for getting in touch.

I have attached PCAPs of the bria (just sip) and the bono and sprout hosts (everything). Also the bono and sprout logs at log_level=5. I have copied this email to your metaswitch email in case the zip is removed from the forum emails, hope that?s ok.

Your explanation makes sense - let?s hope it?s an easy fix!

This is my #1 priority right now so please let me know if there?s anything else I can do to help debug this.

Kind regards
Jim
_______________________________________________
Clearwater mailing list
Clearwater at lists.projectclearwater.org<mailto:Clearwater at lists.projectclearwater.org>
http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org

_______________________________________________
Clearwater mailing list
Clearwater at lists.projectclearwater.org<mailto:Clearwater at lists.projectclearwater.org>
http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org


_______________________________________________
Clearwater mailing list
Clearwater at lists.projectclearwater.org<mailto:Clearwater at lists.projectclearwater.org>
http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org

_______________________________________________
Clearwater mailing list
Clearwater at lists.projectclearwater.org<mailto:Clearwater at lists.projectclearwater.org>
http://lists.projectclearwater.org/mailman/listinfo/clearwater_lists.projectclearwater.org

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20170922/7e99a6e4/attachment.html>

From joehary at gmail.com  Wed Sep 13 03:15:58 2017
From: joehary at gmail.com (joehary ar)
Date: Wed, 13 Sep 2017 07:15:58 -0000
Subject: [Project Clearwater] Installation of ClearWater vIMS via
 OSM/OpenStack
Message-ID: <CAKHfQt44k-eCnX0p-4DqcD_hn23F8H7ySO2tjKOZvhm6qY9jxw@mail.gmail.com>

Hi,

May I know if there is any tutorial on how to deploy/onboarding vIMS
clearwater using OSM and OpenStack.

I've seen it has been done over Cloudify and got good tutorial on it. I my
case i want to try using OSM.

Please assist further.

Thanks.

Regards,
Joe
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20170913/3375fc98/attachment.html>

From jim.page at redmatter.com  Fri Sep 22 05:28:16 2017
From: jim.page at redmatter.com (Jim Page)
Date: Fri, 22 Sep 2017 09:28:16 -0000
Subject: [Project Clearwater] Looping authentication with Bria
In-Reply-To: <CY4PR02MB288723F16B75130EBE30F89290670@CY4PR02MB2887.namprd02.prod.outlook.com>
References: <A08CF3C9-DCAB-46F3-A7AE-3E597E865129@redmatter.com>
	<C4025817-3A23-4856-8613-717AA07D40AC@redmatter.com>
	<C0E6789C-515C-4A39-BDB1-28BCB1183EE9@redmatter.com>
	<CY4PR02MB288723F16B75130EBE30F89290670@CY4PR02MB2887.namprd02.prod.outlook.com>
Message-ID: <921BDA9A-996C-4A60-BF4F-5A855BB634C2@redmatter.com>

Hi Matt

Thanks a lot for getting in touch.

I have attached PCAPs of the bria (just sip) and the bono and sprout hosts (everything). Also the bono and sprout logs at log_level=5. I have copied this email to your metaswitch email in case the zip is removed from the forum emails, hope that?s ok.

Your explanation makes sense - let?s hope it?s an easy fix!

This is my #1 priority right now so please let me know if there?s anything else I can do to help debug this.

Kind regards
Jim
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20170922/2c1561c7/attachment.html>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: BriaDebug.zip
Type: application/zip
Size: 214309 bytes
Desc: BriaDebug.zip
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20170922/2c1561c7/attachment.zip>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20170922/2c1561c7/attachment.htm>

From utnhi989 at gmail.com  Wed Sep 27 10:09:12 2017
From: utnhi989 at gmail.com (nhi dang)
Date: Wed, 27 Sep 2017 14:09:12 -0000
Subject: [Project Clearwater] Fail to install
Message-ID: <59cbb0dd.4407630a.734e0.e845@mx.google.com>

Hi,
?I got the problem related to cassandra 2.1.15 when trying to install the dime node with lastest release as below:
?Get:21 http://us.archive.ubuntu.com/ubuntu/ trusty-updates/main openjdk-7-jre-headless amd64 7u151-2.6.11-0ubuntu1.14.04.1 [39.4 MB]
Err http://repo.cw-ngv.com/stable/ binary/ cassandra 2.1.15??????????????????? 
??403? Forbidden
Get:22 http://us.archive.ubuntu.com/ubuntu/ trusty/main lksctp-tools amd64 1.0.15+dfsg-1 [51.3 kB]
Fetched 42.1 MB in 1min 37s (434 kB/s)???????????????????????????????????????? 
E: Failed to fetch http://repo.cw-ngv.com/stable/binary/cassandra_2.1.15_all.deb? 403? Forbidden
?
The command that I used is ?sudo DEBIAN_FRONTEND=noninteractive apt-get install dime clearwater-prov-tools --yes?

?Is there something wrong with the package cassandra 2.1.15?on the site?
Could someone help to take a look and let me know the solution?
?
Thanks,
Nhi Dang.


Sent from Mail for Windows 10

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.projectclearwater.org/pipermail/clearwater_lists.projectclearwater.org/attachments/20170927/844e92eb/attachment.html>

